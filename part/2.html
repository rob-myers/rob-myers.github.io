<!DOCTYPE html><html lang="en"><head><meta name="description" content="A Game AI focused roguelike, built blog by blog." /><link rel="icon" href="/favicon.ico" /><style id="_goober"> .go1654252976{padding:0;color:#aaa;}.go1654252976 h3{padding:20px 12px;font-family:'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;font-size:1.8rem;font-weight:300;margin:0;border:0 solid #aaa;border-width:0 0 2px;}.go1654252976 h3 a{color:#ddd;}.go1654252976 ul{font-size:1.1rem;padding:6px 0;margin:0;border:0 solid #aaa;border-width:0 0 2px;}.go1654252976 ul li{list-style:none;list-style-position:inside;display:flex;}.go1654252976 ul li.current a{color:white;}.go1654252976 ul a{padding:10px 12px;width:100%;color:#888;}.go1654252976 ul a:hover{color:#ccc;}.go3816569223{position:fixed;z-index:11;height:calc(100% + 200px);width:256px;font-weight:300;font-family:sans-serif;background-color:#222;color:white;cursor:pointer;opacity:0.975;-webkit-tap-highlight-color:transparent;left:0;transition:transform 500ms ease;}.go3816569223.open{transform:translateX(0px);}.go3816569223.closed{transform:translateX(-256px);}.go3816569223 > .article-overlay{position:absolute;top:0;left:256px;width:100vw;height:0;background:rgba(0, 0, 0, .1);}@media(max-width: 1280px){.go3816569223.open > .article-overlay{height:100%;background:rgba(0, 0, 0, .25);}}.go3816569223 > .handle{position:absolute;top:-1px;right:-40px;width:40px;height:41px;display:flex;justify-content:center;align-items:center;user-select:none;}.go3816569223 > .handle .icon{display:flex;justify-content:center;align-items:center;background:#900;color:#fff;width:inherit;height:inherit;padding:0 0 2px 0;}.go3089436763{position:fixed;cursor:pointer;z-index:7;left:0;width:calc(100vw + 256px);height:40px;background:black;}.go4227718824{min-width:256px;transition:min-width 500ms ease;}.go4227718824.closed{min-width:0;}@media(max-width: 1280px){.go4227718824{display:none;}}.go3231828434{margin:24px;color:red;font-size:1.2rem;font-family:monospace;}.go741482717{position:absolute;z-index:10;right:140px;top:-48px;font-size:1rem;}@media(max-width: 1024px){.go741482717{top:-32px;}}@media(max-width: 600px){.go741482717{top:0;}}.go741482717 > ul{position:fixed;width:140px;height:40px;display:flex;justify-content:center;align-items:center;padding:0;margin:0;}.go741482717 > ul li{list-style:none;list-style-position:inside;padding:0 5px;}.go741482717 > ul a{color:#ccc;}.go741482717 > ul a.primary{color:#fff;}.go1710844964{position:absolute;right:140px;z-index:3;top:-8px;}@media(max-width: 1024px){.go1710844964{top:8px;}}@media(max-width: 600px){.go1710844964{top:40px;}}.go1710844964 .fixed{position:fixed;width:140px;text-align:center;font-size:15px;letter-spacing:2px;padding:6px 0 14px;background:#000;}.go1710844964 .fixed a{color:#fff;}.go4260321069{font-family:'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;position:relative;padding-top:40px;}@media(max-width: 600px){.go4260321069{background:#eee;padding-bottom:8px;padding-left:8px;border-bottom:1px solid #aaa;padding-top:64px;}}.go4260321069 h1{margin:0;font-size:5rem;font-weight:300;cursor:pointer;color:#333;display:inline-block;}@media(max-width: 800px){.go4260321069 h1{font-size:5rem;}}@media(max-width: 600px){.go4260321069 h1{font-size:3rem;}}.go4260321069 p{color:#444;letter-spacing:2px;font-size:1.4rem;margin:0;padding:40px 0 48px;font-weight:300;}@media(max-width: 600px){.go4260321069 p{font-size:1.1rem;padding:20px 0 20px 4px;color:#222;}}.go2349753049{max-width:1024px;width:100%;padding:48px 64px;}@media(max-width: 1024px){.go2349753049{padding:32px 0 32px 40px;margin:0;}}@media(max-width: 600px){.go2349753049{padding:0;}}.go1763247448{margin:0;border-color:var(--focus-bg);}@media(min-width: 800px){.go1763247448{padding-bottom:80px;border:0;}}.go2093728181{font-family:Roboto, Arial, sans-serif;}.go2093728181 > .top-right{position:absolute;right:-10px;top:-36px;z-index:2;border-radius:4px 4px 0 0;padding:0 16px 0 16px;display:flex;cursor:pointer;background:#444;}@media(max-width: 600px){.go2093728181 > .top-right{padding-top:4px;}}.go2093728181 > .top-right > div:not(:last-child){margin-right:16px;}.go2093728181 > .central{position:absolute;z-index:6;left:calc(50% - (128px / 2));top:calc(50% - 20px);cursor:pointer;color:#ddd;background:rgba(0, 0, 0, 0.7);padding:12px 32px;border-radius:4px;border:1px solid #ddd;font-size:1.2rem;letter-spacing:2px;opacity:1;transition:300ms opacity ease;}.go2093728181 > .central.enabled{opacity:0;}.go4001245135{position:absolute;z-index:4;width:100%;height:100%;background:#000;font-family:sans-serif;opacity:1;transition:opacity 1s ease-in;}.go4001245135:not(.faded){pointer-events:none;}.go4001245135.clear{opacity:0;transition:opacity 0.5s ease-in;}.go4001245135.faded{opacity:0.5;transition:opacity 0.5s ease-in;}.go3990344948{margin:64px 0;background:var(--focus-bg);position:relative;}@media(max-width: 600px){.go3990344948{margin:40px 0 32px 0;}}.go3990344948 > span.anchor{position:absolute;top:-96px;}.go3990344948 .modal-backdrop{position:fixed;z-index:19;left:0;top:0;width:100vw;height:100vh;background:rgba(0, 0, 0, 0.6);}@keyframes fadein{from{opacity:0;}to{opacity:1;}}.go3990344948 .flexlayout__tabset{animation:fadein 1s;}.go3990344948 .flexlayout__tabset,.go3990344948  .flexlayout__tab{background:white;}.go3990344948 .flexlayout__layout{background:#444;}.go3990344948 .flexlayout__tab{border-top:6px solid #444;position:relative;overflow:hidden;}.go3990344948 .flexlayout__tab > div.portal{width:100%;height:100%;}.go3990344948 .flexlayout__tabset_tabbar_outer{background:#222;border-bottom:1px solid #555;}.go3990344948 .flexlayout__tab_button--selected,.go3990344948  .flexlayout__tab_button:hover{background:#444;}.go3990344948 .flexlayout__tab_button_content{user-select:none;font-size:13px;color:#aaa;}.go3990344948 .flexlayout__tab_button--selected .flexlayout__tab_button_content{color:#fff;}.go3990344948 .flexlayout__tab_button:hover:not(.flexlayout__tab_button--selected) .flexlayout__tab_button_content{color:#ddd;}.go3990344948 .flexlayout__splitter_vert,.go3990344948  .flexlayout__splitter_horz{background:#827575;}.go567358686{position:fixed;z-index:20;top:120px;left:10%;width:80%;height:calc(100% - 120px - 10%);border:10px solid #444;}@media(max-width: 600px){.go567358686{left:0;width:100%;}}.go129633710{line-height:2.2;background:var(--focus-bg);border:var(--blog-border-width) solid var(--border-bg);font-size:1rem;overflow-wrap:break-word;position:relative;padding:64px 164px 96px 164px;}@media(max-width: 1024px){.go129633710{padding:64px 128px 64px 128px;}}@media(max-width: 600px){.go129633710{padding:8px 12px;font-size:1.1rem;border:none;line-height:1.7;}}.go129633710 a{position:relative;}.go129633710 a code{color:unset;}.go129633710 a > span.anchor{position:absolute;top:-96px;}.go129633710 aside{margin:24px 0;padding:36px 48px;font-size:0.9rem;border:0 solid #ddd;background:#eee;position:relative;}.go129633710 aside p{margin:12px 0;}.go129633710 aside p + blockquote,.go129633710 aside  blockquote + p{margin-top:0px;}@media(max-width: 600px){.go129633710 aside{line-height:2;padding:24px;}}.go129633710 aside blockquote{margin:0;border-left:8px solid #ccc;}@media(min-width: 600px){.go129633710 aside figure.tabs{margin:40px 0;}}.go129633710 aside .anchor{position:absolute;top:-48px;}.go129633710 blockquote{margin:32px 0;border-left:8px solid #ddd;padding-left:30px;}@media(max-width: 600px){.go129633710 blockquote{margin:20px 0;padding-left:20px;}}.go129633710 blockquote + p{margin-top:-12px;}@media(max-width: 600px){.go129633710 blockquote + p{margin-top:0;}}.go129633710 code{font-family:'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;letter-spacing:2px;color:#444;padding:0 2px;}.go129633710 h1,.go129633710  h2,.go129633710  h3,.go129633710  h4{font-family:'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;font-weight:400;letter-spacing:2px;}.go129633710 h1 a,.go129633710  h2 a,.go129633710  h3 a,.go129633710  h4 a{color:#444;}.go129633710 h2{font-size:3rem;}@media(max-width: 1024px){.go129633710 h2{font-size:2.8rem;}}@media(max-width: 600px){.go129633710 h2{margin:16px 0 24px;font-size:2rem;}}.go129633710 h2 + time{display:block;margin-top:-24px;margin-bottom:32px;font-family:monospace;font-size:0.9rem;}.go129633710 h2 + time > span{margin-right:16px;}.go129633710 h2 + time > span > span{padding:4px 6px;background:#eee;border:1px solid #ddd;color:#666;}@media(max-width: 600px){.go129633710 h2 + time{font-size:0.8rem;margin-top:0px;}.go129633710 h2 + time > span{padding:3px 0px;}}.go129633710 h2 + time + div.tags{margin-top:-12px;display:flex;flex-wrap:wrap;font-size:0.7rem;font-family:sans-serif;letter-spacing:2px;color:#fff;}.go129633710 h2 + time + div.tags span{padding:4px 8px;margin-right:4px;margin-bottom:4px;background:#99a;border-radius:3px;border:2px solid rgba(0, 0, 0, 0.1);}@media(max-width: 600px){.go129633710 h2 + time + div.tags{font-size:0.65rem;}.go129633710 h2 + time + div.tags span{padding:3px 8px;}}.go129633710 h3{font-size:1.7rem;position:relative;}@media(max-width: 600px){.go129633710 h3{font-size:1.3rem;}}.go129633710 h3 > span.anchor{position:absolute;top:-48px;}.go129633710 h2 + p,.go129633710  h3 + p{margin-top:0px;}.go129633710 li blockquote{margin:0;}.go129633710 li blockquote p{margin:16px 0;}.go129633710 p{margin:40px 0;}@media(max-width: 600px){.go129633710 p{margin:16px 0;}}.go129633710 p code{font-size:1rem;}.go129633710 p + blockquote{margin-top:-20px;}@media(max-width: 600px){.go129633710 p + blockquote{margin-top:-4px;}}.go129633710 span.cmd{color:#555;background:#eee;font-family:monospace;letter-spacing:1px;font-size:smaller;padding:2px 4px;}@media(max-width: 600px){.go129633710 span.cmd{user-select:all;}}.go129633710 > span.anchor{position:absolute;top:-48px;}.go129633710 table{padding:8px;border:1px solid #bbb;width:100%;margin:40px 0;}@media(max-width: 600px){.go129633710 table{margin:20px 0;}}.go129633710 table th,.go129633710 table  td{padding:6px;text-align:left;vertical-align:top;}@media(max-width: 600px){.go129633710 table th,.go129633710 table  td{padding:4px 2px;}}@media(max-width: 600px){.go129633710 ul,.go129633710  ol{padding-left:20px;}}.go129633710 ul + p,.go129633710  ol + p{padding-top:6px;}.go129633710 ul li,.go129633710  ol li{margin:4px 0;}.go2193861445{padding:0;margin:0;list-style:none;}.go3263955189{height:64px;font-size:1.1rem;margin-top:-64px;display:flex;justify-content:center;align-items:center;}@media(max-width: 800px){.go3263955189{margin-top:0;font-size:1rem;}}.go3263955189 a{color:#555;border:1px solid #666;background:#fff;padding:8px 16px;border-radius:4px;}.go842686353::after{display:inline-block;content:'';background-image:url('/icon/anchor-icon.svg');background-size:13px 13px;height:13px;width:13px;margin:0 2px 0 4px;}.go25095430::after{display:inline-block;content:'';background-image:url('/icon/ext-link-icon.svg');background-size:13px 13px;height:13px;width:13px;margin:0 2px 0 4px;}.go78320706{width:100%;height:400px;position:relative;border:10px solid #444;}.go1827927822::after{display:inline-block;content:'';background-image:url('/icon/anchor-icon-white.svg');background-size:13px 13px;height:13px;width:13px;margin:auto;}.go2297566067::after{display:inline-block;content:'';background-image:url('/icon/expand-solid.svg');background-size:13px 13px;height:13px;width:13px;margin:auto;}.go3886657982::after{display:inline-block;content:'';background-image:url('/icon/eye.svg');background-size:16px 16px;height:16px;width:16px;margin:auto;}.go256839001{width:100%;height:340px;position:relative;border:10px solid #444;}.go3883955307{width:100%;height:360px;position:relative;border:10px solid #444;}</style><meta name="next-font-preconnect" /><meta name="viewport" content="width=device-width" /><meta charSet="utf-8" /><title>Rogue Markup</title><meta name="next-head-count" content="3" /><link rel="preload" href="/_next/static/css/b9ed8b53a0b603454ce0.css" as="style" /><link rel="stylesheet" href="/_next/static/css/b9ed8b53a0b603454ce0.css" data-n-g /><noscript data-n-css></noscript><script defer noModule src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-23961316e8cfdc3948ab.js" defer></script><script src="/_next/static/chunks/framework-571220e3661128bb4007.js" defer></script><script src="/_next/static/chunks/main-aba050664ec743567e3e.js" defer></script><script src="/_next/static/chunks/pages/_app-97177240c85b07de4ceb.js" defer></script><script src="/_next/static/chunks/commons-a734680313a8e73165d6.js" defer></script><script src="/_next/static/chunks/45-aa2b20ad0d204f91161f.js" defer></script><script src="/_next/static/chunks/799-5937fdc913393c30b7c7.js" defer></script><script src="/_next/static/chunks/249-84caaddb310b81ebe330.js" defer></script><script src="/_next/static/chunks/pages/part/2-ffb5883f00a63ce9db9f.js" defer></script><script src="/_next/static/FO4G1hO8uLwlVtAZhv72V/_buildManifest.js" defer></script><script src="/_next/static/FO4G1hO8uLwlVtAZhv72V/_ssgManifest.js" defer></script></head><body><div id="__next"><nav class="go3816569223 closed"><div class="article-overlay"></div><div class="handle"><div class="icon">&gt;</div></div><section class="go1654252976"><h3><a href="/">Rogue Markup</a></h3><ul><li><a href="/part/1#objective" title="Our overall objective">1a objective</a></li><li><a href="/part/1#constraints" title="Constraints: tech, game mechanics, setting">1b constraints</a></li><li><a href="/part/1#finishing" title="Finishing as a skill">1c finishing</a></li></ul><ul><li><a href="/part/2#technology" title="The tech we'll use">2a technology</a></li><li><a href="/part/2#tech1" title="JavaScript components">2b tech: js</a></li><li><a href="/part/2#tech2" title="Tech related to gameplay">2c tech: ai</a></li><li><a href="/part/2#tech3" title="Dev env and in-browser terminal">2d tech: dev</a></li></ul><ul><li><a href="/part/3#geomorphs" title="How we use Starship Geomorphs">3a geomorphs</a></li></ul></section></nav><div class="go3089436763"></div><div class="go4227718824 closed"></div><section class="go2349753049"><header class="title go4260321069"><div class="go1710844964"><div class="fixed"><a href>continue</a></div></div><h1 level="1">Rogue Markup</h1>
<p>$( game ai | roguelike | web dev )</p></header><main><ol class="go2193861445"><li><article class="go129633710"><span id="technology" class="anchor"></span><h2 level="2"><a href="#technology"><a>Technology</a></a></h2><time dateTime="2021-07-19"><span><span>1</span><span>9</span><span>t</span><span>h</span></span><span><span>J</span><span>u</span><span>l</span><span>y</span></span><span><span>2</span><span>0</span><span>2</span><span>1</span></span></time><div title="tags" class="tags"><span>lego bricks</span><span>specific tech</span></div>
<p>So, we're going to build a roguelike directly on this website.
We sketched the <a href="1#constraints--technology" title="@anchor" class="anchor-link go842686353"><span id="technology--link--technological-constraints-earlier" class="anchor"></span>technological constraints earlier</a> and now provide more detail.</p>

























































<table><thead><tr><th>Concept</th><th>Technology</th></tr></thead><tbody><tr><td>Component</td><td><a href="https://reactjs.org/docs/components-and-props.html#function-and-class-components"><span id="technology--link--react-function-components" class="anchor"></span>React function components</a>.</td></tr><tr><td>Styles</td><td>CSS-in-JS via <a href="https://www.npmjs.com/package/goober"><span id="technology--link--goober" class="anchor"></span>Goober</a>.</td></tr><tr><td>Component framework</td><td><a href="https://preactjs.com/"><span id="technology--link--preact" class="anchor"></span>Preact</a>, a DOM-diffing alternative to React.</td></tr><tr><td>Pathfinding</td><td>Basic pathfinding based on <a href="https://www.npmjs.com/package/three-pathfinding"><span id="technology--link--three-pathfinding" class="anchor"></span>three-pathfinding</a>.</td></tr><tr><td>Raycasting</td><td>Basic geometry and spacial partitioning.</td></tr><tr><td>Static analysis</td><td>TypeScript via <a href="https://www.typescriptlang.org/docs/handbook/jsdoc-supported-types.html"><span id="technology--link--jsdoc" class="anchor"></span>JSDoc</a>; also <a href="https://www.npmjs.com/package/eslint"><span id="technology--link--eslint" class="anchor"></span>ESLint</a>.</td></tr><tr><td>Live analysis</td><td>In-browser terminal, via <a href="https://www.npmjs.com/package/xterm"><span id="technology--link--xterm.js" class="anchor"></span>xterm.js</a> and <a href="https://www.npmjs.com/package/mvdan-sh"><span id="technology--link--mvdan-sh" class="anchor"></span>mvdan-sh</a>.</td></tr><tr><td>Scripting</td><td><a href="https://www.npmjs.com/package/ts-node"><span id="technology--link--ts-node" class="anchor"></span>TS Node</a> i.e. Node.js with types.</td></tr><tr><td>Code viewing</td><td><a href="https://codemirror.net/"><span id="technology--link--codemirror" class="anchor"></span>CodeMirror</a> to view JS.</td></tr><tr><td>Code editing</td><td>External <a href="https://codesandbox.io/"><span id="technology--link--codesandbox" class="anchor"></span>CodeSandbox</a> links, using React.</td></tr><tr><td>Code sharing</td><td>Show <a href="https://github.com/"><span id="technology--link--github" class="anchor"></span>GitHub</a> comments, provide GitHub <a href="https://github.com/rob-myers/rob-myers.github.io"><span id="technology--link--repo" class="anchor"></span>repo</a>.</td></tr><tr><td>Asset editor</td><td><a href="https://boxy-svg.com/"><span id="technology--link--boxy-svg" class="anchor"></span>Boxy SVG</a>.</td></tr></tbody></table>
<p>We'll explain the above over the next few articles.</p></article><hr class="go1763247448" /></li><li><article class="go129633710"><span id="tech1" class="anchor"></span><h2 level="2"><a href="#tech1"><a>Tech (js)</a></a></h2><time dateTime="2021-07-19"><span><span>1</span><span>9</span><span>t</span><span>h</span></span><span><span>J</span><span>u</span><span>l</span><span>y</span></span><span><span>2</span><span>0</span><span>2</span><span>1</span></span></time><div title="tags" class="tags"><span>javascript</span><span>react</span><span>preact</span><span>jsx</span><span>performance</span><span>hot reload</span></div>
<p>The early 90s brought three pillars: HTML, CSS, JavaScript (JS).
Whenever we visit a website we receive an HTML response, referencing or embedding CSS and JS.
Our web browser renders the HTML and CSS immediately,
and executes the JS to provide interactivity.</p>
<aside><span class="anchor"></span>
<p>More precisely, all <em><a href="https://en.wikipedia.org/wiki/Document_Object_Model#JavaScript"><span id="tech1--link--dom" class="anchor"></span>DOM</a> mutations</em> are performed by JavaScript.
The DOM is the programmatic interface to the current <em>document</em> viewed in the browser.
It amounts to parsed HTML decorated with matching CSS and bound JS, together with APIs for reading and modifying it.</p>
</aside>
<p>Although HTML, CSS and JS are separate standards,
it is now common to generate both the HTML and the CSS using JS.
This is possible via <em>Node.js Server-Side Rendering</em> and <em>CSS-in-JS</em>, respectively.
They counter the fundamental asymmetry between the <em>initial state</em> of the document (determined by HTML and CSS) and <em>all subsequent states</em> (the orbit of JS executions).</p>
<h3 level="3"><span id="tech1--react-function-components" class="anchor"></span><a href="#tech1--react-function-components"><a>React Function Components</a></a></h3>
<p>JavaScript can perform arbitrary computation, but its central purpose is DOM mutation.
However, directly applying JS leads to <a href="https://en.wikipedia.org/wiki/Spaghetti_code"><span id="tech1--link--spaghetti-code" class="anchor"></span>spaghetti code</a>.
To surmount this, developers invented the notion of <em>JavaScript component</em>, instantiated via XML tags.
If the JavaScript component is called <code>MyComponent</code>, the associated tag will be <code>&lt;MyComponent /&gt;</code> or perhaps <code>&lt;my-component /&gt;</code>.
Intuitively, HTML is extended with these custom tags which ultimately unwind into plain old HTML.</p>
<p>Competing notions of JavaScript component exist in the wild.
One popular approach is <em>React function components</em>.
They are just JavaScript functions with constraints on their parameters and return value.</p>
<ul>
<li>
<p>They have a single parameter conventionally called <em>props</em>.
It is a JavaScript <code>Object</code> defining the component's named inputs,
and possibly special properties like <em>children</em>, <em>key</em> and <em>ref</em>.</p>
</li>
<li>
<p>They must return either null or a virtual <a href="https://developer.mozilla.org/en-US/docs/Web/API/Node"><span id="tech1--link--dom-node" class="anchor"></span>DOM node</a>.
This returned value ultimately unwinds to an HTML fragment,
and may depend on the component's props and internal state (via <a href="https://reactjs.org/docs/hooks-intro.html"><span id="tech1--link--hooks" class="anchor"></span>hooks</a>).</p>
</li>
</ul>
<p>React developers use a grammatical extension of JavaScript called <strong>JSX</strong>.
We already mentioned the idea of extending HTML with custom XML tags.
JSX goes further by reinterpreting XML inside a grammatical extension of JavaScript.</p>
<aside><span class="anchor"></span>
<p>JSX freely combines JS with XML, so arbitrary JavaScript values can be passed to tag attributes, and XML can be passed around as a JavaScript value. Inductively closing these capabilities leads naturally to JSX, making this grammar particularly suitable for building dynamic DOM trees.</p>
</aside>
<p>Consider an example, a pan/zoomable grid (also <a href="https://codesandbox.io/s/rogue-markup-panzoom-yq060?file=/src/panzoom/PanZoom.jsx" title="@new-tab" target="_blank" rel="noopener" class="new-tab-link go25095430">on CodeSandbox</a>).</p>
<figure class="tabs scrollable go3990344948"><span id="tech1--tabs--panzoom" class="anchor"></span><div class="go78320706"><div class="go2093728181"><div class="top-right"><div title="anchor" class="go1827927822"></div><div title="maximise" class="go2297566067"></div><div title="enable" style="padding-top: 2px;" class="go3886657982"></div></div><div class="central">interact</div></div><div class="go4001245135"></div></div></figure>
<p>The file <em>panzoom/PanZoom.jsx</em> (see <a href="#command" title="open-tab panzoom panzoom/PanZoom.jsx">tab above</a>) defines two React function components.
One called <em>PanZoom</em>, another called <em>Grid</em>.
Behaviourally:</p>
<ul>
<li>
<p><em>PanZoom</em> renders an SVG containing <em>children</em> (an image provided in <em>PanZoomDemo</em>) and <code>&lt;Grid /&gt;</code>. Over time it adjusts the <a href="https://developer.mozilla.org/en-US/docs/Web/SVG/Attribute/viewBox"><span id="tech1--link--svg-viewbox" class="anchor"></span>SVG viewBox</a> in response to mouse/pointer events.</p>
</li>
<li>
<p><em>Grid</em> renders part of an SVG i.e. two grid patterns.
They repeat squares of size 10x10 and 60x60 in abstract <a href="https://www.w3.org/TR/SVG2/coords.html#TermUserUnits"><span id="tech1--link--svg-user-units" class="anchor"></span>SVG user units</a>.</p>
<aside><span id="tech1--aside--svg-user-units" class="anchor"></span>
<p>SVG user units become concrete via the <code>&lt;svg&gt;</code>'s viewBox attribute and its width/height in the DOM.
We'll follow a convention based on the work of Robert Pearce and Eric B. Smith:</p>
<blockquote>
<p>60 abstract user units (one large grid square) correspond to 1.5 meters.</p>
</blockquote>
<p>In fact, 1.5m comes from a Traveller convention concerning <a href="https://wiki.travellerrpg.com/Deck_Plan"><span id="tech1--link--deck-plans" class="anchor"></span>deck plans</a>.</p>
</aside>
</li>
</ul>
<p>The above JS functions both have a single parameter <code>props</code>.
Moreover, they both return something which looks like HTML but isn't.
Then what does the XML-like value returned by <code>PanZoom</code> actually mean?
What are React function components actually returning?</p>

<p>Here's a whirlwind overview.</p>
<ul>
<li>
<p>React devs use a grammatical extension of JavaScript called <a href="https://en.wikipedia.org/wiki/JSX_(JavaScript)" title="@new-tab" target="_blank" rel="noopener" class="new-tab-link go25095430">JSX</a>, permitting XML syntax.</p>
</li>
<li>
<p>React applications are built by composing together React function components. A typical React function component will return XML syntax referencing one or more other components.</p>
</li>
<li>
<p>Dev tools convert JSX into JS by replacing XML tags with invocations of <code>React.createElement</code> (see <a href="#command" title="open-tab jsx-to-js">example below</a>).</p>
</li>
<li>
<p><strong>This website actually uses <em>Preact</em></strong>, a React alternative with the same API.
Then <code>React.createElement</code> is <a href="https://github.com/preactjs/preact/blob/master/src/create-element.js" title="@new-tab" target="_blank" rel="noopener" class="new-tab-link go25095430">this function</a>,
and creates Preact virtual DOM nodes.</p>
</li>
<li>
<p>The root component of an application is usually called <em>App</em>.
Running a React application means invoking <code>ReactDOM.render</code>
with two arguments: <code>&lt;App/&gt;</code> and a DOM node <em>el</em>. See how we bootstrap examples on <a href="https://codesandbox.io/s/rogue-markup-panzoom-yq060?file=/src/index.js" title="@new-tab" target="_blank" rel="noopener" class="new-tab-link go25095430">CodeSandbox</a>.</p>
</li>
<li>
<p><a href="https://github.com/preactjs/preact/blob/master/src/render.js" title="@new-tab" target="_blank" rel="noopener" class="new-tab-link go25095430">ReactDOM.render</a> initially converts <code>&lt;App/&gt;</code> into a DOM node mounted at <em>el</em>.
Later a subcomponent may &quot;re-render&quot;, recursively recreating a virtual DOM node.
It is <a href="https://github.com/preactjs/preact/blob/master/src/diff/index.js" title="@new-tab" target="_blank" rel="noopener" class="new-tab-link go25095430">diffed</a>  and only the difference is applied to the DOM.</p>
</li>
</ul>
<figure class="tabs scrollable go3990344948"><span id="tech1--tabs--jsx-to-js" class="anchor"></span><div class="go256839001"><div class="go2093728181"><div class="top-right"><div title="anchor" class="go1827927822"></div><div title="maximise" class="go2297566067"></div><div title="enable" style="padding-top: 2px;" class="go3886657982"></div></div><div class="central">interact</div></div><div class="go4001245135"></div></div></figure>
<aside><span class="anchor"></span>
<p>Our whirlwind overview attempts to provide the gist.
Actually, React is notoriously hard to understand.
The internet is awash with poor explanations and cargo cult mentalities.
However, React is probably the most popular JavaScript component framework;
if you want to understand modern web development, it is arguably unavoidable.</p>
</aside>
<h3 level="3"><span id="tech1--react-renders" class="anchor"></span><a href="#tech1--react-renders"><a>React Renders</a></a></h3>

<p>When React renders a component, it invokes the respective function.
The return value of the function is a JavaScript representation of a DOM subtree.
This representation is usually referred to as &quot;Virtual DOM&quot;.
React compares this JavaScript value to the previous one, and patches the DOM accordingly.
If many components change in a small amount of time, <a href="https://github.com/preactjs/preact/blob/ebd87f3005d9558bfd3c5f38e0496a5d19553441/src/component.js#L221" title="@new-tab" target="_blank" rel="noopener" class="new-tab-link go25095430">some renders are automatically avoided</a> via the ancestral relationship.
Developers can also avoid recreating a particular virtual DOM subtree using <a href="https://github.com/preactjs/preact/blob/master/compat/src/memo.js" title="@new-tab" target="_blank" rel="noopener" class="new-tab-link go25095430"><code>React.memo</code></a>.
But for many websites, the virtual DOM manipulations are neither too large nor too frequent, and React developers may simply ignore their overhead.</p>
<p>However, we are making a realtime video game.
We want to control the rendering as much as possible, to ensure good performance and aid debugging.
If we allowed React (actually, Preact) to render in response to user interaction, we'd lose this control.
Take another look at <em>panzoom/PanZoom.jsx</em>.</p>
<figure class="tabs scrollable go3990344948"><span id="tech1--tabs--panzoom-again" class="anchor"></span><div class="go3883955307"><div class="go2093728181"><div class="top-right"><div title="anchor" class="go1827927822"></div><div title="maximise" class="go2297566067"></div><div title="enable" style="padding-top: 2px;" class="go3886657982"></div></div><div class="central">interact</div></div><div class="go4001245135"></div></div></figure>
<p><em>PanZoom</em> returns an <code>&lt;svg/&gt;</code> with a viewBox attribute determined by <code>state.viewBox</code>.
When a user zooms via mousewheel, the event handler <code>state.onWheel</code> updates <code>state.viewBox</code>.
But updating this variable does not automatically update the virtual DOM.
Usually one would <em>trigger a re-render</em>, so that <em>PanZoom</em> returns <code>&lt;svg/&gt;</code> with the updated viewBox, and the DOM-diffing algorithm does the update.
But how do we trigger a re-render?</p>
<h3 level="3"><span id="tech1--internal-state-via-" class="anchor"></span><a href="#tech1--internal-state-via-"><a>Internal state via <code>useState</code></a></a></h3>
<p>A React function component is rendered whenever an ancestor is (modulo <code>React.memo</code>), or if its internal state changes. Internal state is represented using the <a href="https://reactjs.org/docs/hooks-state.html"><span id="tech1--link--react.usestate-hook" class="anchor"></span>React.useState hook</a> e.g.</p>
<blockquote>
<p><code>const [value, setValue] = React.useState(() =&gt; initialValue);</code></p>
</blockquote>
<p>These declarations cannot be nested, must occur at the &quot;top-level&quot; of the React function component, and must always execute in the same order.
This induces a <a href="https://github.com/preactjs/preact/blob/98f130ee8695c2b4f7535205ddf02168192cdcac/hooks/src/index.js#L109" title="@new-tab" target="_blank" rel="noopener" class="new-tab-link go25095430">well-defined association</a> with their enclosing component.
To change state we execute <code>setValue(nextValue)</code> e.g. in response to a click. If <code>nextValue</code> differs from <code>value</code>, the function <code>setValue</code> causes the component to re-render where now <code>React.setState(...)[0]</code> has the new value.
This propagation of internal state is possible because a component's hooks must always execute in the same order.</p>
<h3 level="3"><span id="tech1--avoiding-react-renders" class="anchor"></span><a href="#tech1--avoiding-react-renders"><a>Avoiding React Renders</a></a></h3>
<p>In <em>panzoom/PanZoom.jsx</em>, the variable <code>state</code> is the value of an internal state variable i.e. deconstructed from a <code>React.useState</code> hook. Observe that we do not deconstruct the setter (<code>setValue</code> in the terminology of the previous section).
Why?
Because we decided to never inform React we've changed <code>state</code>, despite mutating it on mouse and pointer events.
Instead we directly mutate the DOM via:</p>
<blockquote>
<p><code>state.root.setAttribute( 'viewBox', `${state.viewBox}` );</code></p>
</blockquote>

<p>Then as far as React is concerned, nothing has changed.
Furthermore if React renders the component for another reason, it'll use the mutated <code>state</code> to set the viewBox attribute (producing no change).</p>
<blockquote>
<p>But why not just use a setter <code>setState</code>?</p>
</blockquote>
<p>Because otherwise we'd recompute <code>children</code> and <code>&lt;Grid /&gt;</code> whenever the player pans or zooms.
Our game may contain many elements, and we'd rather not needlessly recompute their virtual DOM tens of times per second.</p>


<h3 level="3"><span id="tech1--react-refresh" class="anchor"></span><a href="#tech1--react-refresh"><a>React Refresh</a></a></h3>
<p>Finally, we further justify our somewhat strange usage of <code>React.useState</code> i.e. <em>sans the setter</em>.
Since we only ever mutate the state, <code>React.useRef</code> may seem more suitable.
However, there's something special about <code>React.useState</code>.</p>
<p>Whilst working in a suitably tooled development environment, it is possible to textually edit React components <a href="https://www.npmjs.com/package/react-refresh"><span id="tech1--link--without-losing-the-internal-state-of-their-instances" class="anchor"></span>without losing the internal state of their instances</a> (the deconstructed values of <code>React.useState</code> hooks).
See this in action by editing one of our CodeSandboxes.
This important devtool is known as <a href="https://www.npmjs.com/package/react-refresh"><span id="tech1--link--react-refresh" class="anchor"></span>react-refresh</a> (see also <a href="https://github.com/preactjs/prefresh"><span id="tech1--link--preact/prefresh" class="anchor"></span>preact/prefresh</a>).
It will help us develop sophisticated Game AI.</p></article><hr class="go1763247448" /></li><li><article class="go129633710"><span id="tech2" class="anchor"></span><h2 level="2"><a href="#tech2"><a>Tech (ai)</a></a></h2><time dateTime="2021-07-19"><span><span>1</span><span>9</span><span>t</span><span>h</span></span><span><span>J</span><span>u</span><span>l</span><span>y</span></span><span><span>2</span><span>0</span><span>2</span><span>1</span></span></time><div title="tags" class="tags"><span>navigation</span><span>navgraph</span><span>navmesh</span><span>string pull</span><span>steering</span><span>detour</span><span>raycast</span></div>

<h3 level="3"><span id="tech2--overview" class="anchor"></span><a href="#tech2--overview"><a>Overview</a></a></h3>
<p><em>Rogue Markup</em> will present a birdseye viewpoint of the interior of starships.
The <a href="https://wiki.travellerrpg.com/Crew" title="@new-tab" target="_blank" rel="noopener" class="new-tab-link go25095430">crew</a> will have tasks, such as manning the bridge, patrolling the decks, monitoring <a href="https://wiki.travellerrpg.com/Low_Passage" title="@new-tab" target="_blank" rel="noopener" class="new-tab-link go25095430">low berths</a>.
These behaviours will be constrained by e.g. sleep patterns, the behaviour of others, and hardware failures.</p>
<p>But how do video games implement these behaviours?
Well, there are three standard systems:</p>
<ul>
<li><strong>Navigation</strong>: <em>planning e.g. route from A to B.</em></li>
<li><strong>Animation</strong>: <em>realism (e.g. limbs) and visual cues.</em></li>
<li><strong>Physics</strong>: <em>collision detection, force-driven rigid bodies, raycasting</em>.</li>
</ul>
<p>Navigation is of central importance to us, and will be discussed shortly.
As for animation, we won't obsess over realism,
but we'll need visual cues to indicate NPC actions.
We also want a <em>sense of flow</em>, achieved via interdependent concurrent animations.
As for a physics engine, we <a href="1#constraints--game-mechanics" title="@anchor" class="anchor-link go842686353"><span id="tech2--link--mentioned" class="anchor"></span>mentioned</a> we won't be using one. In fact:</p>
<ul>
<li>Collision detection will be handled at the level of navigation.</li>
<li>Force-based motion will be simulated via the Web Animations API.</li>
</ul>
<p>In the rest of this article we'll discuss Navigation and Raycasting in detail.</p>
<h3 level="3"><span id="tech2--static-navigation" class="anchor"></span><a href="#tech2--static-navigation"><a>Static Navigation</a></a></h3>
<p>To move an NPC from <strong>A</strong> to <strong>B</strong>, we need a respective path.
This might simply be a straight line e.g. when an item is directly within grasp.
However, usually there are objects to be avoided: static ones like walls, dynamic ones like NPCs.</p>
<p>Sans dynamic objects, a canonical approach exists.</p>
<ul>
<li>The navigable area is represented by <em>polygons</em> (<a href="https://datatracker.ietf.org/doc/html/rfc7946#section-3.1.6"><span id="tech2--link--possibly-with-holes" class="anchor"></span>possibly with holes</a>),
with <strong>A</strong> and <strong>B</strong> inside them.</li>
<li>These polygons can be <em>triangulated</em> i.e. partitioned into triangles with disjoint interiors.
Thin or large triangles can be avoided via <em><a href="https://en.wikipedia.org/wiki/Steiner_point_(computational_geometry)"><span id="tech2--link--steiner-points" class="anchor"></span>Steiner points</a></em>.</li>
<li>The triangulation induces an undirected graph.
<blockquote>
<p>A <strong>Navgraph</strong> is an undirected graph whose
nodes are <em>the triangles of the provided triangulation</em>.
Two nodes are connected if and only if <em>their respective triangles share exactly one edge.</em></p>
</blockquote>
</li>
</ul>
<p>For example, the triangles below collectively induce the red navgraph below.</p>
<figure class="tabs scrollable go3990344948"><span id="tech2--tabs--nav-graph-demo" class="anchor"></span><div class="go78320706"><div class="go2093728181"><div class="top-right"><div title="anchor" class="go1827927822"></div><div title="maximise" class="go2297566067"></div><div title="enable" style="padding-top: 2px;" class="go3886657982"></div></div><div class="central">interact</div></div><div class="go4001245135"></div></div></figure>
<p><strong>TODO</strong> Mention triangle-wasm CodeSandbox</p>
<p>Technically, an undirected graph is just a <em>symmetric binary relation</em>.
We have made it concrete by depicting each node as the centroid of its respective triangle.
This is a standard convention, although triangles have more than one <a href="https://en.wikipedia.org/wiki/Triangle_center"><span id="tech2--link--notion-of-center" class="anchor"></span>notion of center</a>.
It provides a weight for each edge i.e. the distance between the centroids.
Then the length of a path through the undirected graph may be defined as the sum of its edge's weights.</p>
<aside><span id="tech2--aside--why-we-abstract" class="anchor"></span>
<p>Searching for paths through the embedded undirected graph is much easier than searching the navigable polygons.
There are far fewer possibilities.
However, NPCs won't actually follow these embedded paths (for realism),
but an induced path instead (see below).</p>
</aside>
<aside><span class="anchor"></span>
<p>The length of each path in the undirected graph should approximate the respective <em>real</em> shortest path length.
Zig-zags between centroids can make a relatively short path <em>long</em>. This is often mitigated by pre-processing the navigable polygons, ensuring small triangles.</p>
</aside>
<p>So, how to find a path from A to B?</p>
<blockquote>
<p>Given A and B we have two triangles (maybe equal), so two nodes, hence may apply <a href="https://en.wikipedia.org/wiki/A*_search_algorithm"><span id="tech2--link--a*" class="anchor"></span>A*</a> using our chosen edge weights (distance between centroids).</p>
<p>This quickly provides a solution i.e. a path.
However it is insufficient because realistic NPCs would not follow centroid to centroid paths.
One can solve this by applying the <a href="http://digestingduck.blogspot.com/2010/03/simple-stupid-funnel-algorithm.html"><span id="tech2--link--string-pulling-algorithm" class="anchor"></span>string-pulling algorithm</a>.
It pulls the zig-zag path tight along the navigable polygons' extremal points.</p>
</blockquote>
<p>Drag the nodes below to see <em>string-pulling</em> in action.</p>
<figure class="tabs scrollable go3990344948"><span id="tech2--tabs--nav-string-pull-demo" class="anchor"></span><div class="go78320706"><div class="go2093728181"><div class="top-right"><div title="anchor" class="go1827927822"></div><div title="maximise" class="go2297566067"></div><div title="enable" style="padding-top: 2px;" class="go3886657982"></div></div><div class="central">interact</div></div><div class="go4001245135"></div></div></figure>

<h3 level="3"><span id="tech2--dynamic-navigation" class="anchor"></span><a href="#tech2--dynamic-navigation"><a>Dynamic Navigation</a></a></h3>

<p>Navigation around dynamic objects is harder.
What was once a collision-free path may no longer be.
Two officers on the bridge could be swapping shifts,
or perhaps the player needs to rush through a moving crowd.</p>
<p>One common approach is to combine static navigation (previous section) with <a href="https://www.researchgate.net/publication/2495826_Steering_Behaviors_For_Autonomous_Characters"><span id="tech2--link--steering-behaviours" class="anchor"></span>steering behaviours</a>.
They are usually implemented via a physics engine.
An NPC will be driven by its own force, plus other forces induced by the position and velocity of nearby NPCs.</p>
<aside><span class="anchor"></span>
<p>For example, <strong>obstacle avoidance</strong> works by driving close characters apart.
A suitable force is applied orthogonal to the NPC's direction of travel.</p>
</aside>
<p>However, one cannot expect the vector sum of forces to capture complex interactions between multiple characters.
Reynolds introduced Steering Behaviours as part of a pipeline:</p>
<blockquote>
<p><em>action selection</em> → <em>steering</em> → <em>animation</em>.</p>
</blockquote>
<p>In practice, one must rely <em>heavily</em> on action selection to avoid unrealistic behaviour such as oscillation and deadlock.</p>
<p>There is another well-known approach i.e. <a href="https://github.com/recastnavigation/recastnavigation#detour"><span id="tech2--link--detour" class="anchor"></span>Detour</a> and in particular <em>DetourCrowd</em>, providing a sophisticated solution to multiple character navigation.
It has been <a href="https://github.com/BabylonJS/Extensions/tree/master/recastjs"><span id="tech2--link--ported-to-js" class="anchor"></span>ported to JS</a> in BabylonJS,
and also <a href="https://docs.unrealengine.com/4.27/en-US/API/Runtime/Navmesh/DetourCrowd/dtCrowd/"><span id="tech2--link--integrated" class="anchor"></span>integrated</a> into the Unreal Engine.</p>
<p>In Detour, a collection of NPCs is conceptualised as a <em>Crowd</em>.
One requests the Crowd to move individual NPCs to particular targets.
An updater function must be executed each frame.
For each fixed NPC, its nearby neighbours are modelled as temporary geometry, influencing the NPC's velocity.
We'll have more to say about this impressive open source library.</p>
<h3 level="3"><span id="tech2--navigation:-our-approach" class="anchor"></span><a href="#tech2--navigation:-our-approach"><a>Navigation: Our Approach</a></a></h3>
<p>So how will we approach this difficult problem?
Well, we won't solve it generally.
That is,</p>
<blockquote>
<p><em>we don't seek a black box, magically producing collision-free concurrent navigation</em>.</p>
</blockquote>
<p>We're happy to take things slow.
Let's start with two colliding NPCs.
We'll detect their imminent collision, and then stop them both.</p>
<figure class="tabs scrollable go3990344948"><span id="tech2--tabs--nav-collide-demo" class="anchor"></span><div class="go78320706"><div class="go2093728181"><div class="top-right"><div title="anchor" class="go1827927822"></div><div title="maximise" class="go2297566067"></div><div title="enable" style="padding-top: 2px;" class="go3886657982"></div></div><div class="central">interact</div></div><div class="go4001245135"></div></div></figure>
<p><strong>TODO</strong></p>
<ul>
<li>DraggablePath component ✅</li>
<li>Circle moves along navpath ✅</li>
<li>Componentise and improve</li>
<li>Detect future collision for 2 paths</li>
<li>Combine with terminal?</li>
</ul>
<h3 level="3"><span id="tech2--raycasting" class="anchor"></span><a href="#tech2--raycasting"><a>Raycasting</a></a></h3>
<p><strong>TODO</strong></p>
<ul>
<li>illustrate line-seg vs line-seg intersection with initial space partitioning</li>
<li>navigation through auto-opening doors</li>
<li>combine with terminal?</li>
</ul>
<figure class="tabs scrollable go3990344948"><span id="tech2--tabs--nav-doors-demo" class="anchor"></span><div class="go78320706"><div class="go2093728181"><div class="top-right"><div title="anchor" class="go1827927822"></div><div title="maximise" class="go2297566067"></div><div title="enable" style="padding-top: 2px;" class="go3886657982"></div></div><div class="central">interact</div></div><div class="go4001245135"></div></div></figure></article><hr class="go1763247448" /></li><li><article class="go129633710"><span id="tech3" class="anchor"></span><h2 level="2"><a href="#tech3"><a>Tech (dev)</a></a></h2><time dateTime="2021-07-19"><span><span>1</span><span>9</span><span>t</span><span>h</span></span><span><span>J</span><span>u</span><span>l</span><span>y</span></span><span><span>2</span><span>0</span><span>2</span><span>1</span></span></time><div title="tags" class="tags"></div>
<h3 level="3"><span id="tech3--static-analysis" class="anchor"></span><a href="#tech3--static-analysis"><a>Static Analysis</a></a></h3>
<ul>
<li>Typescript via JSDoc, referring to CodeSandbox.</li>
</ul>
<h3 level="3"><span id="tech3--runtime-analysis" class="anchor"></span><a href="#tech3--runtime-analysis"><a>Runtime Analysis</a></a></h3>
<ul>
<li>Terminal + Game AI</li>
</ul>
<h3 level="3"><span id="tech3--comments" class="anchor"></span><a href="#tech3--comments"><a>Comments</a></a></h3>
<ul>
<li>Display GitHub comments from Issue (build-time)</li>
<li>Can use anonymous credits to get recent</li>
</ul>
<br />
<br />
</article><hr class="go1763247448" /></li></ol><div class="go3263955189"><a href="/part/3#geomorphs" title="Continue to next article"><span id="next-article--geomorphs" class="anchor"></span>Next</a></div></main></section></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/part/2","query":{},"buildId":"FO4G1hO8uLwlVtAZhv72V","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>