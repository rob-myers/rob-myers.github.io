<!DOCTYPE html><html lang="en"><head><meta name="description" content="A Game AI focused roguelike, built blog by blog." /><link rel="icon" href="/favicon.ico" /><style id="_goober"> .go1654252976{padding:0;color:#aaa;}.go1654252976 h3{padding:20px 12px;font-family:'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;font-size:1.8rem;font-weight:300;margin:0;border:0 solid #aaa;border-width:0 0 2px;}.go1654252976 h3 a{color:#ddd;}.go1654252976 ul{font-size:1.1rem;padding:6px 0;margin:0;border:0 solid #aaa;border-width:0 0 2px;}.go1654252976 ul li{list-style:none;list-style-position:inside;display:flex;}.go1654252976 ul li.current a{color:white;}.go1654252976 ul a{padding:10px 12px;width:100%;color:#888;}.go1654252976 ul a:hover{color:#ccc;}.go3816569223{position:fixed;z-index:11;height:calc(100% + 200px);width:256px;font-weight:300;font-family:sans-serif;background-color:#222;color:white;cursor:pointer;opacity:0.975;-webkit-tap-highlight-color:transparent;left:0;transition:transform 500ms ease;}.go3816569223.open{transform:translateX(0px);}.go3816569223.closed{transform:translateX(-256px);}.go3816569223 > .article-overlay{position:absolute;top:0;left:256px;width:100vw;height:0;background:rgba(0, 0, 0, .1);}@media(max-width: 1280px){.go3816569223.open > .article-overlay{height:100%;background:rgba(0, 0, 0, .25);}}.go3816569223 > .handle{position:absolute;top:-1px;right:-40px;width:40px;height:41px;display:flex;justify-content:center;align-items:center;user-select:none;}.go3816569223 > .handle .icon{display:flex;justify-content:center;align-items:center;background:#900;color:#fff;width:inherit;height:inherit;padding:0 0 2px 0;}.go3089436763{position:fixed;cursor:pointer;z-index:7;left:0;width:calc(100vw + 256px);height:40px;background:black;}.go4227718824{min-width:256px;transition:min-width 500ms ease;}.go4227718824.closed{min-width:0;}@media(max-width: 1280px){.go4227718824{display:none;}}.go3231828434{margin:24px;color:red;font-size:1.2rem;font-family:monospace;}.go741482717{position:absolute;z-index:10;right:140px;top:-48px;font-size:1rem;}@media(max-width: 1024px){.go741482717{top:-32px;}}@media(max-width: 600px){.go741482717{top:0;}}.go741482717 > ul{position:fixed;width:140px;height:40px;display:flex;justify-content:center;align-items:center;padding:0;margin:0;}.go741482717 > ul li{list-style:none;list-style-position:inside;padding:0 5px;}.go741482717 > ul a{color:#ccc;}.go741482717 > ul a.primary{color:#fff;}.go712665785{position:absolute;right:140px;z-index:3;top:-8px;}@media(max-width: 1024px){.go712665785{top:8px;}}@media(max-width: 600px){.go712665785{top:40px;}}.go712665785 .fixed{position:fixed;border-radius:0 0 64px 64px;width:140px;text-align:center;font-size:15px;letter-spacing:1px;padding:6px 0 14px;background:#444;}.go712665785 .fixed a{color:#fff;}.go4260321069{font-family:'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;position:relative;padding-top:40px;}@media(max-width: 600px){.go4260321069{background:#eee;padding-bottom:8px;padding-left:8px;border-bottom:1px solid #aaa;padding-top:64px;}}.go4260321069 h1{margin:0;font-size:5rem;font-weight:300;cursor:pointer;color:#333;display:inline-block;}@media(max-width: 800px){.go4260321069 h1{font-size:5rem;}}@media(max-width: 600px){.go4260321069 h1{font-size:3rem;}}.go4260321069 p{color:#444;letter-spacing:2px;font-size:1.4rem;margin:0;padding:40px 0 48px;font-weight:300;}@media(max-width: 600px){.go4260321069 p{font-size:1.1rem;padding:20px 0 20px 4px;color:#222;}}.go4140030{max-width:1024px;width:100%;padding:48px 64px;}@media(max-width: 1024px){.go4140030{padding:32px 64px;margin:0;}}@media(max-width: 600px){.go4140030{padding:0;}}.go1763247448{margin:0;border-color:var(--focus-bg);}@media(min-width: 800px){.go1763247448{padding-bottom:80px;border:0;}}.go713503133{font-family:Roboto, Arial, sans-serif;}.go713503133 > .top-right{position:absolute;right:-10px;top:-39px;z-index:2;border-radius:4px 4px 0 0;padding:2px 16px;cursor:pointer;background:#444;font-size:1rem;font-weight:300;color:#999;}.go713503133 > .top-right.enabled{color:#ddd;}.go713503133 > .top-right > span:not(:last-child){margin-right:8px;}.go713503133 > .central{position:absolute;z-index:5;left:calc(50% - (128px / 2));top:calc(50% - 20px);cursor:pointer;color:#ddd;background:#000;padding:12px 32px;border-radius:4px;border:1px solid #ddd;font-size:1.2rem;opacity:1;transition:300ms opacity ease;}.go713503133 > .central.enabled{opacity:0;}.go475180145{position:absolute;z-index:0;width:inherit;height:inherit;background:#000;font-family:sans-serif;opacity:1;transition:opacity 1s ease-in;}.go475180145:not(.faded){pointer-events:none;}.go475180145.clear{opacity:0;transition:opacity 0.5s ease-in;}.go475180145.faded{opacity:0.5;transition:opacity 0.5s ease-in;}.go3273224629{background:var(--focus-bg);}@keyframes fadein{from{opacity:0;}to{opacity:1;}}.go3273224629 .flexlayout__tabset{animation:fadein 1s;}.go3273224629 .flexlayout__tabset,.go3273224629  .flexlayout__tab{background:white;}.go3273224629 .flexlayout__layout{background:#444;}.go3273224629 .flexlayout__tab{border-top:6px solid #444;position:relative;overflow:hidden;}.go3273224629 .flexlayout__tab > div.portal{width:100%;height:100%;}.go3273224629 .flexlayout__tabset_tabbar_outer{background:#222;border-bottom:1px solid #555;}.go3273224629 .flexlayout__tab_button--selected,.go3273224629  .flexlayout__tab_button:hover{background:#444;}.go3273224629 .flexlayout__tab_button_content{user-select:none;font-size:13px;color:#aaa;}.go3273224629 .flexlayout__tab_button--selected .flexlayout__tab_button_content{color:#fff;}.go3273224629 .flexlayout__tab_button:hover:not(.flexlayout__tab_button--selected) .flexlayout__tab_button_content{color:#ddd;}.go3273224629 .flexlayout__splitter_vert,.go3273224629  .flexlayout__splitter_horz{background:#827575;}.go960957165{line-height:2.2;background:var(--focus-bg);border:var(--blog-border-width) solid var(--border-bg);font-size:1rem;overflow-wrap:break-word;position:relative;padding:64px 164px 96px 164px;}@media(max-width: 800px){.go960957165{padding:32px 64px 48px 64px;}}@media(max-width: 600px){.go960957165{padding:8px 12px;font-size:1.1rem;border:none;line-height:1.7;}}.go960957165 a{position:relative;}.go960957165 a code{color:unset;}.go960957165 a > span.anchor{position:absolute;top:-96px;}.go960957165 aside{margin:24px 0;padding:20px 36px;font-size:0.96rem;border-radius:12px;background:#fff;border:1px solid #aaa;position:relative;}.go960957165 aside p{margin:12px 0;}@media(max-width: 600px){.go960957165 aside{margin:16px 0;padding:16px;border-radius:8px;}.go960957165 aside p{margin:8px 0;}}.go960957165 aside blockquote{margin:0;border-left:10px solid #ccc;}@media(min-width: 600px){.go960957165 aside figure.tabs{margin:40px 0;}}.go960957165 aside:hover, .go960957165 aside:active{background-color:#eee;}.go960957165 aside .anchor{position:absolute;top:-48px;}.go960957165 blockquote{margin:32px 0;border-left:10px solid #ddd;padding-left:30px;}@media(max-width: 600px){.go960957165 blockquote{margin:20px 0;padding-left:20px;}}.go960957165 code{font-family:'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;letter-spacing:2px;color:#444;padding:0 2px;}.go960957165 figure{margin:0;}.go960957165 figure.tabs{border:10px solid #444;margin:64px 0;position:relative;}@media(max-width: 600px){.go960957165 figure.tabs{margin:40px 0 32px 0;}}.go960957165 figure.tabs > span.anchor{position:absolute;top:-96px;}.go960957165 h1,.go960957165  h2,.go960957165  h3,.go960957165  h4{font-family:'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;font-weight:400;letter-spacing:2px;}.go960957165 h1 a,.go960957165  h2 a,.go960957165  h3 a,.go960957165  h4 a{color:#444;}.go960957165 h2{font-size:2.6rem;}@media(max-width: 600px){.go960957165 h2{margin:16px 0 24px;font-size:1.9rem;}}.go960957165 h2 + div.subtitle{margin-top:-16px;padding:4px 8px;display:flex;flex-wrap:wrap;font-size:0.75rem;}.go960957165 h2 + div.subtitle time{color:#533;}.go960957165 h2 + div.subtitle ul.tags{font-family:monospace;display:inline-block;padding:0;color:#777;}@media(max-width: 600px){.go960957165 h2 + div.subtitle{background:none;padding:0 0 8px;margin-top:-16px;}.go960957165 h2 + div.subtitle ul.tags{font-size:0.8rem;}}.go960957165 h2 + div.subtitle ul.tags li{display:inline;margin:0;}.go960957165 h2 + div.subtitle ul.tags li:not(:last-child):after{content:" | ";}.go960957165 h3{font-size:1.6rem;position:relative;}@media(max-width: 600px){.go960957165 h3{font-size:1.3em;}}@media(max-width: 800px){.go960957165 h3{font-size:1.4em;}}.go960957165 h3 > span.anchor{position:absolute;top:-48px;}.go960957165 h2 + p,.go960957165  h3 + p{margin-top:0px;}.go960957165 li blockquote{margin:0;}.go960957165 li blockquote p{margin:16px 0;}.go960957165 p{margin:40px 0;}@media(max-width: 600px){.go960957165 p{margin:16px 0;}}.go960957165 p code{font-size:1rem;}.go960957165 span.cmd{color:#555;background:#eee;font-family:monospace;letter-spacing:1px;font-size:smaller;padding:2px 4px;}@media(max-width: 600px){.go960957165 span.cmd{user-select:all;}}.go960957165 > span.anchor{position:absolute;top:-48px;}.go960957165 table{padding:8px;border:1px solid #bbb;width:100%;margin:40px 0;}@media(max-width: 600px){.go960957165 table{margin:20px 0;}}.go960957165 table th,.go960957165 table  td{padding:6px;text-align:left;vertical-align:top;}@media(max-width: 600px){.go960957165 table th,.go960957165 table  td{padding:4px 2px;}}@media(max-width: 600px){.go960957165 ul,.go960957165  ol{padding-left:20px;}}.go960957165 ul + p,.go960957165  ol + p{padding-top:6px;}.go960957165 ul li,.go960957165  ol li{margin:4px 0;}.go2193861445{padding:0;margin:0;list-style:none;}.go3263955189{height:64px;font-size:1.1rem;margin-top:-64px;display:flex;justify-content:center;align-items:center;}@media(max-width: 800px){.go3263955189{margin-top:0;font-size:1rem;}}.go3263955189 a{color:#555;border:1px solid #666;background:#fff;padding:8px 16px;border-radius:4px;}.go842686353::after{display:inline-block;content:'';background-image:url('/icon/anchor-icon.svg');background-size:13px 13px;height:13px;width:13px;margin:0 2px 0 4px;}.go25095430::after{display:inline-block;content:'';background-image:url('/icon/ext-link-icon.svg');background-size:13px 13px;height:13px;width:13px;margin:0 2px 0 4px;}.go3574057674{width:100%;height:400px;position:relative;}.go2648511114::after{display:inline-block;content:'';background-image:url('/icon/anchor-icon-white.svg');background-size:12px 12px;height:12px;width:12px;margin:auto;}.go2697092909{width:100%;height:340px;position:relative;}.go4220627111{width:100%;height:360px;position:relative;}.go3944991801{width:100%;height:300px;position:relative;}</style><meta name="next-font-preconnect" /><meta name="viewport" content="width=device-width" /><meta charSet="utf-8" /><title>Rogue Markup</title><meta name="next-head-count" content="3" /><link rel="preload" href="/_next/static/css/26d3e41a738398fa2e64.css" as="style" /><link rel="stylesheet" href="/_next/static/css/26d3e41a738398fa2e64.css" data-n-g /><noscript data-n-css></noscript><script defer noModule src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-c97cf907d4ac25e7ffe3.js" defer></script><script src="/_next/static/chunks/framework-571220e3661128bb4007.js" defer></script><script src="/_next/static/chunks/main-aba050664ec743567e3e.js" defer></script><script src="/_next/static/chunks/pages/_app-1d58e46013d8ce12869f.js" defer></script><script src="/_next/static/chunks/commons-e384418dbc8675b008bb.js" defer></script><script src="/_next/static/chunks/45-aa2b20ad0d204f91161f.js" defer></script><script src="/_next/static/chunks/106-1f0d30f212b23637a4fb.js" defer></script><script src="/_next/static/chunks/994-940f9d9225290c2c4d12.js" defer></script><script src="/_next/static/chunks/pages/part/2-cd3558e2dc537e85ca34.js" defer></script><script src="/_next/static/MQCBnS8LQftWt2z_NaPxQ/_buildManifest.js" defer></script><script src="/_next/static/MQCBnS8LQftWt2z_NaPxQ/_ssgManifest.js" defer></script></head><body><div id="__next"><nav class="go3816569223 closed"><div class="article-overlay"></div><div class="handle"><div class="icon">&gt;</div></div><section class="go1654252976"><h3><a href="/">Rogue Markup</a></h3><ul><li><a href="/part/1#objective" title="Our overall objective">1a objective</a></li><li><a href="/part/1#constraints" title="Constraints: tech, game mechanics, setting">1b constraints</a></li><li><a href="/part/1#finishing" title="Finishing as a skill">1c finishing</a></li></ul><ul><li><a href="/part/2#technology" title="The tech we'll use">2a technology</a></li><li><a href="/part/2#tech1" title="JavaScript components">2b tech: js</a></li><li><a href="/part/2#tech2" title="Tech related to gameplay">2c tech: ai</a></li><li><a href="/part/2#tech3" title="Dev env and in-browser terminal">2d tech: dev</a></li></ul><ul><li><a href="/part/3#geomorphs" title="How we use Starship Geomorphs">3a geomorphs</a></li></ul></section></nav><div class="go3089436763"></div><div class="go4227718824 closed"></div><section class="go4140030"><header class="title go4260321069"><div class="go712665785"><div class="fixed"><a href>continue</a></div></div><h1 level="1">Rogue Markup</h1>
<p>$( game ai | roguelike | web dev )</p></header><main><ol class="go2193861445"><li><article class="go960957165"><span id="technology" class="anchor"></span><h2 level="2"><a href="#technology"><a>Technology</a></a></h2><div class="subtitle"><ul class="tags"><li><time dateTime="2021-07-19">19th July 2021</time></li><li>lego bricks</li><li>specific tech</li></ul></div>
<p>So, we're going to build a roguelike directly on this website.
We sketched the <a href="1#constraints--technology" title="@anchor" class="anchor-link go842686353"><span id="technology--link--technological-constraints-earlier" class="anchor"></span>technological constraints earlier</a> and now provide more detail.</p>

























































<table><thead><tr><th>Concept</th><th>Technology</th></tr></thead><tbody><tr><td>Component</td><td><a href="https://reactjs.org/docs/components-and-props.html#function-and-class-components"><span id="technology--link--react-function-components" class="anchor"></span>React function components</a>.</td></tr><tr><td>Styles</td><td>CSS-in-JS via <a href="https://www.npmjs.com/package/goober"><span id="technology--link--goober" class="anchor"></span>Goober</a>.</td></tr><tr><td>Component framework</td><td><a href="https://preactjs.com/"><span id="technology--link--preact" class="anchor"></span>Preact</a>, a DOM-diffing alternative to React.</td></tr><tr><td>Pathfinding</td><td>Based on <a href="https://www.npmjs.com/package/three-pathfinding"><span id="technology--link--three-pathfinding" class="anchor"></span>three-pathfinding</a>.</td></tr><tr><td>Raycasting</td><td>Basic geometry and spacial partitioning.</td></tr><tr><td>Static analysis</td><td>TypeScript via <a href="https://www.typescriptlang.org/docs/handbook/jsdoc-supported-types.html"><span id="technology--link--jsdoc" class="anchor"></span>JSDoc</a>; also <a href="https://www.npmjs.com/package/eslint"><span id="technology--link--eslint" class="anchor"></span>ESLint</a>.</td></tr><tr><td>Live analysis</td><td>In-browser terminal, via <a href="https://www.npmjs.com/package/xterm"><span id="technology--link--xterm.js" class="anchor"></span>xterm.js</a> and <a href="https://www.npmjs.com/package/mvdan-sh"><span id="technology--link--mvdan-sh" class="anchor"></span>mvdan-sh</a>.</td></tr><tr><td>Scripting</td><td><a href="https://www.npmjs.com/package/ts-node"><span id="technology--link--ts-node" class="anchor"></span>TS Node</a> i.e. Node.js with types.</td></tr><tr><td>Code viewing</td><td><a href="https://codemirror.net/"><span id="technology--link--codemirror" class="anchor"></span>CodeMirror</a> to view JS.</td></tr><tr><td>Code editing</td><td>External <a href="https://codesandbox.io/"><span id="technology--link--codesandbox" class="anchor"></span>CodeSandbox</a> links, using React.</td></tr><tr><td>Code sharing</td><td>Show <a href="https://github.com/"><span id="technology--link--github" class="anchor"></span>GitHub</a> comments, provide GitHub <a href="https://github.com/rob-myers/rob-myers.github.io"><span id="technology--link--repo" class="anchor"></span>repo</a>.</td></tr><tr><td>Asset editor</td><td><a href="https://boxy-svg.com/"><span id="technology--link--boxy-svg" class="anchor"></span>Boxy SVG</a>.</td></tr></tbody></table>
<p>We'll explain the above over the next few articles.</p></article><hr class="go1763247448" /></li><li><article class="go960957165"><span id="tech1" class="anchor"></span><h2 level="2"><a href="#tech1"><a>Tech (js)</a></a></h2><div class="subtitle"><ul class="tags"><li><time dateTime="2021-07-19">19th July 2021</time></li><li>javascript</li><li>react</li><li>preact</li><li>jsx</li><li>performance</li><li>hot reload</li></ul></div>
<p>The early 90s brought three pillars: HTML, CSS, JavaScript (JS).
Whenever we visit a website we receive an HTML response, referencing or embedding CSS and JS.
Our web browser renders the HTML and CSS immediately, and runs the JS to provide interactivity.</p>
<aside><span class="anchor"></span>
<p>More precisely, all subsequent <a href="https://en.wikipedia.org/wiki/Document_Object_Model#JavaScript"><span id="tech1--link--dom" class="anchor"></span>DOM</a> mutations are performed by JavaScript.
The DOM is the programmatic interface to the current <em>document</em> viewed in the browser.
It amounts to parsed HTML decorated with matching CSS and bound JS, together with APIs for reading and modifying it.</p>
</aside>
<p>Although HTML, CSS and JS are separate standards,
it is now common to generate HTML using JS (Node.js Server-Side Rendering),
and also CSS using JS (CSS-in-JS).
In particular, JavaScript has become the central web technology.</p>
<h3 level="3"><span id="tech1--react-function-components" class="anchor"></span><a href="#tech1--react-function-components"><a>React Function Components</a></a></h3>
<p>Although JS can perform arbitrary computations, its central purpose is to mutate the DOM.
Such JavaScript is often broken down into named <em>components</em>, instantiated via XML tags.
Competing notions of JavaScript component exist in the wild, a popular approach being <em>React function components</em>.
They are just JavaScript functions with constraints on their parameters and return value.</p>
<ul>
<li>
<p>They have a single parameter, usually called <em>props</em>.
It is a JavaScript object defining the component's named inputs,
and possibly special properties like <em>children</em>, <em>key</em> and <em>ref</em>.</p>
</li>
<li>
<p>They must return either null or a virtual <a href="https://developer.mozilla.org/en-US/docs/Web/API/Node"><span id="tech1--link--dom-node" class="anchor"></span>DOM node</a>.
This returned value ultimately amounts to an HTML fragment to be rendered,
and may depend on the component's props and internal state (via <a href="https://reactjs.org/docs/hooks-intro.html"><span id="tech1--link--hooks" class="anchor"></span>hooks</a>).</p>
</li>
</ul>
<p>React developers use a grammatical extension of JavaScript called JSX.
It freely combines JS with XML, so JavaScript values can be passed to arbitrary attributes, and XML can be passed around as a JavaScript value. Inductively closing these capabilities leads naturally to JSX, making this grammar particularly suitable for building dynamic DOM trees.</p>
<p>Consider an example, a pannable/zoomable grid (also <a href="https://codesandbox.io/s/rogue-markup-panzoom-yq060?file=/src/panzoom/PanZoom.jsx" title="@new-tab" target="_blank" rel="noopener" class="new-tab-link go25095430">on CodeSandbox</a>).</p>
<figure class="tabs scrollable go3273224629"><span id="tech1--tabs--panzoom" class="anchor"></span><div class="go3574057674"><div class="go713503133"><div class="top-right"><span class="go2648511114"></span><span>disable</span></div><div class="central">interact</div></div><div class="go475180145"></div></div></figure>
<p>The file <em>panzoom/PanZoom.jsx</em> (see <a href="#command" title="open-tab panzoom panzoom/PanZoom.jsx">tab above</a>) defines two React function components, <em>PanZoom</em> and <em>Grid</em>.
Behaviourally:</p>
<ul>
<li>
<p><em>PanZoom</em> renders an SVG consisting of its children (the Geomorph image provided in <em>PanZoomDemo</em>) and <em>Grid</em>. It adjusts the <a href="https://developer.mozilla.org/en-US/docs/Web/SVG/Attribute/viewBox"><span id="tech1--link--svg-viewbox" class="anchor"></span>SVG viewBox</a> in response to mouse/pointer events.</p>
</li>
<li>
<p><em>Grid</em> renders part of an SVG i.e. two grid patterns.
They repeat squares of size 10x10 and 60x60 in abstract <a href="https://www.w3.org/TR/SVG2/coords.html#TermUserUnits"><span id="tech1--link--svg-user-units" class="anchor"></span>SVG user units</a>.</p>
<aside><span id="tech1--aside--svg-user-units" class="anchor"></span>
<p>SVG user units become concrete via the <code>&lt;svg&gt;</code>'s viewBox attribute and its width/height in the DOM.
We'll follow a convention based on the work of Robert Pearce and Eric B. Smith:</p>
<blockquote>
<p>60 abstract user units (one large grid square) correspond to 1.5 meters.</p>
</blockquote>
<p>In fact, 1.5m comes from a Traveller convention concerning <a href="https://wiki.travellerrpg.com/Deck_Plan"><span id="tech1--link--deck-plans" class="anchor"></span>deck plans</a>.</p>
</aside>
</li>
</ul>
<p>The above two JS functions each have a single parameter <code>props</code>, and return something which looks like HTML (but isn't).
For example, <em>PanZoom</em> renders <em>Grid</em> by using the XML tag <code>&lt;Grid/&gt;</code>.
Then although React function components are functions, syntactically they are not invoked like functions (we don't write <code>Grid(props)</code>).
Then what does this XML syntax mean?
What are React function components actually returning?</p>
<p>Here's a whirlwind overview.</p>
<ul>
<li>
<p>React devs use a grammatical extension of JavaScript called <a href="https://en.wikipedia.org/wiki/JSX_(JavaScript)" title="@new-tab" target="_blank" rel="noopener" class="new-tab-link go25095430">JSX</a>, which permits XML syntax.</p>
</li>
<li>
<p>React applications are built by composing together React function components. A typical React function component will return XML syntax referencing one or more other components.</p>
</li>
<li>
<p>Dev tools convert JSX into JS by replacing XML tags with invocations of <code>React.createElement</code> (see <a href="#command" title="open-tab jsx-to-js">example below</a>).</p>
</li>
<li>
<p>This website actually uses <em>Preact</em>, a React alternative with the same API.
Then <code>React.createElement</code> is <a href="https://github.com/preactjs/preact/blob/master/src/create-element.js" title="@new-tab" target="_blank" rel="noopener" class="new-tab-link go25095430">this function</a>,
and creates Preact virtual DOM nodes.</p>
</li>
<li>
<p>The root component is usually called <em>App</em>.
Running a React application means invoking <code>ReactDOM.render</code>
with 2 arguments: <code>&lt;App/&gt;</code> and a DOM node <em>el</em>. See how we bootstrap examples on <a href="https://codesandbox.io/s/rogue-markup-panzoom-yq060?file=/src/index.js" title="@new-tab" target="_blank" rel="noopener" class="new-tab-link go25095430">CodeSandbox</a>.</p>
</li>
<li>
<p><a href="https://github.com/preactjs/preact/blob/master/src/render.js" title="@new-tab" target="_blank" rel="noopener" class="new-tab-link go25095430">ReactDOM.render</a> initially converts <code>&lt;App/&gt;</code> into a DOM node mounted at <em>el</em>.
A subcomponent may re-render, recursively recreating a virtual DOM node.
It is <a href="https://github.com/preactjs/preact/blob/master/src/diff/index.js" title="@new-tab" target="_blank" rel="noopener" class="new-tab-link go25095430">diffed</a>  and only the difference is applied to the DOM.</p>
</li>
</ul>
<figure class="tabs scrollable go3273224629"><span id="tech1--tabs--jsx-to-js" class="anchor"></span><div class="go2697092909"><div class="go713503133"><div class="top-right"><span class="go2648511114"></span><span>disable</span></div><div class="central">interact</div></div><div class="go475180145"></div></div></figure>
<h3 level="3"><span id="tech1--react-renders" class="anchor"></span><a href="#tech1--react-renders"><a>React Renders</a></a></h3>

<p>When React renders a component, it computes a rooted subtree of the virtual DOM,
compares the previous one, and patches the DOM.
If many components change in a small amount of time, <a href="https://github.com/preactjs/preact/blob/ebd87f3005d9558bfd3c5f38e0496a5d19553441/src/component.js#L221" title="@new-tab" target="_blank" rel="noopener" class="new-tab-link go25095430">some renders are automatically avoided</a> via the ancestral relationship.
Developers can also avoid recreating an entire rooted subtree using <a href="https://github.com/preactjs/preact/blob/master/compat/src/memo.js" title="@new-tab" target="_blank" rel="noopener" class="new-tab-link go25095430"><code>React.memo</code></a>.
But for many websites, the virtual DOM manipulations are neither too large nor too frequent, and React developers may simply ignore their overhead.</p>
<p>However, we are making a realtime video game.
We want to control the rendering as much as possible, to ensure good performance and aid debugging e.g. when many objects are onscreen.
If we allowed React (actually, Preact) to render in response to user interaction, we'd lose this control.
Take another look at <em>panzoom/PanZoom.jsx</em>.</p>
<figure class="tabs scrollable go3273224629"><span id="tech1--tabs--panzoom-again" class="anchor"></span><div class="go4220627111"><div class="go713503133"><div class="top-right"><span class="go2648511114"></span><span>disable</span></div><div class="central">interact</div></div><div class="go475180145"></div></div></figure>
<p><em>PanZoom</em> returns an <code>&lt;svg/&gt;</code> with a viewBox attribute determined by <code>state.viewBox</code>.
When a user zooms via mousewheel, the event handler <code>state.onWheel</code> updates <code>state.viewBox</code>.
But updating this variable does not automatically update the virtual DOM.
Usually one would <em>trigger a re-render</em>, so that <em>PanZoom</em> returns <code>&lt;svg/&gt;</code> with the updated viewBox, and the DOM-diffing algorithm does the update.
But how do we trigger a re-render?</p>
<h3 level="3"><span id="tech1--internal-state-via-" class="anchor"></span><a href="#tech1--internal-state-via-"><a>Internal state via <code>useState</code></a></a></h3>
<p>A React function component is rendered whenever an ancestor is (modulo React.memo), or if its internal state changes. Internal state is represented using the <a href="https://reactjs.org/docs/hooks-state.html"><span id="tech1--link--react.usestate-hook" class="anchor"></span>React.useState hook</a> e.g.</p>
<blockquote>
<p><code>const [value, setValue] = React.useState(() =&gt; initialValue);</code></p>
</blockquote>
<p>These declarations cannot be nested, must occur at the &quot;top-level&quot; of the React function component, and must always execute in the same order.
This induces a <a href="https://github.com/preactjs/preact/blob/98f130ee8695c2b4f7535205ddf02168192cdcac/hooks/src/index.js#L109" title="@new-tab" target="_blank" rel="noopener" class="new-tab-link go25095430">well-defined association</a> with their enclosing component.
To change state we execute <code>setValue(nextValue)</code> e.g. in response to a click. If <code>nextValue</code> differs from <code>value</code>, the function <code>setValue</code> causes the component to re-render where now <code>React.setState(...)[0]</code> has the new value.
This propagation of internal state is possible because a component's hooks must always execute in the same order.</p>
<h3 level="3"><span id="tech1--avoiding-react-renders" class="anchor"></span><a href="#tech1--avoiding-react-renders"><a>Avoiding React Renders</a></a></h3>
<p>In <em>panzoom/PanZoom.jsx</em>, the variable <code>state</code> is the value of an internal state variable i.e. deconstructed from a <code>React.useState</code> hook. Observe that we do not deconstruct the setter (<code>setValue</code> in the terminology of the previous section).
Why?
Because we decided to never inform React we've changed <code>state</code>, despite mutating it on mouse and pointer events.
Instead we directly mutate the DOM via:</p>
<blockquote>
<p><code>state.root.setAttribute( 'viewBox', `${state.viewBox}` );</code></p>
</blockquote>

<p>Then as far as React is concerned, nothing has changed.
Furthermore if React renders the component for another reason, it'll use the mutated <code>state</code> to set the viewBox attribute (producing no change).</p>
<blockquote>
<p>But why not just use a setter <code>setState</code>?</p>
</blockquote>
<p>Because we avoid needlessly recomputing <code>&lt;Grid /&gt;</code> and <code>children</code> whenever the player pans or zooms.
Our game may contain many elements, and we'd rather not needlessly recompute their virtual DOM tens of times per second.</p>


<h3 level="3"><span id="tech1--react-refresh" class="anchor"></span><a href="#tech1--react-refresh"><a>React Refresh</a></a></h3>
<p>We finish by further justifying our (somewhat odd) usage of <code>React.useState</code> i.e. sans the state setter.</p>
<p>So far, we've justified things by claiming direct DOM mutation provides performance benefits.
But there's also a reason specific to <code>React.useState</code>.
Whilst working in a development environment, it is possible to textually edit React components <a href="https://www.npmjs.com/package/react-refresh"><span id="tech1--link--without-losing-their-instances-internal-state" class="anchor"></span>without losing their instances internal state</a>.
See this in action by editing one of our CodeSandboxes.
We'll use this important devtool to develop sophisticated Game AI.</p></article><hr class="go1763247448" /></li><li><article class="go960957165"><span id="tech2" class="anchor"></span><h2 level="2"><a href="#tech2"><a>Tech (ai)</a></a></h2><div class="subtitle"><ul class="tags"><li><time dateTime="2021-07-19">19th July 2021</time></li><li>navigation</li><li>navgraph</li><li>navmesh</li><li>string pull</li><li>steering</li><li>detour</li><li>raycast</li></ul></div>
<p>We've described our objective, constrained our approach and listed the technologies we'll use.
We now turn from <a href="2#tech1--react-function-components" title="@anchor" class="anchor-link go842686353"><span id="tech2--link--js-components" class="anchor"></span>JS components</a> to Game AI.</p>
<h3 level="3"><span id="tech2--overview" class="anchor"></span><a href="#tech2--overview"><a>Overview</a></a></h3>
<p><em>Rogue Markup</em> will present a birdseye viewpoint of the interior of starships.
The <a href="https://wiki.travellerrpg.com/Crew" title="@new-tab" target="_blank" rel="noopener" class="new-tab-link go25095430">crew</a> will have tasks, such as manning the bridge, patrolling the decks, monitoring <a href="https://wiki.travellerrpg.com/Low_Passage" title="@new-tab" target="_blank" rel="noopener" class="new-tab-link go25095430">low berths</a>.
These behaviours will be constrained by e.g. sleep patterns, the behaviour of others, and hardware failures.</p>
<p>But how do video games implement these behaviours?
Well, there are three standard systems:</p>
<ul>
<li><strong>Navigation</strong>: <em>planning e.g. route from A to B.</em></li>
<li><strong>Animation</strong>: <em>realism (e.g. limbs) and visual cues.</em></li>
<li><strong>Physics</strong>: collision detection, force-driven rigid bodies, raycasting.</li>
</ul>
<p>Navigation is of central importance to us and will be discussed shortly.
As for animation, we're definitely not going to obsess over realism.
Nevertheless we'll need visual cues to indicate NPC actions,
and a <em>sense of flow</em> via interdependent concurrent animations.
As for a physics engine, we <a href="1#constraints--game-mechanics" title="@anchor" class="anchor-link go842686353"><span id="tech2--link--mentioned" class="anchor"></span>mentioned</a> we won't be using one. In fact:</p>
<ul>
<li>Collision detection will be handled at the level of navigation.</li>
<li>Force-based motion will be handled by the Web Animations API.</li>
</ul>
<p>The rest of this article provides detail concerning Navigation and Raycasting.</p>
<h3 level="3"><span id="tech2--static-navigation" class="anchor"></span><a href="#tech2--static-navigation"><a>Static Navigation</a></a></h3>
<p>To move an NPC from A to B, we need a respective path.
This might be a straight line e.g. when an item is directly within grasp.
But usually objects must be avoided: static ones like walls, dynamic ones like other NPCs.</p>
<p>If there are no dynamic objects, a canonical approach exists.
The navigable area is represented by polygons (possibly with holes), where A and B lie in their interior. These polygons can be triangulated (admittedly non-canonically), inducing an undirected graph:</p>
<blockquote>
<p>its nodes are <em>the triangles of the triangulation</em>; two nodes are connected iff <em>their respective triangles share an edge.</em></p>
</blockquote>
<p>The triangles below collectively induce the red undirected graph.</p>
<p><strong>TODO</strong> higher quality navmesh via Recast</p>
<figure class="tabs scrollable go3273224629"><span id="tech2--tabs--nav-graph-demo" class="anchor"></span><div class="go3944991801"><div class="go713503133"><div class="top-right"><span class="go2648511114"></span><span>disable</span></div><div class="central">interact</div></div><div class="go475180145"></div></div></figure>
<p>Technically, an undirected graph is just a symmetric binary relation.
We have made it concrete by depicting each node as the centroid of its respective triangle.
This provides a weight for each edge i.e. the distance between the centroids.
Then the length of a path through the undirected graph may be defined as the sum of its edge's weights.</p>
<aside><span id="tech2--aside--why-we-abstract" class="anchor"></span>
<p>Searching for paths through the embedded undirected graph is much easier than searching the navigable polygons.
However NPCs won't actually follow these embedded paths (for realism),
but an induced path instead (see below).</p>
</aside>
<aside><span class="anchor"></span>
<p>The length of each path in the undirected graph should approximate the respective <em>real</em> shortest path length.
Zig-zags between centroids can make a relatively short path <em>long</em>. This is often mitigated by pre-processing the navigable polygons, ensuring small triangles.</p>
</aside>
<p>So, how to find a path from A to B?</p>
<blockquote>
<p>Given A and B we have two triangles (maybe equal), so two nodes, hence may apply <a href="https://en.wikipedia.org/wiki/A*_search_algorithm"><span id="tech2--link--a*" class="anchor"></span>A*</a> using our chosen edge weights (distance between centroids).</p>
<p>This quickly provides a solution i.e. a path.
However it is insufficient because realistic NPCs would not follow centroid to centroid paths.
One can solve this by applying the <a href="http://digestingduck.blogspot.com/2010/03/simple-stupid-funnel-algorithm.html"><span id="tech2--link--string-pulling-algorithm" class="anchor"></span>string-pulling algorithm</a>.
It pulls the zig-zag path tight along the navigable polygons' extremal points.</p>
</blockquote>
<p>Drag the nodes below to see <em>string-pulling</em> in action.</p>
<figure class="tabs scrollable go3273224629"><span id="tech2--tabs--nav-string-pull-demo" class="anchor"></span><div class="go3574057674"><div class="go713503133"><div class="top-right"><span class="go2648511114"></span><span>disable</span></div><div class="central">interact</div></div><div class="go475180145"></div></div></figure>

<h3 level="3"><span id="tech2--dynamic-navigation" class="anchor"></span><a href="#tech2--dynamic-navigation"><a>Dynamic Navigation</a></a></h3>

<p>Navigation around dynamic objects is harder.
What was once a collision-free path may no longer be.
Two officers on the bridge could be swapping shifts,
or perhaps the player needs to rush through a moving crowd.</p>
<p>One common approach is to combine static navigation (previous section) with <a href="https://www.researchgate.net/publication/2495826_Steering_Behaviors_For_Autonomous_Characters"><span id="tech2--link--steering-behaviours" class="anchor"></span>steering behaviours</a>.
They are usually implemented via a physics engine.
An NPC will be driven by its own force, plus other forces induced by the position and velocity of nearby NPCs.</p>
<aside><span class="anchor"></span>
<p>For example, <strong>obstacle avoidance</strong> works by driving close characters apart.
A suitable force is applied orthogonal to the NPC's direction of travel.</p>
</aside>
<p>However, one cannot expect the vector sum of forces to capture complex interactions between multiple characters.
Reynolds introduced Steering Behaviours as part of a pipeline:</p>
<blockquote>
<p><em>action selection</em> → <em>steering</em> → <em>animation</em>.</p>
</blockquote>
<p>In practice, one must rely <em>heavily</em> on action selection to avoid unrealistic behaviour such as oscillation and deadlock.</p>
<p>There is another well-known approach i.e. <a href="https://github.com/recastnavigation/recastnavigation#detour"><span id="tech2--link--detour" class="anchor"></span>Detour</a> and in particular <em>DetourCrowd</em>, providing a sophisticated solution to multiple character navigation.
It has been <a href="https://github.com/BabylonJS/Extensions/tree/master/recastjs"><span id="tech2--link--ported-to-js" class="anchor"></span>ported to JS</a> in BabylonJS,
and also <a href="https://docs.unrealengine.com/4.27/en-US/API/Runtime/Navmesh/DetourCrowd/dtCrowd/"><span id="tech2--link--integrated" class="anchor"></span>integrated</a> into the Unreal Engine.</p>
<p>In Detour, a collection of NPCs is conceptualised as a <em>Crowd</em>.
One requests the Crowd to move individual NPCs to particular targets.
An updater function must be executed each frame.
For each fixed NPC, its nearby neighbours are modelled as temporary geometry, influencing the NPC's velocity.
We'll have more to say about this impressive open source library.</p>
<h3 level="3"><span id="tech2--dynamic-navigation:-our-approach" class="anchor"></span><a href="#tech2--dynamic-navigation:-our-approach"><a>Dynamic Navigation: Our Approach</a></a></h3>
<p>So how will we approach this difficult problem?
Well, we won't solve it generally.
That is,</p>
<blockquote>
<p><em>we don't seek a black box, magically producing collision-free concurrent navigation</em>.</p>
</blockquote>
<p>We're happy to take things slow.
Let's start with two colliding NPCs.
We'll detect their imminent collision, and then stop them both.</p>
<figure class="tabs scrollable go3273224629"><span id="tech2--tabs--nav-collide-demo" class="anchor"></span><div class="go3574057674"><div class="go713503133"><div class="top-right"><span class="go2648511114"></span><span>disable</span></div><div class="central">interact</div></div><div class="go475180145"></div></div></figure>
<p><strong>TODO</strong></p>
<ul>
<li>DraggablePath component ✅</li>
<li>Circle moves along navpath ✅</li>
<li>Componentise and improve</li>
<li>Detect future collision for 2 paths</li>
<li>Combine with terminal?</li>
</ul>
<h3 level="3"><span id="tech2--raycasting" class="anchor"></span><a href="#tech2--raycasting"><a>Raycasting</a></a></h3>
<p><strong>TODO</strong></p>
<ul>
<li>illustrate line-seg vs line-seg intersection with initial space partitioning</li>
<li>navigation through auto-opening doors</li>
<li>combine with terminal?</li>
</ul>
<figure class="tabs scrollable go3273224629"><span id="tech2--tabs--nav-doors-demo" class="anchor"></span><div class="go3574057674"><div class="go713503133"><div class="top-right"><span class="go2648511114"></span><span>disable</span></div><div class="central">interact</div></div><div class="go475180145"></div></div></figure></article><hr class="go1763247448" /></li><li><article class="go960957165"><span id="tech3" class="anchor"></span><h2 level="2"><a href="#tech3"><a>Tech (dev)</a></a></h2><div class="subtitle"><ul class="tags"><li><time dateTime="2021-07-19">19th July 2021</time></li></ul></div>
<h3 level="3"><span id="tech3--static-analysis" class="anchor"></span><a href="#tech3--static-analysis"><a>Static Analysis</a></a></h3>
<ul>
<li>Typescript via JSDoc, referring to CodeSandbox.</li>
</ul>
<h3 level="3"><span id="tech3--runtime-analysis" class="anchor"></span><a href="#tech3--runtime-analysis"><a>Runtime Analysis</a></a></h3>
<ul>
<li>Terminal + Game AI</li>
</ul>
<h3 level="3"><span id="tech3--comments" class="anchor"></span><a href="#tech3--comments"><a>Comments</a></a></h3>
<ul>
<li>Display GitHub comments from Issue (build-time)</li>
<li>Can use anonymous credits to get recent</li>
</ul>
<br />
<br />
</article><hr class="go1763247448" /></li></ol><div class="go3263955189"><a href="/part/3#geomorphs" title="Continue to next article">Next</a></div></main></section></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/part/2","query":{},"buildId":"MQCBnS8LQftWt2z_NaPxQ","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>