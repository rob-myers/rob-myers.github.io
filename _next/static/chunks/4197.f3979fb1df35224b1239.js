"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4197],{4197:function(n,t,r){r.r(t),r.d(t,{default:function(){return V}});var e=r(79056),o=r(52209),a=r(59748),i=r(88269),c=r(95090),u=r(36694),s=r(91441),l=r(48103),d=r(84175),f=r(27375),p=r(35650),m=r(97131),g=r(68216),y=r(25997),h=r(14695),v=r(91077),b=r(30268),I=r(92953),x=r(92809);function k(n){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(n){return!1}}();return function(){var r,e=(0,I.Z)(n);if(t){var o=(0,I.Z)(this).constructor;r=Reflect.construct(e,arguments,o)}else r=e.apply(this,arguments);return(0,b.Z)(this,r)}}var Z=function(n){(0,v.Z)(r,n);var t=k(r);function r(n){var e;return(0,g.Z)(this,r),e=t.call(this),(0,x.Z)((0,h.Z)(e),"gms",void 0),e.gms=n,e}return(0,y.Z)(r,[{key:"getAdjacentPair",value:function(n,t){var r=this.gms[n],o=this.getNodeById(w(r.key,r.transform)),a=this.getNodeById(R(r.key,r.transform,t));if(!a)return console.warn("GmGraph: failed to find hull door node: ".concat(R(r.key,r.transform,t))),null;var i=this.getSuccs(a).filter((function(n){return n!==o})),c=(0,e.Z)(i,1)[0];if(!c)return console.info("GmGraph: hull door on boundary",a),null;var u=c.gmIndex,s=c.hullDoorId;return{adjGmId:u,holeId:this.gms[u].hullDoors[s].holeIds.find((function(n){return"number"===typeof n})),adjHullId:c.hullDoorId}}}],[{key:"fromGmItems",value:function(n){var t=new r(n),o=[].concat((0,m.Z)(n.map((function(n,t){return{type:"gm",gmKey:n.key,gmIndex:t,id:w(n.key,n.transform),transform:n.transform}}))),(0,m.Z)(n.flatMap((function(n,t){var r=n.key,e=n.hullDoors,o=n.transform,a=n.pngRect;return e.map((function(n,e){var i=n.poly.center.addScaledVector(n.normal,20),c=a.contains(i);return{type:"door",gmKey:r,gmIndex:t,id:R(r,o,e),hullDoorId:e,transform:o,gmInFront:c}}))}))));t.registerNodes(o);var a=n.flatMap((function(n){var t=n.key,r=n.hullDoors,e=n.transform,o=w(t,e);return r.map((function(n,r){return{src:o,dst:R(t,e,r)}}))})),i=n.flatMap((function(t,r){var o=n.filter((function(n,e){return e>r&&n.gridRect.intersects(t.gridRect)})),a=new l.UL,i=new l.UL,c=new l._3,u=new l._3;return t.hullDoors.flatMap((function(n,r){var s=R(t.key,t.transform,r);c.setMatrixValue(t.transform),a.copy(n.rect).applyMatrix(c);var l=o.flatMap((function(n){return n.hullDoors.map((function(t){return[n,t]}))})).find((function(n){var t=(0,e.Z)(n,2),r=t[0].transform,o=t[1].rect;return a.intersects(i.copy(o).applyMatrix(u.setMatrixValue(r)))}));if(void 0!==l){var d=(0,e.Z)(l,2),f=d[0],p=d[1],m=f.hullDoors.indexOf(p);return{src:s,dst:R(f.key,f.transform,m)}}return[]}))}));return[].concat((0,m.Z)(a),(0,m.Z)(i)).forEach((function(n){var r=n.src,e=n.dst;r&&e&&(t.connect({src:r,dst:e}),t.connect({src:e,dst:r}))})),t}}]),r}(r(82405).b);function w(n,t){return"gm-".concat(n,"-[").concat(t,"]")}function R(n,t,r){return"door-".concat(n,"-[").concat(t,"]-").concat(r)}var A=r(60168),G=r(95814);var D,H,N=r(87079),O=r(30245),P=r(94184),K=r.n(P),S=r(77277),j=r(8311);function M(n,t){var r="undefined"!==typeof Symbol&&n[Symbol.iterator]||n["@@iterator"];if(!r){if(Array.isArray(n)||(r=function(n,t){if(!n)return;if("string"===typeof n)return E(n,t);var r=Object.prototype.toString.call(n).slice(8,-1);"Object"===r&&n.constructor&&(r=n.constructor.name);if("Map"===r||"Set"===r)return Array.from(n);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return E(n,t)}(n))||t&&n&&"number"===typeof n.length){r&&(n=r);var e=0,o=function(){};return{s:o,n:function(){return e>=n.length?{done:!0}:{done:!1,value:n[e++]}},e:function(n){throw n},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,c=!1;return{s:function(){r=r.call(n)},n:function(){var n=r.next();return i=n.done,n},e:function(n){c=!0,a=n},f:function(){try{i||null==r.return||r.return()}finally{if(c)throw a}}}}function E(n,t){(null==t||t>n.length)&&(t=n.length);for(var r=0,e=new Array(t);r<t;r++)e[r]=n[r];return e}function L(n){var t=(0,f.Z)(),r=(0,p.Z)((function(){var e={apis:[],root:{},npcRef:function(n){if(n){var t=r.apis.find((function(t){return n.classList.contains(t.key)}));t?(t.el={root:n},n.style.left="".concat(t.def.position.x,"px"),n.style.top="".concat(t.def.position.y,"px")):console.error("".concat(L.name,": npc not found for div.").concat(Array.from(n.classList.values()).join(".")))}},rootRef:function(n){n&&(r.root=n)},spawn:function(e){if((0,S.l)(n.stageKey)){console.log("spawning...",e),r.apis=r.apis.filter((function(n){return!e.some((function(t){return n.key===t.key}))}));var o,a=M(e);try{for(a.s();!(o=a.n()).done;){var i=o.value;r.apis.push({key:i.key,def:i,animState:"idle",el:{}})}}catch(c){a.e(c)}finally{a.f()}}else console.error("".concat(L.name,': cannot spawn into non-existent stage "').concat(n.stageKey,'"'));t()}};return n.onLoad(e),e}));return(0,j.tZ)("div",{className:B,ref:r.rootRef,children:(0,j.tZ)("div",{className:K()("npcs",{disabled:n.disabled}),onPointerDown:function(n){var e=n.target;(0,d.Nh)(r.apis.find((function(n){return e.classList.contains(n.key)}))).animState="walk",t()},onPointerUp:function(n){var e=n.target;(0,d.Nh)(r.apis.find((function(n){return e.classList.contains(n.key)}))).animState="idle",t()},children:r.apis.map((function(n){return(0,j.tZ)("div",{className:K()("npc",n.key,n.animState,U),ref:r.npcRef,children:(0,j.tZ)("div",{className:K()("body","no-select",n.key)})},n.key)}))})})}var C,B=(0,i.iv)(D||(D=(0,o.Z)(["\n  position: absolute;\n  canvas {\n    position: absolute;\n    pointer-events: none;\n  }\n  .npc {\n    position: absolute;\n  }\n"]))),_=new l.dl(51,26).scale(2),q=new l.dl(49,37).scale(2),U=(0,i.iv)(H||(H=(0,o.Z)(["\n  .body {\n    cursor: pointer;\n    position: absolute;\n    transform: scale(0.18);\n    pointer-events: all;\n    filter: grayscale(100%);\n  }\n  \n  &.walk .body {\n    width: ","px;\n    height: ","px;\n    left: ","px;\n    top: ","px;\n    animation: walk 300ms steps(",") infinite;\n    background: url('/npc/first-npc--walk.png');\n  }\n  &.idle .body {\n    width: ","px;\n    height: ","px;\n    left: ","px;\n    top: ","px;\n    animation: idle 2s steps(",") infinite;\n    background: url('/npc/first-npc--idle.png');\n  }\n\n  &.disabled .body {\n    animation-play-state: paused;\n  }\n\n  @keyframes walk {\n    from { background-position: 0px; }\n    to { background-position: ","px; }\n  }\n  @keyframes idle {\n    from { background-position: 0px; }\n    to { background-position: ","px; }\n  }\n"])),q.x,q.y,-q.x/2,-q.y/2,3,_.x,_.y,-_.x/2,-_.y/2,1,-3*q.x,-1*_.x);function V(n){var t=(0,f.Z)(),r=function(n){var t=a.default.useState((function(){return n.map((function(n){return n.layoutKey}))})),r=(0,e.Z)(t,2),o=r[0],i=r[1];a.default.useEffect((function(){var t=n.map((function(n){return n.layoutKey})).filter((function(n){return!o.includes(n)}));t.length&&i([].concat((0,m.Z)(o),(0,m.Z)(t)))}),[o]);var c=o.map((function(n){return(0,G.Z)(n,{staleTime:1/0})})),u=n.every((function(n){return o.includes(n.layoutKey)}))&&c.every((function(n){return n.data}));return a.default.useMemo((function(){if(u){var t=n.map((function(n){var t=o.findIndex((function(t){return t===n.layoutKey})),r=(0,d.Nh)(c[t].data),e=n.transform||[1,0,0,1,0,0];return(0,A.mI)(r,e)}));return{gms:t,gmGraph:Z.fromGmItems(t)}}return{gms:[],gmGraph:new Z([])}}),[u])}([{layoutKey:"g-301--bridge"},{layoutKey:"g-101--multipurpose",transform:[1,0,0,1,0,600]},{layoutKey:"g-302--xboat-repair-bay",transform:[1,0,0,1,-1200,600]},{layoutKey:"g-302--xboat-repair-bay",transform:[-1,0,0,1,2400,600]},{layoutKey:"g-301--bridge",transform:[1,0,0,-1,0,2400]}]),o=r.gms,i=r.gmGraph,g=(0,p.Z)((function(){return{currentGmId:0,currentHoleId:2,clipPath:o.map((function(n){return"none"})),doorsApi:{ready:!1},npcsApi:{},wire:new c.x,getEnterableHoleIds:function(){var n=g.currentGmId,t=o[n].roomGraph,r=g.doorsApi.getOpen(n),e=t.nodesArray[g.currentHoleId];return t.getEnterableRooms(e,r).map((function(n){return n.holeIndex}))},onChangeDeps:function(){if(o.length){g.update();var n=g.wire.pipe((0,u.h)((function(n){return"closed-door"===n.key||"opened-door"===n.key}))).subscribe((function(n){g.update()}));return function(){return n.unsubscribe()}}},update:function(){g.updateClipPath(),g.updateObservableDoors(),t()},updateClipPath:function(){var n=o[g.currentGmId],t=n.hullOutline,r=n.holesWithDoors,e=n.pngRect,a=[g.currentHoleId].concat(g.getEnterableHoleIds()).map((function(n){return r[n]})),i=l.LA.cutOut(a,[t]).map((function(n){return n.translate(-e.x,-e.y)})).map((function(n){return"".concat(n.svgPath)})).join(" ");g.clipPath=g.clipPath.map((function(n){return"none"})),g.clipPath[g.currentGmId]="path('".concat(i,"')")},updateObservableDoors:function(){var n=this,t=g.currentGmId,r=o[t],e=r.roomGraph,a=(r.doors,r.hullDoors,e.nodesArray[g.currentHoleId]),c=e.getAdjacentDoors(a).map((function(n){return n.doorIndex}));o.forEach((function(r,e){return n.doorsApi.setObservableDoors(e,t===e?c:[])})),e.getAdjacentHullDoorIds(r,a).map((function(n){return(0,d.Cq)(i.getAdjacentPair(t,n),!1)})).filter(Boolean).forEach((function(t){var r=t.adjGmId,e=t.adjHullId;n.doorsApi.setObservableDoors(r,[e])}))}}}),[o],{equality:{currentGmId:!0,currentHoleId:!0}});return o.length?(0,j.BX)(N.Z,{stageKey:"stage-nav-demo-1",dark:!0,className:X,zoom:.4,children:[o.map((function(n){return(0,j.tZ)("img",{className:"geomorph",src:(0,s.qX)(n.key),draggable:!1,width:n.pngRect.width,height:n.pngRect.height,style:{left:n.pngRect.x,top:n.pngRect.y,transform:n.transformStyle,transformOrigin:n.transformOrigin}})})),(0,j.tZ)(L,{onLoad:function(n){g.npcsApi=n,t()},disabled:n.disabled,stageKey:"stage-nav-demo-1"}),o.map((function(n,t){return(0,j.tZ)("img",{className:"geomorph-dark",src:(0,s.qX)(n.key),draggable:!1,width:n.pngRect.width,height:n.pngRect.height,style:{clipPath:g.clipPath[t],WebkitClipPath:g.clipPath[t],left:n.pngRect.x,top:n.pngRect.y,transform:n.transformStyle,transformOrigin:n.transformOrigin}},t)})),g.doorsApi.ready&&(0,j.tZ)(T,{gms:o,gmGraph:i,doorsApi:g.doorsApi,currentGmId:g.currentGmId,currentHoleId:g.currentHoleId,setHole:function(n,t){var r=[n,t];g.currentGmId=r[0],g.currentHoleId=r[1],g.update()}}),(0,j.tZ)(O.Z,{gms:o,wire:g.wire,onLoad:function(n){return g.doorsApi=n}})]}):null}var X=(0,i.iv)(C||(C=(0,o.Z)(["\n  img {\n    position: absolute;\n    transform-origin: top left;\n  }\n  img.geomorph {\n    filter: brightness(80%);\n  }\n  img.geomorph-dark {\n    filter: invert(100%) brightness(55%) contrast(200%) sepia(0%);\n  }\n"])));function T(n){return(0,j.BX)("div",{onClick:function(t){var r=t.target,o=Number(r.getAttribute("data-gm-index")),a=Number(r.getAttribute("data-door-index")),i=n.gms[o],c=i.doors[a],u=c.holeIds.filter((function(t){return t!==n.currentHoleId})),s=(0,e.Z)(u,1)[0];if(null!==s)return n.setHole(n.currentGmId,s);var l=i.hullDoors.indexOf(c),d=n.gmGraph.getAdjacentPair(o,l);return d?n.setHole(d.adjGmId,d.holeId):console.info("hull door is isolated",o,l)},children:[n.outlines&&n.gms.map((function(n,t){return(0,j.tZ)("div",{style:{position:"absolute",left:n.gridRect.x,top:n.gridRect.y,width:n.gridRect.width,height:n.gridRect.height,border:"2px red solid"}},t)})),n.gms.map((function(t,r){var e=n.doorsApi.getObservable(r);return(0,j.tZ)("div",{className:"debug",style:{transform:t.transformStyle,transformOrigin:"".concat(t.pngRect.x,"px ").concat(t.pngRect.y,"px"),position:"absolute"},children:t.doors.map((function(t,o){var a=t.poly,i=t.normal,c=t.holeIds;if(e.includes(o)){var u=c[0]===n.currentHoleId?1:c[1]===n.currentHoleId?-1:0,s=l.dl.from(i).scale(-u||0).angle,d=a.center.addScaledVector(i,15*u);return(0,j.tZ)("div",{"data-gm-index":r,"data-door-index":o,style:{width:2*W,height:2*W,borderRadius:W,position:"absolute",left:d.x-W,top:d.y-W,transform:"rotate(".concat(s,"rad)"),backgroundImage:"url('/icon/solid_arrow-circle-right.svg')",cursor:"pointer"}},o)}return null}))},t.itemKey)}))]})}var W=4}}]);