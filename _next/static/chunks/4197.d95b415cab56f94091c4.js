"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4197],{4197:function(n,t,r){r.r(t),r.d(t,{default:function(){return _}});var e=r(52209),o=r(59748),a=r(88269),i=r(95090),c=r(36694),u=r(91441),s=r(48103),l=r(27375),f=r(35650),d=r(97131),p=r(79056),m=r(84175),g=r(68216),y=r(25997),h=r(91077),v=r(30268),b=r(92953);function x(n){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(n){return!1}}();return function(){var r,e=(0,b.Z)(n);if(t){var o=(0,b.Z)(this).constructor;r=Reflect.construct(e,arguments,o)}else r=e.apply(this,arguments);return(0,v.Z)(this,r)}}var k=function(n){(0,h.Z)(r,n);var t=x(r);function r(){return(0,g.Z)(this,r),t.apply(this,arguments)}return(0,y.Z)(r,null,[{key:"fromGmItems",value:function(n){var t=new r,e=[].concat((0,d.Z)(n.map((function(n){return{type:"gm",gmKey:n.gm.key,id:"gm-".concat(n.gm.key,"-[").concat(n.transform,"]"),transform:n.transform}}))),(0,d.Z)(n.flatMap((function(n){var t=n.gm,r=n.transform;return t.d.hullDoors.map((function(n,e){var o=n.poly.center.addScaledVector(n.normal,20),a=t.d.pngRect.contains(o)?1:-1;return{type:"door",gmKey:t.key,id:"door-".concat(t.key,"-[").concat(r,"]-").concat(e),hullDoorIndex:e,transform:r,gmSign:a}}))}))));t.registerNodes(e);var o=n.flatMap((function(n){var t=n.gm,r=n.transform,e="gm-".concat(t.key,"-[").concat(r,"]");return t.d.hullDoors.map((function(n,o){return{src:e,dst:"door-".concat(t.key,"-[").concat(r,"]-").concat(o)}}))})),a=n.flatMap((function(t,r){var e=n.filter((function(n,e){return e>r&&n.gridRect.intersects(t.gridRect)}));console.info("geomorph to geomorph:",t,"--\x3e",e);var o=new s.UL;return t.gm.d.hullDoors.flatMap((function(n,r){var a="door-".concat(t.gm.key,"-[").concat(t.transform,"]-").concat(r),i=new s._3(t.transform),c=s.UL.fromJson(n.rect).applyMatrix(i),u=e.flatMap((function(n){return n.gm.d.hullDoors.map((function(t){return[n,t]}))})).find((function(n){var t=(0,p.Z)(n,2),r=(t[0],t[1].rect);return c.intersects(o.setFromJson(r).applyMatrix(i))}));if(void 0!==u){var l=(0,p.Z)(u,2),f=l[0],d=l[1],m=f.gm.d.hullDoors.indexOf(d);return console.info("hull door to hull door:",t,r,"==>",f,f.gm.d.hullDoors.indexOf(d)),{src:a,dst:"door-".concat(f.gm.key,"-[").concat(f.transform,"]-").concat(m)}}return[]}))}));return[].concat((0,d.Z)(o),(0,d.Z)(a)).forEach((function(n){var r=n.src,e=n.dst;r&&e&&(t.connect({src:r,dst:e}),t.connect({src:e,dst:r}))})),t}}]),r}(r(82405).b),w=r(49082),Z=r(95814);var R,I,A=r(87079),D=r(30245),O=r(94184),P=r.n(O),S=r(77277),K=r(8311);function N(n,t){var r="undefined"!==typeof Symbol&&n[Symbol.iterator]||n["@@iterator"];if(!r){if(Array.isArray(n)||(r=function(n,t){if(!n)return;if("string"===typeof n)return G(n,t);var r=Object.prototype.toString.call(n).slice(8,-1);"Object"===r&&n.constructor&&(r=n.constructor.name);if("Map"===r||"Set"===r)return Array.from(n);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return G(n,t)}(n))||t&&n&&"number"===typeof n.length){r&&(n=r);var e=0,o=function(){};return{s:o,n:function(){return e>=n.length?{done:!0}:{done:!1,value:n[e++]}},e:function(n){throw n},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,c=!1;return{s:function(){r=r.call(n)},n:function(){var n=r.next();return i=n.done,n},e:function(n){c=!0,a=n},f:function(){try{i||null==r.return||r.return()}finally{if(c)throw a}}}}function G(n,t){(null==t||t>n.length)&&(t=n.length);for(var r=0,e=new Array(t);r<t;r++)e[r]=n[r];return e}function H(n){var t=(0,l.Z)(),r=(0,f.Z)((function(){var e={apis:[],root:{},npcRef:function(n){if(n){var t=r.apis.find((function(t){return n.classList.contains(t.key)}));t?(t.el={root:n},n.style.left="".concat(t.def.position.x,"px"),n.style.top="".concat(t.def.position.y,"px")):console.error("".concat(H.name,": npc not found for div.").concat(Array.from(n.classList.values()).join(".")))}},rootRef:function(n){n&&(r.root=n)},spawn:function(e){if((0,S.l)(n.stageKey)){console.log("spawning...",e),r.apis=r.apis.filter((function(n){return!e.some((function(t){return n.key===t.key}))}));var o,a=N(e);try{for(a.s();!(o=a.n()).done;){var i=o.value;r.apis.push({key:i.key,def:i,animState:"idle",el:{}})}}catch(c){a.e(c)}finally{a.f()}}else console.error("".concat(H.name,': cannot spawn into non-existent stage "').concat(n.stageKey,'"'));t()}};return n.onLoad(e),e}));return(0,K.tZ)("div",{className:M,ref:r.rootRef,children:(0,K.tZ)("div",{className:P()("npcs",{disabled:n.disabled}),onPointerDown:function(n){var e=n.target;(0,m.Nh)(r.apis.find((function(n){return e.classList.contains(n.key)}))).animState="walk",t()},onPointerUp:function(n){var e=n.target;(0,m.Nh)(r.apis.find((function(n){return e.classList.contains(n.key)}))).animState="idle",t()},children:r.apis.map((function(n){return(0,K.tZ)("div",{className:P()("npc",n.key,n.animState,E),ref:r.npcRef,children:(0,K.tZ)("div",{className:P()("body","no-select",n.key)})},n.key)}))})})}var L,M=(0,a.iv)(R||(R=(0,e.Z)(["\n  position: absolute;\n  canvas {\n    position: absolute;\n    pointer-events: none;\n  }\n  .npc {\n    position: absolute;\n  }\n"]))),j=new s.dl(51,26).scale(2),C=new s.dl(49,37).scale(2),E=(0,a.iv)(I||(I=(0,e.Z)(["\n  .body {\n    cursor: pointer;\n    position: absolute;\n    transform: scale(0.18);\n    pointer-events: all;\n    filter: grayscale(100%);\n  }\n  \n  &.walk .body {\n    width: ","px;\n    height: ","px;\n    left: ","px;\n    top: ","px;\n    animation: walk 300ms steps(",") infinite;\n    background: url('/npc/first-npc--walk.png');\n  }\n  &.idle .body {\n    width: ","px;\n    height: ","px;\n    left: ","px;\n    top: ","px;\n    animation: idle 2s steps(",") infinite;\n    background: url('/npc/first-npc--idle.png');\n  }\n\n  &.disabled .body {\n    animation-play-state: paused;\n  }\n\n  @keyframes walk {\n    from { background-position: 0px; }\n    to { background-position: ","px; }\n  }\n  @keyframes idle {\n    from { background-position: 0px; }\n    to { background-position: ","px; }\n  }\n"])),C.x,C.y,-C.x/2,-C.y/2,3,j.x,j.y,-j.x/2,-j.y/2,1,-3*C.x,-1*j.x);function _(n){var t=(0,l.Z)(),r=function(n){var t=o.default.useState((function(){return n.map((function(n){return n.layoutKey}))})),r=(0,p.Z)(t,2),e=r[0],a=r[1];o.default.useEffect((function(){var t=n.map((function(n){return n.layoutKey})).filter((function(n){return!e.includes(n)}));t.length&&a([].concat((0,d.Z)(e),(0,d.Z)(t)))}),[e]);var i=e.map((function(n){return(0,Z.Z)(n,{staleTime:1/0})})),c=n.every((function(n){return e.includes(n.layoutKey)}))&&i.every((function(n){return n.data}));return o.default.useMemo((function(){if(c){var t=n.map((function(n){var t=e.findIndex((function(t){return t===n.layoutKey})),r=(0,m.Nh)(i[t].data),o=n.transform||[1,0,0,1,0,0];return(0,w.mI)(r,o)}));return{gms:t,gmGraph:k.fromGmItems(t)}}return{gms:[],gmGraph:new k}}),[c])}([{layoutKey:"g-301--bridge"},{layoutKey:"g-101--multipurpose",transform:[1,0,0,1,0,600]},{layoutKey:"g-301--bridge",transform:[1,0,0,-1,0,2400]}]),e=r.gms,a=(r.gmGraph,(0,f.Z)((function(){return{currentGmIndex:0,currentHoleId:2,clipPath:e.map((function(n){return"none"})),doorsApi:{ready:!1},npcsApi:{},wire:new i.x,getAdjacentHoleIds:function(){var n=a.currentGmIndex,t=e[n].roomGraph,r=a.doorsApi.getOpen(n),o=t.nodesArray[a.currentHoleId];return t.getEnterableRooms(o,r).map((function(n){return n.holeIndex}))},onChangeDeps:function(){if(e.length){a.updateClipPath(),a.updateObservableDoors(),t();var n=a.wire.pipe((0,c.h)((function(n){return"closed-door"===n.key||"opened-door"===n.key}))).subscribe((function(n){a.updateClipPath(),t()}));return function(){return n.unsubscribe()}}},updateClipPath:function(){var n=a.currentGmIndex,t=e[n],r=t.gm.d,o=r.hullOutline,i=r.holesWithDoors,c=[a.currentHoleId].concat(a.getAdjacentHoleIds()).map((function(n){return i[n]})),u=s.LA.cutOut(c,[o]).map((function(n){return n.translate(-t.gm.d.pngRect.x,-t.gm.d.pngRect.y)})).map((function(n){return"".concat(n.svgPath)})).join(" ");a.clipPath=a.clipPath.map((function(n){return"none"})),a.clipPath[n]="path('".concat(u,"')")},updateObservableDoors:function(){var n=this,t=a.currentGmIndex,r=e[t].roomGraph,o=r.nodesArray[a.currentHoleId],i=r.getAdjacentDoors(o);e.forEach((function(r,e){return n.doorsApi.setObservableDoors(e,t===e?i.map((function(n){return n.doorIndex})):[])}))}}}),[e],{equality:{currentGmIndex:!0,currentHoleId:!0}}));return e.length?(0,K.BX)(A.Z,{stageKey:"stage-nav-demo-1",dark:!0,className:B,zoom:.4,children:[e.map((function(n){return(0,K.tZ)("img",{className:"geomorph",src:(0,u.qX)(n.gm.key),draggable:!1,width:n.gm.d.pngRect.width,height:n.gm.d.pngRect.height,style:{left:n.gm.d.pngRect.x,top:n.gm.d.pngRect.y,transform:"matrix(".concat(n.transform,")"),transformOrigin:"".concat(-n.gm.d.pngRect.x,"px ").concat(-n.gm.d.pngRect.y,"px")}})})),(0,K.tZ)(H,{onLoad:function(n){a.npcsApi=n,t()},disabled:n.disabled,stageKey:"stage-nav-demo-1"}),e.map((function(n,t){return(0,K.tZ)("img",{className:"geomorph-dark",src:(0,u.qX)(n.gm.key),draggable:!1,width:n.gm.d.pngRect.width,height:n.gm.d.pngRect.height,style:{clipPath:a.clipPath[t],WebkitClipPath:a.clipPath[t],left:n.gm.d.pngRect.x,top:n.gm.d.pngRect.y,transform:"matrix(".concat(n.transform,")"),transformOrigin:"".concat(-n.gm.d.pngRect.x,"px ").concat(-n.gm.d.pngRect.y,"px")}},t)})),a.doorsApi.ready&&(0,K.tZ)(U,{gms:e,doorsApi:a.doorsApi,currentHoleId:a.currentHoleId}),(0,K.tZ)(D.Z,{gms:e,wire:a.wire,onLoad:function(n){return a.doorsApi=n}})]}):null}var B=(0,a.iv)(L||(L=(0,e.Z)(["\n  img {\n    position: absolute;\n    transform-origin: top left;\n  }\n  img.geomorph {\n    filter: brightness(80%);\n  }\n  img.geomorph-dark {\n    filter: invert(100%) brightness(55%) contrast(200%) sepia(0%);\n  }\n"])));function U(n){return(0,K.BX)(K.HY,{children:[n.gms.map((function(n,t){return(0,K.tZ)("div",{style:{position:"absolute",left:n.gridRect.x,top:n.gridRect.y,width:n.gridRect.width,height:n.gridRect.height,border:"2px red solid"}},t)})),n.gms.map((function(t,r){var e=n.doorsApi.getObservable(r);return(0,K.tZ)("div",{className:"debug",style:{transform:t.transformStyle,transformOrigin:"".concat(t.gm.d.pngRect.x,"px ").concat(t.gm.d.pngRect.y,"px"),position:"absolute"},children:t.gm.doors.map((function(r,o){var a=r.poly,i=r.normal;if(e.includes(o)){var c=t.roomGraph.getRoomDoorSign(n.currentHoleId,o)||0,u=s.dl.from(i).scale(-c||0).angle,l=a.center.addScaledVector(i,15*c);return(0,K.tZ)("div",{style:{width:2*X,height:2*X,borderRadius:X,position:"absolute",left:l.x-X,top:l.y-X,transform:"rotate(".concat(u,"rad)"),backgroundImage:"url('/icon/solid_arrow-circle-right.svg')"}},o)}return null}))},t.itemKey)}))]})}var X=4}}]);