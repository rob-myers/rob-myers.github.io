"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5878],{3368:function(n,e,t){t.d(e,{Z:function(){return p}});var o,r=t(52209),i=t(79056),s=t(67294),a=t(88269),l=t(48103),c=t(50269),u=t(27375),d=t(85893);function p(n){var e=(0,u.Z)(),t=s.useState((function(){var t,r={position:l.dl.from(n.initial),target:l.dl.from(n.initial),dragging:!1,rootEl:{},lineEl:{},circleEl:{},rootRef:function(n){n&&(o.rootEl=n,o.lineEl=n.querySelector("line.drag-indicator"),o.circleEl=n.querySelector("circle.node"),o.circleEl.addEventListener("pointerdown",o.startDrag),o.circleEl.addEventListener("pointerup",o.applyDrag))},startDrag:function(e){var t;e.stopPropagation(),o.dragging=!0,o.lineEl.style.display="inline",o.target.copy(o.position),["x1","x2"].forEach((function(n){return o.lineEl.setAttribute(n,String(o.position.x))})),["y1","y2"].forEach((function(n){return o.lineEl.setAttribute(n,String(o.position.y))}));var r=o.lineEl.ownerSVGElement;r.addEventListener("pointermove",o.onMove),r.addEventListener("pointerleave",o.endDrag),r.addEventListener("pointerup",o.applyDrag),window.addEventListener("keydown",o.endDragOnEscape),r.style.cursor="grabbing",null===(t=n.onStart)||void 0===t||t.call(n)},onMove:function(n){if(n.stopPropagation(),o.dragging){var e=(0,c.zk)({clientX:n.clientX,clientY:n.clientY,ownerSvg:o.lineEl.ownerSVGElement,pointerId:null}),t=e.x,r=e.y,i=new l.dl(t,r);o.position.distanceTo(i)>=20&&(o.target.set(t,r),o.lineEl.setAttribute("x2",String(t)),o.lineEl.setAttribute("y2",String(r)))}},endDrag:function(){if(o.dragging){o.dragging=!1,o.lineEl.style.display="none",o.lineEl.setAttribute("x2",o.lineEl.getAttribute("x1")),o.lineEl.setAttribute("y2",o.lineEl.getAttribute("y1"));var n=o.lineEl.ownerSVGElement;n.removeEventListener("pointermove",o.onMove),n.removeEventListener("pointerleave",o.endDrag),n.removeEventListener("pointerup",o.applyDrag),window.removeEventListener("keydown",o.endDragOnEscape),n.style.cursor="auto"}},applyDrag:function(){var e,t,r;o.dragging&&(o.endDrag(),null!==(e=n.shouldCancel)&&void 0!==e&&e.call(n,o.position.clone(),o.target.clone())||(o.target.distanceTo(o.position)<20?null===(t=n.onClick)||void 0===t||t.call(n,o.position.clone()):(o.moveTo(o.target),null===(r=n.onStop)||void 0===r||r.call(n,o.target.clone()))))},endDragOnEscape:function(n){"Escape"===n.key&&o.endDrag()},moveTo:function(n){o.position.copy(n),o.lineEl.setAttribute("x1",String(o.target.x)),o.lineEl.setAttribute("y1",String(o.target.y)),e()}};return null===(t=n.onLoad)||void 0===t||t.call(n,{moveTo:r.moveTo,getPosition:function(){return o.position.clone()}}),r})),o=(0,i.Z)(t,1)[0],r=n.radius||8;return(0,d.jsxs)("g",{className:f,ref:o.rootRef,children:[n.icon&&{eye:(0,d.jsx)("image",{className:"icon",href:"/icon/Simple_Icon_Eye.svg",width:"20",height:"20",x:o.position.x-10,y:o.position.y-10}),down:(0,d.jsx)("image",{className:"icon",href:"/icon/solid_arrow-circle-down.svg",width:"20",height:"20",x:o.position.x-10,y:o.position.y-10}),right:(0,d.jsx)("image",{className:"icon",href:"/icon/solid_arrow-circle-right.svg",width:"20",height:"20",x:o.position.x-10,y:o.position.y-10}),run:(0,d.jsx)("image",{className:"icon",href:"/icon/person-running-fa6.svg",width:"20",height:"20",x:o.position.x-10,y:o.position.y-10}),finish:(0,d.jsx)("image",{className:"icon",href:"/icon/flag-checkered-fa6.svg",width:"20",height:"20",x:o.position.x-10,y:o.position.y-10})}[n.icon]||(0,d.jsx)("circle",{className:"inner-node",cx:o.position.x,cy:o.position.y,r:4}),(0,d.jsx)("circle",{className:"node",cx:o.position.x,cy:o.position.y,r:r}),(0,d.jsx)("line",{className:"drag-indicator",stroke:n.stroke||"blue"})]})}var f=(0,a.iv)(o||(o=(0,r.Z)(["\n  circle.node {\n    fill: rgba(0, 0, 100, 0.1);\n    stroke: rgba(0, 0, 100, 0.2);\n    stroke-dasharray: 4px 4px;\n    cursor: pointer;\n  }\n  circle.inner-node {\n    stroke: black;\n    cursor: pointer;\n    stroke-width: 0.5;\n  }\n  line.drag-indicator {\n    display: none;\n    stroke-width: 2.5;\n    user-select: none;\n    pointer-events: none;\n  }\n"])))},75878:function(n,e,t){t.r(e),t.d(e,{default:function(){return b}});var o,r=t(52209),i=t(92809),s=t(79056),a=t(67294),l=t(88269),c=t(94184),u=t.n(c),d=t(48103),p=t(91441),f=t(68451),g=t(35490),h=t(83159),v=t(3368),m=t(95814),y=t(85893);function w(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(n);e&&(o=o.filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),t.push.apply(t,o)}return t}function x(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?w(Object(t),!0).forEach((function(e){(0,i.Z)(n,e,t[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):w(Object(t)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))}))}return n}function b(n){var e=(0,m.Z)(n.layoutKey).data,t=a.useState((function(){return{lightA:new d.dl(205,385),lightB:new d.dl(1e3,400)}})),o=(0,s.Z)(t,1)[0];return(0,y.jsx)(h.Z,{gridBounds:g.l,initViewBox:g.r,maxZoom:6,className:u()(j,n.disabled&&"disabled"),children:e&&(0,y.jsxs)(y.Fragment,{children:[(0,y.jsx)("image",x(x({},e.pngRect),{},{className:"geomorph",href:(0,p.qX)(n.layoutKey)})),(0,y.jsx)(E,{init:o.lightA,walls:e.groups.walls,hull:e.hullPoly}),(0,y.jsx)(E,{init:o.lightB,walls:e.groups.walls,hull:e.hullPoly})]})})}function E(n){var e=n.init,t=n.walls,o=n.hull,r=a.useState((function(){return e})),i=(0,s.Z)(r,2),l=i[0],c=i[1],u=(0,a.useMemo)((function(){if(o[0].clone().removeHoles().contains(l)){var n=t.flatMap((function(n){return f.J.triangulationToPolys(n.fastTriangulate())}));return f.J.lightPolygon({position:l,range:2e3,tris:n})}return new d.LA}),[l.x,l.y]);return(0,y.jsxs)(y.Fragment,{children:[(0,y.jsx)("path",{className:"light",d:u.svgPath}),(0,y.jsx)(v.Z,{initial:l,onStop:c,radius:20,stroke:"black",icon:"eye"})]})}var j=(0,l.iv)(o||(o=(0,r.Z)(["\n  image {\n    filter: contrast(120%);\n  }\n\n  path.light {\n    fill: blue;\n    animation: fadein 2s infinite alternate;\n    \n    @keyframes fadein {\n      from { opacity: 0; }\n      to { opacity: 0.6; }\n    }\n  }\n  &.disabled path.light {\n    animation: none;\n    opacity: 0.25;\n  }\n"])))},35490:function(n,e,t){t.d(e,{l:function(){return r},r:function(){return i}});var o=t(48103),r=new o.UL(-5e3,-5e3,10001,10001),i=new o.UL(0,0,1200,600)},95814:function(n,e,t){t.d(e,{Z:function(){return v}});var o=t(92809),r=t(97131),i=t(30266),s=t(809),a=t.n(s),l=t(88767),c=t(91441),u=t(48103),d=t(2026),p=t(39660),f=t(68451);function g(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(n);e&&(o=o.filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),t.push.apply(t,o)}return t}function h(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?g(Object(t),!0).forEach((function(e){(0,o.Z)(n,e,t[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):g(Object(t)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))}))}return n}function v(n){return(0,l.useQuery)((0,c.tU)(n),(0,i.Z)(a().mark((function e(){var t,o,i,s,l,d,g;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=p.Vn,e.next=3,fetch((0,c.tU)(n)).then((function(n){return n.json()}));case 3:return e.t1=e.sent,t=(0,e.t0)(e.t1),o=t.roomGraph,i=o.nodesArray.filter((function(n){return"room"===n.type})).map((function(n,e){var i=o.getEdgesFrom(n).flatMap((function(n){var e=n.dst;return"door"===e.type?t.doors[e.doorId].poly:[]}));return u.LA.union([t.rooms[e]].concat((0,r.Z)(i)))[0]})),s=t.groups.singles.filter((function(n){return n.tags.includes("light")})).map((function(n){var e=n.poly,t=n.tags;return{center:e.center,poly:e,reverse:t.includes("reverse")}})),l=t.groups.singles.filter((function(n){return n.tags.includes("relate-connectors")})).reduce((function(n,e){var o=e.poly,i=t.doors.flatMap((function(n,e){return f.J.convexPolysIntersect(n.poly.outline,o.outline)?e:[]})),s=t.windows.flatMap((function(n,e){return f.J.convexPolysIntersect(n.poly.outline,o.outline)?e:[]}));return i.forEach((function(e){var t,o;n[e]=n[e]||{doorIds:[],windowIds:[]},(t=n[e].doorIds).push.apply(t,(0,r.Z)(i.filter((function(n){return n!==e})))),(o=n[e].windowIds).push.apply(o,(0,r.Z)(s))})),0===i.length&&console.warn("poly tagged 'relate-connectors' doesn't intersect any door: (windowIds ".concat(s,")")),i.length+s.length<=1&&console.warn("poly tagged 'relate-connectors' should intersect \u2265 2 doors/windows (doorIds ".concat(i,", windowIds ").concat(s,")")),n}),{}),d=t.rooms.map((function(n){return{default:n.center,labels:[],light:{},spawn:[]}})),s.forEach((function(n,e){var o=n.center,r=n.poly,i=n.reverse,s=t.rooms.findIndex((function(n){return n.contains(o)})),a=t.doors.findIndex((function(n){return f.J.convexPolysIntersect(r.outline,n.poly.outline)}));if(-1===s||-1===a)console.warn("useGeomorphData: light ".concat(e," has room/doorId ").concat(s,"/").concat(a));else if(i){var l=t.doors[a].roomIds.find((function(n){return n!==s}));"number"!==typeof l?console.warn("useGeomorphData: reverse light ".concat(e," lacks other roomId (room/doorId ").concat(s,"/").concat(a,")")):s=l}d[s].light[a]=o})),t.groups.singles.filter((function(n){return n.tags.includes("spawn")})).map((function(n){return n.poly.center})).forEach((function(n,e){var o=t.rooms.findIndex((function(e){return e.contains(n)}));o>=0?d[o].spawn.push(n):console.warn("spawn point ".concat(e," should be inside some room"))})),t.labels.forEach((function(n){var e=t.rooms.findIndex((function(e){return e.contains(n.center)}));e>=0?(d[e].labels.push(n),d[e].default=u.dl.from(d[e].labels[0].center)):console.warn("label ".concat(n.text," should be inside some room"))})),(g=h(h({},t),{},{hullDoors:t.doors.filter((function(n){return n.tags.includes("hull")})),hullOutline:t.hullPoly[0].removeHoles(),pngRect:u.UL.fromJson(t.items[0].pngRect),roomsWithDoors:i,relDoorId:l,point:d,lazy:null,getHullDoorId:function(n){var e="number"===typeof n?this.doors[n]:n;return this.hullDoors.findIndex((function(n){return n===e}))},getOtherRoomId:function(n,e){return("number"===typeof n?this.doors[n]:n).roomIds.find((function(n){return n!==e}))||-1},isHullDoor:function(n){return("number"===typeof n?this.doors[n]:n).roomIds.includes(null)}})).lazy=m(g),y(g),e.abrupt("return",g);case 17:case"end":return e.stop()}}),e)}))),{cacheTime:1/0,keepPreviousData:!0,staleTime:1/0})}function m(n){var e={roomNavPoly:{}},t=new Proxy({},{get:function(t,o){if("string"===typeof o){var r=Number(o);if(n.roomsWithDoors[r]&&!e.roomNavPoly[r]){var i=u.LA.intersect(n.navPoly,[n.roomsWithDoors[r]]);i.sort((function(n,e){return n.rect.area>e.rect.area?-1:1})),e.roomNavPoly[r]=i[0]}return e.roomNavPoly[r]}}});return new Proxy(e,{get:function(n,e){if("roomNavPoly"===e)return t}})}function y(n){n.navZone.doorNodeIds.forEach((function(e,t){var o=n.doors[t];if(n.hullDoors.includes(o)){var i,s=o.roomIds.find((function(n){return null!==n}));if(Number.isFinite(s))(i=n.navZone.roomNodeIds[s]).push.apply(i,(0,r.Z)(e));else(0,d.ZK)("extendRoomNodeIds: ".concat(n.key," (hull) door ").concat(t," has empty roomIds"))}}))}},83159:function(n,e,t){t.d(e,{Z:function(){return f}});var o,r=t(52209),i=t(79056),s=t(67294),a=t(88269),l=t(94184),c=t.n(l),u=t(48103),d=t(50269),p=t(85893);function f(n){var e=s.useState((function(){var e=n.initViewBox.clone(),i=n.minZoom||.5,s=n.maxZoom||2;return{viewBox:e,panFrom:null,zoom:n.initZoom||1,ptrs:[],ptrDiff:null,root:{},rootCss:(0,a.iv)(o||(o=(0,r.Z)(["\n        width: 100%;\n        height: 100%;\n\n        touch-action: pan-x pan-y pinch-zoom;\n        background-color: ",";\n\n        > g.content {\n          /** TODO justification? */\n          shape-rendering: ",";\n        }\n        > .grid {\n          pointer-events: none;\n        }\n      "])),n.dark?"#000":"none",(0,d.us)()?"optimizeSpeed":"auto"),onPointerDown:function(n){(0,d.af)(n)&&t.ptrs.length<2&&(t.panFrom=(new u.dl).copy((0,d.zk)((0,d.Xs)(n))),t.ptrs.push((0,d.Xs)(n)))},onPointerMove:function(o){if(t.ptrs=t.ptrs.map((function(n){return n.pointerId===o.pointerId?(0,d.Xs)(o):n})),2===t.ptrs.length){var r=Math.abs(t.ptrs[1].clientX-t.ptrs[0].clientX);if(null!==t.ptrDiff){var i,s=(0,d._Y)(t.ptrs);t.zoomTo(s,.02*(r-t.ptrDiff)),t.root.setAttribute("viewBox","".concat(t.viewBox)),null===(i=n.onUpdate)||void 0===i||i.call(n,t.root)}t.ptrDiff=r}else if(t.panFrom){var a,l=(0,d.zk)((0,d.Xs)(o));e.delta(t.panFrom.x-l.x,t.panFrom.y-l.y),t.root.setAttribute("viewBox","".concat(t.viewBox)),null===(a=n.onUpdate)||void 0===a||a.call(n,t.root)}},onPointerUp:function(n){t.panFrom=null,t.ptrs=t.ptrs.filter((function(e){return n.pointerId!==e.pointerId})),t.ptrs.length<2&&(t.ptrDiff=null),1===t.ptrs.length&&(t.panFrom=(new u.dl).copy((0,d.zk)(t.ptrs[0])))},onTouchStart:function(n){n.preventDefault()},onWheel:function(e){if(e.preventDefault(),(0,d.af)(e)){var o,r=(0,d.zk)((0,d.Xs)(e));t.zoomTo(r,-.003*e.deltaY),t.root.setAttribute("viewBox","".concat(t.viewBox)),null===(o=n.onUpdate)||void 0===o||o.call(n,t.root)}},rootRef:function(n){n&&(t.root=n,n.addEventListener("wheel",t.onWheel,{passive:!1}),n.addEventListener("pointerdown",t.onPointerDown,{passive:!0}),n.addEventListener("pointermove",t.onPointerMove,{passive:!0}),n.addEventListener("pointerup",t.onPointerUp,{passive:!0}),n.addEventListener("pointercancel",t.onPointerUp,{passive:!0}),n.addEventListener("pointerleave",t.onPointerUp,{passive:!0}),n.addEventListener("touchstart",t.onTouchStart,{passive:!1}))},zoomTo:function(o,r){var a=Math.min(Math.max(t.zoom+r,i),s);e.x=t.zoom/a*(e.x-o.x)+o.x,e.y=t.zoom/a*(e.y-o.y)+o.y,e.width=1/a*n.initViewBox.width,e.height=1/a*n.initViewBox.height,t.zoom=a}}})),t=(0,i.Z)(e,1)[0];return(0,p.jsxs)("svg",{ref:t.rootRef,className:t.rootCss,preserveAspectRatio:"xMinYMin slice",viewBox:"".concat(t.viewBox),children:[(0,p.jsx)("g",{className:c()("content",n.className),children:n.children}),(0,p.jsx)(g,{bounds:n.gridBounds,dark:n.dark})]})}function g(n){var e=s.useMemo((function(){return h++}),[]);return(0,p.jsx)(p.Fragment,{children:[10,60].flatMap((function(t,o){return[(0,p.jsx)("defs",{children:(0,p.jsx)("pattern",{id:"pattern-grid-".concat(t,"x").concat(t,"--").concat(e),width:t,height:t,patternUnits:"userSpaceOnUse",children:(0,p.jsx)("path",{d:"M ".concat(t," 0 L 0 0 0 ").concat(t),fill:"none",stroke:n.dark?"rgba(200,200,200,0.2)":"rgba(0,0,0,0.5)",strokeWidth:"0.3"})})},t+o),(0,p.jsx)("rect",{className:"grid",x:n.bounds.x,y:n.bounds.y,width:n.bounds.width,height:n.bounds.height,fill:"url(#pattern-grid-".concat(t,"x").concat(t,"--").concat(e,")")},t+o+1)]}))})}var h=0}}]);