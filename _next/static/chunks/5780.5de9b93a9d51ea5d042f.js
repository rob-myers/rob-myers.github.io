"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5780],{95814:function(e,t,n){n.d(t,{Z:function(){return g}});var r=n(79056),o=n(92809),i=n(97131),u=n(30266),c=n(809),s=n.n(c),a=n(88767),l=n(91441),f=n(48103),d=n(2026),h=n(39660);function p(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function v(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?p(Object(n),!0).forEach((function(t){(0,o.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):p(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function g(e){return(0,a.useQuery)((0,l.tU)(e),(0,u.Z)(s().mark((function t(){var n,o,u,c,a,d,p;return s().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.t0=h.Vn,t.next=3,fetch((0,l.tU)(e)).then((function(e){return e.json()}));case 3:return t.t1=t.sent,n=(0,t.t0)(t.t1),o=n.roomGraph,u=o.nodesArray.filter((function(e){return"room"===e.type})).map((function(e,t){var r=o.getEdgesFrom(e).flatMap((function(e){var t=e.dst;return"door"===t.type?n.doors[t.doorId].poly:[]}));return f.LA.union([n.rooms[t]].concat((0,i.Z)(r)))[0]})),c=n.groups.singles.filter((function(e){return e.tags.includes("spawn")})).map((function(e){return e.poly.center})),a=n.groups.singles.filter((function(e){return e.tags.includes("switch")})).map((function(e){return e.poly.center})),d=n.groups.singles.filter((function(e){return e.tags.includes("light")})).map((function(e){var t=e.poly.rect;return[t.center,t]})),(p=v(v({},n),{},{hullDoors:n.doors.filter((function(e){return e.tags.includes("hull")})),hullOutline:n.hullPoly[0].removeHoles(),pngRect:f.UL.fromJson(n.items[0].pngRect),roomsWithDoors:u,point:{all:[].concat(d.map((function(e){return e[0]})),c,a),light:d.reduce((function(e,t,o){var i=(0,r.Z)(t,2),u=i[0],c=i[1],s=n.rooms.findIndex((function(e){return e.contains(u)})),a=n.doors.findIndex((function(e){return e.rect.intersects(c)}));return s>=0&&a>=0?(e[s]=e[s]||{})[a]=u:console.warn("useGeomorphData: light ".concat(o," roomId/doorId ").concat(s,"/").concat(a)),e}),{}),spawn:n.rooms.map((function(e){return c.filter((function(t){return e.contains(t)}))})),switch:n.rooms.map((function(e){return a.find((function(t){return e.contains(t)}))||e.rect.center}))},lazy:null})).lazy=m(p),y(p),t.abrupt("return",p);case 14:case"end":return t.stop()}}),t)}))),{cacheTime:1/0,keepPreviousData:!0,staleTime:1/0})}function m(e){var t={roomNavPoly:{}},n=new Proxy({},{get:function(n,r){if("string"===typeof r){var o=Number(r);if(e.roomsWithDoors[o]&&!t.roomNavPoly[o]){var i=f.LA.intersect(e.navPoly,[e.roomsWithDoors[o]]);i.sort((function(e,t){return e.rect.area>t.rect.area?-1:1})),t.roomNavPoly[o]=i[0]}return t.roomNavPoly[o]}}});return new Proxy(t,{get:function(e,t){if("roomNavPoly"===t)return n}})}function y(e){e.navZone.doorNodeIds.forEach((function(t,n){var r=e.doors[n];if(e.hullDoors.includes(r)){var o,u=r.roomIds.find((function(e){return null!==e}));if(Number.isFinite(u))(o=e.navZone.roomNodeIds[u]).push.apply(o,(0,i.Z)(t));else(0,d.ZK)("extendRoomNodeIds: ".concat(e.key," (hull) door ").concat(n," has empty roomIds"))}}))}},19964:function(e,t,n){n.d(t,{Z:function(){return x}});var r=n(97131),o=n(79056),i=n(68216),u=n(25997),c=n(14695),s=n(91077),a=n(30268),l=n(92953),f=n(92809),d=n(48103),h=n(82405),p=n(81033),v=function(){function e(t){(0,i.Z)(this,e),this.content=[],this.scoreFunction=t}return(0,u.Z)(e,[{key:"push",value:function(e){this.content.push(e),this.sinkDown(this.content.length-1)}},{key:"pop",value:function(){var e=this.content[0],t=this.content.pop();return this.content.length>0&&(this.content[0]=t,this.bubbleUp(0)),e}},{key:"remove",value:function(e){var t=this.content.indexOf(e),n=this.content.pop();t!==this.content.length-1&&(this.content[t]=n,this.scoreFunction(n)<this.scoreFunction(e)?this.sinkDown(t):this.bubbleUp(t))}},{key:"size",value:function(){return this.content.length}},{key:"rescoreElement",value:function(e){this.sinkDown(this.content.indexOf(e))}},{key:"sinkDown",value:function(e){for(var t=this.content[e];e>0;){var n=(e+1>>1)-1,r=this.content[n];if(!(this.scoreFunction(t)<this.scoreFunction(r)))break;this.content[n]=t,this.content[e]=r,e=n}}},{key:"bubbleUp",value:function(e){for(var t=this.content.length,n=this.content[e],r=this.scoreFunction(n);;){var o=e+1<<1,i=o-1,u=null,c=-1/0;if(i<t){var s=this.content[i];(c=this.scoreFunction(s))<r&&(u=i)}if(o<t){var a=this.content[o];this.scoreFunction(a)<(null===u?r:c)&&(u=o)}if(null===u)break;this.content[e]=this.content[u],this.content[u]=n,e=u}}}]),e}(),g=function(){function e(){(0,i.Z)(this,e)}return(0,u.Z)(e,null,[{key:"init",value:function(e){for(var t=e.nodesArray,n=0;n<t.length;n++){var r=t[n];r.f=0,r.g=0,r.h=0,r.cost=1,r.visited=!1,r.closed=!1,r.parent=null}}},{key:"cleanUp",value:function(e){for(var t=0;t<e.length;t++){var n=e[t];delete n.f,delete n.g,delete n.h,delete n.cost,delete n.visited,delete n.closed,delete n.parent}}},{key:"heap",value:function(){return new v((function(e){return e.f}))}},{key:"search",value:function(e,t,n){this.init(e);var r=e.nodesArray,o=this.heap();for(o.push(t);o.size()>0;){var i=o.pop();if(i===n){for(var u=i,c=[];u.parent;)c.push(u),u=u.parent;return c.push(t),this.cleanUp(c),c.reverse(),c}i.closed=!0;for(var s=this.neighbours(r,i),a=0,l=s.length;a<l;a++){var f=s[a];if(!f.closed){var d=i.g+f.cost,h=f.visited;if(!h||d<f.g){if(f.visited=!0,f.parent=i,!f.centroid||!n.centroid)throw new Error("Unexpected state");f.h=f.h||this.heuristic(f.centroid,n.centroid),f.g=d,f.f=f.g+f.h,h?o.rescoreElement(f):o.push(f)}}}}return[]}},{key:"heuristic",value:function(e,t){return p.c.distanceToSquared(e,t)}},{key:"neighbours",value:function(e,t){for(var n=[],r=0;r<t.neighbours.length;r++)n.push(e[t.neighbours[r]]);return n}}]),e}(),m=function(){function e(){(0,i.Z)(this,e),this.portals=[]}return(0,u.Z)(e,[{key:"push",value:function(e,t){void 0===t&&(t=e),this.portals.push({left:e,right:t})}},{key:"stringPull",value:function(){var e,t,n,r=this.portals,o=[],i=0,u=0,c=0;e=r[0].left,t=r[0].left,n=r[0].right,o.push(e);for(var s=1;s<r.length;s++){var a=r[s].left,l=r[s].right;if(p.c.triarea2(e,n,l)<=0){if(!(p.c.vequal(e,n)||p.c.triarea2(e,t,l)>0)){o.push(t),t=e=t,n=e,u=i=u,c=i,s=i;continue}n=l,c=s}if(p.c.triarea2(e,t,a)>=0){if(!(p.c.vequal(e,t)||p.c.triarea2(e,n,a)<0)){o.push(n),t=e=n,n=e,u=i=c,c=i,s=i;continue}t=a,u=s}}return 0!==o.length&&p.c.vequal(o[o.length-1],r[r.length-1].left)||o.push(r[r.length-1].left),this.path=o,o}}]),e}(),y=n(68451);function b(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function I(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?b(Object(n),!0).forEach((function(t){(0,f.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):b(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function k(e,t){var n="undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"===typeof e)return O(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return O(e,t)}(e))||t&&e&&"number"===typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,u=!0,c=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return u=e.done,e},e:function(e){c=!0,i=e},f:function(){try{u||null==n.return||n.return()}finally{if(c)throw i}}}}function O(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function P(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,l.Z)(e);if(t){var o=(0,l.Z)(this).constructor;n=Reflect.construct(r,arguments,o)}else n=r.apply(this,arguments);return(0,a.Z)(this,n)}}var w=function(e){(0,s.Z)(n,e);var t=P(n);function n(e){var r;(0,i.Z)(this,n),r=t.call(this),(0,f.Z)((0,c.Z)(r),"gm",void 0),(0,f.Z)((0,c.Z)(r),"vectors",void 0),(0,f.Z)((0,c.Z)(r),"nodeToMeta",void 0),r.gm=e,r.vectors=e.navZone.vertices.map(d.dl.from);var o=e.navZone.groups.flatMap((function(e){return e}));return r.nodeToMeta=o.map((function(e){return{doorId:-1,roomId:-1}})),e.navZone.doorNodeIds.forEach((function(e,t){e.forEach((function(e){r.nodeToMeta[e].doorId=t,o[e].neighbours.flatMap((function(e){return o[e].neighbours})).forEach((function(e){return r.nodeToMeta[e].nearDoorId=t}))}))})),e.navZone.roomNodeIds.forEach((function(e,t){e.forEach((function(e){return r.nodeToMeta[e].roomId=t}))})),r}return(0,u.Z)(n,[{key:"findPath",value:function(e,t){var n=this,i=this.getClosestNode(e),u=this.getClosestNode(t);if(!i||!u)return null;var c,s=g.search(this,i,u),a=s.reduce((function(e,t){var r=e.length?e[e.length-1]:void 0,o=n.nodeToMeta[t.index],i=o.doorId>=0?"door":"room";return(null===r||void 0===r?void 0:r.key)===i?r.nodes.push(t):(e.push("door"===i?{key:i,nodes:[t],doorId:o.doorId}:{key:i,nodes:[t],roomId:o.roomId}),"room"===i&&-1===o.roomId&&console.warn("findPathNew: expected roomId for node",t,o)),e}),[]),l=[e.clone()],f=[],h=-1,p=-1,v=k(a.entries());try{for(v.s();!(c=v.n()).done;){var m=(0,o.Z)(c.value,2),b=m[0],O=m[1];if("door"===O.key){if("break"===function(){var r=n.gm.doors[O.doorId];if(b>0){var o=a[b-1].roomId,i={index:l.length-1,doorId:O.doorId,hullDoorId:n.gm.hullDoors.indexOf(r),otherRoomId:r.roomIds[1-r.roomIds.findIndex((function(e){return e===o}))]};f.push(I(I({key:"pre-exit-room"},i),{},{willExitRoomId:o})),f.push(I(I({key:"exit-room"},i),{},{exitedRoomId:o}))}else h=O.doorId;if(!a[b+1])return l.push(t.clone()),p=O.doorId,"break";var u=a[b+1].roomId,c=r.entries[r.roomIds.findIndex((function(e){return e===u}))];0===b&&e.distanceTo(c)<.1||l.push(c.clone())}())break}else!function(){var o=O.roomId,i=0===b?e:l[l.length-1],u=t;if(b<a.length-1){var c=n.gm.doors[a[b+1].doorId];u=c.entries[c.roomIds.findIndex((function(e){return e===o}))]}if(b>0){var s=a[b-1].doorId,h=n.gm.doors[s];f.push({key:"enter-room",index:l.length-1,doorId:s,hullDoorId:n.gm.hullDoors.indexOf(h),enteredRoomId:o,otherRoomId:h.roomIds[1-h.roomIds.findIndex((function(e){return e===o}))]})}var p=n.gm.lazy.roomNavPoly[o];if(!y.J.lineSegCrossesPolygon(i,u,p))l.push(u.clone());else{var v=n.computeStringPull(i,u,O.nodes).path.map(d.dl.from);l.push.apply(l,(0,r.Z)(y.J.removePathReps(v.slice(1))))}if(!a[b+1]){var g=n.nodeToMeta[O.nodes[O.nodes.length-1].index];if(void 0!==g.nearDoorId&&g.nearDoorId>=0){var m=n.gm.doors[g.nearDoorId];f.push({key:"pre-near-door",index:l.length-1,doorId:g.nearDoorId,hullDoorId:n.gm.hullDoors.indexOf(m),currentRoomId:o,otherRoomId:m.roomIds[1-m.roomIds.findIndex((function(e){return e===o}))]})}}}()}}catch(P){v.e(P)}finally{v.f()}return console.log("findPath",{nodePath:s,nodeMetas:s.map((function(e){return n.nodeToMeta[e.index]})),partition:a,fullPath:l,navMetas:f}),{fullPath:l,navMetas:f,doorIds:[h,p]}}},{key:"getClosestNode",value:function(e){var t=this.nodesArray,n=this.vectors,r=null,o=1/0;return t.forEach((function(t){var i=t.centroid.distanceToSquared(e);i<o&&p.c.isVectorInPolygon(e,t,n)&&(r=t,o=i)})),r||t.forEach((function(t){var n=p.c.distanceToSquared(t.centroid,e);n<o&&(r=t,o=n)})),r}},{key:"getPortalFromTo",value:function(e,t){for(var n=0;n<e.neighbours.length;n++)if(e.neighbours[n]===t.index)return e.portals[n]}},{key:"computeStringPull",value:function(e,t,n){var r=new m;r.push(e);for(var o=0;o<n.length;o++){var i=n[o],u=n[o+1];if(u){var c=this.getPortalFromTo(i,u);r.push(this.vectors[c[0]],this.vectors[c[1]])}}return r.push(t),r.stringPull(),r}}],[{key:"fromZone",value:function(e){for(var t=e.navZone,r=t.groups,i=(t.vertices,new n(e)),u=r.flatMap((function(e){return e})),c=0,s=Object.entries(u);c<s.length;c++){var a=(0,o.Z)(s[c],2),l=a[0],f=a[1];i.registerNode({type:"tri",id:"tri-".concat(l),index:Number(l),vertexIds:f.vertexIds.slice(),portals:f.portals.map((function(e){return e.slice()})),cost:1,visited:!1,closed:!1,parent:null,centroid:d.dl.from(f.centroid),neighbours:f.neighbours.slice()})}for(var h=function(){var e=(0,o.Z)(v[p],2),t=e[0],n=e[1],r="tri-".concat(t);n.neighbours.map((function(e){return"tri-".concat(e)})).forEach((function(e){return i.registerEdge({src:r,dst:e})}))},p=0,v=Object.entries(u);p<v.length;p++)h();return i}}]),n}(h.b),Z=n(88767);function x(e,t,n){return(0,Z.useQuery)(function(e){return"pathfinding-".concat(e)}(e),(function(){return{graph:w.fromZone(t)}}),{enabled:!!t&&!n,keepPreviousData:!0,staleTime:1/0})}}}]);