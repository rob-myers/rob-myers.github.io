"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5780],{95814:function(e,n,t){t.d(n,{Z:function(){return g}});var r=t(92809),o=t(97131),i=t(30266),u=t(809),s=t.n(u),c=t(88767),a=t(91441),l=t(48103),f=t(2026),d=t(39660),h=t(68451);function p(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function v(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?p(Object(t),!0).forEach((function(n){(0,r.Z)(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):p(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function g(e){return(0,c.useQuery)((0,a.tU)(e),(0,i.Z)(s().mark((function n(){var t,r,i,u,c,f,p;return s().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.t0=d.Vn,n.next=3,fetch((0,a.tU)(e)).then((function(e){return e.json()}));case 3:return n.t1=n.sent,t=(0,n.t0)(n.t1),r=t.roomGraph,i=r.nodesArray.filter((function(e){return"room"===e.type})).map((function(e,n){var i=r.getEdgesFrom(e).flatMap((function(e){var n=e.dst;return"door"===n.type?t.doors[n.doorId].poly:[]}));return l.LA.union([t.rooms[n]].concat((0,o.Z)(i)))[0]})),u=t.groups.singles.filter((function(e){return e.tags.includes("light")})).map((function(e){var n=e.poly,t=e.tags;return{center:n.center,poly:n,reverse:t.includes("reverse")}})),c=t.groups.singles.filter((function(e){return e.tags.includes("relate-doors")})).reduce((function(e,n){var r=n.poly,i=t.doors.flatMap((function(e,n){return h.J.convexPolysIntersect(e.poly.outline,r.outline)?n:[]}));return i.forEach((function(n){var t;return(t=e[n]||(e[n]=[])).push.apply(t,(0,o.Z)(i.filter((function(e){return e!==n}))))})),i.length<=1&&console.warn("poly tagged 'relate-doors' intersects \u2264 1 doorIds: ".concat(i)),e}),{}),f=t.rooms.map((function(e){return{default:e.center,labels:[],light:{},spawn:[]}})),u.forEach((function(e,n){var r=e.center,o=e.poly,i=e.reverse,u=t.rooms.findIndex((function(e){return e.contains(r)})),s=t.doors.findIndex((function(e){return h.J.convexPolysIntersect(o.outline,e.poly.outline)}));if(-1===u||-1===s)console.warn("useGeomorphData: light ".concat(n," has room/doorId ").concat(u,"/").concat(s));else if(i){var c=t.doors[s].roomIds.find((function(e){return e!==u}));"number"!==typeof c?console.warn("useGeomorphData: reverse light ".concat(n," lacks other roomId (room/doorId ").concat(u,"/").concat(s,")")):u=c}f[u].light[s]=r})),t.groups.singles.filter((function(e){return e.tags.includes("spawn")})).map((function(e){return e.poly.center})).forEach((function(e,n){var r=t.rooms.findIndex((function(n){return n.contains(e)}));r>=0?f[r].spawn.push(e):console.warn("spawn point ".concat(n," should be inside some room"))})),t.labels.forEach((function(e){var n=t.rooms.findIndex((function(n){return n.contains(e.center)}));n>=0?(f[n].labels.push(e),f[n].default=l.dl.from(f[n].labels[0].center)):console.warn("label ".concat(e.text," should be inside some room"))})),(p=v(v({},t),{},{hullDoors:t.doors.filter((function(e){return e.tags.includes("hull")})),hullOutline:t.hullPoly[0].removeHoles(),pngRect:l.UL.fromJson(t.items[0].pngRect),roomsWithDoors:i,relDoorId:c,point:f,lazy:null,getHullDoorId:function(e){var n="number"===typeof e?this.doors[e]:e;return this.hullDoors.findIndex((function(e){return e===n}))},getOtherRoomId:function(e,n){return("number"===typeof e?this.doors[e]:e).roomIds.find((function(e){return e!==n}))||-1},isHullDoor:function(e){return("number"===typeof e?this.doors[e]:e).roomIds.includes(null)}})).lazy=m(p),y(p),n.abrupt("return",p);case 17:case"end":return n.stop()}}),n)}))),{cacheTime:1/0,keepPreviousData:!0,staleTime:1/0})}function m(e){var n={roomNavPoly:{}},t=new Proxy({},{get:function(t,r){if("string"===typeof r){var o=Number(r);if(e.roomsWithDoors[o]&&!n.roomNavPoly[o]){var i=l.LA.intersect(e.navPoly,[e.roomsWithDoors[o]]);i.sort((function(e,n){return e.rect.area>n.rect.area?-1:1})),n.roomNavPoly[o]=i[0]}return n.roomNavPoly[o]}}});return new Proxy(n,{get:function(e,n){if("roomNavPoly"===n)return t}})}function y(e){e.navZone.doorNodeIds.forEach((function(n,t){var r=e.doors[t];if(e.hullDoors.includes(r)){var i,u=r.roomIds.find((function(e){return null!==e}));if(Number.isFinite(u))(i=e.navZone.roomNodeIds[u]).push.apply(i,(0,o.Z)(n));else(0,f.ZK)("extendRoomNodeIds: ".concat(e.key," (hull) door ").concat(t," has empty roomIds"))}}))}},19964:function(e,n,t){t.d(n,{Z:function(){return w}});var r=t(79056),o=t(68216),i=t(25997),u=t(14695),s=t(91077),c=t(30268),a=t(92953),l=t(92809),f=t(48103),d=t(82405),h=t(81033),p=function(){function e(n){(0,o.Z)(this,e),this.content=[],this.scoreFunction=n}return(0,i.Z)(e,[{key:"push",value:function(e){this.content.push(e),this.sinkDown(this.content.length-1)}},{key:"pop",value:function(){var e=this.content[0],n=this.content.pop();return this.content.length>0&&(this.content[0]=n,this.bubbleUp(0)),e}},{key:"remove",value:function(e){var n=this.content.indexOf(e),t=this.content.pop();n!==this.content.length-1&&(this.content[n]=t,this.scoreFunction(t)<this.scoreFunction(e)?this.sinkDown(n):this.bubbleUp(n))}},{key:"size",value:function(){return this.content.length}},{key:"rescoreElement",value:function(e){this.sinkDown(this.content.indexOf(e))}},{key:"sinkDown",value:function(e){for(var n=this.content[e];e>0;){var t=(e+1>>1)-1,r=this.content[t];if(!(this.scoreFunction(n)<this.scoreFunction(r)))break;this.content[t]=n,this.content[e]=r,e=t}}},{key:"bubbleUp",value:function(e){for(var n=this.content.length,t=this.content[e],r=this.scoreFunction(t);;){var o=e+1<<1,i=o-1,u=null,s=-1/0;if(i<n){var c=this.content[i];(s=this.scoreFunction(c))<r&&(u=i)}if(o<n){var a=this.content[o];this.scoreFunction(a)<(null===u?r:s)&&(u=o)}if(null===u)break;this.content[e]=this.content[u],this.content[u]=t,e=u}}}]),e}(),v=function(){function e(){(0,o.Z)(this,e)}return(0,i.Z)(e,null,[{key:"init",value:function(e){for(var n=e.nodesArray,t=0;t<n.length;t++){var r=n[t];r.f=0,r.g=0,r.h=0,r.cost=1,r.visited=!1,r.closed=!1,r.parent=null}}},{key:"cleanUp",value:function(e){for(var n=0;n<e.length;n++){var t=e[n];delete t.f,delete t.g,delete t.h,delete t.cost,delete t.visited,delete t.closed,delete t.parent}}},{key:"heap",value:function(){return new p((function(e){return e.f}))}},{key:"search",value:function(e,n,t){this.init(e);var r=e.nodesArray,o=this.heap();for(o.push(n);o.size()>0;){var i=o.pop();if(i===t){for(var u=i,s=[];u.parent;)s.push(u),u=u.parent;return s.push(n),this.cleanUp(s),s.reverse(),s}i.closed=!0;for(var c=this.neighbours(r,i),a=0,l=c.length;a<l;a++){var f=c[a];if(!f.closed){var d=i.g+f.cost,h=f.visited;if(!h||d<f.g){if(f.visited=!0,f.parent=i,!f.centroid||!t.centroid)throw new Error("Unexpected state");f.h=f.h||this.heuristic(f.centroid,t.centroid),f.g=d,f.f=f.g+f.h,h?o.rescoreElement(f):o.push(f)}}}}return[]}},{key:"heuristic",value:function(e,n){return h.c.distanceToSquared(e,n)}},{key:"neighbours",value:function(e,n){for(var t=[],r=0;r<n.neighbours.length;r++)t.push(e[n.neighbours[r]]);return t}}]),e}(),g=function(){function e(){(0,o.Z)(this,e),this.portals=[]}return(0,i.Z)(e,[{key:"push",value:function(e,n){void 0===n&&(n=e),this.portals.push({left:e,right:n})}},{key:"stringPull",value:function(){var e,n,t,r=this.portals,o=[],i=0,u=0,s=0;e=r[0].left,n=r[0].left,t=r[0].right,o.push(e);for(var c=1;c<r.length;c++){var a=r[c].left,l=r[c].right;if(h.c.triarea2(e,t,l)<=0){if(!(h.c.vequal(e,t)||h.c.triarea2(e,n,l)>0)){o.push(n),n=e=n,t=e,u=i=u,s=i,c=i;continue}t=l,s=c}if(h.c.triarea2(e,n,a)>=0){if(!(h.c.vequal(e,n)||h.c.triarea2(e,t,a)<0)){o.push(t),n=e=t,t=e,u=i=s,s=i,c=i;continue}n=a,u=c}}return 0!==o.length&&h.c.vequal(o[o.length-1],r[r.length-1].left)||o.push(r[r.length-1].left),this.path=o,o}}]),e}(),m=t(68451);function y(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function b(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?y(Object(t),!0).forEach((function(n){(0,l.Z)(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):y(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function I(e,n){var t="undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!t){if(Array.isArray(e)||(t=function(e,n){if(!e)return;if("string"===typeof e)return k(e,n);var t=Object.prototype.toString.call(e).slice(8,-1);"Object"===t&&e.constructor&&(t=e.constructor.name);if("Map"===t||"Set"===t)return Array.from(e);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return k(e,n)}(e))||n&&e&&"number"===typeof e.length){t&&(e=t);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,u=!0,s=!1;return{s:function(){t=t.call(e)},n:function(){var e=t.next();return u=e.done,e},e:function(e){s=!0,i=e},f:function(){try{u||null==t.return||t.return()}finally{if(s)throw i}}}}function k(e,n){(null==n||n>e.length)&&(n=e.length);for(var t=0,r=new Array(n);t<n;t++)r[t]=e[t];return r}function x(e){var n=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var t,r=(0,a.Z)(e);if(n){var o=(0,a.Z)(this).constructor;t=Reflect.construct(r,arguments,o)}else t=r.apply(this,arguments);return(0,c.Z)(this,t)}}var O=function(e){(0,s.Z)(t,e);var n=x(t);function t(e){var r;(0,o.Z)(this,t),r=n.call(this),(0,l.Z)((0,u.Z)(r),"gm",void 0),(0,l.Z)((0,u.Z)(r),"vectors",void 0),(0,l.Z)((0,u.Z)(r),"nodeToMeta",void 0),r.gm=e,r.vectors=e.navZone.vertices.map(f.dl.from);var i=e.navZone.groups.flatMap((function(e){return e}));return r.nodeToMeta=i.map((function(e){return{doorId:-1,roomId:-1}})),e.navZone.doorNodeIds.forEach((function(e,n){e.forEach((function(e){r.nodeToMeta[e].doorId=n,i[e].neighbours.flatMap((function(e){return i[e].neighbours})).forEach((function(e){return r.nodeToMeta[e].nearDoorId=n}))}))})),e.navZone.roomNodeIds.forEach((function(e,n){e.forEach((function(e){return r.nodeToMeta[e].roomId=n}))})),r}return(0,i.Z)(t,[{key:"computeStringPull",value:function(e,n,t){var r=new g;r.push(e);for(var o=0;o<t.length;o++){var i=t[o],u=t[o+1];if(u){var s=this.getPortalFromTo(i,u);r.push(this.vectors[s[0]],this.vectors[s[1]])}}return r.push(n),r.stringPull(),r}},{key:"findPath",value:function(e,n){var t=this,o=this.getClosestNode(e),i=this.getClosestNode(n);if(!o||!i)return null;var u,s=v.search(this,o,i),c=s.reduce((function(e,n){var r=e.length?e[e.length-1]:void 0,o=t.nodeToMeta[n.index],i=o.doorId>=0?"door":"room";return(null===r||void 0===r?void 0:r.key)===i?r.nodes.push(n):(e.push("door"===i?{key:i,nodes:[n],doorId:o.doorId}:{key:i,nodes:[n],roomId:o.roomId}),"room"===i&&-1===o.roomId&&console.warn("findPathNew: expected roomId for node",n,o)),e}),[]),a=[e.clone()],l=[{key:"start-seg",index:0}],d=-1,h=-1,p=I(c.entries());try{for(p.s();!(u=p.n()).done;){var g=(0,r.Z)(u.value,2),y=g[0],k=g[1];if("door"===k.key){if("break"===function(){var r=t.gm.doors[k.doorId];if(y>0){var o=c[y-1].roomId,i={index:a.length-1,doorId:k.doorId,hullDoorId:t.gm.hullDoors.indexOf(r),otherRoomId:r.roomIds[1-r.roomIds.findIndex((function(e){return e===o}))]};l.push(b(b({key:"pre-exit-room"},i),{},{willExitRoomId:o})),l.push(b(b({key:"exit-room"},i),{},{exitedRoomId:o}))}else d=k.doorId;if(!c[y+1])return a.push(n.clone()),l.push({key:"start-seg",index:a.length-1}),h=k.doorId,"break";var u=c[y+1].roomId,s=r.entries[r.roomIds.findIndex((function(e){return e===u}))];0===y&&e.distanceTo(s)<.1||(a.push(s.clone()),l.push({key:"start-seg",index:a.length-1}))}())break}else!function(){var r=k.roomId,o=0===y?e:a[a.length-1],i=n;if(y<c.length-1){var u=t.gm.doors[c[y+1].doorId];i=u.entries[u.roomIds.findIndex((function(e){return e===r}))]}if(y>0){var s=c[y-1].doorId,d=t.gm.doors[s];l.push({key:"enter-room",index:a.length-1,doorId:s,hullDoorId:t.gm.hullDoors.indexOf(d),enteredRoomId:r,otherRoomId:d.roomIds[1-d.roomIds.findIndex((function(e){return e===r}))]})}var h=t.gm.lazy.roomNavPoly[r];if(!m.J.lineSegCrossesPolygon(o,i,h))a.push(i.clone()),l.push({key:"start-seg",index:a.length-1});else{var p=t.computeStringPull(o,i,k.nodes).path.map(f.dl.from);m.J.removePathReps(p.slice(1)).forEach((function(e){a.push(e),l.push({key:"start-seg",index:a.length-1})}))}if(!c[y+1]){var v=t.nodeToMeta[k.nodes[k.nodes.length-1].index];if(void 0!==v.nearDoorId&&v.nearDoorId>=0){var g=t.gm.doors[v.nearDoorId];l.push({key:"pre-near-door",index:a.length-1,doorId:v.nearDoorId,hullDoorId:t.gm.hullDoors.indexOf(g),currentRoomId:r,otherRoomId:g.roomIds[1-g.roomIds.findIndex((function(e){return e===r}))]})}}}()}}catch(x){p.e(x)}finally{p.f()}return console.log("findPath",{nodePath:s,nodeMetas:s.map((function(e){return t.nodeToMeta[e.index]})),partition:c,fullPath:a,navMetas:l}),{fullPath:a,navMetas:l,doorIds:[d,h]}}},{key:"getClosestNode",value:function(e){var n=this.nodesArray,t=this.vectors,r=null,o=1/0;return n.forEach((function(n){var i=n.centroid.distanceToSquared(e);i<o&&h.c.isVectorInPolygon(e,n,t)&&(r=n,o=i)})),r||n.forEach((function(n){var t=h.c.distanceToSquared(n.centroid,e);t<o&&(r=n,o=t)})),r}},{key:"getPortalFromTo",value:function(e,n){for(var t=0;t<e.neighbours.length;t++)if(e.neighbours[t]===n.index)return e.portals[t]}}],[{key:"fromZone",value:function(e){for(var n=e.navZone,o=n.groups,i=(n.vertices,new t(e)),u=o.flatMap((function(e){return e})),s=0,c=Object.entries(u);s<c.length;s++){var a=(0,r.Z)(c[s],2),l=a[0],d=a[1];i.registerNode({type:"tri",id:"tri-".concat(l),index:Number(l),vertexIds:d.vertexIds.slice(),portals:d.portals.map((function(e){return e.slice()})),cost:1,visited:!1,closed:!1,parent:null,centroid:f.dl.from(d.centroid),neighbours:d.neighbours.slice()})}for(var h=function(){var e=(0,r.Z)(v[p],2),n=e[0],t=e[1],o="tri-".concat(n);t.neighbours.map((function(e){return"tri-".concat(e)})).forEach((function(e){return i.registerEdge({src:o,dst:e})}))},p=0,v=Object.entries(u);p<v.length;p++)h();return i}}]),t}(d.b),P=t(88767);function w(e,n,t){return(0,P.useQuery)(function(e){return"pathfinding-".concat(e)}(e),(function(){return{graph:O.fromZone(n)}}),{enabled:!!n&&!t,keepPreviousData:!0,staleTime:1/0})}}}]);