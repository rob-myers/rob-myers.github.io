(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[880],{70704:function(e,t,n){"use strict";n.d(t,{Z:function(){return s}});var r=n(52209),i=n(88823);function a(){var e=(0,r.Z)(["\n  display: flex;\n  flex-direction: column;\n  padding-bottom: 2rem;\n  \n  max-width: 880px;\n  \n  margin: 0 auto;\n  > section {\n    padding: 48px 64px;\n  }\n\n  @media(max-width: 700px) {\n    margin: 0;\n  }\n  @media(max-width: 1024px) {\n    > section {\n      padding: 32px 64px;\n      margin: 0;\n    }\n  }\n  @media(max-width: 800px) {\n    > section {\n      padding: 32px 64px;\n    }\n  }\n  @media(max-width: 600px) {\n    > section {\n      padding: 0;\n    }\n  }\n"]);return a=function(){return e},e}function s(e){var t=e.children;return(0,i.tZ)("main",{className:o,children:(0,i.tZ)("section",{children:t})})}var o=(0,n(88269).iv)(a())},52542:function(e,t,n){"use strict";n.d(t,{Z:function(){return P}});var r=n(52209),i=n(57501),a=n(17120),s=n(58377),o=n(92809),c=n(88823),u=n(11163),l=(n(59748),n(88269)),h=n(38456),p=n.n(h),f=n(76388),d=n.n(f),m=n(10043),v=n.n(m),y=n(86352),g=n(94184),x=n.n(g),b=n(11455);function w(){var e=(0,r.Z)(["\n  line-height: 1.5;\n  font-size: 1.2rem;\n\n  @media(max-width: 600px) {\n    padding: 8px;\n    font-size: 1.1rem;\n  }\n\n  h1, h2, h3, h4 {\n    font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;\n    font-weight: 500;\n  }\n  h2 {\n    font-size: 2rem;\n    @media(max-width: 600px) {\n      margin: 0;\n      font-size: 1.8rem;\n    }\n  }\n\n  ul li, ol li {\n    margin: 4px 0;\n  }\n\n  code {\n    font-family: sans-serif;\n    letter-spacing: 1px;\n    color: #444;\n  }\n  a code {\n    color: unset;\n  }\n\n  span.float {\n    float: right;\n    color: #555;\n    user-select: none;\n    @media(max-width: 480px) {\n      float: unset;\n      display: block;\n      margin-top: 8px;\n    }\n  }\n\n  table {\n    transition: 0.5s background-color ease;\n    background: var(--body-bg);\n    &:hover, &:active {\n      background: var(--focus-bg);\n    }\n\n    padding: 8px;\n    border: 1px solid #bbb;\n    width: 100%;\n\n    th, td {\n      text-align: left;\n      vertical-align: top;\n      padding: 8px;\n      @media(max-width: 540px) {\n        padding: 4px 2px;\n      }\n    }\n  }\n"]);return w=function(){return e},e}function k(){var e=(0,r.Z)(["\n  @media(max-width: 600px) {\n    padding-left: 8px;\n    margin-top: 12px;\n  }\n\n  h1 {\n    font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;\n    font-size: 6rem;\n    font-weight: 300;\n    cursor: pointer;\n    color: #333;\n    margin: 0;\n    \n    @media(max-width: 800px) {\n      font-size: 5rem;\n    }\n    @media(max-width: 600px) {\n      font-size: 3.6rem;\n    }\n  }\n  \n  p {/** Site subtitle */\n    color: #444;\n    letter-spacing: 1px;\n    font-size: 1rem;\n    font-family: monospace;\n    margin: 0;\n    padding: 24px 0 48px;\n    \n    @media(max-width: 600px) {\n      font-size: .9rem;\n      letter-spacing: 0;\n      padding: 24px 0 8px;\n    }\n  }\n"]);return k=function(){return e},e}function Z(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function S(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Z(Object(n),!0).forEach((function(t){(0,o.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Z(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function P(e){return(0,c.tZ)("div",{className:x()(e.title?O:j),children:(0,c.tZ)(p(),S({rehypePlugins:[d()],remarkPlugins:[v()],components:e.title?C:R},e))})}var C={h1:function(e){var t=e.children,n=(0,s.Z)(e,["children"]),r=(0,u.useRouter)();return(0,c.tZ)("h1",S(S({onClick:function(){return r.push("/")}},n),{},{children:t}))}},R={a:function(e){e.node;var t=e.href,n=e.title,r=e.children,o=(0,s.Z)(e,["node","href","title","children"]);return(0,c.tZ)("a",S(S(S(S({href:t},["@new-tab"].includes(n)&&{className:"new-tab-link",target:"_blank"}),{},{title:n},"#command"===t&&{onClick:function(e){e.preventDefault();var t=n.split(" "),r=(0,a.Z)(t),s=r[0],o=r.slice(1);switch(s){case"open-tab":var c=(0,i.Z)(o,2),u=c[0],l=c[1],h=b.Z.getState().tabs[u];h&&(h.model.doAction(y.Actions.selectTab(l)),h.scrollIntoView());break;default:console.warn("link triggered unrecognised command:",n)}}}),o),{},{children:r}))},float:function(e){var t=e.children,n=(0,s.Z)(e,["children"]);return(0,c.tZ)("span",S(S({},n),{},{className:"float",style:S(S({},n.style),{},{fontSize:n.rem?"".concat(n.rem,"rem"):void 0}),children:t}))}},O=(0,l.iv)(k()),j=(0,l.iv)(w())},22200:function(e,t,n){"use strict";n.d(t,{Z:function(){return a}});var r=n(88823),i=n(52542);function a(){return(0,r.tZ)(i.Z,{title:!0,children:"\n# Rogue Markup\n\n$( game ai | roguelike | built online )\n"})}},86576:function(e,t,n){"use strict";n.d(t,{I8:function(){return p},IC:function(){return f},Ql:function(){return d},Z$:function(){return m},wO:function(){return v},or:function(){return y},$G:function(){return g},Q8:function(){return x},BH:function(){return b},RT:function(){return w}});var r=n(809),i=n.n(r),a=n(57501),s=n(68216),o=n(92809),c=n(75392),u=n(87668),l=n.n(u),h=i().mark(k);function p(e){return JSON.parse(JSON.stringify(e))}function f(e){return JSON.stringify(e,null,"\t")}function d(e){return"testNever: ".concat(f(e)," not implemented.")}function m(e){return e[e.length-1]}function v(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return new Promise((function(t){return setTimeout((function(){return t()}),e)}))}function y(e){return"function"===typeof e?function(e){return e.trim().replace(/\s\s+/g," ").trim()}("".concat(e)):function(e){try{var t=[];return JSON.stringify(e,(function(e,n){return"function"===typeof n?"[Function]".concat((t=Object.keys(n)).length?" ...{".concat(t,"} "):""):n}))}catch(n){}}(e)||l()(e,(function(e,t){return t instanceof HTMLElement?"HTMLElement[".concat(t.nodeName,"]"):t}))}function g(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:50;return e.length<=t?e:"".concat(e.slice(0,t)," ...")}function x(e,t){var n,r={};return(n=e,Object.keys(n)).forEach((function(n){return r[n]=t(e[n])})),r}var b=function e(){var t=this;(0,s.Z)(this,e),(0,o.Z)(this,"resolve",null),(0,o.Z)(this,"reject",null),(0,o.Z)(this,"promise",new Promise((function(e,n){t.resolve=e,t.reject=n})))};function w(e){return Array.from(k(e))}function k(e){var t,n,r,s,o,u,l=arguments;return i().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:t=l.length>1&&void 0!==l[1]?l[1]:[],i.t0=null===e||void 0===e?void 0:e.constructor,i.next=i.t0===Object?4:12;break;case 4:n=0,r=Object.entries(e);case 5:if(!(n<r.length)){i.next=11;break}return s=(0,a.Z)(r[n],2),o=s[0],u=s[1],i.delegateYield(k(u,[].concat((0,c.Z)(t),[o])),"t1",8);case 8:n++,i.next=5;break;case 11:return i.abrupt("break",14);case 12:return i.next=14,t.join("/");case 14:case"end":return i.stop()}}),h)}},29950:function(e,t,n){"use strict";n.d(t,{VN:function(){return c},v8:function(){return l},ww:function(){return p},$r:function(){return f},nL:function(){return d},Wc:function(){return m}});var r=n(75392),i=n(83465),a=n.n(i),s=n(17473),o=n(86576);function c(e){return a()(e)}function u(e){var t,n,i;switch(e.type){case"ArithmCmd":case"ArithmExp":return[e.X];case"ArrayElem":return[].concat((0,r.Z)(e.Index?[e.Index]:[]),[e.Value]);case"ArrayExpr":return e.Elems;case"Assign":return[].concat((0,r.Z)(e.Array?[e.Array]:[]),(0,r.Z)(e.Index?[e.Index]:[]),(0,r.Z)(e.Value?[e.Value]:[]));case"BinaryArithm":case"BinaryCmd":case"BinaryTest":return[e.X,e.Y];case"Block":return e.Stmts;case"CStyleLoop":return[e.Cond,e.Init,e.Post];case"CallExpr":return[].concat(e.Args,e.Assigns);case"CaseClause":return[].concat(e.Items,e.Word);case"CaseItem":return[].concat(e.Patterns,e.Stmts);case"CmdSubst":return e.Stmts;case"Comment":return[];case"CoprocClause":return[e.Stmt];case"DblQuoted":return e.Parts;case"DeclClause":return[].concat(e.Args,e.Variant);case"ExtGlob":return[];case"File":return e.Stmts;case"ForClause":return[].concat((0,r.Z)(e.Do),[e.Loop]);case"FuncDecl":return[e.Body,e.Name];case"IfClause":return[].concat((0,r.Z)(e.Cond),(0,r.Z)(e.Then),(0,r.Z)(e.Else?[e.Else]:[]));case"LetClause":return e.Exprs;case"Lit":return[];case"ParamExp":return[].concat((0,r.Z)(null!==(t=e.Exp)&&void 0!==t&&t.Word?[e.Exp.Word]:[]),(0,r.Z)(e.Index?[e.Index]:[]),[e.Param],(0,r.Z)(e.Repl?[e.Repl.Orig]:[]),(0,r.Z)(null!==(n=e.Repl)&&void 0!==n&&n.With?[e.Repl.With]:[]),(0,r.Z)(e.Slice?[e.Slice.Offset]:[]),(0,r.Z)(null!==(i=e.Slice)&&void 0!==i&&i.Length?[e.Slice.Length]:[]));case"ParenArithm":case"ParenTest":return[e.X];case"ProcSubst":return e.Stmts;case"Redirect":return[].concat((0,r.Z)(e.Hdoc?[e.Hdoc]:[]),(0,r.Z)(e.N?[e.N]:[]),[e.Word]);case"SglQuoted":return[];case"Stmt":return[].concat((0,r.Z)(e.Cmd?[e.Cmd]:[]),(0,r.Z)(e.Redirs));case"Subshell":return e.Stmts;case"TestClause":return[e.X];case"TimeClause":return(0,r.Z)(e.Stmt?[e.Stmt]:[]);case"UnaryArithm":case"UnaryTest":return[e.X];case"WhileClause":return e.Cond.concat(e.Do);case"Word":return e.Parts;case"WordIter":return e.Items;default:throw(0,o.Ql)(e)}}function l(e,t){return{opts:h((0,s.Z)(e,t)),operands:e.filter((function(e){return"-"!==e[0]}))}}function h(e){var t=e;return Object.keys(e).forEach((function(n){t.__optKeys=[],"_"!==n&&(Array.isArray(e[n])&&(t[n]=(0,o.Z$)(e[n])),t.__optKeys.push(n))})),t}function p(e,t){t(e),u(e).forEach((function(e){return p(e,t)}))}function f(e){return p(e,(function(e){u(e).forEach((function(t){return t.parent=e}))})),e}function d(e){return{type:"File",Stmts:"Stmt"===e.type?[e]:e.Stmts,meta:e.meta}}function m(e){return e.Else?[e].concat((0,r.Z)(m(e.Else))):[e]}},96082:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return On}});var r=n(88823),i=n(22200),a=n(52209),s=n(88269);function o(){var e=(0,a.Z)(["\n  border: none;\n  margin: 24px;\n\n  @media(max-width: 600px) {\n    margin: 0px;\n  }\n"]);return o=function(){return e},e}function c(){return(0,r.tZ)("hr",{className:u})}var u=(0,s.iv)(o()),l=n(70704),h=n(52542),p=n(59748),f=n(86352),d=n(94184),m=n.n(d),v=n(57501),y=n(75392),g=n(68216),x=n(25997),b=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;(0,g.Z)(this,e),this.x=t,this.y=n}return(0,x.Z)(e,[{key:"add",value:function(e){var t=e.x,n=e.y;return this.translate(t,n)}},{key:"addScaledVector",value:function(e,t){return this.x+=e.x*t,this.y+=e.y*t,this}},{key:"clone",value:function(){return new e(this.x,this.y)}},{key:"copy",value:function(e){return this.set(e.x,e.y)}},{key:"distanceTo",value:function(e){return Math.hypot(e.x-this.x,e.y-this.y)}},{key:"distanceToSquared",value:function(e){return Math.pow(e.x-this.x,2)+Math.pow(e.y-this.y,2)}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y}},{key:"equals",value:function(e){var t=e.x,n=e.y;return this.x===t&&this.y===n}},{key:"normalize",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return this.length?this.scale(e/this.length):(console.error("Cannot normalize Vect '".concat(this,"' to length '").concat(e,"'")),this)}},{key:"precision",value:function(e){return this.set(Number(this.x.toFixed(e)),Number(this.y.toFixed(e)))}},{key:"rotate",value:function(e){var t=[this.x,this.y],n=t[0],r=t[1];return this.x=Math.cos(e)*n-Math.sin(e)*r,this.y=Math.sin(e)*n+Math.cos(e)*r,this}},{key:"round",value:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},{key:"scale",value:function(e){return this.x*=e,this.y*=e,this}},{key:"set",value:function(e,t){return this.x=e,this.y=t,this}},{key:"sub",value:function(e){var t=e.x,n=e.y;return this.translate(-t,-n)}},{key:"subVectors",value:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}},{key:"toString",value:function(){return"".concat(this.x,",").concat(this.y)}},{key:"translate",value:function(e,t){return this.x+=e,this.y+=t,this}},{key:"angle",get:function(){return Math.atan2(this.y,this.x)}},{key:"coord",get:function(){return[this.x,this.y]}},{key:"json",get:function(){return{x:this.x,y:this.y}}},{key:"length",get:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}},{key:"lengthSquared",get:function(){return this.x*this.x+this.y*this.y}}],[{key:"average",value:function(t){return t.length?t.reduce((function(e,t){return e.add(t)}),e.zero).scale(1/t.length):e.zero}},{key:"from",value:function(t){return Array.isArray(t)?new e(t[0],t[1]):new e(t.x,t.y)}},{key:"zero",get:function(){return new e(0,0)}}]),e}(),w=function(){function e(t,n,r,i){(0,g.Z)(this,e),this.x=t,this.y=n,this.width=r,this.height=i}return(0,x.Z)(e,[{key:"applyMatrix",value:function(e){if(!e.isIdentity){var t=e.transformPoint(this.topLeft),n=e.transformPoint(this.bottomRight);this.x=Math.min(t.x,n.x),this.y=Math.min(t.y,n.y),this.width=Math.max(t.x,n.x)-this.x,this.height=Math.max(t.y,n.y)-this.y}return this}},{key:"clone",value:function(){return new e(this.x,this.y,this.width,this.height)}},{key:"contains",value:function(e){var t=e.x,n=e.y;return this.x<=t&&t<=this.x+this.width&&this.y<=n&&n<=this.y+this.height}},{key:"copy",value:function(e){var t=e.x,n=e.y,r=e.width,i=e.height;return this.x=t,this.y=n,this.width=r,this.height=i,this}},{key:"covers",value:function(e){var t=e.x,n=e.y,r=e.width,i=e.height;return this.x<=t&&t+r<=this.x+this.width&&this.y<=n&&n+i<=this.y+this.height}},{key:"delta",value:function(e,t){return this.x+=e,this.y+=t,this}},{key:"inset",value:function(e){var t=[this.cx,this.cy],n=t[0],r=t[1];this.outset(-e),this.width<0&&(this.x=n,this.width=0),this.height<0&&(this.y=r,this.height=0)}},{key:"intersects",value:function(e){return 2*Math.abs(this.cx-e.cx)<=this.width+e.width&&2*Math.abs(this.cy-e.cy)<=this.height+e.height}},{key:"offset",value:function(e){var t=e.x,n=e.y;return this.x+=t,this.y+=n,this}},{key:"outset",value:function(e){return this.x-=e,this.y-=e,this.width+=2*e,this.height+=2*e,this}},{key:"scale",value:function(e){return this.x*=e,this.y*=e,this.width*=e,this.height*=e,this}},{key:"setPosition",value:function(e){return this.x=e.x,this.y=e.y,this}},{key:"toString",value:function(){return"".concat(this.x,",").concat(this.y,",").concat(this.width,",").concat(this.height)}},{key:"area",get:function(){return this.width*this.height}},{key:"bottom",get:function(){return this.y+this.height}},{key:"bottomLeft",get:function(){return new b(this.x,this.y+this.height)}},{key:"bottomRight",get:function(){return new b(this.x+this.width,this.y+this.height)}},{key:"center",get:function(){return new b(this.cx,this.cy)}},{key:"cx",get:function(){return this.x+.5*this.width}},{key:"cy",get:function(){return this.y+.5*this.height}},{key:"geoJson",get:function(){return{type:"Polygon",coordinates:[[[this.x,this.y],[this.x+this.width,this.y],[this.x+this.width,this.y+this.height],[this.x,this.y+this.height]]]}}},{key:"json",get:function(){return{x:this.x,y:this.y,width:this.width,height:this.height}}},{key:"key",get:function(){return"".concat(this.x,",").concat(this.y,",").concat(this.width,",").concat(this.height)}},{key:"dimension",get:function(){return Math.max(this.width,this.height)}},{key:"points",get:function(){return[new b(this.x,this.y),new b(this.x,this.y+this.height),new b(this.x+this.width,this.y+this.height),new b(this.x+this.width,this.y)]}},{key:"right",get:function(){return this.x+this.width}},{key:"topLeft",get:function(){return new b(this.x,this.y)}},{key:"topRight",get:function(){return new b(this.x+this.width,this.y)}}],[{key:"from",value:function(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];if(n.length){if(n[0]instanceof b){var i=n,a=Math.min.apply(Math,(0,y.Z)(i.map((function(e){return e.x})))),s=Math.min.apply(Math,(0,y.Z)(i.map((function(e){return e.y})))),o=Math.max.apply(Math,(0,y.Z)(i.map((function(e){return e.x})))),c=Math.max.apply(Math,(0,y.Z)(i.map((function(e){return e.y}))));return new e(a,s,o-a,c-s)}var u=n,l=Math.min.apply(Math,(0,y.Z)(u.map((function(e){return e.x})))),h=Math.min.apply(Math,(0,y.Z)(u.map((function(e){return e.y})))),p=Math.max.apply(Math,(0,y.Z)(u.map((function(e){return e.x+e.width})))),f=Math.max.apply(Math,(0,y.Z)(u.map((function(e){return e.y+e.height}))));return new e(l,h,p-l,f-h)}return e.zero}},{key:"fromJson",value:function(t){return new e(t.x,t.y,t.width,t.height)}},{key:"zero",get:function(){return new e(0,0,0,0)}}]),e}(),k=n(92809),Z=n(17120),S=n(90831),P=n(32676),C=n(9187),R=n.n(C);function O(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}var j,E=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];(0,g.Z)(this,e),this.outline=t,this.holes=n}return(0,x.Z)(e,[{key:"add",value:function(e){return this.translate(e.x,e.y)}},{key:"addMeta",value:function(e){return this.meta=Object.assign(this.meta||{},e),this}},{key:"applyMatrix",value:function(e){return e.isIdentity||(this.outline=this.outline.map((function(t){return e.transformPoint(t)})),this.holes.forEach((function(t){return t.map((function(t){return e.transformPoint(t)}))}))),this}},{key:"cleanFinalReps",value:function(){for(var e=0,t=[this.outline].concat((0,y.Z)(this.holes));e<t.length;e++){var n=t[e],r=n.pop();r&&!r.equals(n[0])&&n.push(r)}return this}},{key:"clone",value:function(){return new e(this.outline.map((function(e){return e.clone()})),this.holes.map((function(e){return e.map((function(e){return e.clone()}))})))}},{key:"createInset",value:function(t){var n;if(0===t)return[this.clone()];var r=[{ring:this.outline,inset:e.insetRing(this.outline,t)}].concat((0,y.Z)(this.holes.map((function(n){return{ring:n,inset:e.insetRing(n,t)}})))).map((function(t){var n=t.ring,r=t.inset;return n.map((function(t,i){return new e([n[i].clone(),r[i],r[(i+1)%n.length],n[(i+1)%n.length].clone()])}))})),i=(0,Z.Z)(r),a=i[0],s=i.slice(1);return t>0?e.cutOut(a.concat.apply(a,(0,y.Z)(s)),[this.clone()]):e.union((n=[this.clone()]).concat.apply(n,[a].concat((0,y.Z)(s))))}},{key:"createOutset",value:function(e){return this.createInset(-e)}},{key:"fastTriangulate",value:function(){var e=this.geoJson.coordinates,t=R().flatten(e),n=R()(t.vertices,t.holes,2),r=n.reduce((function(e,t,r){return r%3===2?e.concat([[n[r-2],n[r-1],t]]):e}),[]);return{vs:this.allPoints,tris:r}}},{key:"qualityTriangulate",value:function(){try{var e=this.outline.map((function(e,t){return{x:e.x,y:e.y,id:t}})),t=e.length,n=this.holes.map((function(e){return e.map((function(e){return{x:e.x,y:e.y,id:t++}}))})),r=new S.SweepContext(e).addHoles(n).triangulate().getTriangles().map((function(e){return[e.getPoint(0),e.getPoint(1),e.getPoint(2)]})).map((function(e){var t=(0,v.Z)(e,3),n=t[0],r=t[1],i=t[2];return[n.id,r.id,i.id]}));return{vs:this.allPoints,tris:r}}catch(i){return console.error("Quality triangulation failed, falling back to earcut"),console.error(i),this.fastTriangulate()}}},{key:"precision",value:function(e){return this.outline.forEach((function(t){return t.precision(e)})),this.holes.forEach((function(t){return t.forEach((function(t){return t.precision(e)}))})),this}},{key:"removeHoles",value:function(){return this.holes=[],this}},{key:"round",value:function(){return this.outline.forEach((function(e){return e.round()})),this.holes.forEach((function(e){return e.forEach((function(e){return e.round()}))})),this}},{key:"scale",value:function(e){return this.outline.forEach((function(t){return t.scale(e)})),this.holes.forEach((function(t){return t.forEach((function(t){return t.scale(e)}))})),this}},{key:"translate",value:function(e,t){return this.outline.forEach((function(n){return n.translate(e,t)})),this.holes.forEach((function(n){return n.forEach((function(n){return n.translate(e,t)}))})),this}},{key:"allPoints",get:function(){var e;return(e=this.outline).concat.apply(e,(0,y.Z)(this.holes))}},{key:"geoJson",get:function(){return function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?O(Object(n),!0).forEach((function(t){(0,k.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):O(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({type:"Polygon",coordinates:[this.outline.map((function(e){return[e.x,e.y]}))].concat(this.holes.map((function(e){return e.map((function(e){return[e.x,e.y]}))})))},this.meta&&{meta:this.meta})}},{key:"rect",get:function(){return w.from.apply(w,(0,y.Z)(this.outline))}},{key:"svgPath",get:function(){return[this.outline].concat((0,y.Z)(this.holes)).map((function(e){return"M".concat(e,"Z")})).join(" ")}},{key:"tangents",get:function(){var e=[this.outline].concat((0,y.Z)(this.holes)).map((function(e){return e.concat(e[0]).reduce((function(e,t,n,r){return n>0?e.concat(t.clone().sub(r[n-1]).normalize()):[]}),[])})),t=(0,Z.Z)(e);return{outer:t[0],inner:t.slice(1)}}}],[{key:"cutOut",value:function(t,n){return P.difference.apply(P,[n.map((function(e){return e.geoJson.coordinates}))].concat((0,y.Z)(t.map((function(e){return e.geoJson.coordinates}))))).map((function(t){return e.from(t).cleanFinalReps()}))}},{key:"from",value:function(t){return t instanceof Array?new e(t[0].map((function(e){var t=(0,v.Z)(e,2),n=t[0],r=t[1];return new b(n,r)})),t.slice(1).map((function(e){return e.map((function(e){var t=(0,v.Z)(e,2),n=t[0],r=t[1];return new b(n,r)}))}))):new e(t.coordinates[0].map((function(e){var t=(0,v.Z)(e,2),n=t[0],r=t[1];return new b(n,r)})),t.coordinates.slice(1).map((function(e){return e.map((function(e){var t=(0,v.Z)(e,2),n=t[0],r=t[1];return new b(n,r)}))})))}},{key:"fromRect",value:function(t){return new e(t.points)}},{key:"getLinesIntersection",value:function(e,t,n,r){var i=t.x,a=t.y,s=e.x,o=e.y,c=r.x,u=r.y,l=n.x,h=n.y;return Math.abs(-a*c+i*u)<1e-4?null:(c*(h-o)-u*(l-s))/(a*c-u*i)}},{key:"insetRing",value:function(t,n){var r=new e(t).tangents.outer,i=t.map((function(e,i){return[e.clone().translate(n*-r[i].y,n*r[i].x),t[(i+1)%t.length].clone().translate(n*-r[i].y,n*r[i].x)]}));return i.map((function(t,n){var a=(n+1)%i.length,s=i[a],o=e.getLinesIntersection(t[1],r[n],s[0],r[a]);return o?t[1].translate(o*r[n].x,o*r[n].y):b.average([t[1],s[0]])}))}},{key:"pointInTriangle",value:function(t,n,r,i){var a=e.sign(t,n,r),s=e.sign(t,r,i),o=e.sign(t,i,n);return!((a<0||s<0||o<0)&&(a>0||s>0||o>0))}},{key:"sign",value:function(e,t,n){return(e.x-n.x)*(t.y-n.y)-(t.x-n.x)*(e.y-n.y)}},{key:"union",value:function(t){return P.union.apply(P,[[]].concat((0,y.Z)(t.map((function(e){return e.geoJson.coordinates}))))).map((function(t){return e.from(t).cleanFinalReps()}))}}]),e}(),D=function(){function e(t){return(0,g.Z)(this,e),this.a=1,this.b=0,this.c=0,this.d=1,this.e=0,this.f=0,this.setMatrixValue(t)}return(0,x.Z)(e,[{key:"setIdentity",value:function(){this.a=1,this.b=0,this.c=0,this.d=1,this.e=0,this.f=0}},{key:"setMatrixValue",value:function(e){if("string"===typeof e){var t=e.slice("matrix(".length,-")".length).split(",").map(Number);return this.feedFromArray(t)}return e?Array.isArray(e)?this.feedFromArray([this.a,this.b,this.c,this.d,this.e,this.f]):this.feedFromArray([e.a,e.b,e.c,e.d,e.e,e.f]):this}},{key:"transformPoint",value:function(e){var t=this.a*e.x+this.c*e.y+this.e,n=this.b*e.x+this.d*e.y+this.f;return e.x=t,e.y=n,e}},{key:"feedFromArray",value:function(e){var t=(0,v.Z)(e,6),n=t[0],r=t[1],i=t[2],a=t[3],s=t[4],o=t[5];return this.a=n,this.b=r,this.c=i,this.d=a,this.e=s,this.f=o,this}},{key:"isIdentity",get:function(){return 1===this.a&&0===this.b&&0===this.c&&1===this.d&&0===this.e&&0===this.f}}]),e}();n(70956);function T(e,t){var n;if("undefined"===typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"===typeof e)return A(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return A(e,t)}(e))||t&&e&&"number"===typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,o=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return s=e.done,e},e:function(e){o=!0,a=e},f:function(){try{s||null==n.return||n.return()}finally{if(o)throw a}}}}function A(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function M(e){var t,n,r;return(j=j||(null===(t=_(e))||void 0===t?void 0:t.createSVGPoint())).x=e.clientX,j.y=e.clientY,j.matrixTransform(null===(n=_(e))||void 0===n||null===(r=n.getScreenCTM())||void 0===r?void 0:r.inverse())}function _(e){var t;return null===(t=e.target)||void 0===t?void 0:t.ownerSVGElement}var I="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0;function V(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];t.length&&(e.moveTo(t[0].x,t[0].y),t.forEach((function(t){return e.lineTo(t.x,t.y)})),n&&e.fill(),e.closePath())}function N(e,t){e.beginPath();var n,r=T(t);try{for(r.s();!(n=r.n()).done;){var i=n.value;V(e,i.outline,!1);var a,s=T(i.holes);try{for(s.s();!(a=s.n()).done;){V(e,a.value,!1)}}catch(o){s.e(o)}finally{s.f()}e.fill()}}catch(o){r.e(o)}finally{r.f()}}var B=0;var L=n(809),z=n.n(L),K=n(30266),W=function(){function e(){(0,g.Z)(this,e),this.bjsRECAST={},this.lookup={},this.readyResolvers=[]}return(0,x.Z)(e,[{key:"ready",value:function(){var e=(0,K.Z)(z().mark((function e(){var t=this;return z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.bjsRECAST.NavMesh){e.next=2;break}return e.abrupt("return",new Promise((function(e){t.readyResolvers.push(e)})));case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"initialize",value:function(e){if(e(this.bjsRECAST),!this.bjsRECAST.NavMesh)return console.error("RecastJS is not available. Please make sure you included the js file.");for(;this.readyResolvers.length;){var t;null===(t=this.readyResolvers.pop())||void 0===t||t()}}},{key:"clearNavMesh",value:function(e){var t;null===(t=this.lookup[e])||void 0===t||t.destroy(),delete this.lookup[e]}},{key:"createNavMesh",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=Object.assign({},G,n),i=new this.bjsRECAST.rcConfig;i.cs=r.cs,i.ch=r.ch,i.borderSize=r.borderSize,i.tileSize=0,i.walkableSlopeAngle=r.walkableSlopeAngle,i.walkableHeight=r.walkableHeight,i.walkableClimb=r.walkableClimb,i.walkableRadius=r.walkableRadius,i.maxEdgeLen=r.maxEdgeLen,i.maxSimplificationError=r.maxSimplificationError,i.minRegionArea=r.minRegionArea,i.mergeRegionArea=r.mergeRegionArea,i.maxVertsPerPoly=r.maxVertsPerPoly,i.detailSampleDist=r.detailSampleDist,i.detailSampleMaxError=r.detailSampleMaxError;var a=new this.bjsRECAST.NavMesh,s=this.lookup[e];this.lookup[e]=a;var o=t.vs.flatMap((function(e){return[e.x,0,e.y]})),c=t.vs.length,u=t.tris.flatMap((function(e){return e}));console.info("recast: building:",e),a.build(o,c,u,u.length,i),console.info("recast: built:",e),null===s||void 0===s||s.destroy()}},{key:"getDebugTriangulation",value:function(e){if(!this.lookup[e])return{vs:[],tris:[]};var t,n,r=this.lookup[e].getDebugNavMesh(),i=r.getTriangleCount(),a=[],s=[];for(t=0;t<3*i;t+=3)a.push([t,t+1,t+2]);for(t=0;t<i;t++)for(n=0;n<3;n++){var o=r.getTriangle(t).getPoint(n);s.push(new b(o.x,o.z))}return{vs:s,tris:a}}},{key:"getClosestPoint",value:function(e,t){var n=new this.bjsRECAST.Vec3(t.x,0,t.y),r=this.lookup[e].getClosestPoint(n);return{x:r.x,y:r.z}}},{key:"getClosestPointToRef",value:function(e,t,n){var r=new this.bjsRECAST.Vec3(t.x,0,t.y),i=this.lookup[e].getClosestPoint(r);n.x=i.x,n.y=i.z}},{key:"getRandomPointAround",value:function(e,t,n){var r=new this.bjsRECAST.Vec3(t.x,0,t.y),i=this.lookup[e].getRandomPointAround(r,n);return{x:i.x,y:i.z}}},{key:"getRandomPointAroundToRef",value:function(e,t,n,r){var i=new this.bjsRECAST.Vec3(t.x,0,t.y),a=this.lookup[e].getRandomPointAround(i,n);r.x=a.x,r.y=a.z}},{key:"moveAlong",value:function(e,t,n){var r=new this.bjsRECAST.Vec3(t.x,0,t.y),i=new this.bjsRECAST.Vec3(n.x,0,n.y),a=this.lookup[e].moveAlong(r,i);return{x:a.x,y:a.z}}},{key:"moveAlongToRef",value:function(e,t,n,r){var i=new this.bjsRECAST.Vec3(t.x,0,t.y),a=new this.bjsRECAST.Vec3(n.x,0,n.y),s=this.lookup[e].moveAlong(i,a);r.x=s.x,r.y=s.z}},{key:"computePath",value:function(e,t,n){if(!this.lookup[e])return console.warn("navmesh: ".concat(e,": not found")),[];var r,i=new this.bjsRECAST.Vec3(t.x,0,t.y),a=new this.bjsRECAST.Vec3(n.x,0,n.y),s=this.lookup[e].computePath(i,a),o=s.getPointCount(),c=[];for(r=0;r<o;r++){var u=s.getPoint(r);c.push(new b(u.x,u.z))}return c}},{key:"setDefaultQueryExtent",value:function(e,t){var n=new this.bjsRECAST.Vec3(t.x,0,t.y);this.lookup[e].setDefaultQueryExtent(n)}},{key:"getDefaultQueryExtent",value:function(e){var t=this.lookup[e].getDefaultQueryExtent();return{x:t.x,y:t.z}}},{key:"buildFromNavmeshData",value:function(e,t){var n=t.length*t.BYTES_PER_ELEMENT,r=this.bjsRECAST._malloc(n),i=new Uint8Array(this.bjsRECAST.HEAPU8.buffer,r,n);i.set(t);var a=new this.bjsRECAST.NavmeshData;a.dataPointer=i.byteOffset,a.size=t.length,this.lookup[e]=new this.bjsRECAST.NavMesh,this.lookup[e].buildFromNavmeshData(a),this.bjsRECAST._free(i.byteOffset)}},{key:"getNavmeshData",value:function(e){var t=this.lookup[e].getNavmeshData(),n=new Uint8Array(this.bjsRECAST.HEAPU8.buffer,t.dataPointer,t.size),r=new Uint8Array(t.size);return r.set(n),this.lookup[e].freeNavmeshData(t),r}},{key:"getDefaultQueryExtentToRef",value:function(e,t){var n=this.lookup[e].getDefaultQueryExtent();t.x=n.x,t.y=n.z}},{key:"dispose",value:function(){this.lookup={}}}]),e}(),G={borderSize:0,cs:1,ch:1,walkableSlopeAngle:0,walkableHeight:10,walkableClimb:10,walkableRadius:0,maxEdgeLen:12,maxSimplificationError:.1,minRegionArea:10,mergeRegionArea:20,maxVertsPerPoly:6,detailSampleDist:10,detailSampleMaxError:.1};"undefined"!==typeof self&&Promise.all([n.e(593),n.e(317)]).then(n.t.bind(n,67362,23)).then((function(e){F.initialize(e.default)}));var F=new W;function J(e,t){var n;if("undefined"===typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"===typeof e)return $(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return $(e,t)}(e))||t&&e&&"number"===typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,o=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return s=e.done,e},e:function(e){o=!0,a=e},f:function(){try{s||null==n.return||n.return()}finally{if(o)throw a}}}}function $(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var U=new(function(){function e(){(0,g.Z)(this,e)}return(0,x.Z)(e,[{key:"createNavMesh",value:function(){var e=(0,K.Z)(z().mark((function e(t,n,r){var i;return z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,F.ready();case 2:n.length?(i=this.polysToTriangulation(n),F.createNavMesh(t,i,r)):F.clearNavMesh(t);case 3:case"end":return e.stop()}}),e,this)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"requestNavPath",value:function(e,t,n){try{var r=F.computePath(e,t,n);return this.removePathReps(r.map((function(e){return e.precision(1)})))}catch(i){return console.error("nav error",i),[]}}},{key:"joinTriangulations",value:function(e){if(1===e.length)return e[0];var t,n=[],r=[],i=0,a=J(e);try{for(a.s();!(t=a.n()).done;){var s=t.value;n.push.apply(n,(0,y.Z)(s.vs)),r.push.apply(r,(0,y.Z)(s.tris.map((function(e){return e.map((function(e){return e+i}))})))),i+=s.vs.length}}catch(o){a.e(o)}finally{a.f()}return{vs:n,tris:r}}},{key:"polysToTriangulation",value:function(e){var t=e.map((function(e){return e.qualityTriangulate()}));return this.joinTriangulations(t)}},{key:"removePathReps",value:function(e){var t;return e.reduce((function(e,n){return t&&n.x===t.x&&n.y===t.y||e.push(t=n),e}),[])}}]),e}());function H(){var e=(0,a.Z)(["\n        width: 100%;\n        height: 100%;\n        touch-action: pan-x pan-y pinch-zoom;\n        > g.content {\n          shape-rendering: ",";\n        }\n      "]);return H=function(){return e},e}function X(e){var t=p.useState((function(){var t=e.initViewBox.clone(),r=e.minZoom||.5,i=e.maxZoom||2;return{viewBox:t,panFrom:null,zoom:e.initZoom||1,ptrEvent:[],ptrDiff:null,zoomTo:function(a,s){var o=Math.min(Math.max(n.zoom+s,r),i);t.x=n.zoom/o*(t.x-a.x)+a.x,t.y=n.zoom/o*(t.y-a.y)+a.y,t.width=1/o*e.initViewBox.width,t.height=1/o*e.initViewBox.height,n.zoom=o},onWheel:function(e){e.preventDefault();var t=M(e);n.zoomTo(t,-.003*e.deltaY),n.root.setAttribute("viewBox","".concat(n.viewBox))},onPointerDown:function(e){n.panFrom=(new b).copy(M(e)),n.ptrEvent.push(e)},onPointerMove:function(e){if(n.ptrEvent=n.ptrEvent.map((function(t){return t.pointerId===e.pointerId?e:t})),2===n.ptrEvent.length){var r=Math.abs(n.ptrEvent[1].clientX-n.ptrEvent[0].clientX);if(null!==n.ptrDiff){var i=function(e){var t,n,r;return(j=j||(null===(t=_(e[0]))||void 0===t?void 0:t.createSVGPoint())).x=j.y=0,e.forEach((function(e){j.x+=e.clientX,j.y+=e.clientY})),j.x/=e.length||1,j.y/=e.length||1,j.matrixTransform(null===(n=_(e[0]))||void 0===n||null===(r=n.getScreenCTM())||void 0===r?void 0:r.inverse())}(n.ptrEvent);n.zoomTo(i,.02*(r-n.ptrDiff)),n.root.setAttribute("viewBox","".concat(n.viewBox))}n.ptrDiff=r}else if(n.panFrom){var a=M(e);t.delta(n.panFrom.x-a.x,n.panFrom.y-a.y),n.root.setAttribute("viewBox","".concat(n.viewBox))}},onPointerUp:function(e){n.panFrom=null,n.ptrEvent=n.ptrEvent.filter((function(t){return e.pointerId!==t.pointerId})),n.ptrEvent.length<2&&(n.ptrDiff=null)},rootRef:function(e){e&&(n.root=e,e.addEventListener("wheel",n.onWheel),e.addEventListener("pointerdown",n.onPointerDown,{passive:!0}),e.addEventListener("pointermove",n.onPointerMove,{passive:!0}),e.addEventListener("pointerup",n.onPointerUp,{passive:!0}),e.addEventListener("pointercancel",n.onPointerUp,{passive:!0}),e.addEventListener("pointerleave",n.onPointerUp,{passive:!0}),e.addEventListener("touchstart",(function(e){return e.preventDefault()})))},root:{},rootCss:(0,s.iv)(H(),I?"optimizeSpeed":"auto")}})),n=(0,v.Z)(t,1)[0];return(0,r.BX)("svg",{ref:n.rootRef,className:n.rootCss,preserveAspectRatio:"xMinYMin",viewBox:"".concat(n.viewBox),children:[(0,r.tZ)(q,{bounds:e.gridBounds}),(0,r.tZ)("g",{className:"content",children:e.children})]})}function q(e){var t=p.useMemo((function(){return"".concat("grid-").concat(B++)}),[]);return(0,r.BX)(r.HY,{children:[(0,r.tZ)("defs",{children:(0,r.tZ)("pattern",{id:t,width:"10",height:"10",patternUnits:"userSpaceOnUse",children:(0,r.tZ)("path",{d:"M 10 0 L 0 0 0 10",fill:"none",stroke:"rgba(0,0,0,0.5)",strokeWidth:"0.3"})})}),(0,r.tZ)("rect",{x:e.bounds.x,y:e.bounds.y,width:e.bounds.width,height:e.bounds.height,fill:"url(#".concat(t,")")})]})}function Y(){var e=(0,a.Z)(["\n  display: flex;\n  flex-direction: column;\n  height: 100%;\n\n  > p {\n    padding: 12px 8px;\n    margin: 0;\n    font-family: monospace;\n    font-size: 16px;\n    background: #eee;\n  }\n"]);return Y=function(){return e},e}var Q=new w(-5e3,-5e3,10001,10001),ee=new w(0,0,200,200),te=(0,s.iv)(Y()),ne=n(88767),re=new E((0,y.Z)(Array(8)).map((function(e,t){return new b(Math.cos(2*Math.PI*(1/16+t/8)),Math.sin(2*Math.PI*(1/16+t/8)))}))).scale(50).round(),ie=E.cutOut([re],[re.clone().scale(1.5)]),ae=(0,v.Z)(ie,1)[0],se=E.union([ae,ae.clone().translate(ae.rect.width-20,0)]),oe=(0,v.Z)(se,1)[0];function ce(){var e=(0,a.Z)(["\n  border: 1px solid #555555;\n  height: inherit;\n\n  path.walls {\n    fill: #000;\n  }\n  path.floor {\n    cursor: crosshair;\n    fill: white;\n    stroke:none;\n  }\n  g.dots circle {\n    cursor: crosshair;\n    fill: #ddd;\n    stroke: black;\n    stroke-width: 0.5;\n\n    &.selected {\n      fill: red;\n    }\n  }\n  polygon.triangle {\n    pointer-events: none;\n    fill: none;\n    stroke: #bbb;\n    stroke-width: 0.5;\n  }\n  polyline.navpath {\n    fill: none;\n    stroke: #800;\n    stroke-width: 1;\n    stroke-dasharray: 4 4;\n  }\n"]);return ce=function(){return e},e}oe.round();var ue=function(e){var t;return(0,r.tZ)("g",{children:null===(t=e.tris)||void 0===t?void 0:t.map((function(e,t){return(0,r.tZ)("polygon",{className:"triangle",points:"".concat(e)},t)}))})},le=p.default.memo(ue),he=new w(-5e3,-5e3,10001,10001),pe=new w(0,0,200,200),fe="fig-of-8",de=oe.clone().translate(100,100),me=de.createOutset(6),ve=(0,v.Z)(me,1)[0],ye=(0,s.iv)(ce());n(77503);function ge(e){return Object.values(e).reduce((function(e,t){return(e[t.key]={key:(n=t).key,doors:n.doors.map(E.from),labels:n.labels.map(E.from),obstacles:n.obstacles.map(E.from),walls:n.walls.map(E.from),meta:n.meta})&&e;var n}),{})}function xe(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function be(){var e=(0,a.Z)(["\n  height: 100%;\n  image.debug {\n    opacity: 0.3;\n  }\n  image.symbol {\n    transform: scale(0.2);\n  }\n"]);return be=function(){return e},e}var we=new w(0,0,1200,600),ke=new w(-5e3,-5e3,10001,10001),Ze=(0,s.iv)(be());var Se={key:"g-301--bridge",id:301,items:[{symbol:"301--hull",tags:["doors"]},{symbol:"misc-stellar-cartography--023--4x4",transform:[-1,0,0,1,1200,360]},{symbol:"stateroom--014--2x2",transform:[1,0,0,-1,0,480]},{symbol:"stateroom--014--2x2",transform:[1,0,0,-1,120,480]},{symbol:"office--001--2x2",transform:[-1,0,0,1,240,120],tags:["door-s"]},{symbol:"office--001--2x2",transform:[1,0,0,1,960,120],tags:["door-s"]},{symbol:"stateroom--036--2x4"},{symbol:"stateroom--036--2x4",transform:[-1,0,0,1,1200,0]},{symbol:"stateroom--036--2x4",transform:[0,-1,1,0,0,600]},{symbol:"bridge--042--8x9",transform:[1,0,0,1,360,60]},{symbol:"iris-valves--005--1x1",transform:[0,-1,1,0,0,360]},{symbol:"iris-valves--005--1x1",transform:[0,1,1,0,1140,240]},{symbol:"iris-valves--005--1x1",transform:[-1,0,0,1,360,540]},{symbol:"iris-valves--005--1x1",transform:[-1,0,0,1,960,540]},{symbol:"console--031--1x1.2",transform:[-1,0,0,1,360,60]},{symbol:"console--031--1x1.2",transform:[1,0,0,1,840,60]}]};var Pe=(0,K.Z)(z().mark((function e(){var t,r,i,a=arguments;return z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=WebAssembly.validate(new Uint8Array([0,97,115,109,1,0,0,0,1,5,1,96,0,1,123,3,2,1,0,10,10,1,8,0,65,0,253,15,253,98,11])),e.next=3,t?n.e(912).then(n.bind(n,46912)):n.e(646).then(n.bind(n,69646));case 3:return r=e.sent,i=r.default,e.next=7,i.apply(void 0,a);case 7:return e.abrupt("return",e.sent);case 8:case"end":return e.stop()}}),e)})));var Ce=new w(-5e3,-5e3,10001,10001),Re=new w(0,0,200,200),Oe={"panzoom/PanZoom.jsx":"import * as React from 'react';\nimport { css } from 'goober';\nimport { Vect, Rect } from '../geom';\nimport { getSvgPos, getSvgMid, generateId, canTouchDevice } from '../service';\n\n/** @param {React.PropsWithChildren<Props>} props */\nexport default function PanZoom(props) {\n\n  const [state] = React.useState(() => {\n    const viewBox = props.initViewBox.clone();\n    const minZoom = props.minZoom || 0.5;\n    const maxZoom = props.maxZoom || 2;\n    return {\n      viewBox,\n      /** @type {null | Vect} */\n      panFrom: null,\n      zoom: props.initZoom || 1,\n      /** @type {PointerEvent[]} */\n      ptrEvent: [],\n      /** @type {null | number} */\n      ptrDiff: null,\n      /**\n       * @param {DOMPoint} point \n       * @param {number} delta \n       */\n      zoomTo: (point, delta) => {\n        const zoom = Math.min(Math.max(state.zoom + delta, minZoom), maxZoom);\n        viewBox.x = (state.zoom / zoom) * (viewBox.x - point.x) + point.x;\n        viewBox.y = (state.zoom / zoom) * (viewBox.y - point.y) + point.y;\n        viewBox.width = (1 / zoom) * props.initViewBox.width;\n        viewBox.height = (1 / zoom) * props.initViewBox.height;\n        state.zoom = zoom;\n      },\n      /** @param {WheelEvent} e */\n      onWheel: e => {\n        e.preventDefault();\n        const point = getSvgPos(e);\n        state.zoomTo(point, -0.003 * e.deltaY);\n        state.root.setAttribute('viewBox', `${state.viewBox}`);\n      },\n      /** @param {PointerEvent} e */\n      onPointerDown: e => {\n        state.panFrom = (new Vect).copy(getSvgPos(e));\n        state.ptrEvent.push(e);\n      },\n      /** @param {PointerEvent} e */\n      onPointerMove: e => {\n        state.ptrEvent = state.ptrEvent.map(x => x.pointerId === e.pointerId ? e : x);\n\n        if (state.ptrEvent.length === 2) {\n          const ptrDiff = Math.abs(state.ptrEvent[1].clientX - state.ptrEvent[0].clientX);\n          if (state.ptrDiff !== null) {\n            const point = getSvgMid(state.ptrEvent);\n            state.zoomTo(point, 0.02 * (ptrDiff - state.ptrDiff));\n            state.root.setAttribute('viewBox', `${state.viewBox}`);\n          }          \n          state.ptrDiff = ptrDiff;\n        } else if (state.panFrom) {\n          const mouse = getSvgPos(e);\n          viewBox.delta(state.panFrom.x - mouse.x, state.panFrom.y - mouse.y);\n          state.root.setAttribute('viewBox', `${state.viewBox}`);\n        }\n      },\n      /** @param {PointerEvent} e */\n      onPointerUp: (e) => {\n        state.panFrom = null;\n        state.ptrEvent = state.ptrEvent.filter(alt => e.pointerId !== alt.pointerId);\n        if (state.ptrEvent.length < 2) {\n          state.ptrDiff = null;\n        }\n      },\n      /** @type {(el: null | SVGSVGElement) => void} */\n      rootRef: el => {\n        if (el) {\n          state.root = el;\n          el.addEventListener('wheel', state.onWheel);\n          el.addEventListener('pointerdown', state.onPointerDown, { passive: true });\n          el.addEventListener('pointermove', state.onPointerMove, { passive: true });\n          el.addEventListener('pointerup', state.onPointerUp, { passive: true });\n          el.addEventListener('pointercancel', state.onPointerUp, { passive: true });\n          el.addEventListener('pointerleave', state.onPointerUp, { passive: true });\n          el.addEventListener('touchstart', e => e.preventDefault());\n        }\n      },\n      /** @type {SVGSVGElement} */\n      root: ({}),\n      rootCss: css`\n        width: 100%;\n        height: 100%;\n        touch-action: pan-x pan-y pinch-zoom;\n        > g.content {\n          shape-rendering: ${canTouchDevice ? 'optimizeSpeed' : 'auto'};\n        }\n      `,\n    };\n  });\n\n  return (\n    <svg\n      ref={state.rootRef}\n      className={state.rootCss}\n      preserveAspectRatio=\"xMinYMin\"\n      viewBox={`${state.viewBox}`}\n    >\n      <Grid bounds={props.gridBounds} />\n      <g className=\"content\">\n        {props.children}\n      </g>\n    </svg>\n  );\n}\n\n/**\n * @typedef Props @type {object}\n * @property {Rect} gridBounds World bounds\n * @property {Rect} initViewBox Initial viewbox in world coords\n * @property {number} [minZoom] Minimum zoom factor (default 0.5)\n * @property {number} [maxZoom] Maximum zoom factor (default 2)\n * @property {number} [initZoom] Initial zoom factor (default 1)\n */\n\n/** @param {{ bounds: Rect }} props */\nfunction Grid(props) {\n  const gridId = React.useMemo(() => generateId('grid-'), []);\n\n  return <>\n    <defs>\n      <pattern\n        id={gridId}\n        width=\"10\" \n        height=\"10\"\n        patternUnits=\"userSpaceOnUse\"\n      >\n        <path\n          d=\"M 10 0 L 0 0 0 10\"\n          fill=\"none\"\n          stroke=\"rgba(0,0,0,0.5)\"\n          strokeWidth=\"0.3\"\n        />\n      </pattern>\n    </defs>\n    <rect\n      x={props.bounds.x}\n      y={props.bounds.y}\n      width={props.bounds.width}\n      height={props.bounds.height}\n      fill={`url(#${gridId})`}\n    />\n  </>;\n}\n","panzoom/PanZoomDemo.jsx":"import * as React from 'react';\nimport { css } from 'goober';\nimport PanZoom from './PanZoom';\nimport { Rect } from '../geom';\n\nexport default function PanZoomDemo() {\n  return (\n    <div className={rootCss}>\n      <p>\n        drag to <strong>pan</strong>, scroll/pinch to <strong>zoom</strong>\n      </p>\n      <PanZoom initViewBox={initViewBox} gridBounds={gridBounds}>\n        <rect fill=\"red\" x={10} y={10} width={20} height={20} />\n      </PanZoom>\n    </div>\n  );\n}\n\nconst gridBounds = new Rect(-5000, -5000, 10000 + 1, 10000 + 1);\nconst initViewBox = new Rect(0, 0, 200, 200);\n\nconst rootCss = css`\n  display: flex;\n  flex-direction: column;\n  height: 100%;\n\n  > p {\n    padding: 12px 8px;\n    margin: 0;\n    font-family: monospace;\n    font-size: 16px;\n    background: #eee;\n  }\n`;","pathfinding/NavDemo.jsx":'import React, { useEffect, useState } from "react";\nimport { css } from "goober";\nimport { useQuery } from "react-query";\nimport { Rect, Vect } from "../geom";\nimport { figureOfEight } from \'../example/geom\';\nimport { getSvgPos, geom, recast } from "../service";\nimport PanZoom from "../panzoom/PanZoom";\n\n// import { options } from \'preact\';\n// if (typeof window !== \'undefined\') {\n//   const prev = options.diffed;\n//   options.diffed = (/** @type {*} */ vnode) => {\n//     prev?.(vnode);\n//     console.log(vnode); \n//   };\n// }\n\n// TODO remove recast-detour:\n// (a) compute navmesh in dev-env or codesandbox\n// (b) adapt three-pathfinding\n\n// TODO provide random point button\n\nexport default function NavDemo() {\n\n  const [dots, setDots] = useState(/** @type {Vect[]} */ ([]));\n  const [selected, setSelected] = useState(/** @type {number[]} */ ([]));\n  const [path, setPath] = useState(/** @type {Vect[]} */ ([]));\n\n  // TODO draw into image via canvas instead\n  const { data: tris } = useQuery(\'create-nav\', async () => {\n    await geom.createNavMesh(navKey, [polygon], {  cs: 1, walkableRadius: 2, maxSimplificationError: 50 });\n    const { tris, vs } = recast.getDebugTriangulation(navKey);\n    return tris.map(tri => tri.map(i => vs[i]));\n  }, { staleTime: Infinity });\n\n  useEffect(() => {\n    if (selected.length === 2) {\n      setPath(geom.requestNavPath(navKey, dots[selected[0]], dots[selected[1]]));\n    }\n  }, [dots, selected]);\n\n  /** @param {number} index */\n  function toggleDot(index) {\n    setSelected(selected.includes(index)\n      ? selected.filter(x => x !== index)\n      : [index].concat(selected).slice(0, 2)\n    );\n  }\n\n  return (\n    <section className={rootCss}>\n      <PanZoom gridBounds={gridBounds} initViewBox={initViewBox}>\n        <path className="walls" d={`${thickWalls.svgPath}`} />\n        <path className="floor" d={`${polygon.svgPath}`}\n          onClick={(e) => {\n            const point = getSvgPos(e);\n            if (!dots.some(d => d.distanceTo(point) < 5)) {\n              setDots(dots.concat(Vect.from(point)));\n              toggleDot(dots.length);\n            }\n          }}\n        />\n        {<MemoedTriangles tris={tris} />}\n        <polyline className="navpath" points={`${path}`} />\n        <g className="dots">\n          {dots.map((p, i) =>\n            <circle\n              key={i}\n              cx={p.x}\n              cy={p.y}\n              r={2.5}\n              className={selected.includes(i) ? \'selected\' : undefined }\n              onClick={() => toggleDot(i)}\n            />\n          )}\n        </g>\n      </PanZoom>\n    </section>\n  );\n}\n\n/** @type {React.FC<{ tris?: Vect[][] }>}  */\nconst Triangles = (props) => <g>\n  {props.tris?.map((tri, i) =>\n    <polygon key={i} className="triangle" points={`${tri}`} />  \n  )}\n</g>;\n\nconst MemoedTriangles = React.memo(Triangles);\n\nconst gridBounds = new Rect(-5000, -5000, 10000 + 1, 10000 + 1);\nconst initViewBox = new Rect(0, 0, 200, 200);\nconst navKey = \'fig-of-8\';\nconst polygon = figureOfEight.clone().translate(100, 100);\nconst [thickWalls] = polygon.createOutset(6);\n\nconst rootCss = css`\n  border: 1px solid #555555;\n  height: inherit;\n\n  path.walls {\n    fill: #000;\n  }\n  path.floor {\n    cursor: crosshair;\n    fill: white;\n    stroke:none;\n  }\n  g.dots circle {\n    cursor: crosshair;\n    fill: #ddd;\n    stroke: black;\n    stroke-width: 0.5;\n\n    &.selected {\n      fill: red;\n    }\n  }\n  polygon.triangle {\n    pointer-events: none;\n    fill: none;\n    stroke: #bbb;\n    stroke-width: 0.5;\n  }\n  polyline.navpath {\n    fill: none;\n    stroke: #800;\n    stroke-width: 1;\n    stroke-dasharray: 4 4;\n  }\n`;',"example/jsx-to-js.jsx":"import * as React from 'react';\nimport PanZoomDemo from '../panzoom/PanZoomDemo';\n\nconst withJsx = <div title=\"message\">Welcome!</div>;\nconst withoutJsx = React.createElement(\n  'div',\n  { title: 'message' },\n  'Welcome!',\n);\n\nconst withJsxToo = <div><PanZoomDemo /></div>;\nconst withoutJsxToo = React.createElement(\n  'div',\n  null,\n  React.createElement(PanZoomDemo, null),\n);","geom/rect.js":"import { Vect } from './vect';\n\n/**\n * A two dimensional rectangle where `(x, y)` is viewed as top left.\n */\nexport class Rect {\n  /**\n   * @param {number} x \n   * @param {number} y \n   * @param {number} width \n   * @param {number} height \n   */\n  constructor(x, y, width, height) {\n    /** @type {number} */ this.x = x;\n    /** @type {number} */ this.y = y;\n    /** @type {number} */ this.width = width;\n    /** @type {number} */ this.height = height;\n  }\n\n  get area() {\n    return this.width * this.height;\n  }\n\n  get bottom() {\n    return this.y + this.height;\n  }\n\n  get bottomLeft() {\n    return new Vect(this.x, this.y + this.height);\n  }\n\n  get bottomRight() {\n    return new Vect(this.x + this.width, this.y + this.height);\n  }\n\n  get center() {\n    return new Vect(this.cx, this.cy);\n  }\n\n  get cx() {\n    return this.x + 0.5 * this.width;\n  }\n\n  get cy() {\n    return this.y + 0.5 * this.height;\n  }\n\n  /** @returns {Geom.GeoJsonPolygon} */\n  get geoJson() {\n    return {\n      type: 'Polygon',\n      coordinates: [\n        [\n          [this.x, this.y],\n          [this.x + this.width, this.y],\n          [this.x + this.width, this.y + this.height],\n          [this.x, this.y + this.height]\n        ]\n      ]\n    };\n  }\n\n  /** @returns {Geom.RectJson} */\n  get json() {\n    return { \n      x: this.x,\n      y: this.y,\n      width: this.width,\n      height: this.height,\n    };\n  }\n\n  get key() {\n    return `${this.x},${this.y},${this.width},${this.height}`;\n  }\n\n  get dimension() {\n    return Math.max(this.width, this.height);\n  }\n\n  /**\n   * Anti-clockwise w.r.t y being downwards\n   * @returns {[Vect, Vect, Vect, Vect]}\n   */\n  get points() {\n    return [\n      new Vect(this.x, this.y),\n      new Vect(this.x, this.y + this.height),\n      new Vect(this.x + this.width, this.y + this.height),\n      new Vect(this.x + this.width, this.y),\n    ];\n  }\n\n  get right() {\n    return this.x + this.width;\n  }\n\n  get topLeft() {\n    return new Vect(this.x, this.y);\n  }\n\n  get topRight() {\n    return new Vect(this.x + this.width, this.y);\n  }\n\n  static get zero() {\n    return new Rect(0, 0, 0, 0);\n  }\n\n  /** @param {import('./mat').Mat} m */\n  applyMatrix(m) {\n    if (!m.isIdentity) {\n      const min = m.transformPoint(this.topLeft);\n      const max = m.transformPoint(this.bottomRight);\n      this.x = Math.min(min.x, max.x);\n      this.y = Math.min(min.y, max.y);\n      this.width = Math.max(min.x, max.x) - this.x;\n      this.height = Math.max(min.y, max.y) - this.y;\n    }\n    return this;\n  }\n\n  clone() {\n    return new Rect(this.x, this.y, this.width, this.height);\n  }\n\n  /** @param {Geom.VectJson} _ */\n  contains({ x, y }) {\n    return this.x <= x && x <= this.x + this.width && (this.y <= y && y <= this.y + this.height);\n  }\n\n  /** @param {Geom.RectJson} _ */\n  copy({ x, y, width, height }) {\n    this.x = x;\n    this.y = y;\n    this.width = width;\n    this.height = height;\n    return this;\n  }\n\n  /** @param {Rect} _ */\n  covers({ x, y, width, height }) {\n    return (\n      this.x <= x &&\n      x + width <= this.x + this.width &&\n      this.y <= y &&\n      y + height <= this.y + this.height\n    );\n  }\n\n  /**\n   * @param {number} dx \n   * @param {number} dy \n   */\n  delta(dx, dy) {\n    this.x += dx;\n    this.y += dy;\n    return this;\n  }\n\n  /** \n   * Returns `Rect2.zero` if no args.\n   * @param {Vect[] | Rect[]} items\n   */\n  static from(...items) {\n    if (!items.length) {\n      return Rect.zero;\n    } else if (items[0] instanceof Vect) {\n      const vectors = /** @type {Vect[]} */ (items);\n      const mx = Math.min(...vectors.map(({ x }) => x));\n      const my = Math.min(...vectors.map(({ y }) => y));\n      const Mx = Math.max(...vectors.map(({ x }) => x));\n      const My = Math.max(...vectors.map(({ y }) => y));\n      return new Rect(mx, my, Mx - mx, My - my);\n    } else {\n      const rects = /** @type {Rect[]} */ (items);\n      const mx = Math.min(...rects.map(({ x }) => x));\n      const my = Math.min(...rects.map(({ y }) => y));\n      const Mx = Math.max(...rects.map(({ x, width }) => x + width));\n      const My = Math.max(...rects.map(({ y, height }) => y + height));\n      return new Rect(mx, my, Mx - mx, My - my);\n    }\n  }\n\n  /** @param {Geom.RectJson} _ */\n  static fromJson({ x, y, width, height }) {\n    return new Rect(x, y, width, height);\n  }\n\n  /**\n   * Bounded version of `lambda x.this.outset(-x)`\n   * @param {number} nonNegAmount \n   */\n  inset(nonNegAmount) {\n    const [cx, cy] = [this.cx, this.cy];\n    this.outset(-nonNegAmount);\n    if (this.width < 0) {\n      this.x = cx;\n      this.width = 0;\n    }\n    if (this.height < 0) {\n      this.y = cy;\n      this.height = 0;\n    }\n  }\n\n  /**\n   * Does this filled rectangle intersect with {other} filled rectangle?\n   * @param {Rect} other\n   */\n  intersects(other) {\n    return (\n      Math.abs(this.cx - other.cx) * 2 <= this.width + other.width &&\n      Math.abs(this.cy - other.cy) * 2 <= this.height + other.height\n    );\n  }\n\n  /** @param {Geom.VectJson} _ */\n  offset({ x, y }) {\n    this.x += x;\n    this.y += y;\n    return this;\n  }\n\n  /** @param {number} nonNegAmount */\n  outset(nonNegAmount) {\n    this.x -= nonNegAmount;\n    this.y -= nonNegAmount;\n    this.width += 2 * nonNegAmount;\n    this.height += 2 * nonNegAmount;\n    return this;\n  }\n\n  /** @param {number} k */\n  scale(k) {\n    this.x *= k;\n    this.y *= k;\n    this.width *= k;\n    this.height *= k;\n    return this;\n  }\n\n  /** @param {Geom.VectJson} position */\n  setPosition(position) {\n    this.x = position.x;\n    this.y = position.y;\n    return this;\n  }\n\n  toString() {\n    return `${this.x},${this.y},${this.width},${this.height}`;\n  }\n\n}\n"},je={"panzoom/PanZoomDemo.jsx":function(){return(0,r.BX)("div",{className:te,children:[(0,r.BX)("p",{children:["drag to ",(0,r.tZ)("strong",{children:"pan"}),", scroll/pinch to ",(0,r.tZ)("strong",{children:"zoom"})]}),(0,r.tZ)(X,{initViewBox:ee,gridBounds:Q,children:(0,r.tZ)("rect",{fill:"red",x:10,y:10,width:20,height:20})})]})},"pathfinding/NavDemo.jsx":function(){var e=(0,p.useState)([]),t=e[0],n=e[1],i=(0,p.useState)([]),a=i[0],s=i[1],o=(0,p.useState)([]),c=o[0],u=o[1],l=(0,ne.useQuery)("create-nav",(0,K.Z)(z().mark((function e(){var t,n,r;return z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,U.createNavMesh(fe,[de],{cs:1,walkableRadius:2,maxSimplificationError:50});case 2:return t=F.getDebugTriangulation(fe),n=t.tris,r=t.vs,e.abrupt("return",n.map((function(e){return e.map((function(e){return r[e]}))})));case 4:case"end":return e.stop()}}),e)}))),{staleTime:1/0}).data;function h(e){s(a.includes(e)?a.filter((function(t){return t!==e})):[e].concat(a).slice(0,2))}return(0,p.useEffect)((function(){2===a.length&&u(U.requestNavPath(fe,t[a[0]],t[a[1]]))}),[t,a]),(0,r.tZ)("section",{className:ye,children:(0,r.BX)(X,{gridBounds:he,initViewBox:pe,children:[(0,r.tZ)("path",{className:"walls",d:"".concat(ve.svgPath)}),(0,r.tZ)("path",{className:"floor",d:"".concat(de.svgPath),onClick:function(e){var r=M(e);t.some((function(e){return e.distanceTo(r)<5}))||(n(t.concat(b.from(r))),h(t.length))}}),(0,r.tZ)(le,{tris:l}),(0,r.tZ)("polyline",{className:"navpath",points:"".concat(c)}),(0,r.tZ)("g",{className:"dots",children:t.map((function(e,t){return(0,r.tZ)("circle",{cx:e.x,cy:e.y,r:2.5,className:a.includes(t)?"selected":void 0,onClick:function(){return h(t)}},t)}))})]})})},"geomorph/GeomorphDemo.jsx":function(){var e=function(e){var t=(0,ne.useQuery)("svg-json",(function(){return fetch("/symbol/svg.json").then((function(e){return e.json()})).then((function(e){return ge(e)}))})).data;if(t){var n=function(e,t){var n={doors:[],labels:[],obstacles:[],walls:[]},r=new D;e.items.forEach((function(e,i){var a,s,o,c;e.transform?r.feedFromArray(e.transform):r.setIdentity(),i&&(r.a*=.2,r.b*=.2,r.c*=.2,r.d*=.2);var u,l,h,p=t[e.symbol],f=p.doors,d=p.labels,m=p.obstacles,v=p.walls,g=p.meta,x=(u=f,l=g.doors,(h=e.tags)?l.flatMap((function(e,t){return e.length?e.some((function(e){return h.includes(e)}))?u[t]:[]:u[t]})):u);(a=n.doors).push.apply(a,(0,y.Z)(x.map((function(e){return e.clone().applyMatrix(r)})))),(s=n.labels).push.apply(s,(0,y.Z)(d.map((function(e){return e.clone().applyMatrix(r)})))),(o=n.obstacles).push.apply(o,(0,y.Z)(m.map((function(e){return e.clone().applyMatrix(r)})))),(c=n.walls).push.apply(c,(0,y.Z)(v.map((function(e){return e.clone().applyMatrix(r)}))))})),n.walls=E.cutOut(n.doors,n.walls);var i=e.items.map((function(e){return t[e.symbol]})),a=i[0],s=a.walls[0].clone().removeHoles(),o=E.cutOut(n.walls.flatMap((function(e){return e.createOutset(12.5)})).concat(n.obstacles.flatMap((function(e){return e.createOutset(5)}))),[s]);return{def:e,actual:n,navPoly:o,hullRect:a.meta.hullRect,pngHref:"/debug/".concat(e.key,".png"),pngRect:a.meta.pngRect,symbols:i.map((function(t,n){return{key:t.key,pngHref:"/symbol/".concat(t.key,".png"),pngRect:t.meta.pngRect,transformArray:e.items[n].transform,transform:e.items[n].transform?"matrix(".concat(e.items[n].transform,")"):void 0}}))}}(e,t),r=function(e,t){var n=t[e.symbols[0].key],r=n.meta.hullRect,i=document.createElement("canvas"),a=document.createElement("canvas");i.width=n.meta.pngRect.width,i.height=n.meta.pngRect.height,a.width=n.meta.pngRect.width,a.height=n.meta.pngRect.height;var s=[i.getContext("2d"),a.getContext("2d")],o=s[0],c=s[1],u=n.walls[0].outline;c.translate(-r.x,-r.y),c.fillStyle="rgba(100, 0, 0, 0.1)",c.strokeStyle="rgba(0, 0, 0, 0.2)",V(c,u),c.fillStyle="rgba(0, 0, 200, 0.03)",N(c,e.navPoly),c.resetTransform();var l=e.actual,h=l.doors,p=l.labels,f=l.obstacles,d=l.walls;return o.translate(-r.x,-r.y),o.fillStyle="rgba(0, 200, 0, 1)",N(o,h),o.fillStyle="rgba(200, 50, 50, .2)",N(o,d),o.fillStyle="rgba(100, 0, 0, 0.05)",N(o,f),o.fillStyle="rgba(0, 0, 0, 0.04)",N(o,p),o.resetTransform(),{overlay:i,underlay:a}}(n,t),i=r.overlay,a=r.underlay;return function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?xe(Object(n),!0).forEach((function(t){(0,k.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):xe(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({overlay:i.toDataURL(),underlay:a.toDataURL()},n)}}(Se);return console.log({gm:e}),(0,r.tZ)("div",{className:Ze,children:(0,r.tZ)(X,{initViewBox:we,gridBounds:ke,maxZoom:5,children:e&&(0,r.BX)("g",{children:[(0,r.tZ)("image",{className:"debug",href:e.pngHref,x:e.pngRect.x,y:e.pngRect.y}),(0,r.tZ)("image",{className:"underlay",href:e.underlay,x:e.hullRect.x,y:e.hullRect.y}),e.symbols.map((function(e,t){return(0,r.tZ)("g",{transform:e.transform,children:(0,r.tZ)("image",{className:"symbol",href:e.pngHref,x:e.pngRect.x,y:e.pngRect.y})},t)})),(0,r.tZ)("image",{className:"overlay",href:e.overlay,x:e.hullRect.x,y:e.hullRect.y})]})})})},"physics/PhysicsDemo.jsx":function(){var e=p.useRef({}).current;return p.useEffect((function(){return Pe({locateFile:function(e,t){return"/box2d/".concat(e)}}).then((function(t){var n=new t.b2Vec2(0,0);e.world=new t.b2World(n),console.info("created world",e)})),function(){var t;console.info("destroying world"),null===(t=e.world)||void 0===t||t.__destroy__(),Object.assign(e,{world:null})}}),[]),(0,r.tZ)(X,{gridBounds:Ce,initViewBox:Re,children:(0,r.tZ)("text",{x:10,y:20,children:"TODO"})})}};var Ee=n(5152),De=(0,Ee.default)((function(){return Promise.all([n.e(126),n.e(135),n.e(209)]).then(n.bind(n,35209))}),{ssr:!1,loadableGenerated:{webpack:function(){return[35209]},modules:["../components/dynamic.tsx -> ./code/CodeEditor"]}}),Te=(0,Ee.default)((function(){return Promise.all([n.e(142),n.e(586)]).then(n.bind(n,17586))}),{ssr:!1,loadableGenerated:{webpack:function(){return[17586]},modules:["../components/dynamic.tsx -> ./sh/XTerm"]}}),Ae=(0,Ee.default)((function(){return n.e(431).then(n.bind(n,78431))}),{ssr:!1,loadableGenerated:{webpack:function(){return[78431]},modules:["../components/dynamic.tsx -> ./page/Loadable"]}});function Me(){var e=(0,a.Z)(["\n  pointer-events: none;\n  position: absolute;\n  z-index: 5;\n  width: inherit;\n  height: inherit;\n  background: #000;\n  display: flex;\n  justify-content: center;\n\n  > div {\n    display: flex;\n    align-items: center;\n  }\n  .message {\n    color: #ccc;\n    background: #444;\n    border-radius: 4px;\n    padding: 8px 12px;\n    font-size: 14px;\n  }\n\n  opacity: 1;\n  transition: opacity 0.5s linear;\n  &.fade-out {\n    opacity: 0;    \n  }\n"]);return Me=function(){return e},e}function _e(e){var t=e.children,n=(0,p.useState)(!1),i=n[0],a=n[1];return(0,r.BX)(r.HY,{children:[(0,r.tZ)(Ie,{fadeOut:i}),(0,r.tZ)(Ae,{onLoaded:function(){return a(!0)},children:t})]})}function Ie(e){return(0,r.tZ)("section",{className:m()(Ve,{"fade-out":e.fadeOut}),children:(0,r.tZ)("div",{children:(0,r.tZ)("div",{className:"message",children:"Loading..."})})})}var Ve=(0,s.iv)(Me());function Ne(e){var t=e.children;return(0,r.tZ)("section",{children:(0,r.tZ)("strong",{children:t})})}var Be=n(11455);function Le(){var e=(0,a.Z)(["\n  margin: 40px 0;\n  @media(max-width: 600px) {\n    margin: 0;\n  }\n\n  > .flexlayout__layout {\n    background: #444;\n    position: relative;\n    height: ","px;\n  }\n  .flexlayout__tab {\n    /* border: 1px solid rgba(0, 0, 0, 0.3); */\n    border-top: 6px solid #444;\n    position: relative;\n    /** Handle svg overflow */\n    overflow: hidden;\n  }\n  .flexlayout__tabset_tabbar_outer {\n    background: #222;\n    border-bottom: 1px solid #555;\n  }\n  .flexlayout__tab_button--selected, .flexlayout__tab_button:hover {\n    background: #444;\n  }\n  .flexlayout__tab_button_content {\n    user-select: none;\n    font-size: 13px;\n    color: #aaa;\n  }\n  .flexlayout__tab_button--selected .flexlayout__tab_button_content {\n    color: #fff;\n  }\n  .flexlayout__tab_button:hover:not(.flexlayout__tab_button--selected) .flexlayout__tab_button_content {\n    color: #ddd;\n  }\n  .flexlayout__splitter_vert, .flexlayout__splitter_horz {\n    background: #827575;\n  }\n"]);return Le=function(){return e},e}function ze(e){var t=e.tabs,n=e.height,i=e.storeKey,a=p.default.useMemo((function(){return f.Model.fromJson(function(e){return{global:{tabEnableRename:!1},layout:{type:"row",weight:100,children:[{type:"tabset",weight:50,selected:0,children:e.map((function(e){return{type:"tab",id:"".concat(e.key,"@").concat(e.filepath),name:"code"===e.key?e.filepath:e.filepath.split("/").pop().slice(0,-4),config:{key:e.key,folds:"folds"in e?e.folds:void 0},component:e.filepath,enableClose:!1}}))}]}}}(t))}),[t]),s=p.default.useRef(null);return p.default.useEffect((function(){if(i)return Be.Z.getState().tabs[i]={key:i,model:a,scrollIntoView:function(){var e;return null===(e=s.current)||void 0===e?void 0:e.scrollIntoView({behavior:"smooth",block:"center"})}},function(){delete Be.Z.getState().tabs[i]}}),[a]),(0,r.tZ)("section",{className:m()("tabs","scrollable",We(n)),ref:s,children:(0,r.tZ)(f.Layout,{model:a,factory:Ke})})}function Ke(e){var t=e.getConfig(),n=t.key,i=t.folds;switch(n){case"code":var a=e.getComponent()||"";return a in Oe?(0,r.tZ)(_e,{children:(0,r.tZ)(De,{height:"100%",lineNumbers:!0,readOnly:!0,code:Oe[a],folds:i})}):(0,r.BX)(Ne,{children:["Unknown code with filepath ",a]});case"component":var s=e.getComponent()||"";if(s in je)return(0,r.tZ)(_e,{children:p.default.createElement(je[s])});default:return(0,r.BX)(Ne,{children:["Unknown TabNode with name ",n]})}}var We=function(e){return(0,s.iv)(Le(),e)},Ge=n(39944),Fe=n(86576),Je=n(24790),$e=n(14671),Ue=n(38597),He=n(58377);function Xe(e){var t=function(e,t){if("object"!==typeof e||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!==typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===typeof t?t:String(t)}function qe(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Ye(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?qe(Object(n),!0).forEach((function(t){(0,k.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):qe(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Qe(e,t){return Ye(Ye({},t),{},(0,k.Z)({},e.key,e))}function et(e,t){t[e];return(0,He.Z)(t,[e].map(Xe))}function tt(e,t,n){if(!t[e])return t;var r=n(t[e]);return r?Ye(Ye({},t),{},(0,k.Z)({},e,Ye(Ye({},t[e]),r))):t}var nt=n(8068),rt=n(29950),it=new(function(){function e(){var t=this;(0,g.Z)(this,e),(0,k.Z)(this,"onOneLine",!0),(0,k.Z)(this,"multilineSrc",(function(e){t.onOneLine=!1;var n=t.src(e);return t.onOneLine=!0,n})),(0,k.Z)(this,"seqSrc",(function(e){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(t.onOneLine){var r=[];return e.forEach((function(e){return r.push(t.src(e),t.isBackgroundNode(e)?" ":"; ")})),(n?r:r.slice(0,-1)).join("")}return e.map((function(e){return t.src(e)})).join("\n")})),(0,k.Z)(this,"src",(function(e){var n,r;if(!e)return"";switch(e.type){case"ArithmCmd":return"(( ".concat(t.src(e.X)," ))");case"BinaryCmd":var i=t.binaryCmds(e);return[i[0].X].concat(i.map((function(e){return e.Y}))).map((function(e){return t.src(e)})).join(" ".concat(e.Op).concat(t.onOneLine||"|"===e.Op?"":"\n"," "));case"BinaryArithm":return[e.X,e.Y].map((function(e){return t.src(e)})).join("".concat(e.Op));case"UnaryArithm":return e.Post?"".concat(t.src(e.X)).concat(e.Op):"".concat(e.Op).concat(t.src(e.X));case"ParenArithm":return"(".concat(t.src(e.X),")");case"Word":return"string"===typeof e.string?e.string:e.Parts.map((function(e){return t.src(e)})).join("");case"ArrayExpr":var a=e.Elems.map((function(e){var n=e.Index,r=e.Value;return n?"[".concat(t.src(n),"]=").concat(t.src(r)):t.src(r)}));return"(".concat(a.join(" "),")");case"Assign":var s=e.Name.Value;return e.Array?"".concat(s,"=").concat(t.src(e.Array)):e.Index?"".concat(s,"[").concat(t.src(e.Index),"]").concat(e.Append?"+":"","=").concat(t.src(e.Value)):"".concat(s).concat(e.Append?"+":"","=").concat(t.src(e.Value||null));case"Block":var o=e.Stmts,c=o.length&&t.isBackgroundNode((0,Fe.Z$)(o))?"":";";if(t.onOneLine)return"{ ".concat(t.seqSrc(o)).concat(c," }");var u=t.seqSrc(o).split("\n");return 1===u.length&&!u[0]&&u.pop(),"{\n".concat(u.map((function(e){return"  ".concat(e)})).concat(e.Last.map((function(e){return"  #".concat(e.Text)}))).join("\n"),"\n}");case"CallExpr":return[e.Assigns.map((function(e){return t.src(e)})).join(" "),e.Args.map((function(e){return t.src(e)})).join(" ")].filter(Boolean).join(" ");case"Stmt":var l=[e.Negated&&"!",t.src(e.Cmd),e.Redirs.map((function(e){return t.src(e)})).join(" "),e.Background&&"&"].filter(Boolean).join(" ");if(!t.onOneLine&&e.Comments.length){var h=[];e.Comments.forEach((function(t){return t.Hash.Offset<e.Position.Offset?h.push("#".concat(t.Text)):l+=" #".concat(t.Text)})),l=h.concat(l).join("\n")}return l;case"CaseClause":var p=e.Items.map((function(e){return{globs:e.Patterns,terminal:e.Op,child:e.Stmts}}));return["case",t.src(e.Word),"in",p.flatMap((function(e){var n=e.child,r=e.globs,i=e.terminal;return["".concat(r.map((function(e){return t.src(e)})).join(" | "),")"),t.seqSrc(n),i]})).join(" "),"esac"].filter(Boolean).join(" ");case"CoprocClause":return["coproc",null===(n=e.Name)||void 0===n?void 0:n.Value,t.src(e.Stmt)].filter(Boolean).join(" ");case"DeclClause":return[e.Variant.Value,e.Args.map((function(e){return t.src(e)})).join(" ")].filter(Boolean).join(" ");case"ArithmExp":return"".concat("Stmt"===(null===(r=e.parent)||void 0===r?void 0:r.type)?"":"$","(( ").concat(t.src(e.X)," ))");case"CmdSubst":return"$( ".concat(t.seqSrc(e.Stmts)," )");case"DblQuoted":return'"'.concat(e.Parts.map((function(e){return t.src(e)})).join(""),'"');case"ExtGlob":return e.Pattern.Value.replace(/\n/g,"");case"Lit":return e.Value;case"ParamExp":var f;return":-"===(null===(f=e.Exp)||void 0===f?void 0:f.Op)?"${".concat(e.Param.Value,":-").concat(t.src(e.Exp.Word),"}"):"${".concat(e.Param.Value,"}");case"ProcSubst":var d="<("===e.Op?"<":">";return"".concat(d,"( ").concat(t.seqSrc(e.Stmts)," )");case"SglQuoted":var m=e.Value;return"".concat(e.Dollar?"$":"","'").concat(m,"'");case"FuncDecl":return"".concat(e.Name.Value,"() ").concat(t.src(e.Body));case"IfClause":return(0,rt.Wc)(e).map((function(e,n){var r=e.Cond,i=e.Then;return r.length?"".concat(n?"elif":"if"," ").concat(t.seqSrc(r),"; then ").concat(t.seqSrc(i),"; "):"else ".concat(t.seqSrc(i),"; ")})).concat("fi").join("");case"LetClause":return"let ".concat(e.Exprs.map((function(e){return t.src(e)})).join(" "));case"Redirect":var y=e.N?Number(e.N.Value):"";switch(e.Op){case">":case">>":var g=(0,v.Z)(e.Word.Parts,1)[0],x="Lit"===(null===g||void 0===g?void 0:g.type)&&g.Value.endsWith("-");return"".concat(y).concat(e.Op).concat(t.src(e.Word)).concat(x?"-":"");default:return""}case"File":return t.seqSrc(e.Stmts);case"Subshell":return"( ".concat(e.Stmts.map((function(e){return t.src(e)})).join("; ")," )");case"TestClause":return"[[ ".concat(t.src(e.X)," ]]");case"BinaryTest":return[e.X,e.Y].map((function(e){return t.src(e)})).join(" ".concat(e.Op," "));case"UnaryTest":return"".concat(e.Op," ").concat(t.src(e.X));case"ParenTest":return"(".concat(t.src(e.X),")");case"TimeClause":return"time ".concat(e.PosixFormat?"-p ":"").concat(t.src(e.Stmt));case"ForClause":var b=e.Do,w=e.Loop;return"CStyleLoop"===w.type?"for (( ".concat(t.src(w.Init),"; ").concat(t.src(w.Cond),"; ").concat(t.src(w.Post)," )); do ").concat(t.seqSrc(b,!0),"done"):"for ".concat(w.Name.Value," in ").concat(w.Items.map((function(e){return t.src(e)})).join(" "),"; do ").concat(t.seqSrc(b,!0),"done");case"WhileClause":return"".concat(e.Until?"until":"while"," ").concat(t.seqSrc(e.Cond,!0),"do ").concat(t.seqSrc(e.Do,!0),"done");case"CStyleLoop":case"Comment":case"WordIter":case"ArrayElem":case"CaseItem":return"";default:throw(0,Fe.Ql)(e)}}))}return(0,x.Z)(e,[{key:"binaryCmds",value:function(e){var t=e.X,n=e.Y,r=e.Op;return t.Cmd&&"BinaryCmd"===t.Cmd.type&&t.Cmd.Op===r?[].concat((0,y.Z)(this.binaryCmds(t.Cmd)),[e]):n.Cmd&&"BinaryCmd"===n.Cmd.type&&n.Cmd.Op===r?[e].concat((0,y.Z)(this.binaryCmds(n.Cmd))):[e]}},{key:"isBackgroundNode",value:function(e){return"Stmt"===e.type&&e.Background}}]),e}()),at=n(29209),st=n(29998),ot=n(36375),ct=n(47480),ut=n(95775),lt=n.n(ut),ht=n(14695),pt=n(91077),ft=n(3415),dt=n(92953),mt=n(98250),vt=n(86744),yt=n.n(vt);function gt(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,dt.Z)(e);if(t){var i=(0,dt.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,ft.Z)(this,n)}}function xt(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!e.trim())return[];if(t)return e.trim().replace(/[\s]+/g," ").split(" ");var n=e.replace(/[\s]+/g," ").split(" ");return n[0]||(n.shift(),n[0]=" "+n[0]),(0,Fe.Z$)(n)||(n.pop(),n.push(n.pop()+" ")),n}function bt(e){return{key:"expanded",values:e instanceof Array?e:[e],value:e instanceof Array?e.join(" "):e}}var wt={expand:!0,rangeLimit:1/0};function kt(e){var t=e.Value,n=e.parent;if(!n)throw Error("Literal must have parent");var r=t.replace(/\\\n/,"").replace(/\[/g,"\\[").replace(/\]/g,"\\]");return"DblQuoted"===n.type?[r.replace(/\\(["\\$`])/g,"$1")]:"TestClause"===n.type||"Redirect"===n.type?[r.replace(/\\(.|$)/g,"$1")]:yt()(r,wt)}function Zt(e){var t,n=e.Dollar,r=e.Value;return[n?(t=r,JSON.parse(JSON.stringify(t).replace(/\\\\e/g,"\\u001b").replace(/\\\\x([0-9a-f]{2})/g,"\\u00$1").replace(/\\\\([bfnrt])/g,"\\$1"))):r]}var St=function(e){(0,pt.Z)(n,e);var t=gt(n);function n(e,r,i){var a;return(0,g.Z)(this,n),(a=t.call(this,e)).exitCode=r,a.original=i,Object.setPrototypeOf((0,ht.Z)(a),n.prototype),a}return n}((0,mt.Z)(Error)),Pt=function(e){(0,pt.Z)(n,e);var t=gt(n);function n(e,r,i){var a;return(0,g.Z)(this,n),(a=t.call(this,e)).code=e,a.pid=r,a.sessionKey=i,Object.setPrototypeOf((0,ht.Z)(a),n.prototype),a}return n}((0,mt.Z)(Error));function Ct(e){return new Pt(sn.SIGKILL,e.pid,e.sessionKey)}function Rt(e,t,n){return function(e,t){return Et(jt(e),t)}(e.startsWith("/")?e.split("/"):n.split("/").concat(e.split("/")),t)}function Ot(e,t,n){return jt(e.startsWith("/")?e.split("/"):n.split("/").concat(e.split("/")))}function jt(e){return e.reduce((function(e,t){return t&&"."!==t?".."===t?e.slice(0,-1):e.concat(t):e}),[])}function Et(e,t){return e.reduce((function(e,t){return e[t]}),t)}var Dt=n(30023),Tt=n.n(Dt);function At(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Mt(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?At(Object(n),!0).forEach((function(t){(0,k.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):At(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function _t(e,t){var n;if("undefined"===typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"===typeof e)return It(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return It(e,t)}(e))||t&&e&&"number"===typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,o=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return s=e.done,e},e:function(e){o=!0,a=e},f:function(){try{s||null==n.return||n.return()}finally{if(o)throw a}}}}function It(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var Vt={call:!0,cd:!0,declare:!0,echo:!0,expr:!0,false:!0,filter:!0,get:!0,help:!0,history:!0,kill:!0,ls:!0,poll:!0,ps:!0,pwd:!0,map:!0,reduce:!0,return:!0,rm:!0,run:!0,session:!0,set:!0,sleep:!0,split:!0,sponge:!0,true:!0,unset:!0},Nt=new(function(){function e(){(0,g.Z)(this,e),(0,k.Z)(this,"shellUtil",{pretty:function(e){return(0,Fe.IC)(JSON.parse((0,Fe.or)(e)))}})}return(0,x.Z)(e,[{key:"isCmd",value:function(e){return e in Vt}},{key:"runCmd",value:function(e,t,n){var r=this;return(0,at.Z)(z().mark((function i(){var a,s,o,c,u,l,h,p,f,d,m,g,x,b,w,k,Z,S,P,C,R,O,j,E,D,T,A,M,_,I,V,N,B,L,K,W,G,F,J,$,U,H,X,q,Y,Q,ee,te,ne,re,ie,ae,se,oe,ce,ue,le,he,pe,fe,de,me,ve,ye,ge,xe,be,we,ke,Ze,Se,Pe,Ce,Re,Oe,je,Ee,De,Te,Ae,Me,_e,Ie,Ve,Ne,Be,Le,ze,Ke,We,Ge,Je,$e,Ue,He,Xe,qe,Ye,Qe;return z().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:a=e.meta,i.t0=t,i.next="call"===i.t0?4:"cd"===i.t0?8:"declare"===i.t0?40:"echo"===i.t0?77:"expr"===i.t0?106:"false"===i.t0?109:"filter"===i.t0?111:"get"===i.t0?114:"help"===i.t0?116:"history"===i.t0?154:"kill"===i.t0?174:"ls"===i.t0?177:"map"===i.t0?203:"poll"===i.t0?206:"ps"===i.t0?217:"pwd"===i.t0?268:"reduce"===i.t0?271:"return"===i.t0?277:"rm"===i.t0?282:"run"===i.t0?307:"session"===i.t0?310:"set"===i.t0?313:"sleep"===i.t0?317:"split"===i.t0?321:"sponge"===i.t0?324:"true"===i.t0?329:"unset"===i.t0?331:335;break;case 4:return s=Function("return ".concat(n[0])),i.next=7,s()(r.provideProcessCtxt(a,n.slice(1)));case 7:return i.abrupt("break",336);case 8:if(!(n.length>1)){i.next=10;break}throw new St("usage: `cd /`, `cd`, `cd foo/bar`, `cd /foo/bar`, `cd ..` and `cd -`",1);case 10:if(o=an.api.getVar(a.sessionKey,"OLDPWD"),c=an.api.getVar(a.sessionKey,"PWD"),an.api.setVar(a.sessionKey,"OLDPWD",c),i.prev=13,n[0]){i.next=18;break}an.api.setVar(a.sessionKey,"PWD","home"),i.next=33;break;case 18:if("-"!==n[0]){i.next=22;break}an.api.setVar(a.sessionKey,"PWD",o),i.next=33;break;case 22:if(!n[0].startsWith("/")){i.next=29;break}if(void 0!==Et(u=jt(n[0].split("/")),r.provideProcessCtxt(e.meta))){i.next=26;break}throw Error;case 26:an.api.setVar(a.sessionKey,"PWD",u.join("/")),i.next=33;break;case 29:if(void 0!==Et(l=jt(c.split("/").concat(n[0].split("/"))),r.provideProcessCtxt(e.meta))){i.next=32;break}throw Error;case 32:an.api.setVar(a.sessionKey,"PWD",l.join("/"));case 33:i.next=39;break;case 35:throw i.prev=35,i.t1=i.catch(13),an.api.setVar(a.sessionKey,"OLDPWD",o),new St("".concat(n[0]," not found"),1);case 39:return i.abrupt("break",336);case 40:h=an.api.getFuncs(a.sessionKey),p=_t(h),i.prev=42,p.s();case 44:if((f=p.n()).done){i.next=68;break}d=f.value,m=d.key,g=d.src,x="".concat(wn).concat(m).concat(kn," () ").concat(g).split(/\r?\n/),b=_t(x),i.prev=48,b.s();case 50:if((w=b.n()).done){i.next=56;break}return k=w.value,i.next=54,k;case 54:i.next=50;break;case 56:i.next=61;break;case 58:i.prev=58,i.t2=i.catch(48),b.e(i.t2);case 61:return i.prev=61,b.f(),i.finish(61);case 64:return i.next=66,"";case 66:i.next=44;break;case 68:i.next=73;break;case 70:i.prev=70,i.t3=i.catch(42),p.e(i.t3);case 73:return i.prev=73,p.f(),i.finish(73);case 76:return i.abrupt("break",336);case 77:if(Z=(0,rt.v8)(n,{boolean:["a","n"]}),S=Z.opts,P=Z.operands,!S.a){i.next=83;break}return i.next=81,S.n?P.map(Number):P;case 81:i.next=105;break;case 83:if(!S.n){i.next=103;break}C=_t(P),i.prev=85,C.s();case 87:if((R=C.n()).done){i.next=93;break}return O=R.value,i.next=91,Number(O);case 91:i.next=87;break;case 93:i.next=98;break;case 95:i.prev=95,i.t4=i.catch(85),C.e(i.t4);case 98:return i.prev=98,C.f(),i.finish(98);case 101:i.next=105;break;case 103:return i.next=105,P.join(" ");case 105:return i.abrupt("break",336);case 106:return i.next=108,r.parseJsArg(n.join(" "));case 108:return i.abrupt("break",336);case 109:return e.exitCode=1,i.abrupt("break",336);case 111:return j=Function("fn = ".concat(n[0],"; return (...args) => fn(...args) ? args[0] : undefined")),i.delegateYield((0,ot.Z)((0,nt.Z)(r.read(a,(function(e){return j()(e,r.provideProcessCtxt(a))}))),st.Z),"t5",113);case 113:return i.abrupt("break",336);case 114:return i.delegateYield((0,ot.Z)((0,nt.Z)(r.get(e,n)),st.Z),"t6",115);case 115:return i.abrupt("break",336);case 116:return E=an.api.getSession(a.sessionKey),D=E.ttyShell,i.next=119,"1) The following commands are supported:";case 119:T=Tt()(Object.keys(Vt),{width:D.xterm.xterm.cols}).split(/\r?\n/),A=_t(T),i.prev=121,A.s();case 123:if((M=A.n()).done){i.next=129;break}return _=M.value,i.next=127,"".concat(wn).concat(_);case 127:i.next=123;break;case 129:i.next=134;break;case 131:i.prev=131,i.t7=i.catch(121),A.e(i.t7);case 134:return i.prev=134,A.f(),i.finish(134);case 137:return i.next=139,"2) Traverse context via `ls` or `ls -l var.foo.bar` (Object.keys).";case 139:return i.next=141,"3) View shell functions via `declare`.";case 141:return i.next=143,"4) Use Ctrl-c to interrupt and Ctrl-l to clear screen.";case 143:return i.next=145,"5) View history via up/down or `history`.";case 145:return i.next=147,"6) Traverse input using Option-left/right and Ctrl-{a,e}.";case 147:return i.next=149,"7) Delete input using Ctrl-{w,u,k}.";case 149:return i.next=151,"8) You can copy and paste.";case 151:return i.next=153,"9) Pipes, command substitution and background processes are supported.";case 153:return i.abrupt("break",336);case 154:I=an.api.getSession(a.sessionKey),V=I.ttyShell,N=V.getHistory(),B=_t(N),i.prev=157,B.s();case 159:if((L=B.n()).done){i.next=165;break}return K=L.value,i.next=163,K;case 163:i.next=159;break;case 165:i.next=170;break;case 167:i.prev=167,i.t8=i.catch(157),B.e(i.t8);case 170:return i.prev=170,B.f(),i.finish(170);case 173:return i.abrupt("break",336);case 174:if("break"!==function(){var e,t=(0,rt.v8)(n,{boolean:["STOP","CONT"]}),i=t.opts,s=_t(t.operands.map((function(e){return r.parseJsonArg(e)})).filter((function(e){return Number.isFinite(e)})));try{for(s.s();!(e=s.n()).done;){var o=e.value;an.api.getProcesses(a.sessionKey,o).reverse().forEach((function(e){var t;if(i.STOP)null===(t=e.onSuspend)||void 0===t||t.call(e),e.onSuspend=null,e.status=Ht.Suspended;else if(i.CONT){var n;null===(n=e.onResume)||void 0===n||n.call(e),e.onResume=null,e.status=Ht.Running}else{var r;e.status=Ht.Killed,null===(r=e.onResume)||void 0===r||r.call(e),e.onSuspend=e.onResume=null,setTimeout((function(){e.cleanups.forEach((function(e){return e()})),e.cleanups.length=0}))}}))}}catch(c){s.e(c)}finally{s.f()}return"break"}()){i.next=177;break}return i.abrupt("break",336);case 177:W=(0,rt.v8)(n,{boolean:["1","l","r","a"]}),G=W.opts,F=W.operands,J=an.api.getVar(a.sessionKey,"PWD"),$=F.length?F.slice():[""],U=r.provideProcessCtxt(a),H=$.map((function(e){return Rt(e,U,J)})),X=an.api.getSession(e.meta.sessionKey),q=X.ttyShell,Y=_t(H.entries()),i.prev=184,ee=z().mark((function e(){var t,n,r,i,s,o,c,u,l,h;return z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=(0,v.Z)(Q.value,2),n=t[0],void 0!==(r=t[1])){e.next=4;break}return an.api.warn(a.sessionKey,'ls: "'.concat($[n],'" is not defined')),e.abrupt("return","continue");case 4:if(!(H.length>1)){e.next=7;break}return e.next=7,"".concat(wn).concat($[n],":");case 7:i=(G.r?(0,Fe.RT)(r):Object.keys(r)).sort(),s=[],"home"!==J||G.a||(i=i.filter((function(e){return e.toUpperCase()!==e}))),G.l?("function"===typeof r&&(i=i.filter((function(e){return!["caller","callee","arguments"].includes(e)}))),o=i.map((function(e){var t,n;return(null===(t=r[e])||void 0===t||null===(n=t.constructor)||void 0===n?void 0:n.name)||(null===r[e]?"null":"undefined")})),c=Math.max.apply(Math,(0,y.Z)(o.map((function(e){return e.length})))),s=i.map((function(e,t){return"".concat(bn).concat(o[t].padEnd(c)).concat(kn," ").concat(e)}))):s=G[1]?i:Tt()(i,{width:q.xterm.xterm.cols}).split(/\r?\n/),u=_t(s),e.prev=12,u.s();case 14:if((l=u.n()).done){e.next=20;break}return h=l.value,e.next=18,h;case 18:e.next=14;break;case 20:e.next=25;break;case 22:e.prev=22,e.t0=e.catch(12),u.e(e.t0);case 25:return e.prev=25,u.f(),e.finish(25);case 28:case"end":return e.stop()}}),e,null,[[12,22,25,28]])})),Y.s();case 187:if((Q=Y.n()).done){i.next=194;break}return i.delegateYield(ee(),"t9",189);case 189:if("continue"!==i.t9){i.next=192;break}return i.abrupt("continue",192);case 192:i.next=187;break;case 194:i.next=199;break;case 196:i.prev=196,i.t10=i.catch(184),Y.e(i.t10);case 199:return i.prev=199,Y.f(),i.finish(199);case 202:return i.abrupt("break",336);case 203:return te=Function("return ".concat(n[0])),i.delegateYield((0,ot.Z)((0,nt.Z)(r.read(a,(function(e){return te()(e,r.provideProcessCtxt(a))}))),st.Z),"t11",205);case 205:return i.abrupt("break",336);case 206:ne=n.length?parseFloat(r.parseJsonArg(n[0]))||0:1,re=1e3*Math.max(ne,.5),ie=new Fe.BH,an.api.addCleanup(a,(function(){return ie.resolve()})),ae=1;case 210:return i.next=213,ae++;case 213:return i.next=215,(0,st.Z)(Promise.race([(0,Fe.wO)(re),ie.promise]));case 215:i.next=210;break;case 217:if(se=(0,rt.v8)(n,{boolean:["a","s"]}),oe=se.opts,ce=Object.values(an.api.getProcesses(a.sessionKey)).filter(oe.a?function(e){return e}:function(e){return e.key===e.pgid}),ue=["pid","ppid","pgid"].map((function(e){return e.padEnd(5)})).join(" "),!oe.s){i.next=246;break}le=_t(ce),i.prev=222,le.s();case 224:if((he=le.n()).done){i.next=236;break}return pe=he.value,fe=pe.key,de=pe.ppid,me=pe.pgid,ve=pe.status,ye=pe.src,ge=dn(ve),xe=[fe,de,me].map(String).map((function(e){return e.padEnd(5)})).join(" "),i.next=230,"".concat(wn).concat(ue).concat(xn);case 230:return i.next=232,"".concat(xe).concat(ge);case 232:return i.next=234,ye+"\n";case 234:i.next=224;break;case 236:i.next=241;break;case 238:i.prev=238,i.t12=i.catch(222),le.e(i.t12);case 241:return i.prev=241,le.f(),i.finish(241);case 244:i.next=267;break;case 246:return i.next=248,"".concat(wn).concat(ue).concat(xn);case 248:be=_t(ce),i.prev=249,be.s();case 251:if((we=be.n()).done){i.next=259;break}return ke=we.value,Ze=ke.key,Se=ke.ppid,Pe=ke.pgid,Ce=ke.status,Re=ke.src,Oe=dn(Ce),je=[Ze,Se,Pe].map(String).map((function(e){return e.padEnd(5)})).join(" "),i.next=257,"".concat(je).concat(Oe,"  ").concat((0,Fe.$G)(Re,30));case 257:i.next=251;break;case 259:i.next=264;break;case 261:i.prev=261,i.t13=i.catch(249),be.e(i.t13);case 264:return i.prev=264,be.f(),i.finish(264);case 267:return i.abrupt("break",336);case 268:return i.next=270,"/"+an.api.getVar(a.sessionKey,"PWD");case 270:return i.abrupt("break",336);case 271:return Ee=[],De=Function("return ".concat(n[0]))(),i.delegateYield((0,ot.Z)((0,nt.Z)(r.read(a,(function(e){Ee.push(e)}))),st.Z),"t14",274);case 274:return i.next=276,n[1]?Ee.reduce(De,r.parseJsArg(n[1])):Ee.reduce(De);case 276:return i.abrupt("break",336);case 277:return(Ae=an.api.getProcess(a)).status=Ht.Killed,null===(Te=Ae.onResume)||void 0===Te||Te.call(Ae),Ae.onSuspend=Ae.onResume=null,i.abrupt("break",336);case 282:Me=r.provideProcessCtxt(a),_e=an.api.getVar(a.sessionKey,"PWD"),Ie=_t(n),i.prev=285,Ie.s();case 287:if((Ve=Ie.n()).done){i.next=298;break}if(Ne=Ve.value,!("home"===(Be=Ot(Ne,0,_e))[0]&&Be.length>1)){i.next=295;break}Le=Be.pop(),delete Et(Be,Me)[Le],i.next=296;break;case 295:throw new St("cannot delete ".concat(Ne),1);case 296:i.next=287;break;case 298:i.next=303;break;case 300:i.prev=300,i.t15=i.catch(285),Ie.e(i.t15);case 303:return i.prev=303,Ie.f(),i.finish(303);case 306:return i.abrupt("break",336);case 307:return ze=Function("_","return async function *generator ".concat(n[0])),i.delegateYield((0,ot.Z)((0,nt.Z)(ze()(r.provideProcessCtxt(a,n.slice(1)))),st.Z),"t16",309);case 309:return i.abrupt("break",336);case 310:return i.next=312,a.sessionKey;case 312:return i.abrupt("break",336);case 313:return Ke=r.provideProcessCtxt(a),We=r.parseJsArg(n[1]),"/"===n[0][0]?Function("__1","__2","return __1.".concat(n[0].slice(1)," = __2"))(Ke,We):(Ge=r.computeCwd(a,Ke),Function("__1","__2","return __1.".concat(n[0]," = __2"))(Ge,We)),i.abrupt("break",336);case 317:return i.delegateYield(z().mark((function e(){var t,i,s;return z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=an.api.getProcess(a),i=1e3*(n.length?parseFloat(r.parseJsonArg(n[0]))||0:1),s=-1;case 3:return e.next=5,(0,st.Z)(new Promise((function(e,n){t.onSuspend=function(){i=s+i-Date.now(),e()},an.api.addCleanup(a,(function(){return n(Ct(a))})),(s=Date.now())&&setTimeout(e,i)})));case 5:return void(e.next=7);case 7:if(Date.now()<s+i-1){e.next=3;break}case 8:return e.abrupt("return","break");case 9:case"end":return e.stop()}}),e)}))(),"t17",318);case 318:if("break"!==i.t17){i.next=321;break}return i.abrupt("break",336);case 321:return Je=r.parseJsonArg(n[0]),i.delegateYield((0,ot.Z)((0,nt.Z)(void 0===Je?r.split(a):r.splitBy(a,Je)),st.Z),"t18",323);case 323:return i.abrupt("break",336);case 324:return $e=[],i.delegateYield((0,ot.Z)((0,nt.Z)(r.read(a,(function(e){$e.push(e)}))),st.Z),"t19",326);case 326:return i.next=328,$e;case 328:return i.abrupt("break",336);case 329:return e.exitCode=0,i.abrupt("break",336);case 331:Ue=an.api.getSession(a.sessionKey),He=Ue.var,Xe=Ue.func,qe=_t(n);try{for(qe.s();!(Ye=qe.n()).done;)Qe=Ye.value,delete He[Qe],delete Xe[Qe]}catch(et){qe.e(et)}finally{qe.f()}return i.abrupt("break",336);case 335:throw(0,Fe.Ql)(t);case 336:case"end":return i.stop()}}),i,null,[[13,35],[42,70,73,76],[48,58,61,64],[85,95,98,101],[121,131,134,137],[157,167,170,173],[184,196,199,202],[222,238,241,244],[249,261,264,267],[285,300,303,306]])})))()}},{key:"get",value:function(e,t){var n=this.provideProcessCtxt(e.meta),r=an.api.getVar(e.meta.sessionKey,"PWD"),i=t.map((function(e){return Rt(e,n,r)}));return e.exitCode=i.length&&i.every((function(e){return void 0===e}))?1:0,i}},{key:"computeCwd",value:function(e,t){return Et(an.api.getVar(e.sessionKey,"PWD").split("/"),t)}},{key:"launchFunc",value:function(){var e=(0,K.Z)(z().mark((function e(t,n,r){var i,a,s;return z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=(0,rt.VN)(n.node),a=an.api.getSession(t.meta.sessionKey),s=a.ttyShell,Object.assign(i.meta,Mt(Mt({},t.meta),{},{ppid:t.meta.pid,stack:t.meta.stack.concat(n.key)})),e.next=5,s.spawn(i,{posPositionals:r.slice()});case 5:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"provideProcessApi",value:function(e){var t=this;return{read:function(){var n=(0,K.Z)(z().mark((function n(){var r;return z().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,t.readOnce(e);case 2:return r=n.sent,n.abrupt("return",null!==r&&void 0!==r&&r.eof?null:r);case 4:case"end":return n.stop()}}),n)})));return function(){return n.apply(this,arguments)}}(),sleep:function(t){return new Promise((function(n,r){setTimeout(n,1e3*t),an.api.addCleanup(e,(function(){return r(Ct(e))}))}))}}}},{key:"provideProcessCtxt",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=an.api.getSession(e.sessionKey);return new Proxy({home:r.var,util:this.shellUtil},{get:function(r,i){return"api"===i?t.provideProcessApi(e):"args"===i?n:r[i]},deleteProperty:function(e,t){return!1}})}},{key:"readLoop",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return(0,at.Z)(z().mark((function r(){var i,a,s;return z().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(i=an.api.getProcess(e),!((a=an.api.resolve(0,e))instanceof Jt&&0!==i.pgid)){r.next=4;break}throw new St("background process tried to read tty",1);case 4:s={};case 5:return r.next=7,(0,st.Z)(a.readData(n));case 7:if((s=r.sent).eof){r.next=17;break}if(void 0===s.data){r.next=13;break}return r.next=11,t(s);case 11:if(!n){r.next=13;break}return r.abrupt("break",17);case 13:return r.next=15,(0,st.Z)(pn(i,a));case 15:r.next=5;break;case 17:case"end":return r.stop()}}),r)})))()}},{key:"read",value:function(e,t){var n=this;return(0,at.Z)(z().mark((function r(){return z().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.delegateYield((0,ot.Z)((0,nt.Z)(n.readLoop(e,(function(e){if(mn(e.data)){var n,r,i=[],a=_t(e.data.items);try{for(a.s();!(r=a.n()).done;){var s=r.value;void 0!==(n=t(s))&&i.push(n)}}catch(o){a.e(o)}finally{a.f()}return e.data.items=i,e.data}return t(e.data)}))),st.Z),"t0",1);case 1:case"end":return r.stop()}}),r)})))()}},{key:"readOnce",value:function(){var e=(0,K.Z)(z().mark((function e(t){var n,r,i,a,s,o,c;return z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=!0,r=!1,e.prev=2,a=(0,nt.Z)(this.readLoop(t,(function(e){return e.data}),!0));case 4:return e.next=6,a.next();case 6:return s=e.sent,n=s.done,e.next=10,s.value;case 10:if(o=e.sent,n){e.next=17;break}return c=o,e.abrupt("return",c);case 14:n=!0,e.next=4;break;case 17:e.next=23;break;case 19:e.prev=19,e.t0=e.catch(2),r=!0,i=e.t0;case 23:if(e.prev=23,e.prev=24,n||null==a.return){e.next=28;break}return e.next=28,a.return();case 28:if(e.prev=28,!r){e.next=31;break}throw i;case 31:return e.finish(28);case 32:return e.finish(23);case 33:return e.abrupt("return",{eof:!0});case 34:case"end":return e.stop()}}),e,this,[[2,19,23,33],[24,,28,32]])})));return function(t){return e.apply(this,arguments)}}()},{key:"split",value:function(e){var t=this;return(0,at.Z)(z().mark((function n(){return z().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.delegateYield((0,ot.Z)((0,nt.Z)(t.readLoop(e,(function(e){return mn(e.data)?(e.data.items=e.data.items.flatMap((function(e){return e})),e.data):Array.isArray(e.data)?vn(e.data):e.data}))),st.Z),"t0",1);case 1:case"end":return n.stop()}}),n)})))()}},{key:"splitBy",value:function(e,t){var n=this;return(0,at.Z)(z().mark((function r(){return z().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.delegateYield((0,ot.Z)((0,nt.Z)(n.readLoop(e,(function(e){if(mn(e.data))return e.data.items=e.data.items.flatMap((function(e){return e.split(t)})),e.data;if("string"===typeof e.data)return vn(e.data.split(t));throw new St("expected string",1)}))),st.Z),"t0",1);case 1:case"end":return r.stop()}}),r)})))()}},{key:"parseJsonArg",value:function(e){try{return void 0===e?void 0:JSON.parse(e)}catch(t){return e}}},{key:"parseJsArg",value:function(e){try{return Function("return ".concat(e))()}catch(t){return e}}}]),e}());function Bt(e,t){var n;if("undefined"===typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"===typeof e)return Lt(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Lt(e,t)}(e))||t&&e&&"number"===typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,o=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return s=e.done,e},e:function(e){o=!0,a=e},f:function(){try{s||null==n.return||n.return()}finally{if(o)throw a}}}}function Lt(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var zt,Kt=new(function(){function e(){(0,g.Z)(this,e)}return(0,x.Z)(e,[{key:"assignVars",value:function(e){var t=this;return(0,at.Z)(z().mark((function n(){var r,i,a;return z().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:r=Bt(e.Assigns),n.prev=1,r.s();case 3:if((i=r.n()).done){n.next=8;break}return a=i.value,n.delegateYield((0,ot.Z)((0,nt.Z)(t.Assign(a)),st.Z),"t0",6);case 6:n.next=3;break;case 8:n.next=13;break;case 10:n.prev=10,n.t1=n.catch(1),r.e(n.t1);case 13:return n.prev=13,r.f(),n.finish(13);case 16:case"end":return n.stop()}}),n,null,[[1,10,13,16]])})))()}},{key:"applyRedirects",value:function(){var e=(0,K.Z)(z().mark((function e(t,n){var r,i,a,s,o;return z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,r=Bt(n),e.prev=2,r.s();case 4:if((i=r.n()).done){e.next=11;break}return(a=i.value).exitCode=0,e.next=9,this.Redirect(a);case 9:e.next=4;break;case 11:e.next=16;break;case 13:e.prev=13,e.t0=e.catch(2),r.e(e.t0);case 16:return e.prev=16,r.f(),e.finish(16);case 19:e.next=25;break;case 21:throw e.prev=21,e.t1=e.catch(0),t.exitCode=null!==(s=null===(o=n.find((function(e){return e.exitCode})))||void 0===o?void 0:o.exitCode)&&void 0!==s?s:1,e.t1;case 25:case"end":return e.stop()}}),e,this,[[0,21],[2,13,16,19]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"expandParameter",value:function(e,t){if(/^\d+$/.test(t))return an.api.getPositional(e.pid,e.sessionKey,Number(t));var n=an.api.getVar(e.sessionKey,t);return void 0===n||"string"===typeof n?n||"":lt()(n)}},{key:"handleShError",value:function(e,t,n){if(t instanceof Pt)throw t;if(t instanceof St){var r=[n,t.message].filter(Boolean).join(": ");an.api.warn(e.meta.sessionKey,r),console.error("ShError: ".concat(e.meta.sessionKey,": ").concat(r)),e.exitCode=t.exitCode}else{var i=[n,null===t||void 0===t?void 0:t.message].filter(Boolean).join(": ");an.api.warn(e.meta.sessionKey,i),console.error("Internal ShError: ".concat(e.meta.sessionKey,": ").concat(i)),console.error(t),e.exitCode=2}}},{key:"handleTopLevelProcessError",value:function(e){if(e.code===sn.SIGKILL){var t=an.api.getProcess({pid:e.pid,sessionKey:e.sessionKey});if(t)an.api.getProcesses(e.sessionKey,t.pgid).forEach((function(e){e.status=Ht.Killed,e.cleanups.forEach((function(e){return e()})),e.cleanups.length=0}))}}},{key:"lastExpanded",value:function(){var e=(0,K.Z)(z().mark((function e(t){var n,r,i,a,s,o,c;return z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=void 0,r=!0,i=!1,e.prev=3,s=(0,nt.Z)(t);case 5:return e.next=7,s.next();case 7:return o=e.sent,r=o.done,e.next=11,o.value;case 11:if(c=e.sent,r){e.next=18;break}n=c;case 15:r=!0,e.next=5;break;case 18:e.next=24;break;case 20:e.prev=20,e.t0=e.catch(3),i=!0,a=e.t0;case 24:if(e.prev=24,e.prev=25,r||null==s.return){e.next=29;break}return e.next=29,s.return();case 29:if(e.prev=29,!i){e.next=32;break}throw a;case 32:return e.finish(29);case 33:return e.finish(24);case 34:return e.abrupt("return",n);case 35:case"end":return e.stop()}}),e,null,[[3,20,24,34],[25,,29,33]])})));return function(t){return e.apply(this,arguments)}}()},{key:"stmts",value:function(e,t){return(0,at.Z)(z().mark((function n(){var r,i,a;return z().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:r=Bt(t),n.prev=1,r.s();case 3:if((i=r.n()).done){n.next=9;break}return a=i.value,n.delegateYield((0,ot.Z)((0,nt.Z)(Wt.Stmt(a)),st.Z),"t0",6);case 6:e.exitCode=a.exitCode;case 7:n.next=3;break;case 9:n.next=14;break;case 11:n.prev=11,n.t1=n.catch(1),r.e(n.t1);case 14:return n.prev=14,r.f(),n.finish(14);case 17:case"end":return n.stop()}}),n,null,[[1,11,14,17]])})))()}},{key:"performShellExpansion",value:function(){var e=(0,K.Z)(z().mark((function e(t){var n,r,i,a,s,o;return z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=[],r=Bt(t),e.prev=2,r.s();case 4:if((i=r.n()).done){e.next=17;break}return a=i.value,e.next=8,this.lastExpanded(this.Expand(a));case 8:if(s=e.sent,o=1===a.Parts.length?a.Parts[0]:null,!a.exitCode){e.next=14;break}throw new St("failed to expand word",a.exitCode);case 14:"SglQuoted"===(null===o||void 0===o?void 0:o.type)?n.push(s.value):"ParamExp"===(null===o||void 0===o?void 0:o.type)||"CmdSubst"===(null===o||void 0===o?void 0:o.type)?xt(s.value).forEach((function(e){return n.push(e)})):s.values.forEach((function(e){return n.push(e)}));case 15:e.next=4;break;case 17:e.next=22;break;case 19:e.prev=19,e.t0=e.catch(2),r.e(e.t0);case 22:return e.prev=22,r.f(),e.finish(22);case 25:return e.abrupt("return",n);case 26:case"end":return e.stop()}}),e,this,[[2,19,22,25]])})));return function(t){return e.apply(this,arguments)}}()},{key:"Assign",value:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){var t=this,n=e.meta,r=e.Name,i=e.Value,a=e.Naked;return(0,at.Z)(z().mark((function e(){return z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=an.api,e.t1=n.sessionKey,e.t2=r.Value,a||!i){e.next=9;break}return e.next=6,(0,st.Z)(t.lastExpanded(Wt.Expand(i)));case 6:e.t3=e.sent.value,e.next=10;break;case 9:e.t3="";case 10:e.t4=e.t3,e.t0.setVar.call(e.t0,e.t1,e.t2,e.t4);case 12:case"end":return e.stop()}}),e)})))()}))},{key:"BinaryCmd",value:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){return(0,at.Z)(z().mark((function t(){var n,r,i,a,s,o,c,u,l,h,p,f,d,m,y,g,x,b,w;return z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=it.binaryCmds(e),r=[n[0].X].concat(n.map((function(e){return e.Y}))),t.t0=e.Op,t.next="&&"===t.t0?5:"||"===t.t0?24:"|"===t.t0?43:62;break;case 5:i=Bt(r),t.prev=6,i.s();case 8:if((a=i.n()).done){t.next=15;break}return s=a.value,t.delegateYield((0,ot.Z)((0,nt.Z)(Wt.Stmt(s)),st.Z),"t1",11);case 11:if(!(e.exitCode=s.exitCode)){t.next=13;break}return t.abrupt("break",15);case 13:t.next=8;break;case 15:t.next=20;break;case 17:t.prev=17,t.t2=t.catch(6),i.e(t.t2);case 20:return t.prev=20,i.f(),t.finish(20);case 23:return t.abrupt("break",63);case 24:o=Bt(r),t.prev=25,o.s();case 27:if((c=o.n()).done){t.next=34;break}return u=c.value,t.delegateYield((0,ot.Z)((0,nt.Z)(Wt.Stmt(u)),st.Z),"t3",30);case 30:if(e.exitCode=u.exitCode){t.next=32;break}return t.abrupt("break",34);case 32:t.next=27;break;case 34:t.next=39;break;case 36:t.prev=36,t.t4=t.catch(25),o.e(t.t4);case 39:return t.prev=39,o.f(),t.finish(39);case 42:return t.abrupt("break",63);case 43:l=[],h=r.map((function(t){var n=(0,rt.nL)((0,rt.VN)(t));return n.meta.ppid=e.meta.pid,n})),t.prev=45,p=an.api.getSession(e.meta.sessionKey),f=p.ttyShell,d=Bt(h.slice(0,-1).entries());try{for(d.s();!(m=d.n()).done;)y=(0,v.Z)(m.value,2),g=y[0],x=y[1],b="/dev/fifo-".concat(x.meta.pid,"-").concat(g),l.push(an.api.createFifo(b)),h[g+1].meta.fd[0]=x.meta.fd[1]=b}catch(k){d.e(k)}finally{d.f()}return w=h.map((function(e){var t=e.meta;return an.api.resolve(1,t)})),t.next=52,(0,st.Z)(Promise.all(h.map((function(t,n){return new Promise(function(){var r=(0,K.Z)(z().mark((function r(i,a){var s;return z().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,r.next=3,f.spawn(t);case 3:if(w[n].finishedWriting(),null===(s=w[n-1])||void 0===s||s.finishedReading(),!(e.exitCode=t.exitCode)){r.next=7;break}throw new St("pipe ".concat(n),e.exitCode);case 7:i(),r.next=13;break;case 10:r.prev=10,r.t0=r.catch(0),a(r.t0);case 13:case"end":return r.stop()}}),r,null,[[0,10]])})));return function(e,t){return r.apply(this,arguments)}}())}))));case 52:t.next=58;break;case 54:throw t.prev=54,t.t5=t.catch(45),h.map((function(e){var t=e.meta;return an.api.getProcess(t)})).forEach((function(e){return e&&(e.status=Ht.Killed)})),Ct(e.meta);case 58:return t.prev=58,l.forEach((function(e){e.finishedWriting(),an.api.removeDevice(e.key)})),t.finish(58);case 61:return t.abrupt("break",63);case 62:throw new St("binary command ".concat(e.Op," unsupported"),2);case 63:case"end":return t.stop()}}),t,null,[[6,17,20,23],[25,36,39,42],[45,54,58,61]])})))()}))},{key:"Block",value:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){return this.stmts(e,e.Stmts)}))},{key:"CallExpr",value:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){return(0,at.Z)(z().mark((function t(){var n,r,i,a,s,o,c,u,l;return z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.exitCode=0,t.next=3,(0,st.Z)(Wt.performShellExpansion(e.Args));case 3:if(n=t.sent,r=(0,Z.Z)(n),i=r[0],a=r.slice(1),e.meta.verbose&&console.log("simple command",n),!n.length){t.next=49;break}if(!Nt.isCmd(i)){t.next=11;break}return t.delegateYield((0,ot.Z)((0,nt.Z)(Nt.runCmd(e,i,a)),st.Z),"t0",9);case 9:t.next=47;break;case 11:if(!(s=an.api.getFunc(e.meta.sessionKey,i))){t.next=16;break}return t.next=14,(0,st.Z)(Nt.launchFunc(e,s,a));case 14:t.next=47;break;case 16:t.prev=16,o=Bt(n),t.prev=18,o.s();case 20:if((c=o.n()).done){t.next=34;break}if(!(u=c.value).includes("(")){t.next=26;break}return t.delegateYield((0,ot.Z)((0,nt.Z)(Nt.get(e,[u])),st.Z),"t1",24);case 24:t.next=32;break;case 26:if(void 0===(l=Nt.get(e,[u]))[0]){t.next=31;break}return t.delegateYield((0,ot.Z)((0,nt.Z)(l),st.Z),"t2",29);case 29:t.next=32;break;case 31:throw Error();case 32:t.next=20;break;case 34:t.next=39;break;case 36:t.prev=36,t.t3=t.catch(18),o.e(t.t3);case 39:return t.prev=39,o.f(),t.finish(39);case 42:t.next=47;break;case 44:throw t.prev=44,t.t4=t.catch(16),new St("not found",127);case 47:t.next=50;break;case 49:return t.delegateYield((0,ot.Z)((0,nt.Z)(Wt.assignVars(e)),st.Z),"t5",50);case 50:case"end":return t.stop()}}),t,null,[[16,44],[18,36,39,42]])})))()}))},{key:"Command",value:function(e){function t(t,n){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e,t){var n=this;return(0,at.Z)(z().mark((function r(){var i,a,s,o,c,u,l,h,p,f,d;return z().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,r.next=3,(0,st.Z)(Wt.applyRedirects(e,t));case 3:if("CallExpr"!==e.type){r.next=7;break}i=n.CallExpr(e),r.next=25;break;case 7:r.t0=e.type,r.next="Block"===r.t0?10:"BinaryCmd"===r.t0?12:"DeclClause"===r.t0?14:"FuncDecl"===r.t0?16:"IfClause"===r.t0?18:"TimeClause"===r.t0?20:"Subshell"===r.t0?22:24;break;case 10:return i=n.Block(e),r.abrupt("break",25);case 12:return i=n.BinaryCmd(e),r.abrupt("break",25);case 14:return i=n.DeclClause(e),r.abrupt("break",25);case 16:return i=n.FuncDecl(e),r.abrupt("break",25);case 18:return i=n.IfClause(e),r.abrupt("break",25);case 20:return i=n.TimeClause(e),r.abrupt("break",25);case 22:return i=n.Subshell(e),r.abrupt("break",25);case 24:throw new St("not implemented",2);case 25:if(a=an.api.getProcess(e.meta),s=an.api.resolve(1,e.meta)){r.next=29;break}throw Ct(e.meta);case 29:o=!0,c=!1,r.prev=31,l=(0,nt.Z)(i);case 33:return r.next=35,(0,st.Z)(l.next());case 35:return h=r.sent,o=h.done,r.next=39,(0,st.Z)(h.value);case 39:if(p=r.sent,o){r.next=49;break}return f=p,r.next=44,(0,st.Z)(ln(a,s));case 44:return r.next=46,(0,st.Z)(s.writeData(f));case 46:o=!0,r.next=33;break;case 49:r.next=55;break;case 51:r.prev=51,r.t1=r.catch(31),c=!0,u=r.t1;case 55:if(r.prev=55,r.prev=56,o||null==l.return){r.next=60;break}return r.next=60,(0,st.Z)(l.return());case 60:if(r.prev=60,!c){r.next=63;break}throw u;case 63:return r.finish(60);case 64:return r.finish(55);case 65:r.next=73;break;case 67:r.prev=67,r.t2=r.catch(0),d="CallExpr"===e.type?e.Args[0].string||"unknown CallExpr":e.type,(r.t2 instanceof St?r.t2:new St("",1,r.t2)).message="".concat(e.meta.stack.concat(d).join(": "),": ").concat(r.t2.message||r.t2),Wt.handleShError(e,r.t2);case 73:case"end":return r.stop()}}),r,null,[[0,67],[31,51,55,65],[56,,60,64]])})))()}))},{key:"DeclClause",value:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){var t=this;return(0,at.Z)(z().mark((function n(){var r,i,a;return z().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if("declare"!==e.Variant.Value){n.next=24;break}if(!e.Args.length){n.next=20;break}r=Bt(e.Args),n.prev=3,r.s();case 5:if((i=r.n()).done){n.next=10;break}return a=i.value,n.delegateYield((0,ot.Z)((0,nt.Z)(t.Assign(a)),st.Z),"t0",8);case 8:n.next=5;break;case 10:n.next=15;break;case 12:n.prev=12,n.t1=n.catch(3),r.e(n.t1);case 15:return n.prev=15,r.f(),n.finish(15);case 18:n.next=22;break;case 20:return e.exitCode=0,n.delegateYield((0,ot.Z)((0,nt.Z)(Nt.runCmd(e,"declare",[])),st.Z),"t2",22);case 22:n.next=25;break;case 24:throw new St("Commmand: DeclClause: ".concat(e.Variant.Value," unsupported"),2);case 25:case"end":return n.stop()}}),n,null,[[3,12,15,18]])})))()}))},{key:"Expand",value:function(e){var t=this;return(0,at.Z)(z().mark((function n(){var r,i,a,s,o,c,u,l,h,p,f,d,m,v,g,x,b,w,k;return z().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!(e.Parts.length>1)){n.next=53;break}r=Bt(e.Parts),n.prev=2,r.s();case 4:if((i=r.n()).done){n.next=11;break}return a=i.value,n.next=8,(0,st.Z)(t.lastExpanded(Wt.ExpandPart(a)));case 8:a.string=n.sent.value;case 9:n.next=4;break;case 11:n.next=16;break;case 13:n.prev=13,n.t0=n.catch(2),r.e(n.t0);case 16:return n.prev=16,r.f(),n.finish(16);case 19:s=!1,o=[],c=Bt(e.Parts),n.prev=22,c.s();case 24:if((u=c.n()).done){n.next=40;break}if(l=u.value,h=l.type,p=l.string,f=p,"ParamExp"!==h&&"CmdSubst"!==h){n.next=37;break}if((d=xt(f,!1)).length){n.next=33;break}return n.abrupt("continue",38);case 33:!o.length||s||/^\s/.test(d[0])?o.push.apply(o,(0,y.Z)(d.map((function(e){return e.trim()})))):(o.push(o.pop()+d[0].trim()),o.push.apply(o,(0,y.Z)(d.slice(1).map((function(e){return e.trim()})))));case 34:s=/\s$/.test((0,Fe.Z$)(d)),n.next=38;break;case 37:!o.length||s?(o.push(f),s=!1):(o.push(o.pop()+f),s=!1);case 38:n.next=24;break;case 40:n.next=45;break;case 42:n.prev=42,n.t1=n.catch(22),c.e(n.t1);case 45:return n.prev=45,c.f(),n.finish(45);case 48:return e.string=o.join(" "),n.next=51,bt(o);case 51:n.next=88;break;case 53:m=!0,v=!1,n.prev=55,x=(0,nt.Z)(t.ExpandPart(e.Parts[0]));case 57:return n.next=59,(0,st.Z)(x.next());case 59:return b=n.sent,m=b.done,n.next=63,(0,st.Z)(b.value);case 63:if(w=n.sent,m){n.next=72;break}return k=w,e.string=k.value,n.next=69,k;case 69:m=!0,n.next=57;break;case 72:n.next=78;break;case 74:n.prev=74,n.t2=n.catch(55),v=!0,g=n.t2;case 78:if(n.prev=78,n.prev=79,m||null==x.return){n.next=83;break}return n.next=83,(0,st.Z)(x.return());case 83:if(n.prev=83,!v){n.next=86;break}throw g;case 86:return n.finish(83);case 87:return n.finish(78);case 88:case"end":return n.stop()}}),n,null,[[2,13,16,19],[22,42,45,48],[55,74,78,88],[79,,83,87]])})))()}},{key:"ExpandPart",value:function(e){var t=this;return(0,at.Z)(z().mark((function n(){var r,i,a,s,o,c,u,l,h,p;return z().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:n.t0=e.type,n.next="DblQuoted"===n.t0?3:"Lit"===n.t0?26:"SglQuoted"===n.t0?29:"CmdSubst"===n.t0?32:"ParamExp"===n.t0?46:("ArithmExp"===n.t0||"ExtGlob"===n.t0||n.t0,48);break;case 3:r=[],i=Bt(e.Parts),n.prev=5,i.s();case 7:if((a=i.n()).done){n.next=15;break}return s=a.value,n.next=11,(0,st.Z)(t.lastExpanded(Wt.ExpandPart(s)));case 11:o=n.sent,"ParamExp"===s.type&&"@"===s.Param.Value?r.push.apply(r,["".concat(r.pop()||"").concat(o.values[0]||"")].concat((0,y.Z)(o.values.slice(1)))):r.push("".concat(r.pop()||"").concat(o.value||""));case 13:n.next=7;break;case 15:n.next=20;break;case 17:n.prev=17,n.t1=n.catch(5),i.e(n.t1);case 20:return n.prev=20,i.f(),n.finish(20);case 23:return n.next=25,bt(r);case 25:return n.abrupt("return");case 26:return n.next=28,bt(kt(e));case 28:return n.abrupt("break",49);case 29:return n.next=31,bt(Zt(e));case 31:return n.abrupt("break",49);case 32:return c=(0,rt.nL)((0,rt.VN)(e)),u="/dev/fifo-cmd-".concat((0,ct.x0)()),l=an.api.createFifo(u),c.meta.fd[1]=l.key,h=an.api.getSession(e.meta.sessionKey),p=h.ttyShell,n.next=39,(0,st.Z)(p.spawn(c));case 39:return n.prev=39,n.next=42,bt(l.readAll().map((function(e){return"string"===typeof e?e:lt()(e)})).join("\n").replace(/\n*$/,""));case 42:return n.prev=42,an.api.removeDevice(l.key),n.finish(42);case 45:return n.abrupt("break",49);case 46:return n.delegateYield((0,ot.Z)((0,nt.Z)(t.ParamExp(e)),st.Z),"t2",47);case 47:return n.abrupt("return");case 48:throw Error("".concat(e.type," unimplemented"));case 49:case"end":return n.stop()}}),n,null,[[5,17,20,23],[39,,42,45]])})))()}},{key:"File",value:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){return Wt.stmts(e,e.Stmts)}))},{key:"FuncDecl",value:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){return(0,at.Z)(z().mark((function t(){var n,r;return z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=(0,rt.VN)(e.Body),r=(0,rt.nL)(n),an.api.addFunc(e.meta.sessionKey,e.Name.Value,r);case 3:case"end":return t.stop()}}),t)})))()}))},{key:"IfClause",value:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){return(0,at.Z)(z().mark((function t(){var n,r,i,a,s,o,c;return z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=Bt((0,rt.Wc)(e)),t.prev=1,n.s();case 3:if((r=n.n()).done){t.next=18;break}if(i=r.value,a=i.Cond,s=i.Then,!a.length){t.next=13;break}return t.delegateYield((0,ot.Z)((0,nt.Z)(Wt.stmts(e,a)),st.Z),"t0",7);case 7:if(0!==(0,Fe.Z$)(a).exitCode){t.next=11;break}return t.delegateYield((0,ot.Z)((0,nt.Z)(Wt.stmts(e,s)),st.Z),"t1",9);case 9:return e.exitCode=(null===(o=(0,Fe.Z$)(s))||void 0===o?void 0:o.exitCode)||0,t.abrupt("return");case 11:t.next=16;break;case 13:return t.delegateYield((0,ot.Z)((0,nt.Z)(Wt.stmts(e,s)),st.Z),"t2",14);case 14:return e.exitCode=(null===(c=(0,Fe.Z$)(s))||void 0===c?void 0:c.exitCode)||0,t.abrupt("return");case 16:t.next=3;break;case 18:t.next=23;break;case 20:t.prev=20,t.t3=t.catch(1),n.e(t.t3);case 23:return t.prev=23,n.f(),t.finish(23);case 26:case"end":return t.stop()}}),t,null,[[1,20,23,26]])})))()}))},{key:"ParamExp",value:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){var t=this,n=e.meta,r=e.Param,i=e.Slice,a=e.Repl,s=e.Length,o=e.Excl,c=e.Exp;return(0,at.Z)(z().mark((function e(){var u;return z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(o||s||a||i)){e.next=4;break}throw new St("ParamExp: ".concat(r.Value,": unsupported operation"),2);case 4:if(!c){e.next=22;break}e.t0=c.Op,e.next=":-"===e.t0?8:19;break;case 8:if(""!==(u=t.expandParameter(n,r.Value))||!c.Word){e.next=15;break}return e.next=12,(0,st.Z)(t.lastExpanded(t.Expand(c.Word)));case 12:e.t1=e.sent,e.next=16;break;case 15:e.t1=bt(u);case 16:return e.next=18,e.t1;case 18:return e.abrupt("break",20);case 19:throw new St("ParamExp: ".concat(r.Value,": unsupported operation"),2);case 20:e.next=29;break;case 22:if("@"!==r.Value){e.next=27;break}return e.next=25,bt(an.api.getProcess(n).positionals.slice(1));case 25:e.next=29;break;case 27:return e.next=29,bt(t.expandParameter(n,r.Value));case 29:case"end":return e.stop()}}),e)})))()}))},{key:"Redirect",value:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(){var e=(0,K.Z)(z().mark((function e(t){var n,r,i;return z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(">"!==t.Op&&">>"!==t.Op){e.next=11;break}return e.next=3,this.lastExpanded(Wt.Expand(t.Word));case 3:if(n=e.sent,"/dev/null"!==(r=n.value)){e.next=9;break}return e.abrupt("return",un(t.parent,{1:"/dev/null"}));case 9:return i=an.api.createVarDevice(t.meta.sessionKey,r,">"===t.Op?"last":"array"),e.abrupt("return",un(t.parent,{1:i.key}));case 11:throw new St("".concat(t.Op,": unsupported redirect"),127);case 12:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}())},{key:"Stmt",value:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){var t=this;return(0,at.Z)(z().mark((function n(){var r,i,a;return z().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(e.Cmd){n.next=4;break}throw new St("pure redirects are unsupported",2);case 4:if(!e.Background||0!==e.meta.pgid){n.next=13;break}r=an.api.getSession(e.meta.sessionKey),i=r.ttyShell,(a=(0,rt.nL)((0,rt.VN)(e))).meta.ppid=e.meta.pid,a.meta.pgid=an.api.getSession(e.meta.sessionKey).nextPid,i.spawn(a).catch((function(e){e instanceof Pt?t.handleTopLevelProcessError(e):console.error("background process error",e)})),e.exitCode=e.Negated?1:0,n.next=16;break;case 13:return n.delegateYield((0,ot.Z)((0,nt.Z)(Wt.Command(e.Cmd,e.Redirs)),st.Z),"t0",14);case 14:e.exitCode=e.Cmd.exitCode,e.Negated&&(e.exitCode=1-Number(!!e.Cmd.exitCode));case 16:case"end":return n.stop()}}),n)})))()}))},{key:"Subshell",value:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){return(0,at.Z)(z().mark((function t(){var n,r,i;return z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=(0,rt.nL)((0,rt.VN)(e)),r=an.api.getSession(e.meta.sessionKey),i=r.ttyShell,t.next=4,(0,st.Z)(i.spawn(n));case 4:case"end":return t.stop()}}),t)})))()}))},{key:"TimeClause",value:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){return(0,at.Z)(z().mark((function t(){var n;return z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=Date.now(),!e.Stmt){t.next=3;break}return t.delegateYield((0,ot.Z)((0,nt.Z)(Wt.Stmt(e.Stmt)),st.Z),"t0",3);case 3:an.api.resolve(1,e.meta).writeData("real\t".concat(Date.now()-n,"ms"));case 4:case"end":return t.stop()}}),t)})))()}))}]),e}()),Wt=Kt,Gt={range:"{\ncall '({args}) =>\n  [...Array(Number(args[0]))].map((_, i) => i)\n' \"$1\"\n}",seq:'{\n  range "$1" | split\n}',pretty:"{\n  map '(x, {util}) => util.pretty(x)'\n}",keys:"{\n  map Object.keys\n}",log:"{\n  map 'x => console.log(x)'\n}"},Ft={},Jt=("\n\n".concat("\n\n# options key handler\nkey | run '({ api: {read}, var: {msg}, stage: {opt} }) {\n  while (msg = await read()) {\n    if (msg.type !== \"keydown\" || !opt.enabled) continue;\n    switch (msg.key) {\n      // NOOP\n    }\n  }\n}' &\n".trim(),"\n\n").trim(),function(){function e(t,n,r){(0,g.Z)(this,e),this.sessionKey=t,this.io=n,this.history=r,(0,k.Z)(this,"key",void 0),(0,k.Z)(this,"xterm",void 0),(0,k.Z)(this,"inputs",[]),(0,k.Z)(this,"input",null),(0,k.Z)(this,"buffer",[]),(0,k.Z)(this,"maxLines",500),(0,k.Z)(this,"process",void 0),(0,k.Z)(this,"oneTimeReaders",[]),this.key="/dev/tty-".concat(t)}return(0,x.Z)(e,[{key:"initialise",value:function(){var e=(0,K.Z)(z().mark((function e(t){var n,r,i,a,s;return z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.xterm=t,this.io.read(this.onMessage.bind(this)),an.api.createProcess({sessionKey:this.sessionKey,ppid:0,pgid:0,src:""}),this.process=an.api.getSession(this.sessionKey).process[0],$t.parse){e.next=7;break}return e.next=7,new Promise((function(e){return Ut.push(e)}));case 7:for(this.loadShellFuncs(Gt),n=0,r=Object.entries(Ft);n<r.length;n++)i=(0,v.Z)(r[n],2),a=i[0],s=i[1],an.api.setVar(this.sessionKey,a,s);return e.next=11,this.runProfile();case 11:this.prompt("$");case 12:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"onMessage",value:function(e){var t=this;switch(e.key){case"req-history-line":var n=this.getHistoryLine(e.historyIndex),r=n.line,i=n.nextIndex;this.io.write({key:"send-history-line",line:r,nextIndex:i});break;case"send-line":this.oneTimeReaders.length?(this.oneTimeReaders.shift().resolve(e.line),this.io.write({key:"tty-received-line"})):(this.inputs.push({line:e.line,resolve:function(){return t.io.write({key:"tty-received-line"})}}),this.tryParse());break;case"send-kill-sig":this.buffer.length=0,this.oneTimeReaders.forEach((function(e){return(0,e.reject)()})),this.oneTimeReaders.length=0,this.process.status!==Ht.Running?this.prompt("$"):Kt.handleTopLevelProcessError(new Pt(sn.SIGKILL,0,this.sessionKey));break;default:throw(0,Fe.Ql)(e)}}},{key:"spawn",value:function(){var e=(0,K.Z)(z().mark((function e(t){var n,r,i,a,s,o,c,u,l,h,p,f,d,m=arguments;return z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=m.length>1&&void 0!==m[1]?m[1]:{},r=t.meta,n.leading?(this.process.status=Ht.Running,this.process.onResume=null):(i=r.ppid,a=r.pgid,s=an.api.getProcess(r),o=s.positionals,c=an.api.createProcess({ppid:i,pgid:a,sessionKey:r.sessionKey,src:it.src(t),posPositionals:n.posPositionals||o.slice(1)}),r.pid=c.key),e.prev=3,u=!0,l=!1,e.prev=6,p=(0,nt.Z)(Kt.File(t));case 8:return e.next=10,p.next();case 10:return f=e.sent,u=f.done,e.next=14,f.value;case 14:if(d=e.sent,u){e.next=21;break}d;case 18:u=!0,e.next=8;break;case 21:e.next=27;break;case 23:e.prev=23,e.t0=e.catch(6),l=!0,h=e.t0;case 27:if(e.prev=27,e.prev=28,u||null==p.return){e.next=32;break}return e.next=32,p.return();case 32:if(e.prev=32,!l){e.next=35;break}throw h;case 35:return e.finish(32);case 36:return e.finish(27);case 37:t.meta.verbose&&console.warn("".concat(r.sessionKey).concat(r.pgid?" (background)":"",": ").concat(r.pid,": exit ").concat(t.exitCode)),e.next=44;break;case 40:throw e.prev=40,e.t1=e.catch(3),e.t1 instanceof Pt&&console.error("".concat(r.sessionKey).concat(r.pgid?" (background)":"",": ").concat(r.pid,": ").concat(e.t1.code)),e.t1;case 44:return e.prev=44,!n.leading&&an.api.removeProcess(r.pid,this.sessionKey),e.finish(44);case 47:case"end":return e.stop()}}),e,this,[[3,40,44,47],[6,23,27,37],[28,,32,36]])})));return function(t){return e.apply(this,arguments)}}()},{key:"tryParse",value:function(){var e=(0,K.Z)(z().mark((function e(){var t,n,r,i;return z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.input=this.inputs.pop()||null,this.input){e.next=3;break}return e.abrupt("return");case 3:e.prev=3,this.buffer.push(this.input.line),t=$t.tryParseBuffer(this.buffer.slice()),e.t0=t.key,e.next="failed"===e.t0?9:"complete"===e.t0?15:"incomplete"===e.t0?24:26;break;case 9:return n="mvdan-sh: ".concat(t.error.replace(/^src\.sh:/,"")),console.error(n),this.io.write({key:"error",msg:n}),this.buffer.length=0,this.prompt("$"),e.abrupt("break",26);case 15:return this.buffer.length=0,(r=it.src(t.parsed))&&this.storeSrcLine(r),this.process.src=r,this.provideContextToParsed(t.parsed),e.next=22,this.spawn(t.parsed,{leading:!0});case 22:return this.prompt("$"),e.abrupt("break",26);case 24:return this.prompt(">"),e.abrupt("break",26);case 26:e.next=32;break;case 28:e.prev=28,e.t1=e.catch(3),e.t1 instanceof Pt?Kt.handleTopLevelProcessError(e.t1):console.error("unexpected error propagated to tty.shell",e.t1),this.prompt("$");case 32:return e.prev=32,null===(i=this.input)||void 0===i||i.resolve(),this.input=null,this.process.status=Ht.Suspended,e.finish(32);case 37:case"end":return e.stop()}}),e,this,[[3,28,32,37]])})));return function(){return e.apply(this,arguments)}}()},{key:"prompt",value:function(e){this.io.write({key:"send-xterm-prompt",prompt:"".concat(e," ")})}},{key:"loadShellFuncs",value:function(e){for(var t=0,n=Object.entries(e);t<n.length;t++){var r=(0,v.Z)(n[t],2),i=r[0],a=r[1];try{var s=$t.parse("".concat(i," () ").concat(a.trim())).Stmts[0].Cmd.Body,o=(0,rt.nL)(s);an.api.addFunc(this.sessionKey,i,o)}catch(c){console.error("Failed to load function: ".concat(i)),console.error(c)}}}},{key:"runProfile",value:function(){var e=(0,K.Z)(z().mark((function e(){var t,n;return z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=an.api.getVar(this.sessionKey,"PROFILE")||"",n=$t.parse(t),this.provideContextToParsed(n),e.next=5,this.spawn(n,{leading:!0});case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"provideContextToParsed",value:function(e){Object.assign(e.meta,{sessionKey:this.sessionKey,pid:0,ppid:0,pgid:0,fd:{0:this.key,1:this.key,2:this.key},stack:[],verbose:!1})}},{key:"getHistoryLine",value:function(e){var t=this.history.length-1;return{line:this.history[t-e]||"",nextIndex:e<0?0:e>t?t:e}}},{key:"getHistory",value:function(){return this.history.slice()}},{key:"storeSrcLine",value:function(e){var t=this.history.pop();if(t&&this.history.push(t),t!==e){for(this.history.push(e);this.history.length>this.maxLines;)this.history.shift();an.api.persist(this.sessionKey)}}},{key:"readData",value:function(){var e=(0,K.Z)(z().mark((function e(){var t=this;return z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,new Promise((function(e,n){var r;t.oneTimeReaders.push({resolve:function(t){return e({data:t})},reject:n}),null===(r=t.input)||void 0===r||r.resolve(),t.input=null}));case 3:return e.abrupt("return",e.sent);case 6:return e.prev=6,e.t0=e.catch(0),e.abrupt("return",{eof:!0});case 9:case"end":return e.stop()}}),e,null,[[0,6]])})));return function(){return e.apply(this,arguments)}}()},{key:"writeData",value:function(){var e=(0,K.Z)(z().mark((function e(t){return z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.io.write(t);case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"finishedWriting",value:function(){}},{key:"finishedReading",value:function(){}}]),e}()),$t={tryParseBuffer:function(e){return{key:"failed",error:"not ready"}}},Ut=[];Promise.all([n.e(763),n.e(474)]).then(n.bind(n,80557)).then((function(e){$t=e.parseService,Ut.forEach((function(e){return e()})),Ut.length=0})),function(e){e[e.Initial=0]="Initial",e[e.Connected=1]="Connected",e[e.Disconnected=2]="Disconnected"}(zt||(zt={}));var Ht,Xt=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e4;(0,g.Z)(this,e),this.key=t,this.size=n,(0,k.Z)(this,"buffer",void 0),(0,k.Z)(this,"readerStatus",zt.Initial),(0,k.Z)(this,"writerStatus",zt.Initial),(0,k.Z)(this,"readerResolver",null),(0,k.Z)(this,"writerResolver",null),this.buffer=[]}return(0,x.Z)(e,[{key:"readData",value:function(){var e=(0,K.Z)(z().mark((function e(t){var n,r=this;return z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.readerStatus=this.readerStatus||zt.Connected,!this.buffer.length){e.next=17;break}if(null===(n=this.writerResolver)||void 0===n||n.call(this),this.writerResolver=null,!t){e.next=14;break}if(mn(this.buffer[0])){e.next=9;break}return e.abrupt("return",{data:this.buffer.shift()});case 9:if(1!==this.buffer[0].items.length){e.next=11;break}return e.abrupt("return",{data:this.buffer.shift().items[0]});case 11:return e.abrupt("return",{data:this.buffer[0].items.shift()});case 14:return e.abrupt("return",{data:this.buffer.shift()});case 15:e.next=19;break;case 17:if(this.writerStatus!==zt.Disconnected){e.next=19;break}return e.abrupt("return",{eof:!0});case 19:return e.abrupt("return",new Promise((function(e){r.readerResolver=e})).then((function(){return{data:void 0}})));case 20:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"writeData",value:function(){var e=(0,K.Z)(z().mark((function e(t){var n,r=this;return z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.writerStatus=zt.Connected,this.readerStatus!==zt.Disconnected){e.next=4;break}return this.buffer.length=0,e.abrupt("return");case 4:if(this.buffer.push(t),null===(n=this.readerResolver)||void 0===n||n.call(this),this.readerResolver=null,!(this.buffer.length>=this.size)){e.next=9;break}return e.abrupt("return",new Promise((function(e){r.writerResolver=e})));case 9:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"finishedReading",value:function(e){var t;if(e)return this.readerStatus===zt.Disconnected;this.readerStatus=zt.Disconnected,null===(t=this.writerResolver)||void 0===t||t.call(this),this.writerResolver=null}},{key:"finishedWriting",value:function(e){var t;if(e)return this.writerStatus===zt.Disconnected;this.writerStatus=zt.Disconnected,null===(t=this.readerResolver)||void 0===t||t.call(this),this.readerResolver=null}},{key:"readAll",value:function(){var e=[];return this.buffer.forEach((function(t){mn(t)?t.items.forEach((function(t){return e.push(t)})):e.push(t)})),this.buffer.length=0,e}}]),e}(),qt=function(){function e(t,n,r){(0,g.Z)(this,e),this.sessionKey=t,this.varPath=n,this.mode=r,(0,k.Z)(this,"key",void 0),(0,k.Z)(this,"buffer",void 0),this.key="".concat(n,"@").concat(t),this.buffer=null}return(0,x.Z)(e,[{key:"writeData",value:function(){var e=(0,K.Z)(z().mark((function e(t){var n;return z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("array"!==this.mode){e.next=9;break}if(this.buffer||(this.buffer=an.api.getVarDeep(this.sessionKey,this.varPath),Array.isArray(this.buffer)||an.api.setVarDeep(this.sessionKey,this.varPath,this.buffer=[])),void 0!==t){e.next=6;break}return e.abrupt("return");case 6:mn(t)?(n=this.buffer).push.apply(n,(0,y.Z)(t.items)):this.buffer.push(t);case 7:e.next=14;break;case 9:if(void 0!==t){e.next=13;break}return e.abrupt("return");case 13:mn(t)?an.api.setVarDeep(this.sessionKey,this.varPath,(0,Fe.Z$)(t.items)):an.api.setVarDeep(this.sessionKey,this.varPath,t);case 14:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"readData",value:function(){var e=(0,K.Z)(z().mark((function e(){return z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",{eof:!0});case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()},{key:"finishedReading",value:function(){}},{key:"finishedWriting",value:function(){}}]),e}(),Yt=function(){function e(t){(0,g.Z)(this,e),this.key=t}return(0,x.Z)(e,[{key:"writeData",value:function(){var e=(0,K.Z)(z().mark((function e(t){return z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"readData",value:function(){var e=(0,K.Z)(z().mark((function e(){return z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",{eof:!0});case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()},{key:"finishedReading",value:function(){}},{key:"finishedWriting",value:function(){}}]),e}();function Qt(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function en(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Qt(Object(n),!0).forEach((function(t){(0,k.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Qt(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}!function(e){e[e.Suspended=0]="Suspended",e[e.Running=1]="Running",e[e.Killed=2]="Killed"}(Ht||(Ht={}));var tn=(0,$e.Z)((0,Ue.mW)((0,Ue.tJ)((function(e,t){return{device:{},session:{},persist:{},rehydrated:!1,api:{addCleanup:function(e){for(var t,n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];(t=nn.getProcess(e).cleanups).push.apply(t,r)},addFunc:function(e,t,n){nn.getSession(e).func[t]={key:t,node:n,src:it.multilineSrc(n)}},createFifo:function(e,n){var r=new Xt(e,n);return t().device[r.key]=r},createProcess:function(e){var n=e.sessionKey,r=e.ppid,i=e.pgid,a=e.src,s=e.posPositionals,o=t().api.getNextPid(n),c=t().api.getSession(n).process;return c[o]={key:o,ppid:r,pgid:i,sessionKey:n,status:Ht.Running,src:a,positionals:["jsh"].concat((0,y.Z)(s||[])),cleanups:[],onSuspend:null,onResume:null},c[o]},createSession:function(n,r){var i=nn.ensurePersisted(n),a=new on(new cn,new cn),s=new Jt(n,a,i.history);return t().device[s.key]=s,t().device["/dev/null"]=new Yt("/dev/null"),e((function(e){var t=e.session;return{session:Qe({key:n,func:{},nextPid:0,process:{},ttyIo:a,ttyShell:s,var:en(en({PWD:"",OLDPWD:""},i.var),(0,Fe.I8)(r))},t)}})),t().session[n]},createVarDevice:function(e,n,r){var i=new qt(e,n,r);return t().device[i.key]=i},ensureSession:function(e,n){var r=t().session;return r[e]=r[e]||t().api.createSession(e,n)},ensurePersisted:function(n){var r,i,a=null!==(r=null===(i=t().persist)||void 0===i?void 0:i[n])&&void 0!==r?r:{key:n,history:[],var:{}};return e((function(e){var t=e.persist;return{persist:Qe(a,t)}})),a},getFunc:function(e,n){return t().session[e].func[n]||void 0},getFuncs:function(e){return Object.values(t().session[e].func)},getNextPid:function(e){return t().session[e].nextPid++},getPositional:function(e,n,r){return t().session[n].process[e].positionals[r]||""},getProcess:function(e){var n=e.pid,r=e.sessionKey;return t().session[r].process[n]},getProcesses:function(e,n){var r=Object.values(t().session[e].process);return void 0===n?r:r.filter((function(e){return e.pgid===n}))},getVar:function(e,n){return t().session[e].var[n]},getVarDeep:function(e,n){var r=t().session[e].var;return Function("__","return __.".concat(n))(r)},getSession:function(e){return t().session[e]},persist:function(t){var n=nn.getSession(t),r=n.ttyShell,i=n.var;e((function(e){var n=e.persist;return{persist:tt(t,n,(function(){return{history:r.getHistory(),var:(0,Fe.Q8)(i,(function(e){try{return JSON.parse(JSON.stringify(e))}catch(t){}}))}}))}}))},removeDevice:function(e){delete t().device[e]},removeProcess:function(e,n){delete t().session[n].process[e]},removeSession:function(n){for(var r=t().session[n],i=r.process,a=r.ttyShell,s=0,o=Object.values(i);s<o.length;s++){var c=o[s].cleanups;c.forEach((function(e){return e()})),c.length=0}delete t().device[a.key],e((function(e){var t=e.session;return{session:et(n,t)}}))},resolve:function(e,n){return t().device[n.fd[e]]},setVar:function(e,t,n){nn.getSession(e).var[t]=n},setVarDeep:function(e,t,n){var r={home:nn.getSession(e).var},i=Ot(t,0,nn.getVar(e,"PWD"));if(!("home"===i[0]&&i.length>1))throw new St("only the home directory is writable",1);var a=i.pop();try{Et(i,r)[a]=n}catch(s){throw new St("cannot resolve /".concat(i.join("/")),1)}},warn:function(e,t){nn.getSession(e).ttyIo.write({key:"error",msg:t})}}}}),{name:"session",version:0,blacklist:["api","device","session"],onRehydrateStorage:function(e){return function(){rn.setState({rehydrated:!0})}}}),"session")),nn=tn.getState().api,rn=Object.assign(tn,{api:nn}),an=rn;var sn,on=function(){function e(t,n){(0,g.Z)(this,e),this.readable=t,this.writable=n}return(0,x.Z)(e,[{key:"handleWriters",value:function(e){var t=this;return this.writable.registerCallback(e),function(){return t.writable.unregisterCallback(e)}}},{key:"read",value:function(e){var t=this;return this.readable.registerCallback(e),function(){return t.readable.unregisterCallback(e)}}},{key:"write",value:function(e){this.writable.write(e)}},{key:"writeToReaders",value:function(e){this.readable.write(e)}}]),e}(),cn=function(){function e(){(0,g.Z)(this,e),(0,k.Z)(this,"internal",void 0),(0,k.Z)(this,"cbToSub",void 0),this.internal=new Je.x,this.internal.subscribe(),this.cbToSub=new Map}return(0,x.Z)(e,[{key:"registerCallback",value:function(e){this.cbToSub.set(e,this.internal.subscribe(e))}},{key:"unregisterCallback",value:function(e){var t;null===(t=this.cbToSub.get(e))||void 0===t||t.unsubscribe(),this.cbToSub.delete(e)}},{key:"write",value:function(e){this.internal.next(e)}}]),e}();function un(e,t){var n=(0,Fe.I8)(e.meta);Object.assign(n.fd,t),(0,rt.ww)(e,(function(e){return e.meta=n}))}function ln(e,t){return hn.apply(this,arguments)}function hn(){return(hn=(0,K.Z)(z().mark((function e(t,n){return z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.status!==Ht.Killed&&!n.finishedReading(!0)){e.next=4;break}throw new Pt(sn.SIGKILL,t.key,t.sessionKey);case 4:if(t.status!==Ht.Suspended){e.next=7;break}return e.next=7,new Promise((function(e){return t.onResume=e}));case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function pn(e,t){return fn.apply(this,arguments)}function fn(){return(fn=(0,K.Z)(z().mark((function e(t,n){return z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.status!==Ht.Killed){e.next=4;break}throw new Pt(sn.SIGKILL,t.key,t.sessionKey);case 4:if(t.status!==Ht.Suspended){e.next=7;break}return e.next=7,new Promise((function(e){return t.onResume=e}));case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function dn(e){switch(e){case Ht.Killed:return"\u2620";case Ht.Running:return"\u25b6\ufe0f";case Ht.Suspended:return"\u23f8\ufe0f"}}!function(e){e.SIGKILL="SIGKILL"}(sn||(sn={}));function mn(e){return void 0!==e&&null!==e&&e.__chunk__}function vn(e){return{__chunk__:!0,items:e}}function yn(e,t){var n;if("undefined"===typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"===typeof e)return gn(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return gn(e,t)}(e))||t&&e&&"number"===typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,o=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return s=e.done,e},e:function(e){o=!0,a=e},f:function(){try{s||null==n.return||n.return()}finally{if(o)throw a}}}}function gn(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var xn="\x1b[0m",bn="\x1b[93m",wn="\x1b[1;34m",kn="\x1b[0;37m",Zn=function(){function e(t,n,r){var i=this;(0,g.Z)(this,e),this.xterm=t,this.sessionKey=n,this.io=r,(0,k.Z)(this,"commandBuffer",void 0),(0,k.Z)(this,"cursor",void 0),(0,k.Z)(this,"cursorRow",void 0),(0,k.Z)(this,"input",void 0),(0,k.Z)(this,"readyForInput",void 0),(0,k.Z)(this,"promptReady",void 0),(0,k.Z)(this,"nextPrintId",void 0),(0,k.Z)(this,"prompt",void 0),(0,k.Z)(this,"historyIndex",-1),(0,k.Z)(this,"preHistory",void 0),(0,k.Z)(this,"linesPerUpdate",500),(0,k.Z)(this,"refreshMs",0),(0,k.Z)(this,"runCommands",(function(){var e,t=0;for(i.nextPrintId=null;(e=i.commandBuffer.shift())&&t<=i.linesPerUpdate;)switch(e.key){case"await-prompt":return void i.commandBuffer.unshift(e);case"clear":i.clearScreen();break;case"line":i.xterm.writeln(e.line),i.trackCursorRow(1),t++;break;case"newline":for(var n=i.offsetToColRow(i.input,i.cursor).row,r=i.offsetToColRow(i.input,i.input.length).row;n++<r;)i.xterm.write("\r\n");return i.xterm.write("\r\n"),i.trackCursorRow(1),void i.sendLine();case"paste-line":return i.xterm.writeln(e.line),i.trackCursorRow(1),i.input=e.line,void i.sendLine();case"resolve":e.resolve();break;case"prompt":i.xterm.write(e.prompt),i.promptReady=!0;break;default:throw(0,Fe.Ql)(e)}i.printPending()})),this.input="",this.cursor=0,this.prompt="",this.readyForInput=!0,this.promptReady=!1,this.commandBuffer=[],this.nextPrintId=null,this.cursorRow=0,this.historyIndex=-1,this.preHistory=this.input}return(0,x.Z)(e,[{key:"initialise",value:function(){this.xterm.onData(this.handleXtermInput.bind(this)),this.io.handleWriters(this.onMessage.bind(this)),this.xterm.writeln("".concat(kn,"Connected to session ").concat(wn).concat(this.sessionKey).concat(xn)),this.clearInput(),this.cursorRow=2}},{key:"actualCursor",value:function(e,t){return this.actualLine(e.slice(0,t)).length}},{key:"actualLine",value:function(e){return this.prompt+e}},{key:"clearInput",value:function(){this.setCursor(0);var e=Math.min(this.numLines(),this.xterm.rows+1-this.cursorRow);e>1?(this.xterm.write("\r\x1b[K\x1b[E".repeat(e)),this.xterm.write("\x1b[F".repeat(e))):this.xterm.write("\r\x1b[K"),this.input=""}},{key:"clearScreen",value:function(){for(var e=0;e<this.xterm.rows;e++)this.xterm.writeln("");this.xterm.write("\x1b[F".repeat(this.xterm.rows)),this.xterm.scrollToBottom(),this.cursorRow=1}},{key:"closestLeftBoundary",value:function(e,t){return this.wordBoundaries(e,!0).reverse().find((function(e){return e<t}))||0}},{key:"closestRightBoundary",value:function(e,t){return this.wordBoundaries(e,!1).find((function(e){return e>t}))||e.length}},{key:"deletePreviousWord",value:function(){var e=this.closestLeftBoundary(this.input,this.cursor);if(null!=e){var t=this.input.slice(0,e)+this.input.slice(this.cursor);this.clearInput(),this.setInput(t),this.setCursor(e)}}},{key:"handleCursorErase",value:function(e){var t=this.cursor,n=this.input;if(e){if(t<=0)return;var r=-1;"\n"===this.input.charAt(this.cursor+r)&&(r=-2);var i=n.slice(0,t+r)+n.slice(t);this.clearInput(),this.setInput(i),this.setCursor(t+r)}else{var a=n.slice(0,t)+n.slice(t+1);this.clearInput(),this.setInput(a),this.setCursor(t)}}},{key:"handleCursorInsert",value:function(e){var t=this.input,n=this.cursor,r=t.slice(0,n)+e+t.slice(n),i=this.cursor+e.length;this.clearInput(),this.setInput(r),this.setCursor(i)}},{key:"handleCursorMove",value:function(e){var t=1===e?Math.min(e,this.input.length-this.cursor):Math.max(e,-this.cursor),n=this.input.charAt(this.cursor+t);1===e?"\r"===n?t+=2:"\n"===n&&(t+=1):"\n"===n&&(t-=1),this.setCursor(this.cursor+t)}},{key:"handleXtermInput",value:function(){var e=(0,K.Z)(z().mark((function e(t){var n,r,i,a,s,o,c=this;return z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.readyForInput||"\x03"===t){e.next=2;break}return e.abrupt("return");case 2:if(!(t.length>1&&t.includes("\r"))){e.next=26;break}n=t.replace(/[\r\n]+/g,"\n"),(r=n.split("\n"))[0]="".concat(this.input).concat(r[0]),i=!n.endsWith("\n")&&r.pop(),a=yn(r),e.prev=8,o=z().mark((function e(){var t;return z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=s.value,e.next=3,new Promise((function(e){c.queueCommands([{key:"paste-line",line:t},{key:"await-prompt"},{key:"resolve",resolve:e}])}));case 3:case"end":return e.stop()}}),e)})),a.s();case 11:if((s=a.n()).done){e.next=15;break}return e.delegateYield(o(),"t0",13);case 13:e.next=11;break;case 15:e.next=20;break;case 17:e.prev=17,e.t1=e.catch(8),a.e(e.t1);case 20:return e.prev=20,a.f(),e.finish(20);case 23:i&&this.queueCommands([{key:"resolve",resolve:function(){c.clearInput(),c.setInput(i)}}]),e.next=27;break;case 26:this.handleXtermKeypresses(t);case 27:case"end":return e.stop()}}),e,this,[[8,17,20,23]])})));return function(t){return e.apply(this,arguments)}}()},{key:"handleXtermKeypresses",value:function(e){var t,n=e.charCodeAt(0);if(27==n)switch(e.slice(1)){case"[A":this.promptReady&&this.io.writeToReaders({key:"req-history-line",historyIndex:this.historyIndex+1});break;case"[B":this.promptReady&&this.io.writeToReaders({key:"req-history-line",historyIndex:this.historyIndex-1});break;case"[D":this.handleCursorMove(-1);break;case"[C":this.handleCursorMove(1);break;case"[3~":this.handleCursorErase(!1);break;case"[F":this.setCursor(this.input.length);break;case"[H":this.setCursor(0);break;case"b":null!=(t=this.closestLeftBoundary(this.input,this.cursor))&&this.setCursor(t);break;case"f":null!=(t=this.closestRightBoundary(this.input,this.cursor))&&this.setCursor(t);break;case"\x7f":this.deletePreviousWord()}else if(n<32||127===n)switch(e){case"\r":this.queueCommands([{key:"newline"}]);break;case"\x7f":this.handleCursorErase(!0);break;case"\t":this.handleCursorInsert("  ");break;case"\x03":this.sendSigKill();break;case"\x17":this.deletePreviousWord();break;case"\x01":this.setCursor(0);break;case"\x05":this.setCursor(this.input.length);break;case"\f":this.clearScreen(),this.setInput(this.input);break;case"\v":var r=this.input.slice(0,this.cursor);this.clearInput(),this.setInput(r);break;case"\x15":var i=this.input.slice(this.cursor);this.clearInput(),this.setInput(i),this.setCursor(0)}else this.handleCursorInsert(e)}},{key:"inputEndsAtEdge",value:function(e){var t=this.actualLine(e),n=this.actualCursor(e,e.length);return 0===this.offsetToColRow(t,n).col}},{key:"offsetToColRow",value:function(e,t){for(var n=this.xterm.cols,r=0,i=0,a=0;a<t;++a){("\n"===e.charAt(a)||(i+=1)>=n)&&(i=0,r+=1)}return{row:r,col:i}}},{key:"onMessage",value:function(e){var t=this;if("string"===typeof e)return this.queueCommands(e.split("\n").map((function(e){return{key:"line",line:"".concat(kn).concat(e).concat(xn)}})));if(null===e)return this.queueCommands([{key:"line",line:"".concat(bn,"null").concat(xn)}]);if(void 0!==e)switch(e.key){case"send-xterm-prompt":return void this.setPrompt(e.prompt);case"clear-xterm":return void this.clearScreen();case"tty-received-line":return this.input="",void(this.readyForInput=!0);case"send-history-line":if(e.line){var n=e.line.split(/\r?\n/).join("\r\n");-1===this.historyIndex&&(this.preHistory=this.input),this.clearInput(),this.setInput(n),this.historyIndex=e.nextIndex}else 0===e.nextIndex&&(this.clearInput(),this.setInput(this.input!==this.preHistory?this.preHistory:""),this.historyIndex=-1,this.preHistory="");return;case"error":this.queueCommands([{key:"line",line:"".concat("\x1b[41;37m").concat(e.msg).concat(xn)}]);break;default:mn(e)?e.items.slice(-400).forEach((function(e){return t.onMessage(e)})):this.queueCommands([{key:"line",line:"".concat(bn).concat((0,Fe.or)(e)).concat(xn)}])}}},{key:"numLines",value:function(){return 1+this.offsetToColRow(this.input,this.input.length+2).row}},{key:"queueCommands",value:function(e){var t,n=yn(e);try{for(n.s();!(t=n.n()).done;){var r=t.value;this.commandBuffer.push(r)}}catch(i){n.e(i)}finally{n.f()}this.printPending()}},{key:"printPending",value:function(){this.commandBuffer.length&&!this.nextPrintId&&(this.nextPrintId=window.setTimeout(this.runCommands,this.refreshMs))}},{key:"sendLine",value:function(){this.prompt="",this.readyForInput=this.promptReady=!1,this.historyIndex=-1,this.preHistory="",this.io.writeToReaders({key:"send-line",line:this.input})}},{key:"sendSigKill",value:function(){this.input="",this.setCursor(0),this.xterm.write("^C\r\n"),this.trackCursorRow(1),this.cursor=0,this.commandBuffer.length=0,this.io.writeToReaders({key:"send-kill-sig"})}},{key:"setCursor",value:function(e){e<0?e=0:e>this.input.length&&(e=this.input.length);var t=this.actualLine(this.input),n=this.actualCursor(this.input,this.cursor),r=this.offsetToColRow(t,n),i=r.col,a=r.row,s=this.actualCursor(this.input,e),o=this.offsetToColRow(t,s),c=o.col,u=o.row;if(u>a)for(var l=a;l<u;++l)this.xterm.write("\x1b[B");else for(var h=u;h<a;++h)this.xterm.write("\x1b[A");if(this.trackCursorRow(u-a),c>i)for(var p=i;p<c;++p)this.xterm.write("\x1b[C");else for(var f=c;f<i;++f)this.xterm.write("\x1b[D");this.cursor=e}},{key:"setInput",value:function(e){this.setCursor(0);var t=this.actualLine(e);this.xterm.write(t),t&&this.inputEndsAtEdge(e)&&(this.xterm.write("\r\n"),this.trackCursorRow(1)),this.input=e,this.cursor=e.length}},{key:"setPrompt",value:function(e){this.prompt=e;var t=(0,v.Z)(this.commandBuffer,1)[0];t&&"await-prompt"===t.key&&this.commandBuffer.shift(),this.queueCommands([{key:"prompt",prompt:e}])}},{key:"trackCursorRow",value:function(e){this.cursorRow+=e,this.cursorRow<1?this.cursorRow=1:this.cursorRow>this.xterm.rows&&(this.cursorRow=this.xterm.rows)}},{key:"wordBoundaries",value:function(e){for(var t,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=[],i=/\w+/g;t=i.exec(e);)r.push(n?t.index:t.index+t[0].length);return r}}]),e}();function Sn(){var e=(0,a.Z)(["\n  grid-area: terminal;\n  background: black;\n  height: 100%;\n"]);return Sn=function(){return e},e}function Pn(e){var t=e.sessionKey,n=e.env,i=an((function(e){var n=e.session;return t in n?n[t]:null}));(0,p.useEffect)((function(){return an.api.createSession(t,n),function(){return an.api.removeSession(t)}}),[t]);var a=(0,p.useCallback)((function(){return an.api.persist(t)}),[]);return(0,Ge.x)(a),(0,r.tZ)(Cn,{children:i?(0,r.tZ)(Te,{onMount:function(e){var t=new Zn(e,i.key,i.ttyIo);t.initialise(),setTimeout((function(){return i.ttyShell.initialise(t)}))},options:Rn}):null})}var Cn=(0,s.zo)("section")(Sn()),Rn={allowProposedApi:!0,fontSize:16,cursorBlink:!0,rendererType:"canvas",theme:{background:"black",foreground:"#41FF00"},convertEol:!1,scrollback:250,rows:50};function On(){return(0,r.BX)(l.Z,{children:[(0,r.tZ)(i.Z,{}),(0,r.tZ)(h.Z,{children:"\n---\n\n## Objective <float rem=\"1.2\">19th July 2021</float>\n\nWe'll construct a _Game AI focused_ realtime [roguelike](https://en.wikipedia.org/wiki/Roguelike),\nset in the [Traveller universe](https://travellermap.com/?p=-1.329!-23.768!3).\n\n_Why?_\n\nBecause Game AI (NPC behaviour) is more interesting than any particular game.\nAn environment is needed to make it meaningful,\nfixed narratives/missions are not.\n\nWe'll approach things algorithmically,\nyet driven by the environment i.e. thousands of [Traveller-themed assets](http://travellerrpgblog.blogspot.com/2020/08/starship-symbols-book.html).\nWe'll focus on combining and managing behaviours.\nGame AI should be compositional, not forced into a straight-jacket.\n\n\x3c!--\nWeb development permits an open/extendable approach to building a game.\nOn the other hand, realtime games push the boundaries of traditional web development,\nforcing us to take more care than usual.\n--\x3e\n        "}),(0,r.tZ)(c,{}),(0,r.tZ)(h.Z,{children:"\n---\n\n## Constraints <float rem=\"1.2\">19th July 2021</float>\n\nThis project needs a backbone.\nWe've chosen the underlying technology, low-level game mechanics, and where events take place.\n\n### Technology\n\n- Use CSS/SVG/PNGs, not HTMLCanvas/WebGL.\n- Use [WebAssembly](https://developer.mozilla.org/en-US/docs/WebAssembly) for physics.\n- Use React [function components](https://reactjs.org/docs/components-and-props.html#function-and-class-components) and CSS-in-JS.\n- Use [Preact](https://www.npmjs.com/package/preact) (not React), and [Goober](https://www.npmjs.com/package/goober) (not [Emotion](https://www.npmjs.com/package/@emotion/styled)).\n- Use [Web Components](https://developer.mozilla.org/en-US/docs/Web/Web_Components) to avoid React renders.\n- Use [NextJS](https://nextjs.org/) as our dev env.\n- Use [CodeSandbox](https://codesandbox.io) to share editable code.\n- Support mobile/desktop devices.\n\n### Game mechanics (low-level)\n\n- Use [Starship Geomorphs 2.0](http://travellerrpgblog.blogspot.com/2018/10/the-starship-geomorphs-book-if-finally.html) for graphics.\n- Use a realtime birdseye camera. \n- Use [Recast](https://github.com/recastnavigation/recastnavigation) to generate navmeshes.\n- Use [a recent port](https://www.npmjs.com/package/box2d-wasm) of the physics engine [Box2D](https://github.com/erincatto/box2d).\n- Use procedural generation for spaceship building.\n- Use an in-browser terminal.\n\n### Setting\n  \n- The [Traveller Universe](https://travellermap.com/?p=-1.329!-23.768!3).\n- Space vehicles/stations (Starship Geomorphs 2.0).\n\n<div style=\"height:8px\"></div>\n\nOver time we'll clarify the above, but first we emphasise:\n> _creating a video game is really fucking hard_.\n\n\x3c!--\nAlthough we'll avoid _fixed_ narratives/missions/levels,\ncompositional Game AI naturally leads to procedurally generated missions (common amongst Roguelikes).\nIn this sense we are attemping to create a video game.\n--\x3e\nSpelunky's creator suggested [three important requirements](https://makegames.tumblr.com/post/1136623767/finishing-a-game).\nWe'll now address them.\n\n### 1. Fun to develop\n\n_Games I want to make_. My underlying motivation is the lack of Game AI resources available on the web.\nIt is hard to discuss the subject without actually building a game, so I chose a setting and low-level game mechanics which felt fun for me.\n\x3c!-- In particular, we'll control and monitor NPC behaviour using an in-browser terminal. --\x3e\n\n### 2. The Result\n\n_Games I want to have made_. As an end result I want a highly replayable space action-game/sandbox.\nGenerated missions will involve going from A to B and doing C (ever was it so).\nMonotony will be overcome via encountered NPC behaviours and e.g. ship building.\nFunctionally, think [Teleglitch](https://en.wikipedia.org/wiki/Teleglitch) with richer NPCs and the ability to _place_ [room modules](https://steamcommunity.com/sharedfiles/filedetails/?id=175359117) when upgrading/docking.\nGraphically, see Starship Geomorphs 2.0.\n\nIt should be easy for others to extend Rogue Markup.\nWe'll achieve this by providing compositional code, escape hatches to CodeSandbox, and clear explanations.\nComments will be shown so that [GitHub](https://github.com/) users can share ideas and links.\n\n\x3c!--\n[NetHack](https://en.wikipedia.org/wiki/NetHack)'s \u2265 34 year history shows _we needn't spell out a story_.\n--\x3e\n\x3c!--\nWe'll add cameras, guards, doors, keys, weapons etc.\nAll NPC decisions will be depicted graphically, such as future navpaths with probabilistic branches.\n--\x3e\n\n### 3. Experience\n\n_Games I\u2019m good at making_. I work as a web developer, using React and CSS-in-JS on a daily basis. \nI have a [strong background](https://dblp.org/pid/81/8748.html) in Theoretical Computer Science,\nso won't confuse Game AI with AI, nor fall prey to the Deep Learning hype.\nI have also created similar game mechanics _many_ times over the years.\nHere's hoping my chain of unfinished projects is coming to a close!\n      "}),(0,r.tZ)(c,{}),(0,r.tZ)(h.Z,{children:"\n---\n## Technology  <float rem=\"1.2\">19th July 2021</float>\n\nSo, we're building a roguelike, directly on this website.\nIt will get fun once things are moving about.\nBut first we'll describe the underlying browser-related technologies.\n\n| Concept | Technology |\n| - | - |\n| Component | React [function components](https://reactjs.org/docs/components-and-props.html#function-and-class-components), and [Web Components](https://reactjs.org/docs/web-components.html). |\n| Styles | CSS-in-JS via [Goober](https://www.npmjs.com/package/goober) & programmatically. |\n| Component framework | [Preact](https://preactjs.com/), a DOM-diffing alternative to React. |\n| Pathfinding | A port of [three-pathfinding](https://www.npmjs.com/package/three-pathfinding).  |\n| Physics engine | [WebAssembly port](https://www.npmjs.com/package/box2d-wasm) of [Box2D](https://github.com/erincatto/box2d). |\n| Static analysis | TypeScript via [JSDoc](https://www.typescriptlang.org/docs/handbook/jsdoc-supported-types.html); also [ESLint](https://www.npmjs.com/package/eslint). |\n| Live analysis | Our own in-browser terminal. |\n| Code viewing | [CodeMirror](https://codemirror.net/) to view JS. |\n| Code editing | External [CodeSandbox](https://codesandbox.io/) links, using React. |\n| Code sharing | [GitHub](https://github.com/) comments shown on site; GitHub [repo](https://github.com/rob-myers/rob-myers.github.io) for this site. |\n\n\x3c!-- Our in-browser terminal is built using [Xterm.js](https://xtermjs.org/) and the shell parser [mvdan-sh](https://github.com/mvdan/sh/tree/master/_js). --\x3e\n\n\nThe early nineties brought the three pillars: HTML, CSS and JavaScript.\nWhenever we visit a website we receive an HTML response, referencing or embedding CSS and JS.\nOur web browser renders the HTML and CSS immediately, and runs the JS to provide interactivity (beyond links and hovers).\nMore precisely, all subsequent DOM mutations are performed by JavaScript.\nIt is now common to generate the initial HTML using JS too,\neither during a build-step or on a Node.js server.\nIn particular, JavaScript has become the central web technology.\n\n\u2139\ufe0f _We'll spend two sections describing how we use JS.\nThe discussion is technical and full of jargon, but the details can be picked up later on._\n\n### React and Preact\n\nCompeting JavaScript frameworks exist, usually with their own notion of _component_.\nOne popular approach uses _React function components_, which are just JavaScript functions with constraints on their parameters and return values.\n\n- They have a single parameter, conventionally called _props_.\n\n  It is a JavaScript object defining the component's named inputs,\n  and possibly special properties like _children_, _key_ and _ref_.\n\n- They must return either null or a virtual [DOM node](https://developer.mozilla.org/en-US/docs/Web/API/Node).\n\n  This returned value amounts to an HTML fragment to be rendered,\n  and may depend on the component's props and internal state (via [hooks](https://reactjs.org/docs/hooks-intro.html)).\n\nReact developers use a grammatical extension of JavaScript called JSX.\nIt permits composing components using an XML-like syntax, to obtain the desired dynamic DOM tree.\nLet's consider an example, a pannable and zoomable grid.\n      "}),(0,r.tZ)(ze,{storeKey:"panzoom",height:400,tabs:[{key:"component",filepath:"panzoom/PanZoomDemo.jsx"},{key:"code",filepath:"panzoom/PanZoom.jsx",folds:[{line:8,ch:0}]},{key:"code",filepath:"panzoom/PanZoomDemo.jsx"}]}),(0,r.tZ)(h.Z,{children:'\nThe file _panzoom/PanZoom.jsx_ (see [tab above](#command "open-tab panzoom code@panzoom/PanZoom.jsx")) defines two React function components, _PanZoom_ and _Grid_.\nBehaviourally:\n\n- _PanZoom_ renders an SVG consisting of its children (the red square in the demo) and _Grid_. It adjusts the [SVG viewBox](https://developer.mozilla.org/en-US/docs/Web/SVG/Attribute/viewBox) in response to mouse/pointer events.\n\n- _Grid_ renders part of an SVG i.e. a grid obtained by repeating a 10x10 unit pattern.\n\nThey are JS functions with a single parameter, returning something which looks like HTML (but isn\'t).\nNotice _PanZoom_ renders _Grid_ by using the XML tag `<Grid/>`.\nThen although React function components are functions, syntactically they are not invoked like functions.\nYou can also view the demo code [on CodeSandbox](https://codesandbox.io/s/rogue-markup-panzoom-yq060?file=/src/panzoom/PanZoom.jsx "@new-tab"), which permits code editing.\n\nHere\'s a whirlwind overview of React (and Preact).\n\n- React devs use a grammatical extension of JS with XML called [JSX](https://en.wikipedia.org/wiki/JSX_(JavaScript)).\n- React applications are often built by composing React function components, using the XML syntax for their return value.\n- Dev tools convert JSX into JS, by replacing XML tags with invocations of the function `React.createElement`.\n  See [example/jsx-to-js.jsx](#command "open-tab jsx-to-js") below.\n- Actually, this website uses Preact, a React alternative with the same API.\n  Then `React.createElement` is [this function](https://github.com/preactjs/preact/blob/master/src/create-element.js),\n  and makes Preact virtual DOM nodes.\n- The root component is usually called _App_.\n  Running a React application means [invoking `ReactDOM.render`](https://codesandbox.io/s/rogue-markup-panzoom-yq060?file=/src/index.js "@new-tab")\n  with 2 arguments: `<App/>` and a DOM node _el_.\n- [`ReactDOM.render`](https://github.com/preactjs/preact/blob/master/src/render.js) initially converts `<App/>` into a DOM node mounted at _el_.\n  A subcomponent may subsequently re-render, recursively recreating a virtual DOM node.\n  It is then [diffed](https://github.com/preactjs/preact/blob/master/src/diff/index.js), and only the difference is applied to the DOM.\n- If `<App/>` is a website, it is often [rendered as HTML server-side](https://github.com/preactjs/preact-render-to-string/blob/master/src/index.js), so the client can render it immediately.\n  The client then invokes [`ReactDOM.hydrate`](https://github.com/preactjs/preact/blob/master/src/render.js) instead of `ReactDOM.render`, but with the same arguments.\n\n      '}),(0,r.tZ)(ze,{storeKey:"jsx-to-js",height:300,tabs:[{key:"code",filepath:"example/jsx-to-js.jsx"}]}),(0,r.tZ)(h.Z,{children:"\nSo, React function components are written using syntactic-sugar (JSX), and composed together like HTML.\nWe're using Preact (its codebase is smaller, and it has reputation for being faster,\nalthough React has a _much_ wider scope via [custom renderers](https://github.com/chentsulin/awesome-react-renderer)).\nRendering a component involves (re)constructing virtual DOM nodes and diffing them.\nFinally, the first render is often precomputed, to load faster.\n\n### React Renders and Web Components\n\nWebsites respond to interaction, sometimes without changing the DOM.\nWhen they do mutate the DOM, they usually don't continually do so.\nFor example, zooming a map can be done with a CSS transform and a pre-existing CSS transition.\nAs another example, showing additional search results amounts to a single mutation.\n\nWhen React renders a component, it computes a rooted subtree of the virtual DOM,\ncompares the previous one, and patches the DOM.\nIf many components change in a small amount of time, [some renders are automatically avoided](https://github.com/preactjs/preact/blob/ebd87f3005d9558bfd3c5f38e0496a5d19553441/src/component.js#L221) via the ancestral relationship.\nDevelopers can also avoid recreating an entire rooted subtree using [`React.memo`](https://github.com/preactjs/preact/blob/master/compat/src/memo.js).\nBut for most websites, the DOM mutations are neither large nor frequent, and React developers may simply ignore the virtual DOM overhead.\n\nHowever, we are making a realtime video game.\nTo move characters at 60 fps using a physics engine, we'll be updating the DOM at the same rate.\nWe want to control the rendering, to ensure good performance and aid debugging e.g. when pushing the limits of visible objects.\nIf we allowed React (actually, Preact) to render in response to user interaction, we'd lose this control.\nTake another look at _panzoom/PanZoom.jsx_.\n\n      "}),(0,r.tZ)(ze,{height:360,tabs:[{key:"code",filepath:"panzoom/PanZoom.jsx"},{key:"code",filepath:"geom/rect.js"}]}),(0,r.tZ)(h.Z,{children:"\n\n_PanZoom_ returns an `<svg/>` with a viewBox determined by _state.viewBox_.\nInitially, the latter is a clone of the rectangle _props.initViewBox_.\nWhen a user zooms via mousewheel, _state.onWheel_ handles the event, updating _state.viewBox_ accordingly.\nImportantly, we do not trigger a React render, but instead directly mutate the DOM by invoking _setAttribute_.\n\n\n__TODO__ _we'll control the rendering i.e. React should only render initially or during fast refresh. We'll manipulate the DOM directly using Web Components. By keeping the initial virtual DOM mostly constant, the DOM diffing won't interfere._\n\n__TODO__ Server-side rendering cannot handle DOM mutations, so we don't use SSR.\n\n\n### CSS inside JS\n\nTraditionally, CSS is provided in separate files,\nlinked in the `<head/>` and referenced by DOM elements via their space-separated attribute `class`.\nBoth _PanZoom_ and _PanZoomDemo_ above are styled using CSS-in-JS.\nThis means the CSS is written inside JS or JSX files, often together with the React component it applies to.\nThe npm module [Goober](https://www.npmjs.com/package/goober) handles this for us.\n      "}),(0,r.tZ)(c,{}),(0,r.tZ)(h.Z,{children:"\n---\n## Technology (Part 2)\n\n### Navigation\n\nPathfinding is central to Game AI.\nOur NPCs need to move realistically e.g. they cannot move through walls, windows or locked doors.\n\n      "}),(0,r.tZ)(ze,{height:300,tabs:[{key:"component",filepath:"pathfinding/NavDemo.jsx"}]}),(0,r.tZ)(h.Z,{children:"\n### Physics engine\n\nWe need a Physics engine:\n- Raycasting\n- Triggers\n- Collision detection\n      "}),(0,r.tZ)(ze,{height:300,tabs:[{key:"component",filepath:"physics/PhysicsDemo.jsx"}]}),(0,r.tZ)(c,{}),(0,r.tZ)(h.Z,{children:"\n## Technology (Part 3)\n\n### Static and Runtime Analysis\n\n- Typescript via JSDoc, refering to CodeSandbox.\n- Terminal + Preact hooks\n- Terminal + Game AI\n\n### Comments\n\n- Display GitHub comments from Issue (build-time)\n- Can use anonymous credits to get recent\n      "}),(0,r.tZ)(c,{}),(0,r.tZ)(h.Z,{children:'\n## Starship Geomorphs <float rem="1.2">19th July 2021</float>\n\n### Filesystem structure\n\nmedia\n- Starship Geomorphs 2.0.pdf (Original source)\n- Starship Symbols.pdf (Original source)\n- Geomorphs.zip (Transparent PNGs obtained from Starship Geomorphs 2.0)\n- SymbolsHighRes.zip (Transparent PNGs obtained from Starship Symbols)\n\nmedia/Geomorph\n- PNGs of lower quality (relatively).\n- Extracted from "Starship Geomorphs 2.0.pdf" by ... \n\nmedia/Symbols\n- PNGs of higher quality.\n- Extracted from "Starship Symbols.pdf" by ... \n\nmedia/scripts\n- ts-node scripts launched via npm scripts\n- Directories generated by scripts\n- media/geomorph-edge (Edge Geomorphs)\n- media/symbol-bridge\n- media/symbol-dock-small-craft\n- media/symbol-staterooms\n- media/symbol-lounge\n- media/symbol-root\n\npublic/png\n- PNGs from media/symbol-* with labels removed\n\npublic/svg\n- Enriched symbols\n- Geomorph hulls\n      '}),(0,r.tZ)(ze,{height:400,tabs:[{key:"component",filepath:"geomorph/GeomorphDemo.jsx"}]}),(0,r.tZ)(h.Z,{children:'\n## Movement <float rem="1.2">19th July 2021</float>\n\n- Navigation\n- Follow camera\n- Map view\n      '}),(0,r.tZ)(c,{}),(0,r.tZ)("div",{style:{height:200},children:(0,r.tZ)(Pn,{sessionKey:"test",env:jn.test})}),(0,r.tZ)(c,{}),(0,r.tZ)(h.Z,{children:'\nThis is an example of a [command link](#command "@test echo foo").\n      '})]})}var jn={test:{}}},11455:function(e,t,n){"use strict";var r=(0,n(14671).Z)((function(e,t){return{tabs:{},api:{}}})),i=r.getState().api,a=Object.assign(r,{api:i});t.Z=a},35838:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/draft",function(){return n(96082)}])}},function(e){e.O(0,[774,43,702,888,179],(function(){return t=35838,e(e.s=t);var t}));var t=e.O();_N_E=t}]);