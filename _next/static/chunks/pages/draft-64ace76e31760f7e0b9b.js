(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[880],{52542:function(e,t,n){"use strict";n.d(t,{Z:function(){return b}});var r=n(52209),i=n(58377),s=n(92809),o=n(88823),a=n(11163),c=(n(59748),n(88269)),l=n(38456),h=n.n(l),u=n(76388),d=n.n(u),p=n(10043),m=n.n(p);function f(){var e=(0,r.Z)(["\n  background: #f6f6f6;\n  color: #333;\n  padding-left: var(--blog-indent);\n  padding-right: var(--blog-indent);\n  border-top: 8px solid #ccc;\n  border-bottom: 8px solid #ccc;\n\n  @media(min-width: 600px) {\n    padding-top: 16px;\n    padding-bottom: 16px;\n  }\n\n  font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Oxygen,\n    Ubuntu, Cantarell, Fira Sans, Droid Sans, Helvetica Neue, sans-serif;\n  font-size: 1.2rem;\n\n  h1, h2, h3, h4 {\n    font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;\n    font-weight: 500;\n  }\n\n  @media(max-width: 540px) {\n    font-size: 1.1rem;\n  }\n  \n  p {\n    line-height: 1.5;\n    margin-bottom: 24px;\n  }\n\n  code {\n    font-size: 12pt;\n    font-family: Courier, monospace;\n    color: #444;\n    background: #eee;\n  }\n  ul, ol {\n    margin: 20px 0;\n    line-height: 1.4;\n    padding-left: var(--list-indent);\n\n    li {\n      margin: 8px 0;\n      ul, ol {\n        line-height: 1.2;\n      }\n    }\n  }\n  ul.contains-task-list {\n    padding-left: 12px;\n    li.task-list-item {\n      list-style: none;\n    }\n  }\n\n  span.float {\n    float: right;\n    color: #555;\n    @media(max-width: 480px) {\n      float: unset;\n      display: block;\n      margin-top: 8px;\n    }\n  }\n\n  table {\n    border: 1px solid #ccc;\n    border-left: 4px solid #999;\n\n    th, td {\n      text-align: left;\n      vertical-align: top;\n      padding: 8px;\n      @media(max-width: 540px) {\n        padding: 4px 2px;\n      }\n    }\n  }\n"]);return f=function(){return e},e}function v(){var e=(0,r.Z)(["\n  @media(max-width: 600px) {\n    padding-left: 8px;\n  }\n\n  h1 {\n    font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;\n    font-size: 6rem;\n    font-weight: 300;\n    cursor: pointer;\n    color: #333;\n    margin: 0;\n    \n    @media(max-width: 1024px) {\n      font-size: 5rem;\n    }\n    @media(max-width: 800px) {\n      font-size: 4rem;\n    }\n    @media(max-width: 480px) {\n      font-size: 3rem;\n    }\n  }\n  \n  p {/** Site subtitle */\n    color: #444;\n    letter-spacing: 1px;\n    font-size: 1rem;\n    font-family: monospace;\n    margin: 0;\n    padding: 24px 0 48px;\n    \n    @media(max-width: 600px) {\n      padding: 24px 0;\n    }\n    @media(max-width: 480px) {\n      font-size: 0.8rem;\n    }\n  }\n"]);return v=function(){return e},e}function g(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function y(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?g(Object(n),!0).forEach((function(t){(0,s.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):g(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function b(e){return(0,o.tZ)("div",{className:e.title?k:S,children:(0,o.tZ)(h(),y({rehypePlugins:[d()],remarkPlugins:[m()],components:e.title?x:w},e))})}var x={h1(e){var{children:t}=e,n=(0,i.Z)(e,["children"]),r=(0,a.useRouter)();return(0,o.tZ)("h1",y(y({onClick:()=>r.push("/")},n),{},{children:t}))}},w={a(e){var{node:t,href:n,title:r,children:s}=e,a=(0,i.Z)(e,["node","href","title","children"]);return(0,o.tZ)("a",y(y(y(y({href:n},["@new-tab"].includes(r)&&{className:"new-tab-link",target:"_blank"}),{},{title:r},"#command"===n&&{onClick:e=>{e.preventDefault(),console.warn("link triggered command:",r)}}),a),{},{children:s}))},float(e){var{children:t}=e,n=(0,i.Z)(e,["children"]);return(0,o.tZ)("span",y(y({},n),{},{className:"float",style:y(y({},n.style),{},{fontSize:n.rem?"".concat(n.rem,"rem"):void 0}),children:t}))}},k=(0,c.iv)(v()),S=(0,c.iv)(f())},22200:function(e,t,n){"use strict";n.d(t,{Z:function(){return s}});var r=n(88823),i=n(52542);function s(){return(0,r.tZ)(i.Z,{title:!0,children:"\n# Rogue Markup\n\n$( roguelike | built online | game ai )\n"})}},86576:function(e,t,n){"use strict";n.d(t,{I8:function(){return o},IC:function(){return a},Ql:function(){return c},Z$:function(){return l},wO:function(){return h},or:function(){return u},$G:function(){return d},Q8:function(){return p},BH:function(){return m},RT:function(){return f}});var r=n(92809),i=n(87668),s=n.n(i);function o(e){return JSON.parse(JSON.stringify(e))}function a(e){return JSON.stringify(e,null,"\t")}function c(e){return"testNever: ".concat(a(e)," not implemented.")}function l(e){return e[e.length-1]}function h(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return new Promise((t=>setTimeout((()=>t()),e)))}function u(e){return"function"===typeof e?function(e){return e.trim().replace(/\s\s+/g," ").trim()}("".concat(e)):function(e){try{var t=[];return JSON.stringify(e,((e,n)=>"function"===typeof n?"[Function]".concat((t=Object.keys(n)).length?" ...{".concat(t,"} "):""):n))}catch(n){}}(e)||s()(e,((e,t)=>t instanceof HTMLElement?"HTMLElement[".concat(t.nodeName,"]"):t))}function d(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:50;return e.length<=t?e:"".concat(e.slice(0,t)," ...")}function p(e,t){var n,r={};return(n=e,Object.keys(n)).forEach((n=>r[n]=t(e[n]))),r}class m{constructor(){(0,r.Z)(this,"resolve",null),(0,r.Z)(this,"reject",null),(0,r.Z)(this,"promise",new Promise(((e,t)=>{this.resolve=e,this.reject=t})))}}function f(e){return Array.from(v(e))}function*v(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];switch(null===e||void 0===e?void 0:e.constructor){case Object:for(var[n,r]of Object.entries(e))yield*v(r,[...t,n]);break;default:yield t.join("/")}}},29950:function(e,t,n){"use strict";n.d(t,{VN:function(){return a},v8:function(){return l},ww:function(){return u},$r:function(){return d},nL:function(){return p},Wc:function(){return m}});var r=n(83465),i=n.n(r),s=n(17473),o=n(86576);function a(e){return i()(e)}function c(e){var t,n,r;switch(e.type){case"ArithmCmd":case"ArithmExp":return[e.X];case"ArrayElem":return[...e.Index?[e.Index]:[],e.Value];case"ArrayExpr":return e.Elems;case"Assign":return[...e.Array?[e.Array]:[],...e.Index?[e.Index]:[],...e.Value?[e.Value]:[]];case"BinaryArithm":case"BinaryCmd":case"BinaryTest":return[e.X,e.Y];case"Block":return e.Stmts;case"CStyleLoop":return[e.Cond,e.Init,e.Post];case"CallExpr":return[].concat(e.Args,e.Assigns);case"CaseClause":return[].concat(e.Items,e.Word);case"CaseItem":return[].concat(e.Patterns,e.Stmts);case"CmdSubst":return e.Stmts;case"Comment":return[];case"CoprocClause":return[e.Stmt];case"DblQuoted":return e.Parts;case"DeclClause":return[].concat(e.Args,e.Variant);case"ExtGlob":return[];case"File":return e.Stmts;case"ForClause":return[...e.Do,e.Loop];case"FuncDecl":return[e.Body,e.Name];case"IfClause":return[...e.Cond,...e.Then,...e.Else?[e.Else]:[]];case"LetClause":return e.Exprs;case"Lit":return[];case"ParamExp":return[...null!==(t=e.Exp)&&void 0!==t&&t.Word?[e.Exp.Word]:[],...e.Index?[e.Index]:[],e.Param,...e.Repl?[e.Repl.Orig]:[],...null!==(n=e.Repl)&&void 0!==n&&n.With?[e.Repl.With]:[],...e.Slice?[e.Slice.Offset]:[],...null!==(r=e.Slice)&&void 0!==r&&r.Length?[e.Slice.Length]:[]];case"ParenArithm":case"ParenTest":return[e.X];case"ProcSubst":return e.Stmts;case"Redirect":return[...e.Hdoc?[e.Hdoc]:[],...e.N?[e.N]:[],e.Word];case"SglQuoted":return[];case"Stmt":return[...e.Cmd?[e.Cmd]:[],...e.Redirs];case"Subshell":return e.Stmts;case"TestClause":return[e.X];case"TimeClause":return[...e.Stmt?[e.Stmt]:[]];case"UnaryArithm":case"UnaryTest":return[e.X];case"WhileClause":return e.Cond.concat(e.Do);case"Word":return e.Parts;case"WordIter":return e.Items;default:throw(0,o.Ql)(e)}}function l(e,t){return{opts:h((0,s.Z)(e,t)),operands:e.filter((e=>"-"!==e[0]))}}function h(e){var t=e;return Object.keys(e).forEach((n=>{t.__optKeys=[],"_"!==n&&(Array.isArray(e[n])&&(t[n]=(0,o.Z$)(e[n])),t.__optKeys.push(n))})),t}function u(e,t){t(e),c(e).forEach((e=>u(e,t)))}function d(e){return u(e,(e=>{c(e).forEach((t=>t.parent=e))})),e}function p(e){return{type:"File",Stmts:"Stmt"===e.type?[e]:e.Stmts,meta:e.meta}}function m(e){return e.Else?[e,...m(e.Else)]:[e]}},74347:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return Ut}});var r=n(88823),i=n(22200),s=n(52542),o=n(52209),a=n(59748),c=n(88269),l=n(86352);class h{constructor(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.x=e,this.y=t}get angle(){return Math.atan2(this.y,this.x)}get coord(){return[this.x,this.y]}get json(){return{x:this.x,y:this.y}}get length(){return Math.sqrt(this.x*this.x+this.y*this.y)}get lengthSquared(){return this.x*this.x+this.y*this.y}static get zero(){return new h(0,0)}add(e){var{x:t,y:n}=e;return this.translate(t,n)}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this}static average(e){return e.length?e.reduce(((e,t)=>e.add(t)),h.zero).scale(1/e.length):h.zero}clone(){return new h(this.x,this.y)}copy(e){return this.set(e.x,e.y)}distanceTo(e){return Math.hypot(e.x-this.x,e.y-this.y)}distanceToSquared(e){return Math.pow(e.x-this.x,2)+Math.pow(e.y-this.y,2)}dot(e){return this.x*e.x+this.y*e.y}equals(e){var{x:t,y:n}=e;return this.x===t&&this.y===n}static from(e){return Array.isArray(e)?new h(e[0],e[1]):new h(e.x,e.y)}normalize(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return this.length?this.scale(e/this.length):(console.error("Cannot normalize Vector2 '".concat(this,"' to length '").concat(e,"'")),this)}precision(e){return this.set(Number(this.x.toFixed(e)),Number(this.y.toFixed(e)))}rotate(e){var[t,n]=[this.x,this.y];return this.x=Math.cos(e)*t-Math.sin(e)*n,this.y=Math.sin(e)*t+Math.cos(e)*n,this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}scale(e){return this.x*=e,this.y*=e,this}set(e,t){return this.x=e,this.y=t,this}sub(e){var{x:t,y:n}=e;return this.translate(-t,-n)}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}toString(){return"".concat(this.x,",").concat(this.y)}transform(e){var{a:t,b:n,c:r,d:i,e:s,f:o}=e,{x:a,y:c}=this;return this.x=t*a+r*c+s,this.y=n*a+i*c+o,this}translate(e,t){return this.x+=e,this.y+=t,this}}class u{constructor(e,t,n,r){this.x=e,this.y=t,this.width=n,this.height=r}get area(){return this.width*this.height}get bottom(){return this.y+this.height}get bottomLeft(){return new h(this.x,this.y+this.height)}get bottomRight(){return new h(this.x+this.width,this.y+this.height)}get center(){return new h(this.cx,this.cy)}get cx(){return this.x+.5*this.width}get cy(){return this.y+.5*this.height}get geoJson(){return{type:"Polygon",coordinates:[[[this.x,this.y],[this.x+this.width,this.y],[this.x+this.width,this.y+this.height],[this.x,this.y+this.height]]]}}get json(){return{x:this.x,y:this.y,width:this.width,height:this.height}}get key(){return"".concat(this.x,",").concat(this.y,",").concat(this.width,",").concat(this.height)}get dimension(){return Math.max(this.width,this.height)}get points(){return[new h(this.x,this.y),new h(this.x,this.y+this.height),new h(this.x+this.width,this.y+this.height),new h(this.x+this.width,this.y)]}get right(){return this.x+this.width}get topLeft(){return new h(this.x,this.y)}get topRight(){return new h(this.x+this.width,this.y)}static get zero(){return new u(0,0,0,0)}applyMatrix(e){if(!e.isIdentity){var t=e.transformPoint(this.topLeft),n=e.transformPoint(this.bottomRight);this.x=Math.min(t.x,n.x),this.y=Math.min(t.y,n.y),this.width=Math.max(t.x,n.x)-this.x,this.height=Math.max(t.y,n.y)-this.y}return this}clone(){return new u(this.x,this.y,this.width,this.height)}contains(e){var{x:t,y:n}=e;return this.x<=t&&t<=this.x+this.width&&this.y<=n&&n<=this.y+this.height}copy(e){var{x:t,y:n,width:r,height:i}=e;return this.x=t,this.y=n,this.width=r,this.height=i,this}covers(e){var{x:t,y:n,width:r,height:i}=e;return this.x<=t&&t+r<=this.x+this.width&&this.y<=n&&n+i<=this.y+this.height}delta(e,t){return this.x+=e,this.y+=t,this}static from(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];if(t.length){if(t[0]instanceof h){var r=t,i=Math.min(...r.map((e=>{var{x:t}=e;return t}))),s=Math.min(...r.map((e=>{var{y:t}=e;return t}))),o=Math.max(...r.map((e=>{var{x:t}=e;return t}))),a=Math.max(...r.map((e=>{var{y:t}=e;return t})));return new u(i,s,o-i,a-s)}var c=t,l=Math.min(...c.map((e=>{var{x:t}=e;return t}))),d=Math.min(...c.map((e=>{var{y:t}=e;return t}))),p=Math.max(...c.map((e=>{var{x:t,width:n}=e;return t+n}))),m=Math.max(...c.map((e=>{var{y:t,height:n}=e;return t+n})));return new u(l,d,p-l,m-d)}return u.zero}static fromJson(e){var{x:t,y:n,width:r,height:i}=e;return new u(t,n,r,i)}inset(e){var[t,n]=[this.cx,this.cy];this.outset(-e),this.width<0&&(this.x=t,this.width=0),this.height<0&&(this.y=n,this.height=0)}intersects(e){return 2*Math.abs(this.cx-e.cx)<=this.width+e.width&&2*Math.abs(this.cy-e.cy)<=this.height+e.height}offset(e){var{x:t,y:n}=e;return this.x+=t,this.y+=n,this}outset(e){return this.x-=e,this.y-=e,this.width+=2*e,this.height+=2*e,this}scale(e){return this.x*=e,this.y*=e,this.width*=e,this.height*=e,this}setPosition(e){return this.x=e.x,this.y=e.y,this}toString(){return"".concat(this.x,",").concat(this.y,",").concat(this.width,",").concat(this.height)}}var d=n(90831),p=n(32676),m=n(9187),f=n.n(m);class v{constructor(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];this.outline=e,this.holes=t,this.meta}get allPoints(){return this.outline.concat(...this.holes)}get geoJson(){return{type:"Polygon",coordinates:[this.outline.map((e=>{var{x:t,y:n}=e;return[t,n]}))].concat(this.holes.map((e=>e.map((e=>{var{x:t,y:n}=e;return[t,n]})))))}}get rect(){return u.from(...this.outline)}get svgPath(){return[this.outline,...this.holes].map((e=>"M".concat(e,"Z"))).join(" ")}get tangents(){var e=[this.outline,...this.holes],[t,...n]=e.map((e=>e.concat(e[0]).reduce(((e,t,n,r)=>n>0?e.concat(t.clone().sub(r[n-1]).normalize()):[]),[])));return{outer:t,inner:n}}add(e){return this.translate(e.x,e.y)}addMeta(e){return this.meta=Object.assign(this.meta||{},e),this}applyMatrix(e){return e.isIdentity||(this.outline=this.outline.map((t=>t.copy(e.transformPoint(t)))),this.holes.forEach((t=>t.map((t=>t.copy(e.transformPoint(t))))))),this}cleanFinalReps(){for(var e of[this.outline,...this.holes]){var t=e.pop();t&&!t.equals(e[0])&&e.push(t)}return this}clone(){var e=this.outline.map((e=>e.clone())),t=this.holes.map((e=>e.map((e=>e.clone()))));return new v(e,t)}createInset(e){if(0===e)return[this.clone()];var[t,...n]=[{ring:this.outline,inset:v.insetRing(this.outline,e)},...this.holes.map((t=>({ring:t,inset:v.insetRing(t,e)})))].map((e=>{var{ring:t,inset:n}=e;return t.map(((e,r)=>new v([t[r].clone(),n[r],n[(r+1)%t.length],t[(r+1)%t.length].clone()])))}));return e>0?v.cutOut(t.concat(...n),[this.clone()]):v.union([this.clone()].concat(t,...n))}createOutset(e){return this.createInset(-e)}static cutOut(e,t){return p.difference(t.map((e=>{var{geoJson:{coordinates:t}}=e;return t})),...e.map((e=>{var{geoJson:{coordinates:t}}=e;return t}))).map((e=>v.from(e).cleanFinalReps()))}fastTriangulate(){var{coordinates:e}=this.geoJson,t=f().flatten(e),n=f()(t.vertices,t.holes,2),r=n.reduce(((e,t,r)=>r%3===2?e.concat([[n[r-2],n[r-1],t]]):e),[]);return{vs:this.allPoints,tris:r}}static from(e){return e instanceof Array?new v(e[0].map((e=>{var[t,n]=e;return new h(t,n)})),e.slice(1).map((e=>e.map((e=>{var[t,n]=e;return new h(t,n)}))))):new v(e.coordinates[0].map((e=>{var[t,n]=e;return new h(t,n)})),e.coordinates.slice(1).map((e=>e.map((e=>{var[t,n]=e;return new h(t,n)})))))}static fromRect(e){return new v(e.points)}static getLinesIntersection(e,t,n,r){var i=t.x,s=t.y,o=e.x,a=e.y,c=r.x,l=r.y,h=n.x,u=n.y;return Math.abs(-s*c+i*l)<1e-4?null:(c*(u-a)-l*(h-o))/(s*c-l*i)}static insetRing(e,t){var n=new v(e).tangents.outer,r=e.map(((r,i)=>[r.clone().translate(t*-n[i].y,t*n[i].x),e[(i+1)%e.length].clone().translate(t*-n[i].y,t*n[i].x)]));return r.map(((e,t)=>{var i=(t+1)%r.length,s=r[i],o=v.getLinesIntersection(e[1],n[t],s[0],n[i]);return o?e[1].translate(o*n[t].x,o*n[t].y):h.average([e[1],s[0]])}))}qualityTriangulate(){try{var e=this.outline.map(((e,t)=>{var{x:n,y:r}=e;return{x:n,y:r,id:t}})),t=e.length,n=this.holes.map((e=>e.map((e=>{var{x:n,y:r}=e;return{x:n,y:r,id:t++}})))),r=new d.SweepContext(e).addHoles(n).triangulate().getTriangles().map((e=>[e.getPoint(0),e.getPoint(1),e.getPoint(2)])).map((e=>{var[t,n,r]=e;return[t.id,n.id,r.id]}));return{vs:this.allPoints,tris:r}}catch(i){return console.error("Quality triangulation failed, falling back to earcut"),console.error(i),this.fastTriangulate()}}static pointInTriangle(e,t,n,r){var i=v.sign(e,t,n),s=v.sign(e,n,r),o=v.sign(e,r,t);return!((i<0||s<0||o<0)&&(i>0||s>0||o>0))}precision(e){return this.outline.forEach((t=>t.precision(e))),this.holes.forEach((t=>t.forEach((t=>t.precision(e))))),this}round(){return this.outline.forEach((e=>e.round())),this.holes.forEach((e=>e.forEach((e=>e.round())))),this}scale(e){return this.outline.forEach((t=>t.scale(e))),this.holes.forEach((t=>t.forEach((t=>t.scale(e))))),this}static sign(e,t,n){return(e.x-n.x)*(t.y-n.y)-(t.x-n.x)*(e.y-n.y)}translate(e,t){return this.outline.forEach((n=>n.translate(e,t))),this.holes.forEach((n=>n.forEach((n=>n.translate(e,t))))),this}static union(e){return p.union([],...e.map((e=>{var{geoJson:{coordinates:t}}=e;return t}))).map((e=>v.from(e).cleanFinalReps()))}}var g,y=n(70956);function b(e){var t,n,r;return(g=g||(null===(t=x(e))||void 0===t?void 0:t.createSVGPoint())).x=e.clientX,g.y=e.clientY,g.matrixTransform(null===(n=x(e))||void 0===n||null===(r=n.getScreenCTM())||void 0===r?void 0:r.inverse())}function x(e){var t;return null===(t=e.target)||void 0===t?void 0:t.ownerSVGElement}function w(e){var t=[],n=[];return(0,y.makeAbsolute)((0,y.parseSVG)(e)).forEach((e=>{switch(e.code){case"M":t.push(n=[]);case"L":case"H":case"V":case"Z":r=e.x||0,i=e.y||0,n.push(new h(r,i));break;default:throw Error("svg command ".concat(e.command," is not supported"))}var r,i})),t.map((e=>new v(e)))}var k="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0,S=0;var Z=n(30266);var P={borderSize:0,cs:1,ch:1,walkableSlopeAngle:0,walkableHeight:10,walkableClimb:10,walkableRadius:0,maxEdgeLen:12,maxSimplificationError:.1,minRegionArea:10,mergeRegionArea:20,maxVertsPerPoly:6,detailSampleDist:10,detailSampleMaxError:.1};"undefined"!==typeof self&&Promise.all([n.e(593),n.e(317)]).then(n.t.bind(n,67362,23)).then((e=>{C.initialize(e.default)}));var C=new class{constructor(){this.bjsRECAST={},this.lookup={},this.readyResolvers=[]}ready(){var e=this;return(0,Z.Z)((function*(){if(!e.bjsRECAST.NavMesh)return new Promise((t=>{e.readyResolvers.push(t)}))}))()}initialize(e){if(e(this.bjsRECAST),!this.bjsRECAST.NavMesh)return console.error("RecastJS is not available. Please make sure you included the js file.");for(;this.readyResolvers.length;){var t;null===(t=this.readyResolvers.pop())||void 0===t||t()}}clearNavMesh(e){var t;null===(t=this.lookup[e])||void 0===t||t.destroy(),delete this.lookup[e]}createNavMesh(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=Object.assign({},P,n),i=new this.bjsRECAST.rcConfig;i.cs=r.cs,i.ch=r.ch,i.borderSize=r.borderSize,i.tileSize=0,i.walkableSlopeAngle=r.walkableSlopeAngle,i.walkableHeight=r.walkableHeight,i.walkableClimb=r.walkableClimb,i.walkableRadius=r.walkableRadius,i.maxEdgeLen=r.maxEdgeLen,i.maxSimplificationError=r.maxSimplificationError,i.minRegionArea=r.minRegionArea,i.mergeRegionArea=r.mergeRegionArea,i.maxVertsPerPoly=r.maxVertsPerPoly,i.detailSampleDist=r.detailSampleDist,i.detailSampleMaxError=r.detailSampleMaxError;var s=new this.bjsRECAST.NavMesh,o=this.lookup[e];this.lookup[e]=s;var a=t.vs.flatMap((e=>[e.x,0,e.y])),c=t.vs.length,l=t.tris.flatMap((e=>e));console.info("recast: building:",e),s.build(a,c,l,l.length,i),console.info("recast: built:",e),null===o||void 0===o||o.destroy()}getDebugTriangulation(e){if(!this.lookup[e])return{vs:[],tris:[]};var t,n,r=this.lookup[e].getDebugNavMesh(),i=r.getTriangleCount(),s=[],o=[];for(t=0;t<3*i;t+=3)s.push([t,t+1,t+2]);for(t=0;t<i;t++)for(n=0;n<3;n++){var a=r.getTriangle(t).getPoint(n);o.push(new h(a.x,a.z))}return{vs:o,tris:s}}getClosestPoint(e,t){var n=new this.bjsRECAST.Vec3(t.x,0,t.y),r=this.lookup[e].getClosestPoint(n);return{x:r.x,y:r.z}}getClosestPointToRef(e,t,n){var r=new this.bjsRECAST.Vec3(t.x,0,t.y),i=this.lookup[e].getClosestPoint(r);n.x=i.x,n.y=i.z}getRandomPointAround(e,t,n){var r=new this.bjsRECAST.Vec3(t.x,0,t.y),i=this.lookup[e].getRandomPointAround(r,n);return{x:i.x,y:i.z}}getRandomPointAroundToRef(e,t,n,r){var i=new this.bjsRECAST.Vec3(t.x,0,t.y),s=this.lookup[e].getRandomPointAround(i,n);r.x=s.x,r.y=s.z}moveAlong(e,t,n){var r=new this.bjsRECAST.Vec3(t.x,0,t.y),i=new this.bjsRECAST.Vec3(n.x,0,n.y),s=this.lookup[e].moveAlong(r,i);return{x:s.x,y:s.z}}moveAlongToRef(e,t,n,r){var i=new this.bjsRECAST.Vec3(t.x,0,t.y),s=new this.bjsRECAST.Vec3(n.x,0,n.y),o=this.lookup[e].moveAlong(i,s);r.x=o.x,r.y=o.z}computePath(e,t,n){if(!this.lookup[e])return console.warn("navmesh: ".concat(e,": not found")),[];var r,i=new this.bjsRECAST.Vec3(t.x,0,t.y),s=new this.bjsRECAST.Vec3(n.x,0,n.y),o=this.lookup[e].computePath(i,s),a=o.getPointCount(),c=[];for(r=0;r<a;r++){var l=o.getPoint(r);c.push(new h(l.x,l.z))}return c}setDefaultQueryExtent(e,t){var n=new this.bjsRECAST.Vec3(t.x,0,t.y);this.lookup[e].setDefaultQueryExtent(n)}getDefaultQueryExtent(e){var t=this.lookup[e].getDefaultQueryExtent();return{x:t.x,y:t.z}}buildFromNavmeshData(e,t){var n=t.length*t.BYTES_PER_ELEMENT,r=this.bjsRECAST._malloc(n),i=new Uint8Array(this.bjsRECAST.HEAPU8.buffer,r,n);i.set(t);var s=new this.bjsRECAST.NavmeshData;s.dataPointer=i.byteOffset,s.size=t.length,this.lookup[e]=new this.bjsRECAST.NavMesh,this.lookup[e].buildFromNavmeshData(s),this.bjsRECAST._free(i.byteOffset)}getNavmeshData(e){var t=this.lookup[e].getNavmeshData(),n=new Uint8Array(this.bjsRECAST.HEAPU8.buffer,t.dataPointer,t.size),r=new Uint8Array(t.size);return r.set(n),this.lookup[e].freeNavmeshData(t),r}getDefaultQueryExtentToRef(e,t){var n=this.lookup[e].getDefaultQueryExtent();t.x=n.x,t.y=n.z}dispose(){this.lookup={}}};var E=new class{createNavMesh(e,t,n){var r=this;return(0,Z.Z)((function*(){if(yield C.ready(),t.length){var i=r.polysToTriangulation(t);C.createNavMesh(e,i,n)}else C.clearNavMesh(e)}))()}requestNavPath(e,t,n){try{var r=C.computePath(e,t,n);return this.removePathReps(r.map((e=>e.precision(1))))}catch(i){return console.error("nav error",i),[]}}joinTriangulations(e){if(1===e.length)return e[0];var t=[],n=[],r=0;for(var i of e)t.push(...i.vs),n.push(...i.tris.map((e=>e.map((e=>e+r))))),r+=i.vs.length;return{vs:t,tris:n}}polysToTriangulation(e){var t=e.map((e=>e.qualityTriangulate()));return this.joinTriangulations(t)}removePathReps(e){var t;return e.reduce(((e,n)=>(t&&n.x===t.x&&n.y===t.y||e.push(t=n),e)),[])}};function R(){var e=(0,o.Z)(["\n        width: 100%;\n        height: 100%;\n        touch-action: pan-x pan-y pinch-zoom;\n        /** sporadic improvement for pixel5 vs macbookpro */\n        > g.content {\n          shape-rendering: ",";\n        }\n      "]);return R=function(){return e},e}function O(e){var[t]=a.useState((()=>{var n=e.initViewBox.clone(),r=e.minZoom||.5,i=e.maxZoom||2;return{viewBox:n,panFrom:null,zoom:e.initZoom||1,ptrEvent:[],ptrDiff:null,zoomTo:(s,o)=>{var a=Math.min(Math.max(t.zoom+o,r),i);n.x=t.zoom/a*(n.x-s.x)+s.x,n.y=t.zoom/a*(n.y-s.y)+s.y,n.width=1/a*e.initViewBox.width,n.height=1/a*e.initViewBox.height,t.zoom=a},onWheel:e=>{e.preventDefault();var n=b(e);t.zoomTo(n,-.003*e.deltaY),t.root.setAttribute("viewBox","".concat(t.viewBox))},onPointerDown:e=>{t.panFrom=(new h).copy(b(e)),t.ptrEvent.push(e)},onPointerMove:e=>{if(t.ptrEvent=t.ptrEvent.map((t=>t.pointerId===e.pointerId?e:t)),2===t.ptrEvent.length){var r=Math.abs(t.ptrEvent[1].clientX-t.ptrEvent[0].clientX);if(null!==t.ptrDiff){var i=function(e){var t,n,r;return(g=g||(null===(t=x(e[0]))||void 0===t?void 0:t.createSVGPoint())).x=g.y=0,e.forEach((e=>{g.x+=e.clientX,g.y+=e.clientY})),g.x/=e.length||1,g.y/=e.length||1,g.matrixTransform(null===(n=x(e[0]))||void 0===n||null===(r=n.getScreenCTM())||void 0===r?void 0:r.inverse())}(t.ptrEvent);t.zoomTo(i,.02*(r-t.ptrDiff)),t.root.setAttribute("viewBox","".concat(t.viewBox))}t.ptrDiff=r}else if(t.panFrom){var s=b(e);n.delta(t.panFrom.x-s.x,t.panFrom.y-s.y),t.root.setAttribute("viewBox","".concat(t.viewBox))}},onPointerUp:e=>{console.log("up",e.type),t.panFrom=null,t.ptrEvent=t.ptrEvent.filter((t=>e.pointerId!==t.pointerId)),t.ptrEvent.length<2&&(t.ptrDiff=null)},rootRef:e=>{e&&(t.root=e,e.addEventListener("wheel",t.onWheel),e.addEventListener("pointerdown",t.onPointerDown,{passive:!0}),e.addEventListener("pointermove",t.onPointerMove,{passive:!0}),e.addEventListener("pointerup",t.onPointerUp,{passive:!0}),e.addEventListener("pointercancel",t.onPointerUp,{passive:!0}),e.addEventListener("pointerleave",t.onPointerUp,{passive:!0}),e.addEventListener("touchstart",(e=>e.preventDefault())))},root:{},rootCss:(0,c.iv)(R(),k?"optimizeSpeed":"auto")}}));return(0,r.BX)("svg",{ref:t.rootRef,className:t.rootCss,preserveAspectRatio:"xMinYMin",viewBox:"".concat(t.viewBox),children:[(0,r.tZ)(T,{bounds:e.gridBounds}),(0,r.tZ)("g",{className:"content",children:e.children})]})}function T(e){var t=a.useMemo((()=>"".concat("grid-").concat(S++)),[]);return(0,r.BX)(r.HY,{children:[(0,r.tZ)("defs",{children:(0,r.tZ)("pattern",{id:t,width:"10",height:"10",patternUnits:"userSpaceOnUse",children:(0,r.tZ)("path",{d:"M 10 0 L 0 0 0 10",fill:"none",stroke:"rgba(0,0,0,0.5)",strokeWidth:"0.3"})})}),(0,r.tZ)("rect",{x:e.bounds.x,y:e.bounds.y,width:e.bounds.width,height:e.bounds.height,fill:"url(#".concat(t,")")})]})}function j(){var e=(0,o.Z)(["\n  display: flex;\n  flex-direction: column;\n  height: 100%;\n  border: 2px solid #000;\n\n  > p {\n    padding: 12px 8px;\n    margin: 0;\n    font-family: monospace;\n    font-size: 16px;\n    background: #eee;\n  }\n"]);return j=function(){return e},e}var _=new u(-5e3,-5e3,10001,10001),D=new u(0,0,200,200),I=(0,c.iv)(j()),M=n(88767),A=new v([...Array(8)].map(((e,t)=>new h(Math.cos(2*Math.PI*(1/16+t/8)),Math.sin(2*Math.PI*(1/16+t/8)))))).scale(50).round(),[N]=v.cutOut([A],[A.clone().scale(1.5)]),[B]=v.union([N,N.clone().translate(N.rect.width-20,0)]);function V(){var e=(0,o.Z)(["\n  border: 1px solid #555555;\n  height: inherit;\n\n  path.walls {\n    fill: #000;\n  }\n  path.floor {\n    cursor: crosshair;\n    fill: white;\n    stroke:none;\n  }\n  g.dots circle {\n    cursor: crosshair;\n    fill: #ddd;\n    stroke: black;\n    stroke-width: 0.5;\n\n    &.selected {\n      fill: red;\n    }\n  }\n  polygon.triangle {\n    pointer-events: none;\n    fill: none;\n    stroke: #bbb;\n    stroke-width: 0.5;\n  }\n  polyline.navpath {\n    fill: none;\n    stroke: #800;\n    stroke-width: 1;\n    stroke-dasharray: 4 4;\n  }\n"]);return V=function(){return e},e}B.round();var L=e=>{var t;return(0,r.tZ)("g",{children:null===(t=e.tris)||void 0===t?void 0:t.map(((e,t)=>(0,r.tZ)("polygon",{className:"triangle",points:"".concat(e)},t)))})},K=a.default.memo(L),z=new u(-5e3,-5e3,10001,10001),W=new u(0,0,200,200),F="fig-of-8",G=B.clone().translate(100,100),[J]=G.createOutset(6),X=(0,c.iv)(V()),H=n(77503),U=n.n(H),q=n(94184),$=n.n(q);function Q(e){var t,n,{data:i}=(t=e.url,n=e.tags,(0,M.useQuery)("use-svg-".concat(t,"-").concat(n||[],"}"),(0,Z.Z)((function*(){console.info("loading symbol",t,n||"(no tags)");var e=yield fetch(t).then((e=>e.text())),r=U().load(e),i=Array.from(r("svg > *")),s=Y(r,i,"hull"),o=Y(r,i,"doors",n),a=Y(r,i,"walls"),c=Y(r,i,"obstacles"),l=Y(r,i,"iris-valves"),u=Y(r,i,"labels"),d=function(e,t){var n=t.find((t=>ee(e,t,"background"))),{attribs:r}=e(n).children("image").toArray()[0];return new h(Number(r.x||0),Number(r.y||0))}(r,i);return{basename:t.slice("/svg/".length,-".svg".length),svgInnerText:i.map((e=>r.html(e))).join("\n"),hull:v.union(s),doors:o,irisValves:l,labels:u,obstacles:c,pngOffset:d,walls:a}}))));return i?(0,r.BX)("g",{className:"symbol ".concat(i.basename),transform:e.transform,children:[e.debug&&(0,r.tZ)("g",{className:"debug",transform:e.transform,dangerouslySetInnerHTML:{__html:i.svgInnerText||""}}),!e.hull&&(0,r.tZ)("image",{href:"/png/".concat(i.basename,".png"),x:i.pngOffset.x,y:i.pngOffset.y}),(0,r.BX)("g",{className:"meta",children:[i.hull[0]&&(0,r.tZ)("polygon",{className:"outline",points:"".concat(i.hull[0].outline)}),i.hull.map(((e,t)=>(0,r.tZ)("path",{className:"hull",d:"".concat(e.svgPath)},t))),i.doors.map(((e,t)=>{var{outline:n}=e;return(0,r.tZ)("polygon",{className:"door",points:"".concat(n)},t)})),i.irisValves.map(((e,t)=>{var{outline:n}=e;return(0,r.tZ)("polygon",{className:"iris-valve",points:"".concat(n)},t)})),i.walls.map(((e,t)=>(0,r.tZ)("path",{className:"wall",d:"".concat(e.svgPath)},t))),i.obstacles.map(((e,t)=>(0,r.tZ)("path",{className:"obstacle",d:"".concat(e.svgPath)},t))),i.labels.map(((e,t)=>{var{outline:n,meta:i}=e;return(0,r.tZ)("polygon",{className:$()("label",null===i||void 0===i?void 0:i.title),points:"".concat(n)},t)}))]})]}):null}function Y(e,t,n,r){var i=t.find((t=>ee(e,t,n)));return e(i).children("rect, path").toArray().flatMap((t=>function(e,t){var{tagName:n,attribs:r}=t,i=[],s=e(t).children("title").text()||void 0;if("rect"===n){var o=v.fromRect(new u(Number(r.x||0),Number(r.y||0),Number(r.width||0),Number(r.height||0)));i.push(o.addMeta({title:s}))}else"path"===n?i.push(...w(r.d).map((e=>e.addMeta({title:s})))):console.warn("extractPoly: unexpected tagName:",n);var a=new DOMMatrix(r.transform);return i.map((e=>e.applyMatrix(a)))}(e,t))).filter((e=>function(e,t){return!t||!e||e.startsWith("has-")&&t.includes(e.slice(4))}(e.meta.title,r)))}function ee(e,t,n){return e(t).children("title").text()===n&&e(t).addClass(n)}function te(){var e=(0,o.Z)(["\n  width: inherit;\n  height: inherit;\n\n  .meta {\n    stroke: none;\n    .outline { fill: rgba(0, 0, 100, 0.2); }\n    .door, .iris-valve { fill: rgba(0, 200, 0, 0.3); }\n    .wall, .hull { fill: rgba(200, 50, 50, 0.5); }\n    .obstacle { fill: rgba(100, 100, 150, 0.5); }\n    .label { fill: rgba(0, 0, 0, 0.4); }\n  }\n"]);return te=function(){return e},e}var ne=new u(0,0,1200,600),re=new u(-5e3,-5e3,10001,10001),ie=(0,c.iv)(te()),se=(0,Z.Z)((function*(){var e=WebAssembly.validate(new Uint8Array([0,97,115,109,1,0,0,0,1,5,1,96,0,1,123,3,2,1,0,10,10,1,8,0,65,0,253,15,253,98,11])),t=yield e?n.e(912).then(n.bind(n,46912)):n.e(646).then(n.bind(n,69646)),{default:r}=t;return yield r(...arguments)}));var oe=new u(-5e3,-5e3,10001,10001),ae=new u(0,0,200,200),ce={"panzoom/PanZoom.jsx":"import * as React from 'react';\nimport { css } from 'goober';\nimport { Vect, Rect } from '../geom';\nimport { getSvgPos, getSvgMid, generateId, canTouchDevice } from '../service';\n\n/** @param {React.PropsWithChildren<Props>} props */\nexport default function PanZoom(props) {\n\n  const [state] = React.useState(() => {\n    const viewBox = props.initViewBox.clone();\n    const minZoom = props.minZoom || 0.5;\n    const maxZoom = props.maxZoom || 2;\n    return {\n      viewBox,\n      /** @type {null | Vect} */\n      panFrom: null,\n      zoom: props.initZoom || 1,\n      /** @type {PointerEvent[]} */\n      ptrEvent: [],\n      /** @type {null | number} */\n      ptrDiff: null,\n      /**\n       * @param {DOMPoint} point \n       * @param {number} delta \n       */\n      zoomTo: (point, delta) => {\n        const zoom = Math.min(Math.max(state.zoom + delta, minZoom), maxZoom);\n        viewBox.x = (state.zoom / zoom) * (viewBox.x - point.x) + point.x;\n        viewBox.y = (state.zoom / zoom) * (viewBox.y - point.y) + point.y;\n        viewBox.width = (1 / zoom) * props.initViewBox.width;\n        viewBox.height = (1 / zoom) * props.initViewBox.height;\n        state.zoom = zoom;\n      },\n      /** @param {WheelEvent} e */\n      onWheel: e => {\n        e.preventDefault();\n        const point = getSvgPos(e);\n        state.zoomTo(point, -0.003 * e.deltaY);\n        state.root.setAttribute('viewBox', `${state.viewBox}`);\n      },\n      /** @param {PointerEvent} e */\n      onPointerDown: e => {\n        state.panFrom = (new Vect).copy(getSvgPos(e));\n        state.ptrEvent.push(e);\n      },\n      /** @param {PointerEvent} e */\n      onPointerMove: e => {\n        state.ptrEvent = state.ptrEvent.map(x => x.pointerId === e.pointerId ? e : x);\n\n        if (state.ptrEvent.length === 2) {\n          const ptrDiff = Math.abs(state.ptrEvent[1].clientX - state.ptrEvent[0].clientX);\n          if (state.ptrDiff !== null) {\n            const point = getSvgMid(state.ptrEvent);\n            state.zoomTo(point, 0.02 * (ptrDiff - state.ptrDiff));\n            state.root.setAttribute('viewBox', `${state.viewBox}`);\n          }          \n          state.ptrDiff = ptrDiff;\n        } else if (state.panFrom) {\n          const mouse = getSvgPos(e);\n          viewBox.delta(state.panFrom.x - mouse.x, state.panFrom.y - mouse.y);\n          state.root.setAttribute('viewBox', `${state.viewBox}`);\n        }\n      },\n      /** @param {PointerEvent} e */\n      onPointerUp: (e) => {\n        console.log('up', e.type);\n        state.panFrom = null;\n        state.ptrEvent = state.ptrEvent.filter(alt => e.pointerId !== alt.pointerId);\n        if (state.ptrEvent.length < 2) {\n          state.ptrDiff = null;\n        }\n      },\n      /** @type {(el: null | SVGSVGElement) => void} */\n      rootRef: el => {\n        if (el) {\n          state.root = el;\n          el.addEventListener('wheel', state.onWheel);\n          el.addEventListener('pointerdown', state.onPointerDown, { passive: true });\n          el.addEventListener('pointermove', state.onPointerMove, { passive: true });\n          el.addEventListener('pointerup', state.onPointerUp, { passive: true });\n          el.addEventListener('pointercancel', state.onPointerUp, { passive: true });\n          el.addEventListener('pointerleave', state.onPointerUp, { passive: true });\n          el.addEventListener('touchstart', e => e.preventDefault());\n        }\n      },\n      /** @type {SVGSVGElement} */\n      root: ({}),\n      rootCss: css`\n        width: 100%;\n        height: 100%;\n        touch-action: pan-x pan-y pinch-zoom;\n        /** sporadic improvement for pixel5 vs macbookpro */\n        > g.content {\n          shape-rendering: ${canTouchDevice ? 'optimizeSpeed' : 'auto'};\n        }\n      `,\n    };\n  });\n\n  return (\n    <svg\n      ref={state.rootRef}\n      className={state.rootCss}\n      preserveAspectRatio=\"xMinYMin\"\n      viewBox={`${state.viewBox}`}\n    >\n      <Grid bounds={props.gridBounds} />\n      <g className=\"content\">\n        {props.children}\n      </g>\n    </svg>\n  );\n}\n\n/**\n * @typedef Props @type {object}\n * @property {Rect} gridBounds World bounds\n * @property {Rect} initViewBox Initial viewbox in world coords\n * @property {number=} minZoom Minimum zoom factor (default 0.5)\n * @property {number=} maxZoom Maximum zoom factor (default 2)\n * @property {number=} initZoom Initial zoom factor (default 1)\n */\n\n/** @param {{ bounds: Rect }} props */\nfunction Grid(props) {\n  const gridId = React.useMemo(() => generateId('grid-'), []);\n\n  return <>\n    <defs>\n      <pattern\n        id={gridId}\n        width=\"10\" \n        height=\"10\"\n        patternUnits=\"userSpaceOnUse\"\n      >\n        <path\n          d=\"M 10 0 L 0 0 0 10\"\n          fill=\"none\"\n          stroke=\"rgba(0,0,0,0.5)\"\n          strokeWidth=\"0.3\"\n        />\n      </pattern>\n    </defs>\n    <rect\n      x={props.bounds.x}\n      y={props.bounds.y}\n      width={props.bounds.width}\n      height={props.bounds.height}\n      fill={`url(#${gridId})`}\n    />\n  </>;\n}\n","panzoom/PanZoomDemo.jsx":"import * as React from 'react';\nimport { css } from 'goober';\nimport PanZoom from './PanZoom';\nimport { Rect } from '../geom';\n\nexport default function PanZoomDemo() {\n  return (\n    <div className={rootCss}>\n      <p>\n        drag to <strong>pan</strong>, scroll/pinch to <strong>zoom</strong>\n      </p>\n      <PanZoom initViewBox={initViewBox} gridBounds={gridBounds}>\n        <rect fill=\"red\" x={10} y={10} width={20} height={20} />\n      </PanZoom>\n    </div>\n  );\n}\n\nconst gridBounds = new Rect(-5000, -5000, 10000 + 1, 10000 + 1);\nconst initViewBox = new Rect(0, 0, 200, 200);\n\nconst rootCss = css`\n  display: flex;\n  flex-direction: column;\n  height: 100%;\n  border: 2px solid #000;\n\n  > p {\n    padding: 12px 8px;\n    margin: 0;\n    font-family: monospace;\n    font-size: 16px;\n    background: #eee;\n  }\n`;","pathfinding/NavDemo.jsx":'import React, { useEffect, useState } from "react";\nimport { css } from "goober";\nimport { useQuery } from "react-query";\nimport { Rect, Vect } from "../geom";\nimport { figureOfEight } from \'../example/geom\';\nimport { getSvgPos, geom, recast } from "../service";\nimport PanZoom from "../panzoom/PanZoom";\n\n// import { options } from \'preact\';\n// if (typeof window !== \'undefined\') {\n//   const prev = options.diffed;\n//   options.diffed = (/** @type {*} */ vnode) => {\n//     prev?.(vnode);\n//     console.log(vnode); \n//   };\n// }\n\n// TODO remove recast-detour:\n// (a) compute navmesh in dev-env or codesandbox\n// (b) adapt three-pathfinding\n\n// TODO provide random point button\n\nexport default function NavDemo() {\n\n  const [dots, setDots] = useState(/** @type {Vect[]} */ ([]));\n  const [selected, setSelected] = useState(/** @type {number[]} */ ([]));\n  const [path, setPath] = useState(/** @type {Vect[]} */ ([]));\n\n  // TODO draw into image via canvas instead\n  const { data: tris } = useQuery(\'create-nav\', async () => {\n    await geom.createNavMesh(navKey, [polygon], {  cs: 1, walkableRadius: 2, maxSimplificationError: 50 });\n    const { tris, vs } = recast.getDebugTriangulation(navKey);\n    return tris.map(tri => tri.map(i => vs[i]));\n  }, { staleTime: Infinity });\n\n  useEffect(() => {\n    if (selected.length === 2) {\n      setPath(geom.requestNavPath(navKey, dots[selected[0]], dots[selected[1]]));\n    }\n  }, [dots, selected]);\n\n  /** @param {number} index */\n  function toggleDot(index) {\n    setSelected(selected.includes(index)\n      ? selected.filter(x => x !== index)\n      : [index].concat(selected).slice(0, 2)\n    );\n  }\n\n  return (\n    <section className={rootCss}>\n      <PanZoom gridBounds={gridBounds} initViewBox={initViewBox}>\n        <path className="walls" d={`${thickWalls.svgPath}`} />\n        <path className="floor" d={`${polygon.svgPath}`}\n          onClick={(e) => {\n            const point = getSvgPos(e);\n            if (!dots.some(d => d.distanceTo(point) < 5)) {\n              setDots(dots.concat(Vect.from(point)));\n              toggleDot(dots.length);\n            }\n          }}\n        />\n        {<MemoedTriangles tris={tris} />}\n        <polyline className="navpath" points={`${path}`} />\n        <g className="dots">\n          {dots.map((p, i) =>\n            <circle\n              key={i}\n              cx={p.x}\n              cy={p.y}\n              r={2.5}\n              className={selected.includes(i) ? \'selected\' : undefined }\n              onClick={() => toggleDot(i)}\n            />\n          )}\n        </g>\n      </PanZoom>\n    </section>\n  );\n}\n\n/** @type {React.FC<{ tris?: Vect[][] }>}  */\nconst Triangles = (props) => <g>\n  {props.tris?.map((tri, i) =>\n    <polygon key={i} className="triangle" points={`${tri}`} />  \n  )}\n</g>;\n\nconst MemoedTriangles = React.memo(Triangles);\n\nconst gridBounds = new Rect(-5000, -5000, 10000 + 1, 10000 + 1);\nconst initViewBox = new Rect(0, 0, 200, 200);\nconst navKey = \'fig-of-8\';\nconst polygon = figureOfEight.clone().translate(100, 100);\nconst [thickWalls] = polygon.createOutset(6);\n\nconst rootCss = css`\n  border: 1px solid #555555;\n  height: inherit;\n\n  path.walls {\n    fill: #000;\n  }\n  path.floor {\n    cursor: crosshair;\n    fill: white;\n    stroke:none;\n  }\n  g.dots circle {\n    cursor: crosshair;\n    fill: #ddd;\n    stroke: black;\n    stroke-width: 0.5;\n\n    &.selected {\n      fill: red;\n    }\n  }\n  polygon.triangle {\n    pointer-events: none;\n    fill: none;\n    stroke: #bbb;\n    stroke-width: 0.5;\n  }\n  polyline.navpath {\n    fill: none;\n    stroke: #800;\n    stroke-width: 1;\n    stroke-dasharray: 4 4;\n  }\n`;',"example/jsx-to-js.jsx":"import * as React from 'react';\nimport PanZoomDemo from '../panzoom/PanZoomDemo';\n\n// With JSX\nconst node = <div title=\"message\">Welcome!</div>;\n// Without JSX\nconst sameNode = React.createElement(\n  'div',\n  { title: 'message' },\n  'Welcome!',\n);\n\n// With JSX\nconst altNode = <div><PanZoomDemo /></div>;\n// Without JSX\nconst sameAltNode = React.createElement(\n  'div',\n  null,\n  React.createElement(PanZoomDemo, null),\n);"},le={"panzoom/PanZoomDemo.jsx":function(){return(0,r.BX)("div",{className:I,children:[(0,r.BX)("p",{children:["drag to ",(0,r.tZ)("strong",{children:"pan"}),", scroll/pinch to ",(0,r.tZ)("strong",{children:"zoom"})]}),(0,r.tZ)(O,{initViewBox:D,gridBounds:_,children:(0,r.tZ)("rect",{fill:"red",x:10,y:10,width:20,height:20})})]})},"pathfinding/NavDemo.jsx":function(){var{0:e,1:t}=(0,a.useState)([]),{0:n,1:i}=(0,a.useState)([]),{0:s,1:o}=(0,a.useState)([]),{data:c}=(0,M.useQuery)("create-nav",(0,Z.Z)((function*(){yield E.createNavMesh(F,[G],{cs:1,walkableRadius:2,maxSimplificationError:50});var{tris:e,vs:t}=C.getDebugTriangulation(F);return e.map((e=>e.map((e=>t[e]))))})),{staleTime:1/0});function l(e){i(n.includes(e)?n.filter((t=>t!==e)):[e].concat(n).slice(0,2))}return(0,a.useEffect)((()=>{2===n.length&&o(E.requestNavPath(F,e[n[0]],e[n[1]]))}),[e,n]),(0,r.tZ)("section",{className:X,children:(0,r.BX)(O,{gridBounds:z,initViewBox:W,children:[(0,r.tZ)("path",{className:"walls",d:"".concat(J.svgPath)}),(0,r.tZ)("path",{className:"floor",d:"".concat(G.svgPath),onClick:n=>{var r=b(n);e.some((e=>e.distanceTo(r)<5))||(t(e.concat(h.from(r))),l(e.length))}}),(0,r.tZ)(K,{tris:c}),(0,r.tZ)("polyline",{className:"navpath",points:"".concat(s)}),(0,r.tZ)("g",{className:"dots",children:e.map(((e,t)=>(0,r.tZ)("circle",{cx:e.x,cy:e.y,r:2.5,className:n.includes(t)?"selected":void 0,onClick:()=>l(t)},t)))})]})})},"geomorph/GeomorphTest.jsx":function(){return(0,r.tZ)("div",{className:ie,children:(0,r.BX)(O,{initViewBox:ne,gridBounds:re,maxZoom:5,children:[(0,r.tZ)(Q,{hull:!0,debug:!0,url:"/svg/301--hull.svg"}),(0,r.tZ)(Q,{url:"/svg/office--001--2x2.svg",tags:["door-s"],transform:"matrix(-0.2, 0, 0, 0.2, 240, 120)"}),(0,r.tZ)(Q,{url:"/svg/office--001--2x2.svg",tags:["door-s"],transform:"matrix(0.2, 0, 0, 0.2, 960, 120)"}),(0,r.tZ)(Q,{url:"/svg/stateroom--036--2x4.svg",transform:"scale(0.2)"}),(0,r.tZ)(Q,{url:"/svg/stateroom--036--2x4.svg",transform:"matrix(-0.2, 0, 0, 0.2, 1200, 0)"}),(0,r.tZ)(Q,{url:"/svg/stateroom--036--2x4.svg",transform:"matrix(0, -0.2, 0.2, 0, 0, 600)"}),(0,r.tZ)(Q,{url:"/svg/bridge--042--8x9.svg",transform:"matrix(0.2, 0, 0, 0.2, 360, 60)"})]})})},"physics/PhysicsDemo.jsx":function(){var e=a.useRef({}).current;return a.useEffect((()=>(se({locateFile:(e,t)=>"/box2d/".concat(e)}).then((t=>{var n=new t.b2Vec2(0,0);e.world=new t.b2World(n),console.info("created world",e)})),()=>{var t;console.info("destroying world"),null===(t=e.world)||void 0===t||t.__destroy__(),Object.assign(e,{world:null})})),[]),(0,r.tZ)(O,{gridBounds:oe,initViewBox:ae,children:(0,r.tZ)("text",{x:10,y:20,children:"TODO"})})}};var he=n(5152),ue=(0,he.default)((()=>Promise.all([n.e(126),n.e(135),n.e(209)]).then(n.bind(n,35209))),{ssr:!1,loadableGenerated:{webpack:()=>[35209],modules:["../components/dynamic.tsx -> ./code/CodeEditor"]}}),de=(0,he.default)((()=>Promise.all([n.e(142),n.e(586)]).then(n.bind(n,17586))),{ssr:!1,loadableGenerated:{webpack:()=>[17586],modules:["../components/dynamic.tsx -> ./sh/XTerm"]}}),pe=(0,he.default)((()=>n.e(431).then(n.bind(n,78431))),{ssr:!1,loadableGenerated:{webpack:()=>[78431],modules:["../components/dynamic.tsx -> ./page/Loadable"]}});function me(){var e=(0,o.Z)(["\n  pointer-events: none;\n  position: absolute;\n  z-index: 5;\n  width: inherit;\n  height: inherit;\n  background: #000;\n  display: flex;\n  justify-content: center;\n\n  > div {\n    display: flex;\n    align-items: center;\n  }\n  .message {\n    color: #ccc;\n    background: #444;\n    border-radius: 4px;\n    padding: 8px;\n    font-size: 14px;\n  }\n\n  opacity: 1;\n  transition: opacity 0.5s linear;\n  &.fade-out {\n    opacity: 0;    \n  }\n"]);return me=function(){return e},e}function fe(){var e=(0,o.Z)(["\n  height: 100%;\n  width: 100%;\n  border: 1px solid rgba(0, 0, 0, 0.3);\n  border-top: 6px solid #444;\n  position: relative;\n"]);return fe=function(){return e},e}function ve(e){var{children:t,background:n}=e,{0:i,1:s}=(0,a.useState)(!1);return(0,r.BX)("div",{className:ge,style:{background:n},children:[(0,r.tZ)(ye,{fadeOut:i}),(0,r.tZ)(pe,{onLoaded:()=>s(!0),children:t})]})}var ge=(0,c.iv)(fe());function ye(e){return(0,r.tZ)("div",{className:$()(be,{"fade-out":e.fadeOut}),children:(0,r.tZ)("div",{children:(0,r.tZ)("div",{className:"message",children:"Loading..."})})})}var be=(0,c.iv)(me());function xe(e){var{children:t}=e;return(0,r.tZ)("section",{children:(0,r.tZ)("strong",{children:t})})}function we(){var e=(0,o.Z)(["\n  height: ","px;\n  margin: ",";\n  background: #444;\n  \n  @media(min-width: 800px) {\n    margin-top: 24px;\n    margin-bottom: 24px;\n  }\n\n  > div {\n    position: relative;\n    height: inherit;\n  }\n  \n  .flexlayout__tabset_tabbar_outer {\n    background: #222;\n    border-bottom: 1px solid #555;\n  }\n  .flexlayout__tab_button--selected, .flexlayout__tab_button:hover {\n    background: #444;\n  }\n  .flexlayout__tab_button_content {\n    user-select: none;\n    font-size: 13px;\n    color: #aaa;\n  }\n  .flexlayout__tab_button--selected .flexlayout__tab_button_content {\n    color: #fff;\n  }\n  .flexlayout__tab_button:hover:not(.flexlayout__tab_button--selected) .flexlayout__tab_button_content {\n    color: #ddd;\n  }\n  .flexlayout__splitter_vert, .flexlayout__splitter_horz {\n    background: #827575;\n  }\n"]);return we=function(){return e},e}function ke(e){var{tabs:t,margin:n,height:i}=e,s=a.default.useMemo((()=>l.Model.fromJson(function(e){return{global:{tabEnableRename:!1},layout:{type:"row",weight:100,children:[{type:"tabset",weight:50,selected:0,children:e.map((e=>({type:"tab",name:"code"===e.key?e.filepath:e.filepath.split("/").pop().slice(0,-4),config:{key:e.key,folds:"folds"in e?e.folds:void 0},component:e.filepath,enableClose:!1})))}]}}}(t))),[t]);return(0,r.tZ)(Se,{className:"scrollable",height:i,margin:n,children:(0,r.tZ)(l.Layout,{model:s,factory:Ze})})}var Se=(0,c.zo)("div")(we(),(e=>e.height),(e=>e.margin||"auto"));function Ze(e){var{key:t,folds:n}=e.getConfig();switch(t){case"code":var i=e.getComponent()||"";return i in ce?(0,r.tZ)(ve,{background:"black",children:(0,r.tZ)(ue,{height:"100%",lineNumbers:!0,readOnly:!0,code:ce[i],folds:n})}):(0,r.BX)(xe,{children:["Unknown code with filepath ",i]});case"component":var s=e.getComponent()||"";if(s in le)return(0,r.tZ)(ve,{children:a.default.createElement(le[s])});default:return(0,r.BX)(xe,{children:["Unknown TabNode with name ",t]})}}var Pe=n(39944),Ce=n(92809),Ee=n(86576),Re=n(24790),Oe=n(14671),Te=n(38597),je=n(58377);function _e(e){var t=function(e,t){if("object"!==typeof e||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!==typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===typeof t?t:String(t)}function De(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Ie(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?De(Object(n),!0).forEach((function(t){(0,Ce.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):De(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Me(e,t){return Ie(Ie({},t),{},{[e.key]:e})}function Ae(e,t){var{[e]:n}=t;return(0,je.Z)(t,[e].map(_e))}function Ne(e,t,n){if(!t[e])return t;var r=n(t[e]);return r?Ie(Ie({},t),{},{[e]:Ie(Ie({},t[e]),r)}):t}var Be=n(8068),Ve=n(29950);var Le=new class{constructor(){var e=this;(0,Ce.Z)(this,"onOneLine",!0),(0,Ce.Z)(this,"multilineSrc",(e=>{this.onOneLine=!1;var t=this.src(e);return this.onOneLine=!0,t})),(0,Ce.Z)(this,"seqSrc",(function(t){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e.onOneLine){var r=[];return t.forEach((t=>r.push(e.src(t),e.isBackgroundNode(t)?" ":"; "))),(n?r:r.slice(0,-1)).join("")}return t.map((t=>e.src(t))).join("\n")})),(0,Ce.Z)(this,"src",(e=>{var t,n;if(!e)return"";switch(e.type){case"ArithmCmd":return"(( ".concat(this.src(e.X)," ))");case"BinaryCmd":var r=this.binaryCmds(e);return[r[0].X].concat(r.map((e=>{var{Y:t}=e;return t}))).map((e=>this.src(e))).join(" ".concat(e.Op).concat(this.onOneLine||"|"===e.Op?"":"\n"," "));case"BinaryArithm":return[e.X,e.Y].map((e=>this.src(e))).join("".concat(e.Op));case"UnaryArithm":return e.Post?"".concat(this.src(e.X)).concat(e.Op):"".concat(e.Op).concat(this.src(e.X));case"ParenArithm":return"(".concat(this.src(e.X),")");case"Word":return"string"===typeof e.string?e.string:e.Parts.map((e=>this.src(e))).join("");case"ArrayExpr":var i=e.Elems.map((e=>{var{Index:t,Value:n}=e;return t?"[".concat(this.src(t),"]=").concat(this.src(n)):this.src(n)}));return"(".concat(i.join(" "),")");case"Assign":var s=e.Name.Value;return e.Array?"".concat(s,"=").concat(this.src(e.Array)):e.Index?"".concat(s,"[").concat(this.src(e.Index),"]").concat(e.Append?"+":"","=").concat(this.src(e.Value)):"".concat(s).concat(e.Append?"+":"","=").concat(this.src(e.Value||null));case"Block":var{Stmts:o}=e,a=o.length&&this.isBackgroundNode((0,Ee.Z$)(o))?"":";";if(this.onOneLine)return"{ ".concat(this.seqSrc(o)).concat(a," }");var c=this.seqSrc(o).split("\n");return 1===c.length&&!c[0]&&c.pop(),"{\n".concat(c.map((e=>"  ".concat(e))).concat(e.Last.map((e=>"  #".concat(e.Text)))).join("\n"),"\n}");case"CallExpr":return[e.Assigns.map((e=>this.src(e))).join(" "),e.Args.map((e=>this.src(e))).join(" ")].filter(Boolean).join(" ");case"Stmt":var l=[e.Negated&&"!",this.src(e.Cmd),e.Redirs.map((e=>this.src(e))).join(" "),e.Background&&"&"].filter(Boolean).join(" ");if(!this.onOneLine&&e.Comments.length){var h=[];e.Comments.forEach((t=>t.Hash.Offset<e.Position.Offset?h.push("#".concat(t.Text)):l+=" #".concat(t.Text))),l=h.concat(l).join("\n")}return l;case"CaseClause":var u=e.Items.map((e=>{var{Patterns:t,Op:n,Stmts:r}=e;return{globs:t,terminal:n,child:r}}));return["case",this.src(e.Word),"in",u.flatMap((e=>{var{child:t,globs:n,terminal:r}=e;return["".concat(n.map((e=>this.src(e))).join(" | "),")"),this.seqSrc(t),r]})).join(" "),"esac"].filter(Boolean).join(" ");case"CoprocClause":return["coproc",null===(t=e.Name)||void 0===t?void 0:t.Value,this.src(e.Stmt)].filter(Boolean).join(" ");case"DeclClause":return[e.Variant.Value,e.Args.map((e=>this.src(e))).join(" ")].filter(Boolean).join(" ");case"ArithmExp":return"".concat("Stmt"===(null===(n=e.parent)||void 0===n?void 0:n.type)?"":"$","(( ").concat(this.src(e.X)," ))");case"CmdSubst":return"$( ".concat(this.seqSrc(e.Stmts)," )");case"DblQuoted":return'"'.concat(e.Parts.map((e=>this.src(e))).join(""),'"');case"ExtGlob":return e.Pattern.Value.replace(/\n/g,"");case"Lit":return e.Value;case"ParamExp":var d;return":-"===(null===(d=e.Exp)||void 0===d?void 0:d.Op)?"${".concat(e.Param.Value,":-").concat(this.src(e.Exp.Word),"}"):"${".concat(e.Param.Value,"}");case"ProcSubst":var p="<("===e.Op?"<":">";return"".concat(p,"( ").concat(this.seqSrc(e.Stmts)," )");case"SglQuoted":var m=e.Value;return"".concat(e.Dollar?"$":"","'").concat(m,"'");case"FuncDecl":return"".concat(e.Name.Value,"() ").concat(this.src(e.Body));case"IfClause":return(0,Ve.Wc)(e).map(((e,t)=>{var{Cond:n,Then:r}=e;return n.length?"".concat(t?"elif":"if"," ").concat(this.seqSrc(n),"; then ").concat(this.seqSrc(r),"; "):"else ".concat(this.seqSrc(r),"; ")})).concat("fi").join("");case"LetClause":return"let ".concat(e.Exprs.map((e=>this.src(e))).join(" "));case"Redirect":var f=e.N?Number(e.N.Value):"";switch(e.Op){case">":case">>":var[v]=e.Word.Parts,g="Lit"===(null===v||void 0===v?void 0:v.type)&&v.Value.endsWith("-");return"".concat(f).concat(e.Op).concat(this.src(e.Word)).concat(g?"-":"");default:return""}case"File":return this.seqSrc(e.Stmts);case"Subshell":return"( ".concat(e.Stmts.map((e=>this.src(e))).join("; ")," )");case"TestClause":return"[[ ".concat(this.src(e.X)," ]]");case"BinaryTest":return[e.X,e.Y].map((e=>this.src(e))).join(" ".concat(e.Op," "));case"UnaryTest":return"".concat(e.Op," ").concat(this.src(e.X));case"ParenTest":return"(".concat(this.src(e.X),")");case"TimeClause":return"time ".concat(e.PosixFormat?"-p ":"").concat(this.src(e.Stmt));case"ForClause":var{Do:y,Loop:b}=e;return"CStyleLoop"===b.type?"for (( ".concat(this.src(b.Init),"; ").concat(this.src(b.Cond),"; ").concat(this.src(b.Post)," )); do ").concat(this.seqSrc(y,!0),"done"):"for ".concat(b.Name.Value," in ").concat(b.Items.map((e=>this.src(e))).join(" "),"; do ").concat(this.seqSrc(y,!0),"done");case"WhileClause":return"".concat(e.Until?"until":"while"," ").concat(this.seqSrc(e.Cond,!0),"do ").concat(this.seqSrc(e.Do,!0),"done");case"CStyleLoop":case"Comment":case"WordIter":case"ArrayElem":case"CaseItem":return"";default:throw(0,Ee.Ql)(e)}}))}binaryCmds(e){var{X:t,Y:n,Op:r}=e;return t.Cmd&&"BinaryCmd"===t.Cmd.type&&t.Cmd.Op===r?[...this.binaryCmds(t.Cmd),e]:n.Cmd&&"BinaryCmd"===n.Cmd.type&&n.Cmd.Op===r?[e,...this.binaryCmds(n.Cmd)]:[e]}isBackgroundNode(e){return"Stmt"===e.type&&e.Background}},Ke=n(29209),ze=n(29998),We=n(36375),Fe=n(47480),Ge=n(95775),Je=n.n(Ge),Xe=n(86744),He=n.n(Xe);function Ue(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!e.trim())return[];if(t)return e.trim().replace(/[\s]+/g," ").split(" ");var n=e.replace(/[\s]+/g," ").split(" ");return n[0]||(n.shift(),n[0]=" "+n[0]),(0,Ee.Z$)(n)||(n.pop(),n.push(n.pop()+" ")),n}function qe(e){return{key:"expanded",values:e instanceof Array?e:[e],value:e instanceof Array?e.join(" "):e}}var $e={expand:!0,rangeLimit:1/0};class Qe extends Error{constructor(e,t,n){super(e),this.exitCode=t,this.original=n,Object.setPrototypeOf(this,Qe.prototype)}}class Ye extends Error{constructor(e,t,n){super(e),this.code=e,this.pid=t,this.sessionKey=n,Object.setPrototypeOf(this,Ye.prototype)}}function et(e){return new Ye(Pt.SIGKILL,e.pid,e.sessionKey)}function tt(e,t,n){return function(e,t){return it(rt(e),t)}(e.startsWith("/")?e.split("/"):n.split("/").concat(e.split("/")),t)}function nt(e,t,n){return rt(e.startsWith("/")?e.split("/"):n.split("/").concat(e.split("/")))}function rt(e){return e.reduce(((e,t)=>t&&"."!==t?".."===t?e.slice(0,-1):e.concat(t):e),[])}function it(e,t){return e.reduce(((e,t)=>e[t]),t)}var st=n(30023),ot=n.n(st);function at(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function ct(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?at(Object(n),!0).forEach((function(t){(0,Ce.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):at(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var lt={call:!0,cd:!0,declare:!0,echo:!0,expr:!0,false:!0,filter:!0,get:!0,help:!0,history:!0,kill:!0,ls:!0,poll:!0,ps:!0,pwd:!0,map:!0,reduce:!0,return:!0,rm:!0,run:!0,session:!0,set:!0,sleep:!0,split:!0,sponge:!0,true:!0,unset:!0};var ht=new class{constructor(){(0,Ce.Z)(this,"shellUtil",{pretty:e=>(0,Ee.IC)(JSON.parse((0,Ee.or)(e)))})}isCmd(e){return e in lt}runCmd(e,t,n){var r=this;return(0,Ke.Z)((function*(){var{meta:i}=e;switch(t){case"call":var s=Function("return ".concat(n[0]));yield s()(r.provideProcessCtxt(i,n.slice(1)));break;case"cd":if(n.length>1)throw new Qe("usage: `cd /`, `cd`, `cd foo/bar`, `cd /foo/bar`, `cd ..` and `cd -`",1);var o=Ot.api.getVar(i.sessionKey,"OLDPWD"),a=Ot.api.getVar(i.sessionKey,"PWD");Ot.api.setVar(i.sessionKey,"OLDPWD",a);try{if(n[0])if("-"===n[0])Ot.api.setVar(i.sessionKey,"PWD",o);else if(n[0].startsWith("/")){var c=rt(n[0].split("/"));if(void 0===it(c,r.provideProcessCtxt(e.meta)))throw Error;Ot.api.setVar(i.sessionKey,"PWD",c.join("/"))}else{var l=rt(a.split("/").concat(n[0].split("/")));if(void 0===it(l,r.provideProcessCtxt(e.meta)))throw Error;Ot.api.setVar(i.sessionKey,"PWD",l.join("/"))}else Ot.api.setVar(i.sessionKey,"PWD","home")}catch(we){throw Ot.api.setVar(i.sessionKey,"OLDPWD",o),new Qe("".concat(n[0]," not found"),1)}break;case"declare":var h=Ot.api.getFuncs(i.sessionKey);for(var{key:u,src:d}of h){var p="".concat(zt).concat(u).concat(Wt," () ").concat(d).split(/\r?\n/);for(var m of p)yield m;yield""}break;case"echo":var{opts:f,operands:v}=(0,Ve.v8)(n,{boolean:["a","n"]});if(f.a)yield f.n?v.map(Number):v;else if(f.n)for(var g of v)yield Number(g);else yield v.join(" ");break;case"expr":yield r.parseJsArg(n.join(" "));break;case"false":e.exitCode=1;break;case"filter":var y=Function("fn = ".concat(n[0],"; return (...args) => fn(...args) ? args[0] : undefined"));yield*(0,We.Z)((0,Be.Z)(r.read(i,(e=>y()(e,r.provideProcessCtxt(i))))),ze.Z);break;case"get":yield*(0,We.Z)((0,Be.Z)(r.get(e,n)),ze.Z);break;case"help":var{ttyShell:b}=Ot.api.getSession(i.sessionKey);yield"1) The following commands are supported:";var x=ot()(Object.keys(lt),{width:b.xterm.xterm.cols}).split(/\r?\n/);for(var w of x)yield"".concat(zt).concat(w);yield"2) Traverse context via `ls` or `ls -l var.foo.bar` (Object.keys).",yield"3) View shell functions via `declare`.",yield"4) Use Ctrl-c to interrupt and Ctrl-l to clear screen.",yield"5) View history via up/down or `history`.",yield"6) Traverse input using Option-left/right and Ctrl-{a,e}.",yield"7) Delete input using Ctrl-{w,u,k}.",yield"8) You can copy and paste.",yield"9) Pipes, command substitution and background processes are supported.";break;case"history":var{ttyShell:k}=Ot.api.getSession(i.sessionKey),S=k.getHistory();for(var Z of S)yield Z;break;case"kill":if("break"===function(){var{opts:e,operands:t}=(0,Ve.v8)(n,{boolean:["STOP","CONT"]}),s=t.map((e=>r.parseJsonArg(e))).filter((e=>Number.isFinite(e)));for(var o of s){Ot.api.getProcesses(i.sessionKey,o).reverse().forEach((t=>{var n;if(e.STOP)null===(n=t.onSuspend)||void 0===n||n.call(t),t.onSuspend=null,t.status=bt.Suspended;else if(e.CONT){var r;null===(r=t.onResume)||void 0===r||r.call(t),t.onResume=null,t.status=bt.Running}else{var i;t.status=bt.Killed,null===(i=t.onResume)||void 0===i||i.call(t),t.onSuspend=t.onResume=null,setTimeout((()=>{t.cleanups.forEach((e=>e())),t.cleanups.length=0}))}}))}return"break"}())break;case"ls":var{opts:P,operands:C}=(0,Ve.v8)(n,{boolean:["1","l","r","a"]}),E=Ot.api.getVar(i.sessionKey,"PWD"),R=C.length?C.slice():[""],O=r.provideProcessCtxt(i),T=R.map((e=>tt(e,O,E))),{ttyShell:j}=Ot.api.getSession(e.meta.sessionKey),_=function*(e,t){if(void 0===t)return Ot.api.warn(i.sessionKey,'ls: "'.concat(R[e],'" is not defined')),"continue";T.length>1&&(yield"".concat(zt).concat(R[e],":"));var n=(P.r?(0,Ee.RT)(t):Object.keys(t)).sort(),r=[];if("home"!==E||P.a||(n=n.filter((e=>e.toUpperCase()!==e))),P.l){"function"===typeof t&&(n=n.filter((e=>!["caller","callee","arguments"].includes(e))));var s=n.map((e=>{var n,r;return(null===(n=t[e])||void 0===n||null===(r=n.constructor)||void 0===r?void 0:r.name)||(null===t[e]?"null":"undefined")})),o=Math.max(...s.map((e=>e.length)));r=n.map(((e,t)=>"".concat(Kt).concat(s[t].padEnd(o)).concat(Wt," ").concat(e)))}else r=P[1]?n:ot()(n,{width:j.xterm.xterm.cols}).split(/\r?\n/);for(var a of r)yield a};for(var[D,I]of T.entries())yield*_(D,I);break;case"map":var M=Function("return ".concat(n[0]));yield*(0,We.Z)((0,Be.Z)(r.read(i,(e=>M()(e,r.provideProcessCtxt(i))))),ze.Z);break;case"poll":var A=n.length?parseFloat(r.parseJsonArg(n[0]))||0:1,[N,B]=[1e3*Math.max(A,.5),new Ee.BH];Ot.api.addCleanup(i,(()=>B.resolve()));for(var V=1;;)yield V++,yield(0,ze.Z)(Promise.race([(0,Ee.wO)(N),B.promise]));case"ps":var{opts:L}=(0,Ve.v8)(n,{boolean:["a","s"]}),K=Object.values(Ot.api.getProcesses(i.sessionKey)).filter(L.a?e=>e:e=>{var{key:t,pgid:n}=e;return t===n}),z=["pid","ppid","pgid"].map((e=>e.padEnd(5))).join(" ");if(L.s)for(var{key:W,ppid:F,pgid:G,status:J,src:X}of K){var H=Nt(J),U=[W,F,G].map(String).map((e=>e.padEnd(5))).join(" ");yield"".concat(zt).concat(z).concat(Lt),yield"".concat(U).concat(H),yield X+"\n"}else for(var{key:q,ppid:$,pgid:Q,status:Y,src:ee}of(yield"".concat(zt).concat(z).concat(Lt),K)){var te=Nt(Y),ne=[q,$,Q].map(String).map((e=>e.padEnd(5))).join(" ");yield"".concat(ne).concat(te,"  ").concat((0,Ee.$G)(ee,30))}break;case"pwd":yield"/"+Ot.api.getVar(i.sessionKey,"PWD");break;case"reduce":var re=[],ie=Function("return ".concat(n[0]))();yield*(0,We.Z)((0,Be.Z)(r.read(i,(e=>{re.push(e)}))),ze.Z),yield n[1]?re.reduce(ie,r.parseJsArg(n[1])):re.reduce(ie);break;case"return":var se,oe=Ot.api.getProcess(i);oe.status=bt.Killed,null===(se=oe.onResume)||void 0===se||se.call(oe),oe.onSuspend=oe.onResume=null;break;case"rm":var ae=r.provideProcessCtxt(i),ce=Ot.api.getVar(i.sessionKey,"PWD");for(var le of n){var he=nt(le,0,ce);if(!("home"===he[0]&&he.length>1))throw new Qe("cannot delete ".concat(le),1);var ue=he.pop();delete it(he,ae)[ue]}break;case"run":var de=Function("_","return async function *generator ".concat(n[0]));yield*(0,We.Z)((0,Be.Z)(de()(r.provideProcessCtxt(i,n.slice(1)))),ze.Z);break;case"session":yield i.sessionKey;break;case"set":var pe=r.provideProcessCtxt(i),me=r.parseJsArg(n[1]);if("/"===n[0][0])Function("__1","__2","return __1.".concat(n[0].slice(1)," = __2"))(pe,me);else{var fe=r.computeCwd(i,pe);Function("__1","__2","return __1.".concat(n[0]," = __2"))(fe,me)}break;case"sleep":if("break"===(yield*function*(){var e=Ot.api.getProcess(i),t=1e3*(n.length?parseFloat(r.parseJsonArg(n[0]))||0:1),s=-1;do{yield(0,ze.Z)(new Promise(((n,r)=>{e.onSuspend=()=>{t=s+t-Date.now(),n()},Ot.api.addCleanup(i,(()=>r(et(i)))),(s=Date.now())&&setTimeout(n,t)}))),yield}while(Date.now()<s+t-1);return"break"}()))break;case"split":var ve=r.parseJsonArg(n[0]);yield*(0,We.Z)((0,Be.Z)(void 0===ve?r.split(i):r.splitBy(i,ve)),ze.Z);break;case"sponge":var ge=[];yield*(0,We.Z)((0,Be.Z)(r.read(i,(e=>{ge.push(e)}))),ze.Z),yield ge;break;case"true":e.exitCode=0;break;case"unset":var{var:ye,func:be}=Ot.api.getSession(i.sessionKey);for(var xe of n)delete ye[xe],delete be[xe];break;default:throw(0,Ee.Ql)(t)}}))()}get(e,t){var n=this.provideProcessCtxt(e.meta),r=Ot.api.getVar(e.meta.sessionKey,"PWD"),i=t.map((e=>tt(e,n,r)));return e.exitCode=i.length&&i.every((e=>void 0===e))?1:0,i}computeCwd(e,t){return it(Ot.api.getVar(e.sessionKey,"PWD").split("/"),t)}launchFunc(e,t,n){return(0,Z.Z)((function*(){var r=(0,Ve.VN)(t.node),{ttyShell:i}=Ot.api.getSession(e.meta.sessionKey);Object.assign(r.meta,ct(ct({},e.meta),{},{ppid:e.meta.pid,stack:e.meta.stack.concat(t.key)})),yield i.spawn(r,{posPositionals:n.slice()})}))()}provideProcessApi(e){var t=this;return{read:function(){var n=(0,Z.Z)((function*(){var n=yield t.readOnce(e);return null!==n&&void 0!==n&&n.eof?null:n}));return function(){return n.apply(this,arguments)}}(),sleep:t=>new Promise(((n,r)=>{setTimeout(n,1e3*t),Ot.api.addCleanup(e,(()=>r(et(e))))}))}}provideProcessCtxt(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=Ot.api.getSession(e.sessionKey);return new Proxy({home:n.var,util:this.shellUtil},{get:(n,r)=>"api"===r?this.provideProcessApi(e):"args"===r?t:n[r],deleteProperty:(e,t)=>!1})}readLoop(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return(0,Ke.Z)((function*(){var r=Ot.api.getProcess(e),i=Ot.api.resolve(0,e);if(i instanceof ft&&0!==r.pgid)throw new Qe("background process tried to read tty",1);for(var s={};!(s=yield(0,ze.Z)(i.readData(n))).eof&&(void 0===s.data||(yield t(s),!n));)yield(0,ze.Z)(Mt(r,i))}))()}read(e,t){var n=this;return(0,Ke.Z)((function*(){yield*(0,We.Z)((0,Be.Z)(n.readLoop(e,(e=>{if(Bt(e.data)){var n,r=[];for(var i of e.data.items)void 0!==(n=t(i))&&r.push(n);return e.data.items=r,e.data}return t(e.data)}))),ze.Z)}))()}readOnce(e){var t=this;return(0,Z.Z)((function*(){var n,r=!0,i=!1;try{for(var s,o,a=(0,Be.Z)(t.readLoop(e,(e=>{var{data:t}=e;return t}),!0));r=(s=yield a.next()).done,o=yield s.value,!r;r=!0){return o}}catch(c){i=!0,n=c}finally{try{r||null==a.return||(yield a.return())}finally{if(i)throw n}}return{eof:!0}}))()}split(e){var t=this;return(0,Ke.Z)((function*(){yield*(0,We.Z)((0,Be.Z)(t.readLoop(e,(e=>Bt(e.data)?(e.data.items=e.data.items.flatMap((e=>e)),e.data):Array.isArray(e.data)?Vt(e.data):e.data))),ze.Z)}))()}splitBy(e,t){var n=this;return(0,Ke.Z)((function*(){yield*(0,We.Z)((0,Be.Z)(n.readLoop(e,(e=>{if(Bt(e.data))return e.data.items=e.data.items.flatMap((e=>e.split(t))),e.data;if("string"===typeof e.data)return Vt(e.data.split(t));throw new Qe("expected string",1)}))),ze.Z)}))()}parseJsonArg(e){try{return void 0===e?void 0:JSON.parse(e)}catch(t){return e}}parseJsArg(e){try{return Function("return ".concat(e))()}catch(t){return e}}};var ut=new class{assignVars(e){var t=this;return(0,Ke.Z)((function*(){for(var n of e.Assigns)yield*(0,We.Z)((0,Be.Z)(t.Assign(n)),ze.Z)}))()}applyRedirects(e,t){var n=this;return(0,Z.Z)((function*(){try{for(var r of t)r.exitCode=0,yield n.Redirect(r)}catch(o){var i,s;throw e.exitCode=null!==(i=null===(s=t.find((e=>e.exitCode)))||void 0===s?void 0:s.exitCode)&&void 0!==i?i:1,o}}))()}expandParameter(e,t){if(/^\d+$/.test(t))return Ot.api.getPositional(e.pid,e.sessionKey,Number(t));var n=Ot.api.getVar(e.sessionKey,t);return void 0===n||"string"===typeof n?n||"":Je()(n)}handleShError(e,t,n){if(t instanceof Ye)throw t;if(t instanceof Qe){var r=[n,t.message].filter(Boolean).join(": ");Ot.api.warn(e.meta.sessionKey,r),console.error("ShError: ".concat(e.meta.sessionKey,": ").concat(r)),e.exitCode=t.exitCode}else{var i=[n,null===t||void 0===t?void 0:t.message].filter(Boolean).join(": ");Ot.api.warn(e.meta.sessionKey,i),console.error("Internal ShError: ".concat(e.meta.sessionKey,": ").concat(i)),console.error(t),e.exitCode=2}}handleTopLevelProcessError(e){if(e.code===Pt.SIGKILL){var t=Ot.api.getProcess({pid:e.pid,sessionKey:e.sessionKey});if(t)Ot.api.getProcesses(e.sessionKey,t.pgid).forEach((e=>{e.status=bt.Killed,e.cleanups.forEach((e=>e())),e.cleanups.length=0}))}}lastExpanded(e){return(0,Z.Z)((function*(){var t,n=void 0,r=!0,i=!1;try{for(var s,o,a=(0,Be.Z)(e);r=(s=yield a.next()).done,o=yield s.value,!r;r=!0){n=o}}catch(c){i=!0,t=c}finally{try{r||null==a.return||(yield a.return())}finally{if(i)throw t}}return n}))()}stmts(e,t){return(0,Ke.Z)((function*(){for(var n of t)yield*(0,We.Z)((0,Be.Z)(dt.Stmt(n)),ze.Z),e.exitCode=n.exitCode}))()}performShellExpansion(e){var t=this;return(0,Z.Z)((function*(){var n=[];for(var r of e){var i=yield t.lastExpanded(t.Expand(r)),s=1===r.Parts.length?r.Parts[0]:null;if(r.exitCode)throw new Qe("failed to expand word",r.exitCode);"SglQuoted"===(null===s||void 0===s?void 0:s.type)?n.push(i.value):"ParamExp"===(null===s||void 0===s?void 0:s.type)||"CmdSubst"===(null===s||void 0===s?void 0:s.type)?Ue(i.value).forEach((e=>n.push(e))):i.values.forEach((e=>n.push(e)))}return n}))()}Assign(e){var t=this,{meta:n,Name:r,Value:i,Naked:s}=e;return(0,Ke.Z)((function*(){Ot.api.setVar(n.sessionKey,r.Value,!s&&i?(yield(0,ze.Z)(t.lastExpanded(dt.Expand(i)))).value:"")}))()}BinaryCmd(e){return(0,Ke.Z)((function*(){var t=Le.binaryCmds(e),n=[t[0].X].concat(t.map((e=>{var{Y:t}=e;return t})));switch(e.Op){case"&&":for(var r of n)if(yield*(0,We.Z)((0,Be.Z)(dt.Stmt(r)),ze.Z),e.exitCode=r.exitCode)break;break;case"||":for(var i of n)if(yield*(0,We.Z)((0,Be.Z)(dt.Stmt(i)),ze.Z),!(e.exitCode=i.exitCode))break;break;case"|":var s=[],o=n.map((t=>{var n=(0,Ve.nL)((0,Ve.VN)(t));return n.meta.ppid=e.meta.pid,n}));try{var{ttyShell:a}=Ot.api.getSession(e.meta.sessionKey);for(var[c,l]of o.slice(0,-1).entries()){var h="/dev/fifo-".concat(l.meta.pid,"-").concat(c);s.push(Ot.api.createFifo(h)),o[c+1].meta.fd[0]=l.meta.fd[1]=h}var u=o.map((e=>{var{meta:t}=e;return Ot.api.resolve(1,t)}));yield(0,ze.Z)(Promise.all(o.map(((t,n)=>new Promise(function(){var r=(0,Z.Z)((function*(r,i){try{var s;if(yield a.spawn(t),u[n].finishedWriting(),null===(s=u[n-1])||void 0===s||s.finishedReading(),e.exitCode=t.exitCode)throw new Qe("pipe ".concat(n),e.exitCode);r()}catch(o){i(o)}}));return function(e,t){return r.apply(this,arguments)}}())))))}catch(d){throw o.map((e=>{var{meta:t}=e;return Ot.api.getProcess(t)})).forEach((e=>e&&(e.status=bt.Killed))),et(e.meta)}finally{s.forEach((e=>{e.finishedWriting(),Ot.api.removeDevice(e.key)}))}break;default:throw new Qe("binary command ".concat(e.Op," unsupported"),2)}}))()}Block(e){return this.stmts(e,e.Stmts)}CallExpr(e){return(0,Ke.Z)((function*(){e.exitCode=0;var t,n=yield(0,ze.Z)(dt.performShellExpansion(e.Args)),[r,...i]=n;if(e.meta.verbose&&console.log("simple command",n),n.length)if(ht.isCmd(r))yield*(0,We.Z)((0,Be.Z)(ht.runCmd(e,r,i)),ze.Z);else if(t=Ot.api.getFunc(e.meta.sessionKey,r))yield(0,ze.Z)(ht.launchFunc(e,t,i));else try{for(var s of n)if(s.includes("("))yield*(0,We.Z)((0,Be.Z)(ht.get(e,[s])),ze.Z);else{var o=ht.get(e,[s]);if(void 0===o[0])throw Error();yield*(0,We.Z)((0,Be.Z)(o),ze.Z)}}catch(a){throw new Qe("not found",127)}else yield*(0,We.Z)((0,Be.Z)(dt.assignVars(e)),ze.Z)}))()}Command(e,t){var n=this;return(0,Ke.Z)((function*(){try{var r;if(yield(0,ze.Z)(dt.applyRedirects(e,t)),"CallExpr"===e.type)r=n.CallExpr(e);else switch(e.type){case"Block":r=n.Block(e);break;case"BinaryCmd":r=n.BinaryCmd(e);break;case"DeclClause":r=n.DeclClause(e);break;case"FuncDecl":r=n.FuncDecl(e);break;case"IfClause":r=n.IfClause(e);break;case"TimeClause":r=n.TimeClause(e);break;case"Subshell":r=n.Subshell(e);break;default:throw new Qe("not implemented",2)}var i=Ot.api.getProcess(e.meta),s=Ot.api.resolve(1,e.meta);if(!s)throw et(e.meta);var o,a=!0,c=!1;try{for(var l,h,u=(0,Be.Z)(r);a=(l=yield(0,ze.Z)(u.next())).done,h=yield(0,ze.Z)(l.value),!a;a=!0){var d=h;yield(0,ze.Z)(Dt(i,s)),yield(0,ze.Z)(s.writeData(d))}}catch(m){c=!0,o=m}finally{try{a||null==u.return||(yield(0,ze.Z)(u.return()))}finally{if(c)throw o}}}catch(f){var p="CallExpr"===e.type?e.Args[0].string||"unknown CallExpr":e.type;(f instanceof Qe?f:new Qe("",1,f)).message="".concat(e.meta.stack.concat(p).join(": "),": ").concat(f.message||f),dt.handleShError(e,f)}}))()}DeclClause(e){var t=this;return(0,Ke.Z)((function*(){if("declare"!==e.Variant.Value)throw new Qe("Commmand: DeclClause: ".concat(e.Variant.Value," unsupported"),2);if(e.Args.length)for(var n of e.Args)yield*(0,We.Z)((0,Be.Z)(t.Assign(n)),ze.Z);else e.exitCode=0,yield*(0,We.Z)((0,Be.Z)(ht.runCmd(e,"declare",[])),ze.Z)}))()}Expand(e){var t=this;return(0,Ke.Z)((function*(){if(e.Parts.length>1){for(var n of e.Parts)n.string=(yield(0,ze.Z)(t.lastExpanded(dt.ExpandPart(n)))).value;var r=!1,i=[];for(var{type:s,string:o}of e.Parts){var a=o;if("ParamExp"===s||"CmdSubst"===s){var c=Ue(a,!1);if(!c.length)continue;!i.length||r||/^\s/.test(c[0])?i.push(...c.map((e=>e.trim()))):(i.push(i.pop()+c[0].trim()),i.push(...c.slice(1).map((e=>e.trim())))),r=/\s$/.test((0,Ee.Z$)(c))}else!i.length||r?(i.push(a),r=!1):(i.push(i.pop()+a),r=!1)}e.string=i.join(" "),yield qe(i)}else{var l,h=!0,u=!1;try{for(var d,p,m=(0,Be.Z)(t.ExpandPart(e.Parts[0]));h=(d=yield(0,ze.Z)(m.next())).done,p=yield(0,ze.Z)(d.value),!h;h=!0){var f=p;e.string=f.value,yield f}}catch(v){u=!0,l=v}finally{try{h||null==m.return||(yield(0,ze.Z)(m.return()))}finally{if(u)throw l}}}}))()}ExpandPart(e){var t=this;return(0,Ke.Z)((function*(){switch(e.type){case"DblQuoted":var n=[];for(var r of e.Parts){var i=yield(0,ze.Z)(t.lastExpanded(dt.ExpandPart(r)));"ParamExp"===r.type&&"@"===r.Param.Value?n.push("".concat(n.pop()||"").concat(i.values[0]||""),...i.values.slice(1)):n.push("".concat(n.pop()||"").concat(i.value||""))}return void(yield qe(n));case"Lit":yield qe(function(e){var{Value:t,parent:n}=e;if(!n)throw Error("Literal must have parent");var r=t.replace(/\\\n/,"").replace(/\[/g,"\\[").replace(/\]/g,"\\]");return"DblQuoted"===n.type?[r.replace(/\\(["\\$`])/g,"$1")]:"TestClause"===n.type||"Redirect"===n.type?[r.replace(/\\(.|$)/g,"$1")]:He()(r,$e)}(e));break;case"SglQuoted":yield qe(function(e){var t,{Dollar:n,Value:r}=e;return[n?(t=r,JSON.parse(JSON.stringify(t).replace(/\\\\e/g,"\\u001b").replace(/\\\\x([0-9a-f]{2})/g,"\\u00$1").replace(/\\\\([bfnrt])/g,"\\$1"))):r]}(e));break;case"CmdSubst":var s=(0,Ve.nL)((0,Ve.VN)(e)),o="/dev/fifo-cmd-".concat((0,Fe.x0)()),a=Ot.api.createFifo(o);s.meta.fd[1]=a.key;var{ttyShell:c}=Ot.api.getSession(e.meta.sessionKey);yield(0,ze.Z)(c.spawn(s));try{yield qe(a.readAll().map((e=>"string"===typeof e?e:Je()(e))).join("\n").replace(/\n*$/,""))}finally{Ot.api.removeDevice(a.key)}break;case"ParamExp":return void(yield*(0,We.Z)((0,Be.Z)(t.ParamExp(e)),ze.Z));case"ArithmExp":case"ExtGlob":case"ProcSubst":default:throw Error("".concat(e.type," unimplemented"))}}))()}File(e){return dt.stmts(e,e.Stmts)}FuncDecl(e){return(0,Ke.Z)((function*(){var t=(0,Ve.VN)(e.Body),n=(0,Ve.nL)(t);Ot.api.addFunc(e.meta.sessionKey,e.Name.Value,n)}))()}IfClause(e){return(0,Ke.Z)((function*(){for(var{Cond:t,Then:n}of(0,Ve.Wc)(e)){var r,i;if(!t.length)return yield*(0,We.Z)((0,Be.Z)(dt.stmts(e,n)),ze.Z),void(e.exitCode=(null===(r=(0,Ee.Z$)(n))||void 0===r?void 0:r.exitCode)||0);if(yield*(0,We.Z)((0,Be.Z)(dt.stmts(e,t)),ze.Z),0===(0,Ee.Z$)(t).exitCode)return yield*(0,We.Z)((0,Be.Z)(dt.stmts(e,n)),ze.Z),void(e.exitCode=(null===(i=(0,Ee.Z$)(n))||void 0===i?void 0:i.exitCode)||0)}}))()}ParamExp(e){var t=this,{meta:n,Param:r,Slice:i,Repl:s,Length:o,Excl:a,Exp:c}=e;return(0,Ke.Z)((function*(){if(a||o||s||i)throw new Qe("ParamExp: ".concat(r.Value,": unsupported operation"),2);if(c)switch(c.Op){case":-":var e=t.expandParameter(n,r.Value);yield""===e&&c.Word?yield(0,ze.Z)(t.lastExpanded(t.Expand(c.Word))):qe(e);break;default:throw new Qe("ParamExp: ".concat(r.Value,": unsupported operation"),2)}else"@"===r.Value?yield qe(Ot.api.getProcess(n).positionals.slice(1)):yield qe(t.expandParameter(n,r.Value))}))()}Redirect(e){var t=this;return(0,Z.Z)((function*(){if(">"===e.Op||">>"===e.Op){var{value:n}=yield t.lastExpanded(dt.Expand(e.Word));if("/dev/null"===n)return _t(e.parent,{1:"/dev/null"});var r=Ot.api.createVarDevice(e.meta.sessionKey,n,">"===e.Op?"last":"array");return _t(e.parent,{1:r.key})}throw new Qe("".concat(e.Op,": unsupported redirect"),127)}))()}Stmt(e){var t=this;return(0,Ke.Z)((function*(){if(!e.Cmd)throw new Qe("pure redirects are unsupported",2);if(e.Background&&0===e.meta.pgid){var{ttyShell:n}=Ot.api.getSession(e.meta.sessionKey),r=(0,Ve.nL)((0,Ve.VN)(e));r.meta.ppid=e.meta.pid,r.meta.pgid=Ot.api.getSession(e.meta.sessionKey).nextPid,n.spawn(r).catch((e=>{e instanceof Ye?t.handleTopLevelProcessError(e):console.error("background process error",e)})),e.exitCode=e.Negated?1:0}else yield*(0,We.Z)((0,Be.Z)(dt.Command(e.Cmd,e.Redirs)),ze.Z),e.exitCode=e.Cmd.exitCode,e.Negated&&(e.exitCode=1-Number(!!e.Cmd.exitCode))}))()}Subshell(e){return(0,Ke.Z)((function*(){var t=(0,Ve.nL)((0,Ve.VN)(e)),{ttyShell:n}=Ot.api.getSession(e.meta.sessionKey);yield(0,ze.Z)(n.spawn(t))}))()}TimeClause(e){return(0,Ke.Z)((function*(){var t=Date.now();e.Stmt&&(yield*(0,We.Z)((0,Be.Z)(dt.Stmt(e.Stmt)),ze.Z)),Ot.api.resolve(1,e.meta).writeData("real\t".concat(Date.now()-t,"ms"))}))()}},dt=ut,pt={range:"{\ncall '({args}) =>\n  [...Array(Number(args[0]))].map((_, i) => i)\n' \"$1\"\n}",seq:'{\n  range "$1" | split\n}',pretty:"{\n  map '(x, {util}) => util.pretty(x)'\n}",keys:"{\n  map Object.keys\n}",log:"{\n  map 'x => console.log(x)'\n}"},mt={};"\n\n".concat("\n\n# options key handler\nkey | run '({ api: {read}, var: {msg}, stage: {opt} }) {\n  while (msg = await read()) {\n    if (msg.type !== \"keydown\" || !opt.enabled) continue;\n    switch (msg.key) {\n      // NOOP\n    }\n  }\n}' &\n".trim(),"\n\n").trim();class ft{constructor(e,t,n){this.sessionKey=e,this.io=t,this.history=n,(0,Ce.Z)(this,"key",void 0),(0,Ce.Z)(this,"xterm",void 0),(0,Ce.Z)(this,"inputs",[]),(0,Ce.Z)(this,"input",null),(0,Ce.Z)(this,"buffer",[]),(0,Ce.Z)(this,"maxLines",500),(0,Ce.Z)(this,"process",void 0),(0,Ce.Z)(this,"oneTimeReaders",[]),this.key="/dev/tty-".concat(e)}initialise(e){var t=this;return(0,Z.Z)((function*(){for(var[n,r]of(t.xterm=e,t.io.read(t.onMessage.bind(t)),Ot.api.createProcess({sessionKey:t.sessionKey,ppid:0,pgid:0,src:""}),t.process=Ot.api.getSession(t.sessionKey).process[0],gt.parse||(yield new Promise((e=>yt.push(e)))),t.loadShellFuncs(pt),Object.entries(mt)))Ot.api.setVar(t.sessionKey,n,r);yield t.runProfile(),t.prompt("$")}))()}onMessage(e){switch(e.key){case"req-history-line":var{line:t,nextIndex:n}=this.getHistoryLine(e.historyIndex);this.io.write({key:"send-history-line",line:t,nextIndex:n});break;case"send-line":this.oneTimeReaders.length?(this.oneTimeReaders.shift().resolve(e.line),this.io.write({key:"tty-received-line"})):(this.inputs.push({line:e.line,resolve:()=>this.io.write({key:"tty-received-line"})}),this.tryParse());break;case"send-kill-sig":this.buffer.length=0,this.oneTimeReaders.forEach((e=>{var{reject:t}=e;return t()})),this.oneTimeReaders.length=0,this.process.status!==bt.Running?this.prompt("$"):ut.handleTopLevelProcessError(new Ye(Pt.SIGKILL,0,this.sessionKey));break;default:throw(0,Ee.Ql)(e)}}spawn(e){var t=arguments,n=this;return(0,Z.Z)((function*(){var r=t.length>1&&void 0!==t[1]?t[1]:{},{meta:i}=e;if(r.leading)n.process.status=bt.Running,n.process.onResume=null;else{var{ppid:s,pgid:o}=i,{positionals:a}=Ot.api.getProcess(i),c=Ot.api.createProcess({ppid:s,pgid:o,sessionKey:i.sessionKey,src:Le.src(e),posPositionals:r.posPositionals||a.slice(1)});i.pid=c.key}try{var l,h=!0,u=!1;try{for(var d,p=(0,Be.Z)(ut.File(e));h=(d=yield p.next()).done,yield d.value,!h;h=!0);}catch(m){u=!0,l=m}finally{try{h||null==p.return||(yield p.return())}finally{if(u)throw l}}e.meta.verbose&&console.warn("".concat(i.sessionKey).concat(i.pgid?" (background)":"",": ").concat(i.pid,": exit ").concat(e.exitCode))}catch(f){throw f instanceof Ye&&console.error("".concat(i.sessionKey).concat(i.pgid?" (background)":"",": ").concat(i.pid,": ").concat(f.code)),f}finally{!r.leading&&Ot.api.removeProcess(i.pid,n.sessionKey)}}))()}tryParse(){var e=this;return(0,Z.Z)((function*(){if(e.input=e.inputs.pop()||null,e.input)try{e.buffer.push(e.input.line);var t=gt.tryParseBuffer(e.buffer.slice());switch(t.key){case"failed":var n="mvdan-sh: ".concat(t.error.replace(/^src\.sh:/,""));console.error(n),e.io.write({key:"error",msg:n}),e.buffer.length=0,e.prompt("$");break;case"complete":e.buffer.length=0;var r=Le.src(t.parsed);r&&e.storeSrcLine(r),e.process.src=r,e.provideContextToParsed(t.parsed),yield e.spawn(t.parsed,{leading:!0}),e.prompt("$");break;case"incomplete":e.prompt(">")}}catch(s){s instanceof Ye?ut.handleTopLevelProcessError(s):console.error("unexpected error propagated to tty.shell",s),e.prompt("$")}finally{var i;null===(i=e.input)||void 0===i||i.resolve(),e.input=null,e.process.status=bt.Suspended}}))()}prompt(e){this.io.write({key:"send-xterm-prompt",prompt:"".concat(e," ")})}loadShellFuncs(e){for(var[t,n]of Object.entries(e))try{var r=gt.parse("".concat(t," () ").concat(n.trim())).Stmts[0].Cmd.Body,i=(0,Ve.nL)(r);Ot.api.addFunc(this.sessionKey,t,i)}catch(s){console.error("Failed to load function: ".concat(t)),console.error(s)}}runProfile(){var e=this;return(0,Z.Z)((function*(){var t=Ot.api.getVar(e.sessionKey,"PROFILE")||"",n=gt.parse(t);e.provideContextToParsed(n),yield e.spawn(n,{leading:!0})}))()}provideContextToParsed(e){Object.assign(e.meta,{sessionKey:this.sessionKey,pid:0,ppid:0,pgid:0,fd:{0:this.key,1:this.key,2:this.key},stack:[],verbose:!1})}getHistoryLine(e){var t=this.history.length-1;return{line:this.history[t-e]||"",nextIndex:e<0?0:e>t?t:e}}getHistory(){return this.history.slice()}storeSrcLine(e){var t=this.history.pop();if(t&&this.history.push(t),t!==e){for(this.history.push(e);this.history.length>this.maxLines;)this.history.shift();Ot.api.persist(this.sessionKey)}}readData(){var e=this;return(0,Z.Z)((function*(){try{return yield new Promise(((t,n)=>{var r;e.oneTimeReaders.push({resolve:e=>t({data:e}),reject:n}),null===(r=e.input)||void 0===r||r.resolve(),e.input=null}))}catch(t){return{eof:!0}}}))()}writeData(e){var t=this;return(0,Z.Z)((function*(){t.io.write(e)}))()}finishedWriting(){}finishedReading(){}}var vt,gt={tryParseBuffer:e=>({key:"failed",error:"not ready"})},yt=[];Promise.all([n.e(763),n.e(474)]).then(n.bind(n,80557)).then((e=>{gt=e.parseService,yt.forEach((e=>e())),yt.length=0})),function(e){e[e.Initial=0]="Initial",e[e.Connected=1]="Connected",e[e.Disconnected=2]="Disconnected"}(vt||(vt={}));var bt;class xt{constructor(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e4;this.key=e,this.size=t,(0,Ce.Z)(this,"buffer",void 0),(0,Ce.Z)(this,"readerStatus",vt.Initial),(0,Ce.Z)(this,"writerStatus",vt.Initial),(0,Ce.Z)(this,"readerResolver",null),(0,Ce.Z)(this,"writerResolver",null),this.buffer=[]}readData(e){var t=this;return(0,Z.Z)((function*(){var n;return t.readerStatus=t.readerStatus||vt.Connected,t.buffer.length?(null===(n=t.writerResolver)||void 0===n||n.call(t),t.writerResolver=null,e&&Bt(t.buffer[0])?1===t.buffer[0].items.length?{data:t.buffer.shift().items[0]}:{data:t.buffer[0].items.shift()}:{data:t.buffer.shift()}):t.writerStatus===vt.Disconnected?{eof:!0}:new Promise((e=>{t.readerResolver=e})).then((()=>({data:void 0})))}))()}writeData(e){var t=this;return(0,Z.Z)((function*(){var n;if(t.writerStatus=vt.Connected,t.readerStatus!==vt.Disconnected)return t.buffer.push(e),null===(n=t.readerResolver)||void 0===n||n.call(t),t.readerResolver=null,t.buffer.length>=t.size?new Promise((e=>{t.writerResolver=e})):void 0;t.buffer.length=0}))()}finishedReading(e){var t;if(e)return this.readerStatus===vt.Disconnected;this.readerStatus=vt.Disconnected,null===(t=this.writerResolver)||void 0===t||t.call(this),this.writerResolver=null}finishedWriting(e){var t;if(e)return this.writerStatus===vt.Disconnected;this.writerStatus=vt.Disconnected,null===(t=this.readerResolver)||void 0===t||t.call(this),this.readerResolver=null}readAll(){var e=[];return this.buffer.forEach((t=>{Bt(t)?t.items.forEach((t=>e.push(t))):e.push(t)})),this.buffer.length=0,e}}class wt{constructor(e,t,n){this.sessionKey=e,this.varPath=t,this.mode=n,(0,Ce.Z)(this,"key",void 0),(0,Ce.Z)(this,"buffer",void 0),this.key="".concat(t,"@").concat(e),this.buffer=null}writeData(e){var t=this;return(0,Z.Z)((function*(){if("array"===t.mode){if(t.buffer||(t.buffer=Ot.api.getVarDeep(t.sessionKey,t.varPath),Array.isArray(t.buffer)||Ot.api.setVarDeep(t.sessionKey,t.varPath,t.buffer=[])),void 0===e)return;Bt(e)?t.buffer.push(...e.items):t.buffer.push(e)}else{if(void 0===e)return;Bt(e)?Ot.api.setVarDeep(t.sessionKey,t.varPath,(0,Ee.Z$)(e.items)):Ot.api.setVarDeep(t.sessionKey,t.varPath,e)}}))()}readData(){return(0,Z.Z)((function*(){return{eof:!0}}))()}finishedReading(){}finishedWriting(){}}class kt{constructor(e){this.key=e}writeData(e){return(0,Z.Z)((function*(){}))()}readData(){return(0,Z.Z)((function*(){return{eof:!0}}))()}finishedReading(){}finishedWriting(){}}function St(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Zt(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?St(Object(n),!0).forEach((function(t){(0,Ce.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):St(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}!function(e){e[e.Suspended=0]="Suspended",e[e.Running=1]="Running",e[e.Killed=2]="Killed"}(bt||(bt={}));var Pt,Ct=(0,Oe.Z)((0,Te.mW)((0,Te.tJ)(((e,t)=>({device:{},session:{},persist:{},rehydrated:!1,api:{addCleanup:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];Et.getProcess(e).cleanups.push(...n)},addFunc:(e,t,n)=>{Et.getSession(e).func[t]={key:t,node:n,src:Le.multilineSrc(n)}},createFifo(e,n){var r=new xt(e,n);return t().device[r.key]=r},createProcess:e=>{var{sessionKey:n,ppid:r,pgid:i,src:s,posPositionals:o}=e,a=t().api.getNextPid(n),c=t().api.getSession(n).process;return c[a]={key:a,ppid:r,pgid:i,sessionKey:n,status:bt.Running,src:s,positionals:["jsh",...o||[]],cleanups:[],onSuspend:null,onResume:null},c[a]},createSession:(n,r)=>{var i=Et.ensurePersisted(n),s=new Tt(new jt,new jt),o=new ft(n,s,i.history);return t().device[o.key]=o,t().device["/dev/null"]=new kt("/dev/null"),e((e=>{var{session:t}=e;return{session:Me({key:n,func:{},nextPid:0,process:{},ttyIo:s,ttyShell:o,var:Zt(Zt({PWD:"",OLDPWD:""},i.var),(0,Ee.I8)(r))},t)}})),t().session[n]},createVarDevice(e,n,r){var i=new wt(e,n,r);return t().device[i.key]=i},ensureSession:(e,n)=>{var{session:r}=t();return r[e]=r[e]||t().api.createSession(e,n)},ensurePersisted:n=>{var r,i,s=null!==(r=null===(i=t().persist)||void 0===i?void 0:i[n])&&void 0!==r?r:{key:n,history:[],var:{}};return e((e=>{var{persist:t}=e;return{persist:Me(s,t)}})),s},getFunc:(e,n)=>t().session[e].func[n]||void 0,getFuncs:e=>Object.values(t().session[e].func),getNextPid:e=>t().session[e].nextPid++,getPositional:(e,n,r)=>t().session[n].process[e].positionals[r]||"",getProcess:e=>{var{pid:n,sessionKey:r}=e;return t().session[r].process[n]},getProcesses:(e,n)=>{var r=Object.values(t().session[e].process);return void 0===n?r:r.filter((e=>e.pgid===n))},getVar:(e,n)=>t().session[e].var[n],getVarDeep:(e,n)=>{var r=t().session[e].var;return Function("__","return __.".concat(n))(r)},getSession:e=>t().session[e],persist:t=>{var{ttyShell:n,var:r}=Et.getSession(t);e((e=>{var{persist:i}=e;return{persist:Ne(t,i,(()=>({history:n.getHistory(),var:(0,Ee.Q8)(r,(e=>{try{return JSON.parse(JSON.stringify(e))}catch(t){}}))})))}}))},removeDevice(e){delete t().device[e]},removeProcess(e,n){delete t().session[n].process[e]},removeSession:n=>{var{process:r,ttyShell:i}=t().session[n];for(var{cleanups:s}of Object.values(r))s.forEach((e=>e())),s.length=0;delete t().device[i.key],e((e=>{var{session:t}=e;return{session:Ae(n,t)}}))},resolve:(e,n)=>t().device[n.fd[e]],setVar:(e,t,n)=>{Et.getSession(e).var[t]=n},setVarDeep:(e,t,n)=>{var r={home:Et.getSession(e).var},i=nt(t,0,Et.getVar(e,"PWD"));if(!("home"===i[0]&&i.length>1))throw new Qe("only the home directory is writable",1);var s=i.pop();try{it(i,r)[s]=n}catch(o){throw new Qe("cannot resolve /".concat(i.join("/")),1)}},warn:(e,t)=>{Et.getSession(e).ttyIo.write({key:"error",msg:t})}}})),{name:"session",version:0,blacklist:["api","device","session"],onRehydrateStorage:e=>()=>{Rt.setState({rehydrated:!0})}}),"session")),Et=Ct.getState().api,Rt=Object.assign(Ct,{api:Et}),Ot=Rt;class Tt{constructor(e,t){this.readable=e,this.writable=t}handleWriters(e){return this.writable.registerCallback(e),()=>this.writable.unregisterCallback(e)}read(e){return this.readable.registerCallback(e),()=>this.readable.unregisterCallback(e)}write(e){this.writable.write(e)}writeToReaders(e){this.readable.write(e)}}class jt{constructor(){(0,Ce.Z)(this,"internal",void 0),(0,Ce.Z)(this,"cbToSub",void 0),this.internal=new Re.x,this.internal.subscribe(),this.cbToSub=new Map}registerCallback(e){this.cbToSub.set(e,this.internal.subscribe(e))}unregisterCallback(e){var t;null===(t=this.cbToSub.get(e))||void 0===t||t.unsubscribe(),this.cbToSub.delete(e)}write(e){this.internal.next(e)}}function _t(e,t){var n=(0,Ee.I8)(e.meta);Object.assign(n.fd,t),(0,Ve.ww)(e,(e=>e.meta=n))}function Dt(e,t){return It.apply(this,arguments)}function It(){return(It=(0,Z.Z)((function*(e,t){if(e.status===bt.Killed||t.finishedReading(!0))throw new Ye(Pt.SIGKILL,e.key,e.sessionKey);e.status===bt.Suspended&&(yield new Promise((t=>e.onResume=t)))}))).apply(this,arguments)}function Mt(e,t){return At.apply(this,arguments)}function At(){return(At=(0,Z.Z)((function*(e,t){if(e.status===bt.Killed)throw new Ye(Pt.SIGKILL,e.key,e.sessionKey);e.status===bt.Suspended&&(yield new Promise((t=>e.onResume=t)))}))).apply(this,arguments)}function Nt(e){switch(e){case bt.Killed:return"\u2620";case bt.Running:return"\u25b6\ufe0f";case bt.Suspended:return"\u23f8\ufe0f"}}!function(e){e.SIGKILL="SIGKILL"}(Pt||(Pt={}));function Bt(e){return void 0!==e&&null!==e&&e.__chunk__}function Vt(e){return{__chunk__:!0,items:e}}var Lt="\x1b[0m",Kt="\x1b[93m",zt="\x1b[1;34m",Wt="\x1b[0;37m";class Ft{constructor(e,t,n){this.xterm=e,this.sessionKey=t,this.io=n,(0,Ce.Z)(this,"commandBuffer",void 0),(0,Ce.Z)(this,"cursor",void 0),(0,Ce.Z)(this,"cursorRow",void 0),(0,Ce.Z)(this,"input",void 0),(0,Ce.Z)(this,"readyForInput",void 0),(0,Ce.Z)(this,"promptReady",void 0),(0,Ce.Z)(this,"nextPrintId",void 0),(0,Ce.Z)(this,"prompt",void 0),(0,Ce.Z)(this,"historyIndex",-1),(0,Ce.Z)(this,"preHistory",void 0),(0,Ce.Z)(this,"linesPerUpdate",500),(0,Ce.Z)(this,"refreshMs",0),(0,Ce.Z)(this,"runCommands",(()=>{var e,t=0;for(this.nextPrintId=null;(e=this.commandBuffer.shift())&&t<=this.linesPerUpdate;)switch(e.key){case"await-prompt":return void this.commandBuffer.unshift(e);case"clear":this.clearScreen();break;case"line":this.xterm.writeln(e.line),this.trackCursorRow(1),t++;break;case"newline":for(var{row:n}=this.offsetToColRow(this.input,this.cursor),{row:r}=this.offsetToColRow(this.input,this.input.length);n++<r;)this.xterm.write("\r\n");return this.xterm.write("\r\n"),this.trackCursorRow(1),void this.sendLine();case"paste-line":return this.xterm.writeln(e.line),this.trackCursorRow(1),this.input=e.line,void this.sendLine();case"resolve":e.resolve();break;case"prompt":this.xterm.write(e.prompt),this.promptReady=!0;break;default:throw(0,Ee.Ql)(e)}this.printPending()})),this.input="",this.cursor=0,this.prompt="",this.readyForInput=!0,this.promptReady=!1,this.commandBuffer=[],this.nextPrintId=null,this.cursorRow=0,this.historyIndex=-1,this.preHistory=this.input}initialise(){this.xterm.onData(this.handleXtermInput.bind(this)),this.io.handleWriters(this.onMessage.bind(this)),this.xterm.writeln("".concat(Wt,"Connected to session ").concat(zt).concat(this.sessionKey).concat(Lt)),this.clearInput(),this.cursorRow=2}actualCursor(e,t){return this.actualLine(e.slice(0,t)).length}actualLine(e){return this.prompt+e}clearInput(){this.setCursor(0);var e=Math.min(this.numLines(),this.xterm.rows+1-this.cursorRow);e>1?(this.xterm.write("\r\x1b[K\x1b[E".repeat(e)),this.xterm.write("\x1b[F".repeat(e))):this.xterm.write("\r\x1b[K"),this.input=""}clearScreen(){for(var e=0;e<this.xterm.rows;e++)this.xterm.writeln("");this.xterm.write("\x1b[F".repeat(this.xterm.rows)),this.xterm.scrollToBottom(),this.cursorRow=1}closestLeftBoundary(e,t){return this.wordBoundaries(e,!0).reverse().find((e=>e<t))||0}closestRightBoundary(e,t){return this.wordBoundaries(e,!1).find((e=>e>t))||e.length}deletePreviousWord(){var e=this.closestLeftBoundary(this.input,this.cursor);if(null!=e){var t=this.input.slice(0,e)+this.input.slice(this.cursor);this.clearInput(),this.setInput(t),this.setCursor(e)}}handleCursorErase(e){var{cursor:t,input:n}=this;if(e){if(t<=0)return;var r=-1;"\n"===this.input.charAt(this.cursor+r)&&(r=-2);var i=n.slice(0,t+r)+n.slice(t);this.clearInput(),this.setInput(i),this.setCursor(t+r)}else{var s=n.slice(0,t)+n.slice(t+1);this.clearInput(),this.setInput(s),this.setCursor(t)}}handleCursorInsert(e){var{input:t,cursor:n}=this,r=t.slice(0,n)+e+t.slice(n),i=this.cursor+e.length;this.clearInput(),this.setInput(r),this.setCursor(i)}handleCursorMove(e){var t=1===e?Math.min(e,this.input.length-this.cursor):Math.max(e,-this.cursor),n=this.input.charAt(this.cursor+t);1===e?"\r"===n?t+=2:"\n"===n&&(t+=1):"\n"===n&&(t-=1),this.setCursor(this.cursor+t)}handleXtermInput(e){var t=this;return(0,Z.Z)((function*(){if(t.readyForInput||"\x03"===e)if(e.length>1&&e.includes("\r")){var n=e.replace(/[\r\n]+/g,"\n"),r=n.split("\n");r[0]="".concat(t.input).concat(r[0]);var i=!n.endsWith("\n")&&r.pop(),s=function*(e){yield new Promise((n=>{t.queueCommands([{key:"paste-line",line:e},{key:"await-prompt"},{key:"resolve",resolve:n}])}))};for(var o of r)yield*s(o);i&&t.queueCommands([{key:"resolve",resolve:()=>{t.clearInput(),t.setInput(i)}}])}else t.handleXtermKeypresses(e)}))()}handleXtermKeypresses(e){var t,n=e.charCodeAt(0);if(27==n)switch(e.slice(1)){case"[A":this.promptReady&&this.io.writeToReaders({key:"req-history-line",historyIndex:this.historyIndex+1});break;case"[B":this.promptReady&&this.io.writeToReaders({key:"req-history-line",historyIndex:this.historyIndex-1});break;case"[D":this.handleCursorMove(-1);break;case"[C":this.handleCursorMove(1);break;case"[3~":this.handleCursorErase(!1);break;case"[F":this.setCursor(this.input.length);break;case"[H":this.setCursor(0);break;case"b":null!=(t=this.closestLeftBoundary(this.input,this.cursor))&&this.setCursor(t);break;case"f":null!=(t=this.closestRightBoundary(this.input,this.cursor))&&this.setCursor(t);break;case"\x7f":this.deletePreviousWord()}else if(n<32||127===n)switch(e){case"\r":this.queueCommands([{key:"newline"}]);break;case"\x7f":this.handleCursorErase(!0);break;case"\t":this.handleCursorInsert("  ");break;case"\x03":this.sendSigKill();break;case"\x17":this.deletePreviousWord();break;case"\x01":this.setCursor(0);break;case"\x05":this.setCursor(this.input.length);break;case"\f":this.clearScreen(),this.setInput(this.input);break;case"\v":var r=this.input.slice(0,this.cursor);this.clearInput(),this.setInput(r);break;case"\x15":var i=this.input.slice(this.cursor);this.clearInput(),this.setInput(i),this.setCursor(0)}else this.handleCursorInsert(e)}inputEndsAtEdge(e){var t=this.actualLine(e),n=this.actualCursor(e,e.length),{col:r}=this.offsetToColRow(t,n);return 0===r}offsetToColRow(e,t){for(var{cols:n}=this.xterm,r=0,i=0,s=0;s<t;++s){("\n"===e.charAt(s)||(i+=1)>=n)&&(i=0,r+=1)}return{row:r,col:i}}onMessage(e){if("string"===typeof e)return this.queueCommands(e.split("\n").map((e=>({key:"line",line:"".concat(Wt).concat(e).concat(Lt)}))));if(null===e)return this.queueCommands([{key:"line",line:"".concat(Kt,"null").concat(Lt)}]);if(void 0!==e)switch(e.key){case"send-xterm-prompt":return void this.setPrompt(e.prompt);case"clear-xterm":return void this.clearScreen();case"tty-received-line":return this.input="",void(this.readyForInput=!0);case"send-history-line":if(e.line){var t=e.line.split(/\r?\n/).join("\r\n");-1===this.historyIndex&&(this.preHistory=this.input),this.clearInput(),this.setInput(t),this.historyIndex=e.nextIndex}else 0===e.nextIndex&&(this.clearInput(),this.setInput(this.input!==this.preHistory?this.preHistory:""),this.historyIndex=-1,this.preHistory="");return;case"error":this.queueCommands([{key:"line",line:"".concat("\x1b[41;37m").concat(e.msg).concat(Lt)}]);break;default:Bt(e)?e.items.slice(-400).forEach((e=>this.onMessage(e))):this.queueCommands([{key:"line",line:"".concat(Kt).concat((0,Ee.or)(e)).concat(Lt)}])}}numLines(){return 1+this.offsetToColRow(this.input,this.input.length+2).row}queueCommands(e){for(var t of e)this.commandBuffer.push(t);this.printPending()}printPending(){this.commandBuffer.length&&!this.nextPrintId&&(this.nextPrintId=window.setTimeout(this.runCommands,this.refreshMs))}sendLine(){this.prompt="",this.readyForInput=this.promptReady=!1,this.historyIndex=-1,this.preHistory="",this.io.writeToReaders({key:"send-line",line:this.input})}sendSigKill(){this.input="",this.setCursor(0),this.xterm.write("^C\r\n"),this.trackCursorRow(1),this.cursor=0,this.commandBuffer.length=0,this.io.writeToReaders({key:"send-kill-sig"})}setCursor(e){e<0?e=0:e>this.input.length&&(e=this.input.length);var t=this.actualLine(this.input),n=this.actualCursor(this.input,this.cursor),{col:r,row:i}=this.offsetToColRow(t,n),s=this.actualCursor(this.input,e),{col:o,row:a}=this.offsetToColRow(t,s);if(a>i)for(var c=i;c<a;++c)this.xterm.write("\x1b[B");else for(var l=a;l<i;++l)this.xterm.write("\x1b[A");if(this.trackCursorRow(a-i),o>r)for(var h=r;h<o;++h)this.xterm.write("\x1b[C");else for(var u=o;u<r;++u)this.xterm.write("\x1b[D");this.cursor=e}setInput(e){this.setCursor(0);var t=this.actualLine(e);this.xterm.write(t),t&&this.inputEndsAtEdge(e)&&(this.xterm.write("\r\n"),this.trackCursorRow(1)),this.input=e,this.cursor=e.length}setPrompt(e){this.prompt=e;var[t]=this.commandBuffer;t&&"await-prompt"===t.key&&this.commandBuffer.shift(),this.queueCommands([{key:"prompt",prompt:e}])}trackCursorRow(e){this.cursorRow+=e,this.cursorRow<1?this.cursorRow=1:this.cursorRow>this.xterm.rows&&(this.cursorRow=this.xterm.rows)}wordBoundaries(e){for(var t,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=[],i=/\w+/g;t=i.exec(e);)r.push(n?t.index:t.index+t[0].length);return r}}function Gt(){var e=(0,o.Z)(["\n  grid-area: terminal;\n  background: black;\n  height: 100%;\n"]);return Gt=function(){return e},e}function Jt(e){var{sessionKey:t,env:n}=e,i=Ot((e=>{var{session:n}=e;return t in n?n[t]:null}));(0,a.useEffect)((()=>(Ot.api.createSession(t,n),()=>Ot.api.removeSession(t))),[t]);var s=(0,a.useCallback)((()=>Ot.api.persist(t)),[]);return(0,Pe.x)(s),(0,r.tZ)(Xt,{children:i?(0,r.tZ)(de,{onMount:e=>{var t=new Ft(e,i.key,i.ttyIo);t.initialise(),setTimeout((()=>i.ttyShell.initialise(t)))},options:Ht}):null})}var Xt=(0,c.zo)("section")(Gt()),Ht={allowProposedApi:!0,fontSize:16,cursorBlink:!0,rendererType:"canvas",theme:{background:"black",foreground:"#41FF00"},convertEol:!1,scrollback:250,rows:50};function Ut(){return(0,r.tZ)("main",{children:(0,r.BX)("section",{children:[(0,r.tZ)(i.Z,{}),(0,r.tZ)(s.Z,{children:'\n## Objective <float rem="1.2">19th July 2021</float>\n\nWe are going to build a video game step-by-step on this website.\nIt will be a realtime [roguelike](https://en.wikipedia.org/wiki/Roguelike), set in space. We\'ll assume the role of Captain of the starship _Gehennom_.\n\nAs an important side-effect, a popular approach to frontend development will be presented. The underlying technology is the Markup language HTML, brought to life via CSS, SVG and JavaScript.\n        '}),(0,r.tZ)("br",{}),(0,r.tZ)(s.Z,{children:"\n## Constraints <float rem=\"1.2\">19th July 2021</float>\n\nI've necessarily made a large number of decisions. Here are the important ones, from low-level to high-level.\n\n### Technology\n\n- We'll make a browser-based game for mobile & desktop devices.\n- Use CSS/SVG/PNGs instead of HTMLCanvas/WebGL.\n- Use [WebAssembly](https://developer.mozilla.org/en-US/docs/WebAssembly) for simulating physics.\n- Use React [function components](https://reactjs.org/docs/components-and-props.html#function-and-class-components) and CSS-in-JS.\n- Use [Preact](https://www.npmjs.com/package/preact) instead of React, and [Goober](https://www.npmjs.com/package/goober) instead of [Emotion](https://www.npmjs.com/package/@emotion/styled).\n- For performance, favour DOM manipulation over React renders.\n- Use [NextJS](https://nextjs.org/) as our development environment.\n- Use [CodeSandbox](https://codesandbox.io) to share editable code.\n\n### Game mechanics\n\n- Use a realtime birdseye camera, like [Teleglitch](https://en.wikipedia.org/wiki/Teleglitch). \n- Use [Recast](https://github.com/recastnavigation/recastnavigation) to generate navmeshes.\n- Use [a recent port](https://www.npmjs.com/package/box2d-wasm) of the physics engine [Box2D](https://github.com/erincatto/box2d).\n- Use procedural generation e.g. spaceship building/docking.\n- Use explicitly illustrated NPC decisions as a game mechanic.\n\n### Setting\n  \n- The title of the game is _Rogue Markup_.\n- The player is the Captain of the starship _Gehennom_.\n- The player works for _Unified Transport_, providing cargo/personnel transport and hauling services.\n- The graphical style is based on [Starship Geomorphs 2.0](http://travellerrpgblog.blogspot.com/2018/10/the-starship-geomorphs-book-if-finally.html).\n\nOver time we'll clarify the above,\nbut first we emphasise:\n> _finishing a game is really fucking hard_.\n\nSpelunky's creator suggested [three important requirements](https://makegames.tumblr.com/post/1136623767/finishing-a-game). We'll now address them.\n\n### 1. Fun to develop\n\n_Games I want to make_. Rogue Markup will be fun to develop because I enjoy experimenting with NPC behaviour.\nOne of our underlying motivations is the lack of Game AI resources available on the web.\nIt is hard to discuss Game AI without actually building a game, so I chose a setting and game mechanics which felt fun for me.\n\n\x3c!--\nComplexity will arise from the environment and agent interaction, rather than complex individual thinking or scripted behaviour.\nSimple interacting robots fits the space travel theme nicely.\nThey're also analogous to UI components: parallel systems with some intercommunication.\n--\x3e\n\n### 2. The Result\n\n_Games I want to have made_. As an end result I want a highly replayable space travel game.\nThe underlying missions amount to going from A to B (ever was it so).\nMonotony will be overcome via mission specifics, encountered NPC behaviours, procedural generation, and ship building.\nFunctionally, think [Teleglitch](https://en.wikipedia.org/wiki/Teleglitch) where you can _place_ [room modules](https://steamcommunity.com/sharedfiles/filedetails/?id=175359117) when upgrading or docking.\nGraphically, see [Starship Geomorphs 2.0](http://travellerrpgblog.blogspot.com/2018/10/the-starship-geomorphs-book-if-finally.html).\n\nImportantly, it should be easy for other people to extend this game.\nWe'll achieve this by providing source code, escape hatches to CodeSandbox, and clear explanations.\nComments will be shown so that [GitHub](https://github.com/) users can share ideas and links.\n\n\x3c!--\n[NetHack](https://en.wikipedia.org/wiki/NetHack)'s \u2265 34 year history shows _we needn't spell out a story_.\n--\x3e\n\x3c!--\nWe'll add cameras, guards, doors, keys, weapons etc.\nAll NPC decisions will be depicted graphically, such as future navpaths with probabilistic branches.\n--\x3e\n\n### 3. Experience\n\n_Games I\u2019m good at making_. I work as a web developer, using React & Emotion on a daily basis. \nI have a [strong background](https://dblp.org/pid/81/8748.html) in Theoretical Computer Science,\nso won't confuse Game AI with AI, nor fall prey to the Deep Learning hype.\nI have also created similar game mechanics _many_ times over the years.\nHere's hoping my chain of unfinished projects is coming to a close!\n        "}),(0,r.tZ)("br",{}),(0,r.tZ)(s.Z,{children:"\n## Technology  <float rem=\"1.2\">19th July 2021</float>\n\nWe're going to build the game using the following technologies.\n\n| Concept | Browser Technology |\n| - | - |\n| Component | React [function components](https://reactjs.org/docs/components-and-props.html#function-and-class-components). |\n| Styles | CSS-in-JS via [Goober](https://www.npmjs.com/package/goober). |\n| Component framework | [Preact](https://preactjs.com/), a DOM-diffing alternative to React. |\n| Pathfinding | Offline navmeshes, and a port of [three-pathfinding](https://www.npmjs.com/package/three-pathfinding).  |\n| Physics engine | [WebAssembly port](https://www.npmjs.com/package/box2d-wasm) of [Box2D](https://github.com/erincatto/box2d). |\n| Static analysis | TypeScript via [JSDoc](https://www.typescriptlang.org/docs/handbook/jsdoc-supported-types.html), and also [ESLint](https://www.npmjs.com/package/eslint). |\n| Live analysis | Our own in-browser terminal. |\n| Code viewing | [CodeMirror](https://codemirror.net/) to view JS. [FlexLayout](https://github.com/caplin/FlexLayout) provides draggable tabs. |\n| Code editing | External [CodeSandbox](https://codesandbox.io/) links, using React. |\n| Code sharing | [GitHub](https://github.com/) comments shown on site; GitHub [repo](https://github.com/rob-myers/rob-myers.github.io) for this site. |\n\n\x3c!-- Our in-browser terminal is built using [Xterm.js](https://xtermjs.org/) and the shell parser [mvdan-sh](https://github.com/mvdan/sh/tree/master/_js). --\x3e\n\x3c!-- Typically we'll present a \"project\" as a number of tabs, consisting of source code _foo/bar.jsx_, and another tab i.e. the rendered output. --\x3e\n\nWe want to create a video game explicitly, exposing the code and underlying thought process.\nThen it is worth explaining these technologies before using them.\n\n### React and Preact\n\nCompeting web frameworks exist in the wild, often with their own notion of component.\nOne popular approach uses _React function components_, which are just JavaScript functions with constraints on their parameters and return values.\n\n- They have a single parameter, conventionally called _props_.\n  \n  It is a JavaScript object defining the component's named inputs,\n  and possibly special properties like _children_, _key_ and _ref_.\n\n- They must return either null or a virtual [DOM node](https://developer.mozilla.org/en-US/docs/Web/API/Node).\n  \n  This returned value amounts to an HTML fragment to be rendered,\n  and may depend on the component's props and internal state (via [hooks](https://reactjs.org/docs/hooks-intro.html)).\n\nReact developers use a grammatical extension of JavaScript called JSX.\nIt permits composing components using an XML-like syntax, to obtain the desired dynamic DOM tree.\nLet's consider an example, a pannable and zoomable grid.\n        "}),(0,r.tZ)(ke,{height:400,tabs:[{key:"component",filepath:"panzoom/PanZoomDemo.jsx"}]}),(0,r.tZ)(s.Z,{children:"\n\nThe file _panzoom/PanZoom.jsx_ (shown below) defines two React function components, namely _PanZoom_ and _Grid_.\nBehaviourally:\n- _PanZoom_ renders an SVG consisting of its children (the red square in the demo) and _Grid_. It adjusts the [SVG viewBox](https://developer.mozilla.org/en-US/docs/Web/SVG/Attribute/viewBox) in response to mouse/pointer events.\n- _Grid_ renders part of an SVG i.e. a grid obtained by repeating a 10x10 unit pattern.\n\n        "}),(0,r.tZ)(ke,{height:400,tabs:[{key:"code",filepath:"panzoom/PanZoom.jsx",folds:[{line:8,ch:0}]},{key:"code",filepath:"panzoom/PanZoomDemo.jsx"}]}),(0,r.tZ)(s.Z,{children:'\n\nThey are JS functions with a single parameter, returning something which looks like HTML (but isn\'t).\n_PanZoom_ defines a pannable and zoomable grid, and _PanZoomDemo_ renders _PanZoom_.\nYou can also view it [on CodeSandbox](https://codesandbox.io/s/rogue-markup-panzoom-yq060?file=/src/panzoom/PanZoom.jsx "@new-tab"), which permits code editing.\n\nNotice _PanZoomDemo_ renders _PanZoom_ by using the XML tag _\\<PanZoom\\>_.\nThen although React function components are functions, syntactically they are not invoked like functions.\nWe now list some important general info.\n\n- React developers use a grammatical extension of JS called [JSX](https://en.wikipedia.org/wiki/JSX_(JavaScript)), combining JavaScript and XML syntax.\n- Dev tools convert JSX into JS, by replacing XML tags with invocations of the function _React.createElement_.\n        '}),(0,r.tZ)(ke,{height:320,tabs:[{key:"code",filepath:"example/jsx-to-js.jsx"}]}),(0,r.tZ)(s.Z,{children:"\n\n- This website uses [Preact](https://www.npmjs.com/package/@preact/compat), an alternative to React with the same API.\n  Then _React.createElement_ corresponds to [this function](https://github.com/preactjs/preact/blob/master/src/create-element.js),\n  and constructs Preact virtual DOM nodes.\n- The root component is conventionally called _App_.\n  Running a React application amounts to [invoking _ReactDOM.render_](https://codesandbox.io/s/rogue-markup-panzoom-yq060?file=/src/index.js \"@new-tab\")\n  with two arguments i.e. _\\<App/\\>_ and an extant DOM node _el_.\n  \n- [_ReactDOM.render_](https://github.com/preactjs/preact/blob/master/src/render.js) initially converts _\\<App/\\>_ into a DOM node mounted at _el_.\n  A subcomponent may subsequently re-render, recursively recreating a virtual DOM node.\n  It is then [diffed](https://github.com/preactjs/preact/blob/master/src/diff/index.js), and only the difference is applied to the DOM.\n\n- If _\\<App/\\>_ defines a website, it is often rendered server-side.\n  [_ReactDOM.renderToString_](https://github.com/preactjs/preact-render-to-string/blob/master/src/index.js) creates HTML the client can render immediately.\n  The client invokes [_ReactDOM.hydrate_](https://github.com/preactjs/preact/blob/master/src/render.js) instead of _ReactDOM.render_, but with the same two arguments.\n\n\x3c!--\nRecall the three pillars: HTML, CSS and JavaScript (JS), born in the early 1990s.\nTechnically, only HTML is needed to create a website, because CSS can be included via _\\<style\\>_ tags and JS via _\\<script\\>_ tags.\nBut of the three pillars, JS is the only programming language, the only way to dynamically change HTML and CSS.\nFor reasons of uniformity, it is increasingly common for the initial HTML and CSS to be generated by JS too.\n--\x3e\n\nSo, React function components are JavaScript functions.\nThey are written using syntactic-sugar (JSX), and are composed together in the same way as HTML.\nWe use Preact: its codebase is smaller, and it has reputation for being faster\n(although React has a _much_ wider scope via [custom renderers](https://github.com/chentsulin/awesome-react-renderer)).\nRendering a component involves (re)constructing virtual DOM nodes and diffing them.\nSince the initial payload of a website is HTML, the initial render is often precomputed.\n\n\x3c!--\nThere's more to say e.g. how React function components represent internal state,\nbut we've said more than enough for now.\n--\x3e\n\n### React Rendering\n\n__TODO__ _we'll control the rendering i.e. React should only render initially or during fast refresh. We'll manipulate the DOM directly e.g. via Web Components spec. By keeping the initial virtual DOM mostly constant, the DOM diffing won't interfere._\n\n### CSS inside JS\n\nTraditionally, CSS is provided in separate files,\nlinked in the _\\<head\\>_ and referenced by DOM elements via their class attribute.\nBoth _PanZoom_ and _PanZoomDemo_ above are styled using CSS-in-JS.\nThis means the CSS is written inside JS or JSX files, often together with the React component it applies to.\nThe npm module [Goober](https://www.npmjs.com/package/goober) handles this for us.\n        "}),(0,r.tZ)("br",{}),(0,r.tZ)(s.Z,{children:"\n## Technology (Part 2)\n\n### Navigation\n\nPathfinding is central to Game AI.\nOur NPCs need to move realistically e.g. they cannot move through walls, windows or locked doors.\n\n        "}),(0,r.tZ)(ke,{height:300,tabs:[{key:"component",filepath:"pathfinding/NavDemo.jsx"}]}),(0,r.tZ)(s.Z,{children:"\n\n### Physics engine\n\nWe need a Physics engine:\n- Raycasting\n- Triggers\n- Collision detection\n        "}),(0,r.tZ)(ke,{height:300,tabs:[{key:"component",filepath:"physics/PhysicsDemo.jsx"}]}),(0,r.tZ)(s.Z,{children:"\n### Static and Runtime Analysis\n\n- Typescript via JSDoc, refering to CodeSandbox.\n- Terminal + Preact hooks\n- Terminal + Game AI\n\n### Comments\n\n- Display GitHub comments from Issue (build-time)\n- Can use anonymous credits to get recent\n        "}),(0,r.tZ)("br",{}),(0,r.tZ)(s.Z,{children:'\n## Starship Geomorphs <float rem="1.2">19th July 2021</float>\n\n### Filesystem structure\n\nmedia\n- Starship Geomorphs 2.0.pdf (Original source)\n- Starship Symbols.pdf (Original source)\n- Geomorphs.zip (Transparent PNGs obtained from Starship Geomorphs 2.0)\n- SymbolsHighRes.zip (Transparent PNGs obtained from Starship Symbols)\n\nmedia/Geomorph\n- PNGs of lower quality (relatively).\n- Extracted from "Starship Geomorphs 2.0.pdf" by ... \n\nmedia/Symbols\n- PNGs of higher quality.\n- Extracted from "Starship Symbols.pdf" by ... \n\nmedia/scripts\n- ts-node scripts launched via npm scripts\n- Directories generated by scripts\n  - media/geomorph-edge (Edge Geomorphs)\n  - media/symbol-bridge\n  - media/symbol-dock-small-craft\n  - media/symbol-staterooms\n  - media/symbol-lounge\n  - media/symbol-root\n\npublic/png\n- PNGs from media/symbol-* with labels removed\n\npublic/svg\n- Enriched symbols\n- Geomorph hulls\n        '}),(0,r.tZ)(ke,{height:400,tabs:[{key:"component",filepath:"geomorph/GeomorphTest.jsx"}]}),(0,r.tZ)(s.Z,{children:'\n## Movement <float rem="1.2">19th July 2021</float>\n\n- Navigation\n- Follow camera\n- Map view\n        '}),(0,r.tZ)("br",{}),(0,r.tZ)("section",{style:{height:200},children:(0,r.tZ)(Jt,{sessionKey:"test",env:qt.test})}),(0,r.tZ)("br",{}),(0,r.tZ)(s.Z,{children:'\nThis is an example of a [command link](#command "@test echo foo").\n        '})]})})}var qt={test:{}}},35838:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/draft",function(){return n(74347)}])}},function(e){e.O(0,[774,488,203,888,179],(function(){return t=35838,e(e.s=t);var t}));var t=e.O();_N_E=t}]);