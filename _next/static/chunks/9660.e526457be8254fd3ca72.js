"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9660],{82405:function(e,n,t){t.d(n,{b:function(){return f}});var r=t(97131),o=t(68216),i=t(25997),u=t(92809),c=t(34061),a=t.n(c),s=t(84175);function l(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function d(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?l(Object(t),!0).forEach((function(n){(0,u.Z)(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}var f=function(){function e(){(0,o.Z)(this,e),(0,u.Z)(this,"nodes",void 0),(0,u.Z)(this,"succ",void 0),(0,u.Z)(this,"pred",void 0),(0,u.Z)(this,"nodesArray",void 0),(0,u.Z)(this,"edgesArray",void 0),(0,u.Z)(this,"idToNode",void 0),(0,u.Z)(this,"idToEdge",void 0),this.nodes=new Set,this.succ=new Map,this.pred=new Map,this.nodesArray=[],this.edgesArray=[],this.idToNode=new Map,this.idToEdge=new Map}return(0,i.Z)(e,[{key:"getReachableNodes",value:function(e){for(var n=this,t=new Set([e]),r=0,o=[e];t.size>r;)r=t.size,(o=(0,s.xH)(o.map((function(e){return n.getSuccs(e)})))).forEach((function(e){return t.add(e)}));return Array.from(t.values())}},{key:"getReachableUpto",value:function(e,n){for(var t=this,r=new Set([e]),o=0,i=[e];r.size>o;)o=r.size,(i=(0,s.xH)(i.map((function(e){return n(e)?[]:t.getSuccs(e)})))).forEach((function(e){return r.add(e)}));return Array.from(r.values())}},{key:"reset",value:function(){this.nodes.clear(),this.succ.clear(),this.pred.clear(),this.nodesArray=[],this.edgesArray=[],this.idToNode.clear(),this.idToEdge.clear()}},{key:"removeNode",value:function(e){var n=this;return!!this.nodes.has(e)&&(this.nodes.delete(e),(0,s.Dm)(this.nodesArray,e),this.idToNode.delete(e.id),this.getPreds(e).forEach((function(t){return n.removeEdge(n.getEdge(t,e))})),this.getSuccs(e).forEach((function(t){return n.removeEdge(n.getEdge(e,t))})),this.succ.delete(e),this.pred.delete(e),!0)}},{key:"connect",value:function(e){var n=this.getNodeById(e.src),t=this.getNodeById(e.dst);if(n&&t){var r=this.getEdge(n,t);return r?{edge:r,isNew:!1}:(this.registerEdge(e),{edge:r,isNew:!0})}return console.error("Can't connect nodes:",n,t,"given",e,"in",this),{isNew:!1,edge:null}}},{key:"disconnect",value:function(e,n){var t=this.getEdge(e,n);return t?(this.removeEdge(t),!0):(console.error("Failed to disconnect",e,n,"in",this),!1)}},{key:"removeNodeById",value:function(e){var n=this.idToNode.get(e);return!!n&&this.removeNode(n)}},{key:"disconnectById",value:function(e){var n=this.idToEdge.get(e);return n?this.disconnect(n.src,n.dst):(console.error("Cannot remove non-existent edge '".concat(e,"'.")),!1)}},{key:"disconnectByIds",value:function(e,n){var t=this.idToNode.get(e),r=this.idToNode.get(n);return t&&r?this.disconnect(t,r):(console.error("Cannot remove edge ('".concat(e,"' -> '").concat(n,"') from"),t,"to",r),!1)}},{key:"hasNode",value:function(e){return this.nodes.has(e)}},{key:"isConnected",value:function(e,n){var t=this.succ.get(e);return t&&t.has(n)||!1}},{key:"getNodeByid",value:function(e){return this.idToNode.get(e)||null}},{key:"removeEdge",value:function(e){if(e){var n=this.succ.get(e.src);n&&n.delete(e.dst);var t=this.pred.get(e.dst);t&&t.delete(e.src),this.idToEdge.delete(e.id),(0,s.Dm)(this.edgesArray,e)}}},{key:"getParent",value:function(e){var n=this.getPreds(e);return 1===n.length?n[0]:null}},{key:"getSuccs",value:function(e){var n=this.succ.get(e);return n&&Array.from(n.keys())||[]}},{key:"getPreds",value:function(e){var n=this.pred.get(e);return n&&Array.from(n.keys())||[]}},{key:"getEdgesFrom",value:function(e){var n=this.succ.get(e);return n&&Array.from(n.values())||[]}},{key:"getEdgesTo",value:function(e){var n=this.pred.get(e);return n&&Array.from(n.values())||[]}},{key:"nodeHasSucc",value:function(e){var n=this.succ.get(e);return n&&n.size>0||!1}},{key:"nodeHasPred",value:function(e){var n=this.pred.get(e);return n&&n.size>0||!1}},{key:"getNodeById",value:function(e){return this.idToNode.get(e)||null}},{key:"getEdgeById",value:function(e){return this.idToEdge.get(e)||null}},{key:"getEdge",value:function(e,n){var t=this.succ.get(e);return t&&t.get(n)||null}},{key:"registerNode",value:function(e){this.nodes.add(e),this.nodesArray.push(e),this.succ.set(e,new Map),this.pred.set(e,new Map),this.idToNode.set(e.id,e)}},{key:"registerNodes",value:function(e){var n,t=this;e.forEach((function(e){t.nodes.add(e),t.succ.set(e,new Map),t.pred.set(e,new Map),t.idToNode.set(e.id,e)})),(n=this.nodesArray).push.apply(n,(0,r.Z)(e))}},{key:"registerEdge",value:function(e){var n=[this.getNodeById(e.src),this.getNodeById(e.dst)],t=n[0],r=n[1];if(t&&r){var o=d(d({},e),{},{src:t,dst:r,id:"".concat(e.src,"->").concat(e.dst)}),i=this.succ.get(t),u=this.pred.get(r);i.set(r,o),u.set(t,o),this.idToEdge.set(o.id,o),this.edgesArray.push(o)}else console.warn(a().red("error adding edge"),a().yellow(JSON.stringify(e)))}},{key:"plainJson",value:function(){return{nodes:this.nodesArray.map(s.I8),edges:this.edgesArray.map((function(e){return(0,s.I8)(d(d({},e),{},{id:e.id,src:e.src.id,dst:e.dst.id}))}))}}},{key:"plainFrom",value:function(e){var n=this,t=e.nodes.map(s.I8);return this.registerNodes(t),e.edges.forEach((function(e){return n.registerEdge(e)})),this}}]),e}()},81033:function(e,n,t){t.d(n,{c:function(){return i}});var r=t(68216),o=t(25997),i=function(){function e(){(0,r.Z)(this,e)}return(0,o.Z)(e,null,[{key:"roundNumber",value:function(e,n){var t=Math.pow(10,n);return Math.round(e*t)/t}},{key:"sample",value:function(e){return e[Math.floor(Math.random()*e.length)]}},{key:"distanceToSquared",value:function(e,n){var t=e.x-n.x,r=e.y-n.y;return t*t+r*r}},{key:"isPointInPoly",value:function(e,n){for(var t=!1,r=-1,o=e.length,i=o-1;++r<o;i=r)(e[r].y<=n.y&&n.y<e[i].y||e[i].y<=n.y&&n.y<e[r].y)&&n.x<(e[i].x-e[r].x)*(n.y-e[r].y)/(e[i].y-e[r].y)+e[r].x&&(t=!t);return t}},{key:"isVectorInPolygon",value:function(e,n,t){var r=1/0,o=-1/0,i=[];return n.vertexIds.forEach((function(e){r=Math.min(t[e].y,r),o=Math.max(t[e].y,o),i.push(t[e])})),!!(e.y<o+.5&&e.y>r-.5&&this.isPointInPoly(i,e))}},{key:"triarea2",value:function(e,n,t){var r=n.x-e.x,o=n.y-e.y;return-((t.x-e.x)*o-r*(t.y-e.y))}},{key:"vequal",value:function(e,n){return this.distanceToSquared(e,n)<1e-5}}]),e}()},7951:function(e,n,t){t(77503),t(50269),t(48103)},39660:function(e,n,t){t.d(n,{AR:function(){return B},te:function(){return j},Mo:function(){return D},OQ:function(){return _},Vn:function(){return T}});var r=t(97131),o=t(92809),i=t(79056),u=t(30266),c=t(809),a=t.n(c),s=(t(77503),t(292)),l=t(48103),d=(t(7951),t(68451)),f=t(91441),h=t(68216),p=t(25997),g=t(91077),y=t(30268),v=t(92953),m=t(82405),w=t(2026);function b(e){var n=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var t,r=(0,v.Z)(e);if(n){var o=(0,v.Z)(this).constructor;t=Reflect.construct(r,arguments,o)}else t=r.apply(this,arguments);return(0,y.Z)(this,t)}}var k=function(e){(0,g.Z)(t,e);var n=b(t);function t(){return(0,h.Z)(this,t),n.apply(this,arguments)}return(0,p.Z)(t,[{key:"getAdjacentDoors",value:function(){for(var e=this,n=new Set,t=arguments.length,r=new Array(t),o=0;o<t;o++)r[o]=arguments[o];return r.forEach((function(t){return e.getSuccs(t).forEach((function(e){return"door"===e.type&&n.add(e)}))})),Array.from(n)}},{key:"getAdjacentHullDoorIds",value:function(e){for(var n=arguments.length,t=new Array(n>1?n-1:0),r=1;r<n;r++)t[r-1]=arguments[r];return this.getAdjacentDoors.apply(this,t).map((function(n){return[n,e.doors[n.doorId]]})).flatMap((function(n){var t=(0,i.Z)(n,2),r=t[0].doorId,o=t[1];return o.roomIds.some((function(e){return null===e}))?{doorIndex:r,hullDoorIndex:e.hullDoors.indexOf(o)}:[]}))}},{key:"getAdjacentWindows",value:function(){for(var e=this,n=new Set,t=arguments.length,r=new Array(t),o=0;o<t;o++)r[o]=arguments[o];return r.forEach((function(t){return e.getSuccs(t).forEach((function(e){return"window"===e.type&&n.add(e)}))})),Array.from(n)}},{key:"getAdjacentRooms",value:function(){for(var e=this,n=new Set,t=arguments.length,r=new Array(t),o=0;o<t;o++)r[o]=arguments[o];return r.forEach((function(t){return e.getSuccs(t).forEach((function(e){return"room"===e.type&&n.add(e)}))})),Array.from(n)}},{key:"getDoorNode",value:function(e){return this.getNodeById("door-".concat(e))}},{key:"getWindowNode",value:function(e){return this.getNodeById("window-".concat(e))}},{key:"getRoomNode",value:function(e){return this.getNodeById("room-".concat(e))}},{key:"getEnterableRooms",value:function(e,n){var t=this;return this.getAdjacentDoors(e).filter((function(e){return n.includes(e.doorId)})).flatMap((function(e){return t.getAdjacentRooms(e).map((function(n){return{doorId:e.doorId,roomId:n.roomId}}))})).filter((function(n){return n.roomId!==e.roomId}))}}],[{key:"from",value:function(e){return(new t).plainFrom(e)}},{key:"json",value:function(e,n,t){var o=n.map((function(n){return e.flatMap((function(e,t){return 1===l.LA.union([e,n.poly]).length?t:[]}))})),i=t.map((function(n){return e.flatMap((function(e,t){return 1===l.LA.union([e,n.poly]).length?t:[]}))}));return{nodes:[].concat((0,r.Z)(e.map((function(e,n){return{id:"room-".concat(n),type:"room",roomId:n}}))),(0,r.Z)(n.map((function(e,n){return{id:"door-".concat(n),type:"door",doorId:n}}))),(0,r.Z)(t.map((function(e,n){return{id:"window-".concat(n),type:"window",windowIndex:n}})))),edges:[].concat((0,r.Z)(n.flatMap((function(e,n){var t=o[n];return[1,2].includes(t.length)?t.flatMap((function(e){return[{src:"room-".concat(e),dst:"door-".concat(n)},{dst:"room-".concat(e),src:"door-".concat(n)}]})):((0,w.vU)("door ".concat(n,": unexpected adjacent rooms: ").concat(t)),[])}))),(0,r.Z)(t.flatMap((function(e,n){var t=i[n];return[1,2].includes(t.length)?t.flatMap((function(e){return[{src:"room-".concat(e),dst:"window-".concat(n)},{dst:"room-".concat(e),src:"window-".concat(n)}]})):((0,w.vU)("window ".concat(n,": unexpected adjacent rooms: ").concat(t)),[])}))))}}}]),t}(m.b),x=t(81033),A=t(49345),I=function(){function e(){(0,h.Z)(this,e)}return(0,p.Z)(e,null,[{key:"buildZone",value:function(e){var n=this,t=this._buildNavigationMesh(e);t.vertices.forEach((function(e){e.x=x.c.roundNumber(e.x,2),e.y=x.c.roundNumber(e.y,2)}));var r={};r.vertices=t.vertices;var o=this._buildPolygonGroups(t);return r.groups=new Array(o.length),o.forEach((function(e,t){var o=new Map;e.forEach((function(e,n){return o.set(e,n)}));var i=new Array(e.length);e.forEach((function(e,t){var u=[];e.neighbours.forEach((function(e){return u.push(o.get(e))}));var c=[];e.neighbours.forEach((function(t){return c.push(n._getSharedVerticesInOrder(e,t))}));var a=new A.d(0,0);a.add(r.vertices[e.vertexIds[0]]),a.add(r.vertices[e.vertexIds[1]]),a.add(r.vertices[e.vertexIds[2]]),a.scale(1/3),a.x=x.c.roundNumber(a.x,2),a.y=x.c.roundNumber(a.y,2),i[t]={id:t,centroid:a,neighbours:u,portals:c,vertexIds:e.vertexIds}})),r.groups[t]=i})),r}},{key:"_buildNavigationMesh",value:function(e){return this._buildPolygonsFromTriang(e)}},{key:"_spreadGroupId",value:function(e){for(var n=new Set([e]);n.size>0;){var t=n;n=new Set,t.forEach((function(t){t.group=e.group,t.neighbours.forEach((function(e){void 0===e.group&&n.add(e)}))}))}}},{key:"_buildPolygonGroups",value:function(e){var n=this,t=e.polygons,r=[];return t.forEach((function(e){void 0!==e.group?r[e.group].push(e):(e.group=r.length,n._spreadGroupId(e),r.push([e]))})),r}},{key:"_buildPolygonNeighbours",value:function(e,n){var t=new Set,r=n[e.vertexIds[0]],o=n[e.vertexIds[1]],i=n[e.vertexIds[2]];return r.forEach((function(n){n!==e&&(o.includes(n)||i.includes(n))&&t.add(n)})),o.forEach((function(n){n!==e&&i.includes(n)&&t.add(n)})),t}},{key:"_buildPolygonsFromTriang",value:function(e){for(var n=this,t=[],r=[],o={},u=0;u<e.vs.length;u++)r.push(A.d.from(e.vs[u])),o[u]=[];for(var c=0;c<e.tris.length;c++){var a=(0,i.Z)(e.tris[c],3),s=a[0],l=a[1],d=a[2],f={vertexIds:[s,l,d]};t.push(f),o[s].push(f),o[l].push(f),o[d].push(f)}return t.forEach((function(e){e.neighbours=n._buildPolygonNeighbours(e,o)})),{polygons:t,vertices:r}}},{key:"_getSharedVerticesInOrder",value:function(e,n){var t=e.vertexIds,r=t[0],o=t[1],i=t[2],u=n.vertexIds,c=u.includes(r),a=u.includes(o),s=u.includes(i);return c&&a&&s?Array.from(t):c&&a?[r,o]:a&&s?[o,i]:c&&s?[i,r]:(console.warn("Error processing navigation mesh neighbors; neighbors with <2 shared vertices found."),[])}}]),e}(),E=t(13702);function O(e,n){var t="undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!t){if(Array.isArray(e)||(t=function(e,n){if(!e)return;if("string"===typeof e)return Z(e,n);var t=Object.prototype.toString.call(e).slice(8,-1);"Object"===t&&e.constructor&&(t=e.constructor.name);if("Map"===t||"Set"===t)return Array.from(e);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return Z(e,n)}(e))||n&&e&&"number"===typeof e.length){t&&(e=t);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,u=!0,c=!1;return{s:function(){t=t.call(e)},n:function(){var e=t.next();return u=e.done,e},e:function(e){c=!0,i=e},f:function(){try{u||null==t.return||t.return()}finally{if(c)throw i}}}}function Z(e,n){(null==n||n>e.length)&&(n=e.length);for(var t=0,r=new Array(n);t<n;t++)r[t]=e[t];return r}function M(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function N(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?M(Object(t),!0).forEach((function(n){(0,o.Z)(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):M(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function j(e,n,t){return P.apply(this,arguments)}function P(){return(P=(0,u.Z)(a().mark((function e(n,t,o){var u,c,d,h,p,g,y,v,m,b,x,A,I,Z,M,j,P,R,T,D,_,B,U,z,C,F,J,V,G,K,q,W,Q,X;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(u=new l._3,c={singles:[],obstacles:[],walls:[]},n.items.forEach((function(e,n){var o,i,a;u.feedFromArray(e.transform||[1,0,0,1,0,0]);var s=t[e.symbol],d=s.singles,h=s.obstacles,p=s.walls,g=s.hull;n&&(u.a*=.2,u.b*=.2,u.c*=.2,u.d*=.2);var y=d.map((function(e){return{tags:e.tags,poly:e.poly.clone().applyMatrix(u).precision(4)}})).filter((function(n){var t=n.tags;return e.doors&&t.includes("door")?t.some((function(n){return e.doors.includes(n)})):!e.walls||!t.includes("wall")||t.some((function(n){return e.walls.includes(n)}))}));(o=c.singles).push.apply(o,(0,r.Z)(y)),(i=c.obstacles).push.apply(i,(0,r.Z)(h.map((function(e){return e.clone().applyMatrix(u)}))));var v=g.map((function(e){return e.applyMatrix(u)})),m=l.LA.intersect(v.map((function(e){return e.clone().removeHoles()})),v.flatMap((function(e){return e.createOutset(E.Mv)})));(a=c.walls).push.apply(a,(0,r.Z)(l.LA.union([].concat((0,r.Z)(p.map((function(e){return e.clone().applyMatrix(u)}))),(0,r.Z)((0,f.LH)(y,"wall")),(0,r.Z)(m)))))})),c.singles.forEach((function(e){return e.poly.fixOrientation().precision(4)})),c.obstacles.forEach((function(e){return e.fixOrientation().precision(4)})),c.walls.forEach((function(e){return e.fixOrientation().precision(4)})),d=(0,f.LH)(c.singles,"door"),h=c.walls.flatMap((function(e){return l.LA.cutOut(d,[e])})),p=c.walls,c.walls=l.LA.union(h),c.singles=c.singles.reduce((function(e,n){return e.concat(n.tags.includes("wall")?l.LA.cutOut(d,[n.poly]).map((function(e){return N(N({},n),{},{poly:e})})):n)}),[]),g=n.items.map((function(e){return t[e.symbol]})),y=g[0],v=y.hull.map((function(e){return e.clone().removeHoles()})),m=(0,f.LH)(c.singles,"window"),(b=(0,s.vL)(0,0).getContext("2d")).font=f.Dv.font,x=(0,f.J5)(c.singles,"label").map((function(e){var n=e.poly,t=e.tags,r=n.rect.center.precision(4).json,o=t.filter((function(e){return"label"!==e})).join(" "),i=!o.match(/[gjpqy]/),u={x:b.measureText(o).width,y:i?f.Dv.noTailPx:f.Dv.sizePx},c=l.UL.fromJson({x:r.x-.5*u.x,y:r.y-.5*u.y,width:u.x,height:u.y}).precision(4).json;return{text:o,center:r,rect:c,padded:(new l.UL).copy(c).outset(f.Dv.padX,f.Dv.padY).json}})),(A=l.LA.union(y.hull.concat(p,m)).map((function(e){return e.precision(4)}))).sort((function(e,n){return e.rect.area>n.rect.area?-1:1})),I=A[0].holes.map((function(e){return new l.LA(e)})),A.slice(1).forEach((function(e){var t=e.outline[0],r=I.find((function(e){return e.contains(t)}));r?r.holes.push(e.outline):(0,w.ZK)("".concat(n.key,": pillar ").concat(JSON.stringify(e.rect.json)," does not reside in any room"))})),Z=c.singles.filter((function(e){return e.tags.includes("door")})).map((function(e){return L(e,I)})),M=c.singles.filter((function(e){return e.tags.includes("window")})).map((function(e){return L(e,I)})),j=l.UL.fromRects.apply(l.UL,(0,r.Z)(y.hull.concat(d).map((function(e){return e.rect})))),Z.filter((function(e){return e.tags.includes("hull")})).forEach((function(e){S(e,j)})),P=c.singles.filter((function(e){return e.tags.includes("ignore-nav")})).map((function(e){return e.poly.center})),R=l.LA.cutOut([].concat((0,r.Z)(h.flatMap((function(e){return e.createOutset(E.MV)}))),(0,r.Z)(c.obstacles.flatMap((function(e){return e.createOutset(E.MT)})))),v).map((function(e){return e.cleanFinalReps().fixOrientation().precision(4)})).filter((function(e){return!P.some((function(n){return e.contains(n)}))&&e.rect.area>400})),T=d.flatMap((function(e){return l.LA.intersect([e],R)})).map((function(e){return e.cleanFinalReps()})),D=l.LA.cutOut(d,R),!o){e.next=36;break}return e.next=33,o.triangulate(D,{});case 33:e.t0=e.sent,e.next=37;break;case 36:e.t0={vs:[],tris:[]};case 37:_=e.t0,B=new l.dl,U=O(T.entries()),e.prev=40,U.s();case 42:if((z=U.n()).done){e.next=55;break}if(C=(0,i.Z)(z.value,2),F=C[0],4===(J=C[1].outline).length){e.next=47;break}return(0,w.vU)("door ".concat(F," nav skipped: expected 4 vertices but saw ").concat(J.length)),e.abrupt("continue",53);case 47:V=J.map((function(e){var n=_.vs.findIndex((function(n){return e.equalsAlmost(n,1e-4)}));return-1===n?_.vs.push(e)-1:n})),G=V.slice(0,3),B.copy(_.vs[V[3]]),K=G.map((function(e){return[e,B.distanceTo(_.vs[e])]})).sort((function(e,n){return e[1]<n[1]?-1:1})),q=[V[3]].concat(K.slice(0,2).map((function(e){return e[0]}))),_.tris.push(G,q);case 53:e.next=42;break;case 55:e.next=60;break;case 57:e.prev=57,e.t1=e.catch(40),U.e(e.t1);case 60:return e.prev=60,U.f(),e.finish(60);case 63:return console.log("nav tris count:",_.vs.length),(W=H(_,Z,I)).groups.forEach((function(e,n){return n>0&&e.length<=12&&(0,w.ZK)("createLayout: unexpected small navZone group ".concat(n," with ").concat(e.length," tris"))})),Q=k.json(I,Z,M),X=k.from(Q),e.abrupt("return",{key:n.key,id:n.id,def:n,groups:c,rooms:I,doors:Z,windows:M,labels:x,navPoly:R,navZone:W,roomGraph:X,hullPoly:y.hull.map((function(e){return e.clone()})),hullTop:l.LA.cutOut(d.concat(m),y.hull),hullRect:j,items:g.map((function(e,t){return{key:e.key,pngHref:t?"/symbol/".concat(e.key,".png"):"/debug/".concat(n.key,".png"),pngRect:e.pngRect,transformArray:n.items[t].transform,transform:n.items[t].transform?"matrix(".concat(n.items[t].transform,")"):void 0}}))});case 69:case"end":return e.stop()}}),e,null,[[40,57,60,63]])})))).apply(this,arguments)}function S(e,n){var t=e.poly.rect;t.y===n.y?e.tags.push("hull-n"):t.right===n.right?e.tags.push("hull-e"):t.bottom===n.bottom?e.tags.push("hull-s"):t.x===n.x&&e.tags.push("hull-w")}function L(e,n){var t=e.poly,r=e.tags,o=4===t.outline.length?d.J.polyToAngledRect(t):{baseRect:t.rect,angle:0},u=o.angle,c=o.baseRect,a=d.J.getAngledRectSeg({angle:u,baseRect:c}),s=(0,i.Z)(a,2),l=s[0],f=s[1],h=f.clone().sub(l).rotate(Math.PI/2).normalize(),p=Math.min(c.width,c.height)/2+.05,g=t.center.addScaledVector(h,p).precision(3),y=t.center.addScaledVector(h,-p).precision(3),v=n.reduce((function(e,n,t){return null===e[0]&&n.contains(g)?[t,e[1]]:null===e[1]&&n.contains(y)?[e[0],t]:e}),[null,null]);return{angle:u,baseRect:c.precision(3),poly:t,rect:t.rect.precision(4),tags:r,seg:[l.precision(3),f.precision(3)],normal:h.precision(3),roomIds:v,entries:[g,y]}}function R(e){var n=l.LA.from(e.poly);return N(N({},e),{},{baseRect:l.UL.fromJson(e.baseRect),poly:n,rect:n.rect,normal:l.dl.from(e.normal),seg:[l.dl.from(e.seg[0]),l.dl.from(e.seg[1])],entries:[l.dl.from(e.entries[0]),l.dl.from(e.entries[1])]})}function T(e){var n=e.def,t=e.groups,r=e.rooms,o=e.doors,i=e.windows,u=e.labels,c=e.navPoly,a=e.navZone,s=e.roomGraph,d=e.hullPoly,f=e.hullRect,h=e.hullTop,p=e.items;return{key:n.key,id:n.id,def:n,groups:{obstacles:t.obstacles.map(l.LA.from),singles:t.singles.map((function(e){return{tags:e.tags,poly:l.LA.from(e.poly)}})),walls:t.walls.map(l.LA.from)},rooms:r.map(l.LA.from),doors:o.map(R),windows:i.map(R),labels:u,navPoly:c.map(l.LA.from),navZone:a,roomGraph:k.from(s),hullPoly:d.map(l.LA.from),hullRect:f,hullTop:h.map(l.LA.from),items:p}}function D(e){return Object.values(e).reduce((function(e,n){return(e[n.key]={key:(t=n).key,hull:t.hull.map(l.LA.from),obstacles:t.obstacles.map(l.LA.from),walls:t.walls.map(l.LA.from),singles:t.singles.map((function(e){var n=e.tags,t=e.poly;return{tags:n,poly:l.LA.from(t)}})),pngRect:t.pngRect,lastModified:t.lastModified})&&e;var t}),{})}function _(e,n){var t=new l._3(n),r=new l.UL(0,0,1200,e.pngRect.height>1e3?1200:600).applyMatrix(t);return N(N({},e),{},{itemKey:"".concat(e.key,"-[").concat(n,"]"),transform:n,transformOrigin:"".concat(-e.pngRect.x,"px ").concat(-e.pngRect.y,"px"),transformStyle:"matrix(".concat(n,")"),matrix:t,inverseMatrix:t.getInverseMatrix(),gridRect:r})}function B(e,n,t){var r=e.roomIds[0]===n?1:-1;return e.poly.center.addScaledVector(e.normal,t*r)}function H(e,n,t){var r,o=I.buildZone(e),u=o.groups.flatMap((function(e){return e}))||[],c=o.groups[0].length,a=O(o.groups.slice(1));try{for(a.s();!(r=a.n()).done;){var s=r.value;s.forEach((function(e){return e.neighbours=e.neighbours.map((function(e){return e+c}))})),c+=s.length}}catch(b){a.e(b)}finally{a.f()}var f=[],h=[],p=u.map((function(e){return[]})),g=u.map((function(e){return[]})),y=new l.LA;n.forEach((function(e,n){var t=(0,i.Z)(e.seg,2),r=t[0],c=t[1];f[n]=[],u.forEach((function(e,t){y.outline=e.vertexIds.map((function(e){return o.vertices[e]})),d.J.lineSegIntersectsPolygon(r,c,y)&&(f[n].push(t),p[t].push(n)>1&&(0,w.ZK)("nav node",e,"has multiple doorIds",p[t]))}))}));var v=f.flatMap((function(e,n){return 2===e.length?[]:n}));v.length&&(0,w.ZK)("doorIds lacking exactly 2 nav nodes:",v,"(resp. counts ".concat(v.map((function(e){return f[e].length})),")")),t.forEach((function(e,n){h[n]=[],u.forEach((function(t,r){t.vertexIds.some((function(n){return e.outlineContains(o.vertices[n])}))&&(h[n].push(r),g[r].push(n)>1&&0===p[r].length&&(0,w.ZK)("nav node",t.id,"has no doorId and multiple roomIds",g[r]))}))}));var m=g.flatMap((function(e,n){return e.length||p[n].length?[]:n}));return m.length&&(0,w.ZK)("nav nodes have neither roomId nor doorId",m),N(N({},o),{},{doorNodeIds:f,roomNodeIds:h})}}}]);