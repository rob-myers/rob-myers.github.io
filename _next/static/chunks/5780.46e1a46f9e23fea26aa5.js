"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5780],{95814:function(n,t,e){e.d(t,{Z:function(){return g}});var r=e(79056),o=e(92809),i=e(97131),u=e(30266),c=e(809),s=e.n(c),a=e(88767),l=e(91441),f=e(48103),d=e(2026),h=e(39660);function v(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(n,t).enumerable}))),e.push.apply(e,r)}return e}function p(n){for(var t=1;t<arguments.length;t++){var e=null!=arguments[t]?arguments[t]:{};t%2?v(Object(e),!0).forEach((function(t){(0,o.Z)(n,t,e[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):v(Object(e)).forEach((function(t){Object.defineProperty(n,t,Object.getOwnPropertyDescriptor(e,t))}))}return n}function g(n){return(0,a.useQuery)((0,l.tU)(n),(0,u.Z)(s().mark((function t(){var e,o,u,c,a,d,v;return s().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.t0=h.Vn,t.next=3,fetch((0,l.tU)(n)).then((function(n){return n.json()}));case 3:return t.t1=t.sent,e=(0,t.t0)(t.t1),o=e.roomGraph,u=o.nodesArray.filter((function(n){return"room"===n.type})).map((function(n,t){var r=o.getEdgesFrom(n).flatMap((function(n){var t=n.dst;return"door"===t.type?e.doors[t.doorId].poly:[]}));return f.LA.union([e.rooms[t]].concat((0,i.Z)(r)))[0]})),c=e.groups.singles.filter((function(n){return n.tags.includes("spawn")})).map((function(n){return n.poly.center})),a=e.groups.singles.filter((function(n){return n.tags.includes("switch")})).map((function(n){return n.poly.center})),d=e.groups.singles.filter((function(n){return n.tags.includes("light")})).map((function(n){var t=n.poly.rect;return[t.center,t]})),(v=p(p({},e),{},{hullDoors:e.doors.filter((function(n){return n.tags.includes("hull")})),hullOutline:e.hullPoly[0].removeHoles(),pngRect:f.UL.fromJson(e.items[0].pngRect),roomsWithDoors:u,point:{all:[].concat(d.map((function(n){return n[0]})),c,a),light:d.reduce((function(n,t,o){var i=(0,r.Z)(t,2),u=i[0],c=i[1],s=e.rooms.findIndex((function(n){return n.contains(u)})),a=e.doors.findIndex((function(n){return n.rect.intersects(c)}));return s>=0&&a>=0?(n[s]=n[s]||{})[a]=u:console.warn("useGeomorphData: light ".concat(o," roomId/doorId ").concat(s,"/").concat(a)),n}),{}),spawn:e.rooms.map((function(n){return c.filter((function(t){return n.contains(t)}))})),switch:e.rooms.map((function(n){return a.find((function(t){return n.contains(t)}))||n.rect.center}))},lazy:null})).lazy=m(v),y(v),t.abrupt("return",v);case 14:case"end":return t.stop()}}),t)}))),{cacheTime:1/0,keepPreviousData:!0,staleTime:1/0})}function m(n){var t={roomNavPoly:{}},e=new Proxy({},{get:function(e,r){if("string"===typeof r){var o=Number(r);if(n.roomsWithDoors[o]&&!t.roomNavPoly[o]){var i=f.LA.intersect(n.navPoly,[n.roomsWithDoors[o]]);i.sort((function(n,t){return n.rect.area>t.rect.area?-1:1})),t.roomNavPoly[o]=i[0]}return t.roomNavPoly[o]}}});return new Proxy(t,{get:function(n,t){if("roomNavPoly"===t)return e}})}function y(n){n.navZone.doorNodeIds.forEach((function(t,e){var r=n.doors[e];if(n.hullDoors.includes(r)){var o,u=r.roomIds.find(Boolean);if(Number.isFinite(u))(o=n.navZone.roomNodeIds[u]).push.apply(o,(0,i.Z)(t));else(0,d.ZK)("extendRoomNodeIds: ".concat(n.key," (hull) door ").concat(e," has empty roomIds"))}}))}},19964:function(n,t,e){e.d(t,{Z:function(){return P}});var r=e(97131),o=e(79056),i=e(68216),u=e(25997),c=e(14695),s=e(91077),a=e(30268),l=e(92953),f=e(92809),d=e(48103),h=e(82405),v=e(81033),p=function(){function n(t){(0,i.Z)(this,n),this.content=[],this.scoreFunction=t}return(0,u.Z)(n,[{key:"push",value:function(n){this.content.push(n),this.sinkDown(this.content.length-1)}},{key:"pop",value:function(){var n=this.content[0],t=this.content.pop();return this.content.length>0&&(this.content[0]=t,this.bubbleUp(0)),n}},{key:"remove",value:function(n){var t=this.content.indexOf(n),e=this.content.pop();t!==this.content.length-1&&(this.content[t]=e,this.scoreFunction(e)<this.scoreFunction(n)?this.sinkDown(t):this.bubbleUp(t))}},{key:"size",value:function(){return this.content.length}},{key:"rescoreElement",value:function(n){this.sinkDown(this.content.indexOf(n))}},{key:"sinkDown",value:function(n){for(var t=this.content[n];n>0;){var e=(n+1>>1)-1,r=this.content[e];if(!(this.scoreFunction(t)<this.scoreFunction(r)))break;this.content[e]=t,this.content[n]=r,n=e}}},{key:"bubbleUp",value:function(n){for(var t=this.content.length,e=this.content[n],r=this.scoreFunction(e);;){var o=n+1<<1,i=o-1,u=null,c=-1/0;if(i<t){var s=this.content[i];(c=this.scoreFunction(s))<r&&(u=i)}if(o<t){var a=this.content[o];this.scoreFunction(a)<(null===u?r:c)&&(u=o)}if(null===u)break;this.content[n]=this.content[u],this.content[u]=e,n=u}}}]),n}(),g=function(){function n(){(0,i.Z)(this,n)}return(0,u.Z)(n,null,[{key:"init",value:function(n){for(var t=n.nodesArray,e=0;e<t.length;e++){var r=t[e];r.f=0,r.g=0,r.h=0,r.cost=1,r.visited=!1,r.closed=!1,r.parent=null}}},{key:"cleanUp",value:function(n){for(var t=0;t<n.length;t++){var e=n[t];delete e.f,delete e.g,delete e.h,delete e.cost,delete e.visited,delete e.closed,delete e.parent}}},{key:"heap",value:function(){return new p((function(n){return n.f}))}},{key:"search",value:function(n,t,e){this.init(n);var r=n.nodesArray,o=this.heap();for(o.push(t);o.size()>0;){var i=o.pop();if(i===e){for(var u=i,c=[];u.parent;)c.push(u),u=u.parent;return c.push(t),this.cleanUp(c),c.reverse(),c}i.closed=!0;for(var s=this.neighbours(r,i),a=0,l=s.length;a<l;a++){var f=s[a];if(!f.closed){var d=i.g+f.cost,h=f.visited;if(!h||d<f.g){if(f.visited=!0,f.parent=i,!f.centroid||!e.centroid)throw new Error("Unexpected state");f.h=f.h||this.heuristic(f.centroid,e.centroid),f.g=d,f.f=f.g+f.h,h?o.rescoreElement(f):o.push(f)}}}}return[]}},{key:"heuristic",value:function(n,t){return v.c.distanceToSquared(n,t)}},{key:"neighbours",value:function(n,t){for(var e=[],r=0;r<t.neighbours.length;r++)e.push(n[t.neighbours[r]]);return e}}]),n}(),m=function(){function n(){(0,i.Z)(this,n),this.portals=[]}return(0,u.Z)(n,[{key:"push",value:function(n,t){void 0===t&&(t=n),this.portals.push({left:n,right:t})}},{key:"stringPull",value:function(){var n,t,e,r=this.portals,o=[],i=0,u=0,c=0;n=r[0].left,t=r[0].left,e=r[0].right,o.push(n);for(var s=1;s<r.length;s++){var a=r[s].left,l=r[s].right;if(v.c.triarea2(n,e,l)<=0){if(!(v.c.vequal(n,e)||v.c.triarea2(n,t,l)>0)){o.push(t),t=n=t,e=n,u=i=u,c=i,s=i;continue}e=l,c=s}if(v.c.triarea2(n,t,a)>=0){if(!(v.c.vequal(n,t)||v.c.triarea2(n,e,a)<0)){o.push(e),t=n=e,e=n,u=i=c,c=i,s=i;continue}t=a,u=s}}return 0!==o.length&&v.c.vequal(o[o.length-1],r[r.length-1].left)||o.push(r[r.length-1].left),this.path=o,o}}]),n}(),y=(e(84175),e(2026),e(68451));function b(n,t){var e="undefined"!==typeof Symbol&&n[Symbol.iterator]||n["@@iterator"];if(!e){if(Array.isArray(n)||(e=function(n,t){if(!n)return;if("string"===typeof n)return I(n,t);var e=Object.prototype.toString.call(n).slice(8,-1);"Object"===e&&n.constructor&&(e=n.constructor.name);if("Map"===e||"Set"===e)return Array.from(n);if("Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e))return I(n,t)}(n))||t&&n&&"number"===typeof n.length){e&&(n=e);var r=0,o=function(){};return{s:o,n:function(){return r>=n.length?{done:!0}:{done:!1,value:n[r++]}},e:function(n){throw n},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,u=!0,c=!1;return{s:function(){e=e.call(n)},n:function(){var n=e.next();return u=n.done,n},e:function(n){c=!0,i=n},f:function(){try{u||null==e.return||e.return()}finally{if(c)throw i}}}}function I(n,t){(null==t||t>n.length)&&(t=n.length);for(var e=0,r=new Array(t);e<t;e++)r[e]=n[e];return r}function k(n){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(n){return!1}}();return function(){var e,r=(0,l.Z)(n);if(t){var o=(0,l.Z)(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return(0,a.Z)(this,e)}}var Z=function(n){(0,s.Z)(e,n);var t=k(e);function e(n){var r;(0,i.Z)(this,e),r=t.call(this),(0,f.Z)((0,c.Z)(r),"gm",void 0),(0,f.Z)((0,c.Z)(r),"vectors",void 0),(0,f.Z)((0,c.Z)(r),"nodeToMeta",void 0),r.gm=n,r.vectors=n.navZone.vertices.map(d.dl.from);var o=n.navZone.groups[0];return r.nodeToMeta=o.map((function(n){return{doorId:-1,roomId:-1}})),n.navZone.doorNodeIds.forEach((function(n,t){n.forEach((function(n){return r.nodeToMeta[n].doorId=t}))})),n.navZone.roomNodeIds.forEach((function(n,t){n.forEach((function(n){return r.nodeToMeta[n].roomId=t}))})),r}return(0,u.Z)(e,[{key:"findPath",value:function(n,t){var e=this,i=this.getClosestNode(n),u=this.getClosestNode(t);if(!i||!u)return null;var c=g.search(this,i,u).reduce((function(n,t){var r=n.length?n[n.length-1]:void 0,o=e.nodeToMeta[t.index],i=o.doorId>=0?"door":"room";return(null===r||void 0===r?void 0:r.key)===i?r.nodes.push(t):(n.push("door"===i?{key:i,nodes:[t],doorId:o.doorId}:{key:i,nodes:[t],roomId:o.roomId}),"room"===i&&-1===o.roomId&&console.warn("findPathNew: expected roomId for node",t,o)),n}),[]);console.log("findPath: partition",c);var s,a=[n.clone()],l=[],f=b(c.entries());try{for(f.s();!(s=f.n()).done;){var h=(0,o.Z)(s.value,2),v=h[0],p=h[1];if("door"===p.key){if("break"===function(){if(0===v&&1===c.length)return a.push(t.clone()),"break";var n=e.gm.doors[p.doorId];if(v>0){var r=c[v-1].roomId;l.push({key:"exit-room",index:a.length-1,doorId:p.doorId,exitedRoomId:r,otherRoomId:n.roomIds[1-n.roomIds.findIndex((function(n){return n===r}))]})}var o=v<c.length-1?c[v+1].roomId:null,i=v>0?c[v-1].roomId:null,u=null!==o?n.entries[n.roomIds.findIndex((function(n){return n===o}))]:n.entries[1-n.roomIds.findIndex((function(n){return n===i}))];a.push(u.clone())}())break}else if("continue"===function(){var o=p.roomId,i=0===v?n:a[a.length-1],u=t;if(v<c.length-1){var s=e.gm.doors[c[v+1].doorId];u=s.entries[s.roomIds.findIndex((function(n){return n===o}))]}if(v>0){var f=c[v-1].doorId,h=e.gm.doors[f];l.push({key:"enter-room",index:a.length-1,doorId:f,enteredRoomId:o,otherRoomId:h.roomIds[1-h.roomIds.findIndex((function(n){return n===o}))]})}var g=e.gm.lazy.roomNavPoly[o];if(!y.J.lineSegCrossesPolygon(i,u,g))return a.push(u.clone()),"continue";var m=e.computeStringPull(i,u,p.nodes).path.map(d.dl.from);a.push.apply(a,(0,r.Z)(m.slice(1)))}())continue}}catch(m){f.e(m)}finally{f.f()}return{fullPath:a,navMetas:l}}},{key:"getClosestNode",value:function(n){var t=this.nodesArray,e=this.vectors,r=null,o=1/0;return t.forEach((function(t){var i=t.centroid.distanceToSquared(n);i<o&&v.c.isVectorInPolygon(n,t,e)&&(r=t,o=i)})),r||t.forEach((function(t){var e=v.c.distanceToSquared(t.centroid,n);e<o&&(r=t,o=e)})),r}},{key:"getPortalFromTo",value:function(n,t){for(var e=0;e<n.neighbours.length;e++)if(n.neighbours[e]===t.index)return n.portals[e]}},{key:"computeStringPull",value:function(n,t,e){var r=new m;r.push(n);for(var o=0;o<e.length;o++){var i=e[o],u=e[o+1];if(u){var c=this.getPortalFromTo(i,u);r.push(this.vectors[c[0]],this.vectors[c[1]])}}return r.push(t),r.stringPull(),r}}],[{key:"fromZone",value:function(n){for(var t=n.navZone,r=(0,o.Z)(t.groups,1)[0],i=(t.vertices,new e(n)),u=0,c=Object.entries(r);u<c.length;u++){var s=(0,o.Z)(c[u],2),a=s[0],l=s[1];i.registerNode({type:"tri",id:"tri-".concat(a),index:Number(a),vertexIds:l.vertexIds.slice(),portals:l.portals.map((function(n){return n.slice()})),cost:1,visited:!1,closed:!1,parent:null,centroid:d.dl.from(l.centroid),neighbours:l.neighbours.slice()})}for(var f=function(){var n=(0,o.Z)(v[h],2),t=n[0],e=n[1],r="tri-".concat(t);e.neighbours.map((function(n){return"tri-".concat(n)})).forEach((function(n){return i.registerEdge({src:r,dst:n})}))},h=0,v=Object.entries(r);h<v.length;h++)f();return i}}]),e}(h.b),w=e(88767);function P(n,t,e){return(0,w.useQuery)(function(n){return"pathfinding-".concat(n)}(n),(function(){return{graph:Z.fromZone(t)}}),{enabled:!!t&&!e,keepPreviousData:!0,staleTime:1/0})}}}]);