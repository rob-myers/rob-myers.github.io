(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1269],{9580:function(t,e,n){"use strict";n.r(e),n.d(e,{default:function(){return st}});var o=n(79056),r=n(52209),a=n(30266),i=n(809),s=n.n(i),c=n(59748),l=n(88269),u=n(94975),p=n(84175),d=n(91441),f=n(48103),m=n(27375),h=n(44275),g=n(97301),y=n(87079),v=n(30245),b=n(97131),w=n(92809),x=n(94184),k=n.n(x),P=n(16716),I=n(24781),Z=n(32817),N=n(95196),A=n(29127),O=n(74727),S=n(29120),K=n(29998),j=n(99763);function E(t,e){return M.apply(this,arguments)}function M(){return(M=(0,j.Z)(s().mark((function t(e,n){var o,r,a,i;return s().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:o={promise:R()},r=!1,a=e.subscribe({next:function(t){window.setTimeout((function(){var e=o.promise;o.promise=R(),e.resolve(t)}))},error:function(t){window.setTimeout((function(){var e=o.promise;o.promise=R(),e.reject(t)}))},complete:function(){window.setTimeout((function(){r=!0,o.promise.resolve()}))}}),null===n||void 0===n||n(o,a),t.prev=4;case 5:return t.next=8,(0,K.Z)(o.promise);case 8:if(i=t.sent,!r){t.next=11;break}return t.abrupt("break",15);case 11:return t.next=13,i;case 13:t.next=5;break;case 15:return t.prev=15,a.unsubscribe(),t.finish(15);case 18:case"end":return t.stop()}}),t,null,[[4,,15,18]])})))).apply(this,arguments)}function R(){var t={},e=new Promise((function(e,n){Object.assign(t,{resolve:e,reject:n})}));return Object.assign(e,t)}var T=n(68451);n(77503),n(292),n(26470),n(7951),n(28949),n(42830),n(89539),n(21801);n(2026),n(48764).Buffer;function D(t){var e,n,o=t;return"local-nav"===(null===o||void 0===o?void 0:o.key)&&(null===(e=o.fullPath)||void 0===e||null===(n=e.every)||void 0===n?void 0:n.call(e,f.dl.isVectJson))||!1}function G(t){var e,n,o=t;return"global-nav"===(null===o||void 0===o?void 0:o.key)&&(null===(e=o.fullPath)||void 0===e||null===(n=e.every)||void 0===n?void 0:n.call(e,f.dl.isVectJson))||!1}var L=JSON.parse('{"sP":2,"HB":{"idle":{"animName":"idle","aabb":{"x":0,"y":0,"width":128,"height":128},"frameCount":1},"walk":{"animName":"walk","aabb":{"x":0,"y":0,"width":128,"height":128},"frameCount":10}}}');function J(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,o)}return n}function C(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?J(Object(n),!0).forEach((function(e){(0,w.Z)(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):J(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}var B=.2,V=0,z=40*B*L.sP,W=15,q=n(19964);var X,H=n(8311),F=L.HB,U=L.sP;function _(t){var e=t.npc;return c.default.useEffect((function(){return"idle"===e.anim.spriteSheet&&0===e.anim.aux.count&&e.startAnimation(),function(){window.clearTimeout(e.anim.wayTimeoutId)}}),[]),(0,H.tZ)("div",{ref:e.npcRef.bind(e),className:k()("npc",e.key,e.anim.spriteSheet,Q),"data-npc-key":e.key,children:(0,H.tZ)("div",{className:k()("body",e.key,"no-select"),"data-npc-key":e.key})})}var Y,Q=(0,l.iv)(X||(X=(0,r.Z)(["\n  .body {\n    /* cursor: pointer; */\n    position: absolute;\n    filter: grayscale(100%) brightness(140%);\n    /* transform: scale(0.18) rotate(90deg); */\n  }\n  \n  &.walk .body {\n    width: ","px;\n    height: ","px;\n    left: ","px;\n    top: ","px;\n    background: url('/npc/first-npc--walk.png');\n  }\n\n  &.idle .body {\n    width: ","px;\n    height: ","px;\n    left: ","px;\n    top: ","px;\n    background: url('/npc/first-npc--idle.png');\n  }\n\n  &.disabled .body {\n    animation-play-state: paused;\n  }\n"])),F.walk.aabb.width*U,F.walk.aabb.height*U,-F.walk.aabb.width*U*.5,-F.walk.aabb.height*U*.5,F.idle.aabb.width*U,F.idle.aabb.height*U,-F.idle.aabb.width*U*.5,-F.idle.aabb.height*U*.5);function $(t,e){var n="undefined"!==typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=function(t,e){if(!t)return;if("string"===typeof t)return tt(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return tt(t,e)}(t))||e&&t&&"number"===typeof t.length){n&&(t=n);var o=0,r=function(){};return{s:r,n:function(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,s=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return i=t.done,t},e:function(t){s=!0,a=t},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw a}}}}function tt(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,o=new Array(e);n<e;n++)o[n]=t[n];return o}function et(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,o)}return n}function nt(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?et(Object(n),!0).forEach((function(e){(0,w.Z)(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):et(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function ot(t){var e=(0,m.Z)(),n=function(t,e){var n=c.default.useState((function(){return t.gms.map((function(t){return t.key}))})),r=(0,o.Z)(n,2),a=r[0],i=r[1];c.default.useMemo((function(){var e=t.gms.map((function(t){return t.key})).filter((function(t){return!a.includes(t)}));e.length&&i([].concat((0,b.Z)(a),(0,b.Z)(e)))}),[t]);var s=a.map((function(n){return(0,q.Z)(n,t.gmData[n],e)})),l=t.gms.every((function(t){return a.includes(t.key)}))&&s.every((function(t){return t.data}));return c.default.useMemo((function(){return l?{pfs:t.gms.map((function(t){var e=a.findIndex((function(e){return e===t.key}));return(0,p.Nh)(s[e].data)}))}:{pfs:[]}}),[l])}(t.gmGraph,t.disabled),r=(0,h.Z)((function(){return{npc:{},path:{},events:new P.x,playerKey:null,ready:!0,class:{Vect:f.dl},rxjs:{filter:u.h,first:N.P,map:A.U,take:O.q,otag:E},getGlobalNavPath:function(e,n){var o=t.gmGraph.gms,a=o.findIndex((function(t){return t.gridRect.contains(e)})),i=o.findIndex((function(t){return t.gridRect.contains(n)}));if(-1===a||-1===i)throw Error("getGlobalNavPath: src/dst must be inside some geomorph's aabb");if(a===i){var s=r.getLocalNavPath(a,e,n);return console.log("localNavPath (single)",s),{key:"global-nav",fullPath:s.fullPath.slice(),navMetas:s.navMetas.map((function(t){return nt(nt({},t),{},{gmId:s.gmId})}))}}var c=t.gmGraph.findPath(e,n);if(!c)throw Error("getGlobalNavPath: gmGraph.findPath not found: ".concat(JSON.stringify(e)," -> ").concat(JSON.stringify(n)));console.log("gmEdges",c);for(var l=[],u=[],p=function(t){var o=0===t?r.getLocalNavPath(a,e,c[0].srcDoorEntry):t<c.length?r.getLocalNavPath(c[t-1].dstGmId,c[t-1].dstDoorEntry,c[t].srcDoorEntry):r.getLocalNavPath(i,c[t-1].dstDoorEntry,n);console.log("localNavPath",t,o);var s=c[t];if(0===t&&o.doorIds[0]>=0)l.push(f.dl.from(e));else if(t===c.length&&o.doorIds[1]>=0)l.push(f.dl.from(n));else{var p=l.length;l.push.apply(l,(0,b.Z)(o.fullPath)),u.push.apply(u,(0,b.Z)(o.navMetas.map((function(t){return nt(nt({},t),{},{index:p+t.index,gmId:o.gmId})}))))}s&&u.push({key:"exit-room",gmId:s.srcGmId,doorId:s.srcDoorId,exitedRoomId:s.srcRoomId,hullDoorId:s.srcHullDoorId,index:l.length-1,otherRoomId:null})},d=0;d<c.length+1;d++)p(d);return{key:"global-nav",fullPath:l,navMetas:u}},getLocalNavPath:function(e,o,r){var a=t.gmGraph.gms[e],i=a.inverseMatrix.transformPoint(f.dl.from(o)),s=a.inverseMatrix.transformPoint(f.dl.from(r)),c=n.pfs[e].graph.findPath(i,s);return c?nt(nt({key:"local-nav",gmId:e},c),{},{fullPath:c.fullPath.map((function(t){return a.matrix.transformPoint(f.dl.from(t)).precision(3)}))}):{key:"local-nav",gmId:e,fullPath:[],navMetas:[],doorIds:[-1,-1]}},getNpcGlobalNav:function(t){var e=r.npc[t.npcKey];if(!e)throw Error('npcKey "'.concat(t.npcKey,'" does not exist'));if(!f.dl.isVectJson(t.point))throw Error("invalid point: ".concat(JSON.stringify(t.point)));if(!r.isPointLegal(t.point))throw Error("outside navPoly: ".concat(JSON.stringify(t.point)));var n=r.getGlobalNavPath(e.getPosition(),t.point);return t.debug&&r.toggleDebugPath({pathKey:t.npcKey,points:n.fullPath}),n},getNpc:function(t){var e=r.npc[t];if(!e)throw Error('npc "'.concat(t,'" does not exist'));return e},getNpcsIntersecting:function(t){return Object.values(r.npc).filter((function(e){return T.J.rectIntersectsConvexPoly(e.getBounds(),t.outline)}))},getPanZoomApi:function(){return t.panZoomApi},isPointLegal:function(e){var n=t.gmGraph.gms.findIndex((function(t){return t.gridRect.contains(e)}));if(-1===n)return!1;var o=t.gmGraph.gms[n],r=o.navPoly,a=o.inverseMatrix.transformPoint(f.dl.from(e));return r.some((function(t){return t.contains(a)}))},npcAct:function(t){return(0,a.Z)(s().mark((function e(){var n;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=t.action,e.next="cancel"===e.t0?3:"get"===e.t0?6:"pause"===e.t0?7:"play"===e.t0?10:"set-player"===e.t0?13:15;break;case 3:return e.next=5,r.getNpc(t.npcKey).cancel();case 5:return e.abrupt("break",16);case 6:return e.abrupt("return",r.getNpc(t.npcKey));case 7:return e.next=9,r.getNpc(t.npcKey).pause();case 9:return e.abrupt("break",16);case 10:return e.next=12,r.getNpc(t.npcKey).play();case 12:return e.abrupt("break",16);case 13:return r.events.next({key:"set-player",npcKey:null!==(n=t.npcKey)&&void 0!==n?n:null}),e.abrupt("break",16);case 15:throw Error((0,p.Ql)(t,'unrecognised action: "'.concat(JSON.stringify(t),'"')));case 16:case"end":return e.stop()}}),e)})))()},panZoomTo:function(e){return(0,a.Z)(s().mark((function n(){return s().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!(!e||e.zoom&&!Number.isFinite(e.zoom)||e.point&&!f.dl.isVectJson(e.point)||e.ms&&!Number.isFinite(e.ms))){n.next=2;break}throw Error("expected format: { zoom?: number; point?: { x: number; y: number }; ms: number; easing?: string }");case 2:return n.prev=2,n.next=5,t.panZoomApi.panZoomTo(e.zoom,e.point,e.ms,e.easing);case 5:return n.abrupt("return","completed");case 8:return n.prev=8,n.t0=n.catch(2),n.abrupt("return","cancelled");case 11:case"end":return n.stop()}}),n,null,[[2,8]])})))()},spawn:function(n){if(!n.npcKey||"string"!==typeof n.npcKey||!n.npcKey.trim())throw Error("invalid npc key: ".concat(JSON.stringify(n.npcKey)));if(!n.point||"number"!==typeof n.point.x||"number"!==typeof n.point.y)throw Error("invalid point: ".concat(JSON.stringify(n.point)));if(!r.isPointLegal(n.point))throw Error("cannot spawn outside navPoly: ".concat(JSON.stringify(n.point)));r.npc[n.npcKey]=function(t,e,n){var o=n.disabled,r=n.panZoomApi,i=n.npcs;return{key:t,epochMs:Date.now(),def:{key:t,position:e,angle:0,paused:!!o},el:{root:{},body:{}},anim:{animPath:[],aux:{angs:[],count:0,edges:[],elens:[],navPathPolys:[],sofars:[],total:0},spriteSheet:"idle",root:new Animation,body:new Animation,wayMetas:[],wayTimeoutId:0},get paused(){return"paused"===this.anim.root.playState},cancel:function(){var t=this;return(0,a.Z)(s().mark((function e(){var n;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("cancel: cancelling ".concat(t.def.key)),(n=t.anim).root.commitStyles(),n.wayMetas.length=0,e.next=6,new Promise((function(t){n.root.addEventListener("cancel",(function(){return t()})),n.root.cancel()}));case 6:case"end":return e.stop()}}),e)})))()},pause:function(){console.log("pause: pausing ".concat(this.def.key));var t=this.anim;t.root.pause(),t.body.pause(),t.root.commitStyles(),window.clearTimeout(t.wayTimeoutId)},play:function(){console.log("play: resuming ".concat(this.def.key));var t=this.anim;t.root.play(),t.body.play(),this.nextWayTimeout()},nextWayTimeout:function(){var t=this.anim;if(null===t.root.currentTime)return console.warn("nextWayTimeout: anim.root.currentTime is null");t.wayMetas[0]&&(t.wayTimeoutId=window.setTimeout(this.wayTimeout.bind(this),t.wayMetas[0].length*W-t.root.currentTime))},wayTimeout:function(){var t=this.anim;if(0===t.wayMetas.length||"idle"===t.spriteSheet||null===t.root.currentTime||"paused"===t.root.playState)return 0===t.wayMetas.length&&console.warn("wayTimeout: empty anim.wayMetas"),null===t.root.currentTime&&console.warn("wayTimeout: anim.root.currentTime is null"),void("idle"===t.spriteSheet&&console.warn('wayTimeout: anim.spriteSheet is "idle"'));if(t.root.currentTime>=t.wayMetas[0].length*W-1){var e=t.wayMetas.shift();console.log(e),i.events.next({key:"way-point",npcKey:this.def.key,meta:e})}this.nextWayTimeout()},followNavPath:function(t,e){var n=this;return(0,a.Z)(s().mark((function o(){var r;return s().wrap((function(o){for(;;)switch(o.prev=o.next){case 0:if((r=n.anim).animPath=t.map(f.dl.from),r.wayMetas.length=0,n.updateAnimAux(),!(r.animPath.length<=1||0===r.aux.total)){o.next=6;break}return o.abrupt("return");case 6:return null!==e&&void 0!==e&&e.globalNavMetas&&(r.wayMetas=e.globalNavMetas.map((function(t){return C(C({},t),{},{length:"pre-exit-room"===t.key?Math.max(r.aux.sofars[t.index]-(z+5),0):Math.max(r.aux.sofars[t.index]-.1,0)})}))),n.setSpritesheet("walk"),n.startAnimation(),i.events.next({key:"started-walking",npcKey:n.def.key}),console.log("followNavPath: ".concat(n.def.key," started walk")),n.nextWayTimeout(),o.prev=12,o.next=15,new Promise((function(t,e){r.root.addEventListener("finish",(function(){console.log("followNavPath: ".concat(n.def.key," finished walk")),t()})),r.root.addEventListener("cancel",(function(){console.log("followNavPath: ".concat(n.def.key," cancelled walk")),e(new Error("cancelled"))}))}));case 15:return o.prev=15,n.setSpritesheet("idle"),n.startAnimation(),i.events.next({key:"stopped-walking",npcKey:n.def.key}),o.finish(15);case 20:case"end":return o.stop()}}),o,null,[[12,,15,20]])})))()},getAngle:function(){var t=new DOMMatrixReadOnly(window.getComputedStyle(this.el.root).transform);return Math.atan2(t.m12,t.m11)},getAnimDef:function(){var t=this.anim,e=t.aux;return{keyframes:t.animPath.flatMap((function(t,n){return[{offset:e.sofars[n]/e.total,transform:"translate(".concat(t.x,"px, ").concat(t.y,"px) rotateZ(").concat(e.angs[n-1]||e.angs[n]||0,"rad)")},{offset:e.sofars[n]/e.total,transform:"translate(".concat(t.x,"px, ").concat(t.y,"px) rotateZ(").concat(e.angs[n]||e.angs[n-1]||0,"rad)")}]})),opts:{duration:e.total*W,direction:"normal",fill:"forwards"}}},getBounds:function(){var t=this.getPosition();return new f.UL(t.x-z,t.y-z,2*z,2*z)},getPosition:function(){var t=f.dl.from(this.el.root.getBoundingClientRect()),e=t.x,n=t.y;return f.dl.from(r.getWorld({clientX:e,clientY:n})).precision(2)},getTargets:function(){var t=this.anim;if("idle"===t.spriteSheet||null===t.root.currentTime)return[];var e=t.root.currentTime;return t.aux.sofars.map((function(n,o){return{point:t.animPath[o],arriveMs:n*W-e}})).filter((function(t){return t.arriveMs>=0}))},npcRef:function(t){t&&0===this.anim.aux.count&&(this.el.root=t,this.el.body=t.childNodes[0],this.el.root.style.transform="translate(".concat(this.def.position.x,"px, ").concat(this.def.position.y,"px)"),this.el.body.style.transform="scale(".concat(B,") rotate(").concat(V,"deg)"))},setSpritesheet:function(t){t!==this.anim.spriteSheet&&(this.el.root.classList.remove(this.anim.spriteSheet),this.el.root.classList.add(t),this.anim.spriteSheet=t)},startAnimation:function(){var t=this.anim;if(t.aux.count&&(t.root.commitStyles(),t.root.cancel()),"walk"===t.spriteSheet){var e=this.getAnimDef(),n=e.keyframes,o=e.opts;t.root=this.el.root.animate(n,o);var r=L.HB,a=L.sP;t.body=this.el.body.animate([{offset:0,backgroundPosition:"0px"},{offset:1,backgroundPosition:"".concat(-r.walk.frameCount*r.walk.aabb.width*a,"px")}],{easing:"steps(".concat(r.walk.frameCount,")"),duration:625,iterations:1/0})}else"idle"===t.spriteSheet&&(t.wayMetas.length=0,t.root=this.el.root.animate([],{duration:2e3,iterations:1/0}),t.body=this.el.body.animate([],{duration:2e3,iterations:1/0}));t.aux.count++},updateAnimAux:function(){var t=this.anim,e=t.aux;e.edges=t.animPath.map((function(e,n){return{p:e,q:t.animPath[n+1]}})).slice(0,-1),e.angs=e.edges.map((function(t){return Number(Math.atan2(t.q.y-t.p.y,t.q.x-t.p.x).toFixed(2))})),e.elens=e.edges.map((function(t){var e=t.p,n=t.q;return Number(e.distanceTo(n).toFixed(2))})),e.navPathPolys=e.edges.map((function(t){var e=t.q.clone().sub(t.p).rotate(Math.PI/2).normalize(.01);return new f.LA([t.p.clone().add(e),t.q.clone().add(e),t.q.clone().sub(e),t.p.clone().sub(e)])}));var n=e.elens.reduce((function(t,e){return t.total+=e,t.sofars.push(t.sofars[t.sofars.length-1]+e),t}),{sofars:[0],total:0});e.sofars=n.sofars,e.total=n.total}}}(n.npcKey,n.point,{disabled:t.disabled,panZoomApi:t.panZoomApi,npcs:r}),e()},toggleDebugPath:function(t){if(t.points){var n=t.points.map(f.dl.from);r.path[t.pathKey]={path:n,aabb:f.UL.from.apply(f.UL,(0,b.Z)(n)).outset(10)}}else delete r.path[t.pathKey];e()},trackNpc:function(e){var n=e.npcKey,o=e.process;if(!r.npc[n])throw Error('npc "'.concat(n,'" does not exist'));var i="no-track";return(0,I.T)((0,Z.of)({key:"init-track"}),r.events,t.panZoomApi.events).pipe((0,u.h)((function(t){return 1===o.status&&("init-track"===t.key||"ui-idle"===t.key||"resized-bounds"===t.key||"cancelled-panzoom-to"===t.key||"completed-panzoom-to"===t.key||"started-walking"===t.key&&t.npcKey===n||"stopped-walking"===t.key&&t.npcKey===n)}))).subscribe({next:function(e){return(0,a.Z)(s().mark((function o(){var a,c,l;return s().wrap((function(o){for(;;)switch(o.prev=o.next){case 0:if(t.panZoomApi.isIdle()||"started-walking"===e.key){o.next=4;break}return i="no-track",console.warn("@",i),o.abrupt("return");case 4:if(a=r.npc[n],c=a.getPosition(),"idle"!==a.anim.spriteSheet||null!==t.panZoomApi.anims[0]&&"finished"!==t.panZoomApi.anims[0].playState||!(t.panZoomApi.distanceTo(c)>10)){o.next=17;break}return i="panzoom-to",console.warn("@",i),o.prev=9,o.next=12,t.panZoomApi.panZoomTo(2,c,2e3);case 12:o.next=16;break;case 14:o.prev=14,o.t0=o.catch(9);case 16:i="no-track";case 17:if("started-walking"!==e.key){o.next=28;break}return i="follow-walk",console.warn("@",i),o.prev=20,l=a.getTargets().map((function(t){return f.dl.from(t.point)})),o.next=24,t.panZoomApi.followPath(l,{animScaleFactor:W});case 24:o.next=28;break;case 26:o.prev=26,o.t1=o.catch(20);case 28:case"end":return o.stop()}}),o,null,[[9,14],[20,26]])})))()}})},walkNpc:function(t){return(0,a.Z)(s().mark((function e(){var n,a,i,c,l,u,p,d;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=r.npc[t.npcKey]){e.next=5;break}throw Error('npc "'.concat(t.npcKey,'" does not exist'));case 5:if(!("key"in t)){e.next=18;break}if("local-nav"===t.key||"global-nav"===t.key){e.next=10;break}throw Error("invalid key: ".concat(JSON.stringify(t)));case 10:if("local-nav"!==t.key||D(t)){e.next=14;break}throw Error("invalid local navpath: ".concat(JSON.stringify(t)));case 14:if("global-nav"!==t.key||G(t)){e.next=16;break}throw Error("invalid global navpath: ".concat(JSON.stringify(t)));case 16:e.next=20;break;case 18:if(!("points"in t)||null!==(n=t.points)&&void 0!==n&&null!==(a=n.every)&&void 0!==a&&a.call(n,f.dl.isVectJson)){e.next=20;break}throw Error("invalid points: ".concat(JSON.stringify(t.points)));case 20:if(e.prev=20,!("points"in t)){e.next=26;break}return e.next=24,i.followNavPath(t.points);case 24:e.next=35;break;case 26:if("global-nav"!==t.key){e.next=34;break}return l=(c=t).fullPath,console.log("global navMetas",c.navMetas),e.next=32,i.followNavPath(l,{globalNavMetas:c.navMetas});case 32:e.next=35;break;case 34:if("local-nav"===t.key){u=$(t.fullPath.entries());try{for(u.s();!(p=u.n()).done;)d=(0,o.Z)(p.value,2),d[0],d[1]}catch(s){u.e(s)}finally{u.f()}}case 35:e.next=45;break;case 37:if(e.prev=37,e.t0=e.catch(20),r.events.next({key:"stopped-walking",npcKey:t.npcKey}),!(e.t0 instanceof Error&&"cancelled"===e.t0.message)){e.next=44;break}console.log("".concat(t.npcKey,": walkNpc cancelled")),e.next=45;break;case 44:throw e.t0;case 45:case"end":return e.stop()}}),e,null,[[20,37]])})))()}}}),{deps:[n,t.doorsApi]});return c.default.useEffect((function(){return(0,S.Zi)(t.npcsKey,r),t.onLoad(r),Object.values(r.npc).forEach((function(t){delete r.npc[t.key],r.spawn({npcKey:t.key,point:t.getPosition()})})),function(){(0,S.lB)(t.npcsKey)}}),[t.panZoomApi]),(0,H.BX)("div",{className:k()("npcs",at),children:[(0,H.tZ)(it,{debugPath:r.path}),Object.values(r.npc).map((function(t){return(0,H.tZ)(_,{npc:t},"".concat(t.key,"@").concat(t.epochMs))}))]})}var rt,at=(0,l.iv)(Y||(Y=(0,r.Z)(["\n  position: absolute;\n  canvas {\n    position: absolute;\n    pointer-events: none;\n  }\n  .npc {\n    position: absolute;\n    pointer-events: none;\n  }\n  svg.debug-path {\n    position: absolute;\n    pointer-events: none;\n  }\n"])));function it(t){return(0,H.tZ)(H.HY,{children:Object.entries(t.debugPath).map((function(t){var e=(0,o.Z)(t,2),n=e[0],r=e[1],a=r.path,i=r.aabb;return(0,H.tZ)("svg",{className:"debug-path",width:i.width,height:i.height,style:{left:i.x,top:i.y},children:(0,H.BX)("g",{style:{transform:"translate(".concat(-i.x,"px, ").concat(-i.y,"px)")},children:[(0,H.tZ)("polyline",{fill:"none",stroke:"#88f",strokeDasharray:"2 2",strokeWidth:1,points:"".concat(a)}),a.map((function(t){return(0,H.tZ)("circle",{fill:"none",stroke:"#ff444488",r:2,cx:t.x,cy:t.y})}))]})},n)}))})}function st(t){var e=(0,m.Z)(),n=(0,g.Z)([{layoutKey:"g-301--bridge"},{layoutKey:"g-101--multipurpose",transform:[1,0,0,1,0,600]},{layoutKey:"g-302--xboat-repair-bay",transform:[1,0,0,1,-1200,600]},{layoutKey:"g-303--passenger-deck",transform:[1,0,0,-1,-1200,1800]},{layoutKey:"g-302--xboat-repair-bay",transform:[-1,0,0,1,2400,600]},{layoutKey:"g-301--bridge",transform:[1,0,0,-1,0,2400]}]),o=n.gms,r=n.gmGraph,i=(0,h.Z)((function(){return{gmId:0,roomId:9,initOpen:{0:[24]},clipPath:o.map((function(t){return"none"})),doorsApi:{ready:!1},panZoomApi:{},npcsApi:{ready:!1},handlePlayerWayEvent:function(t){return(0,a.Z)(s().mark((function e(){var n,o,a,c;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=t.meta.key,e.next="exit-room"===e.t0?3:"enter-room"===e.t0?6:"pre-exit-room"===e.t0?8:13;break;case 3:return null!==t.meta.otherRoomId?(n=[t.meta.gmId,t.meta.otherRoomId],i.gmId=n[0],i.roomId=n[1]):(o=r.getAdjacentRoomCtxt(t.meta.gmId,t.meta.hullDoorId))&&(a=[o.adjGmId,o.adjRoomId],i.gmId=a[0],i.roomId=a[1]),i.update(),e.abrupt("break",14);case 6:return i.gmId===t.meta.gmId&&i.roomId===t.meta.enteredRoomId||(i.gmId=t.meta.gmId,i.roomId=t.meta.enteredRoomId,i.update()),e.abrupt("break",14);case 8:if(t.meta.doorId in i.doorsApi.open[t.meta.gmId]){e.next=12;break}return c=i.npcsApi.getNpc(t.npcKey),e.next=12,c.cancel();case 12:return e.abrupt("break",14);case 13:throw(0,p.Ql)(t.meta);case 14:case"end":return e.stop()}}),e)})))()},setRoomByNpc:function(t){var e=i.npcsApi.getNpc(t).getPosition(),n=r.findRoomContaining(e);if(n){var o=[n.gmId,n.roomId];i.gmId=o[0],i.roomId=o[1],i.update()}else console.error("set-player ".concat(t,": no room contains ").concat(JSON.stringify(e)))},update:function(){i.updateClipPath(),i.updateVisibleDoors(),e()},updateClipPath:function(){var t=o[i.gmId],e=o.map((function(t){return[]})),n=i.doorsApi.getOpen(i.gmId),a=r.computeLightPolygons(i.gmId,i.roomId,n);o.forEach((function(n,o){var r=a.filter((function(t){return o===t.gmIndex})).map((function(t){return t.poly.precision(2)}));if(n===t){var s=new f.LA(t.roomsWithDoors[i.roomId].outline);e[o]=f.LA.cutOut(r.concat(s),[n.hullOutline])}else e[o]=f.LA.cutOut(r,[n.hullOutline])})),e.forEach((function(t,e){t.forEach((function(t){return t.translate(-o[e].pngRect.x,-o[e].pngRect.y)}));var n=t.map((function(t){return"".concat(t.svgPath)})).join(" ");i.clipPath[e]=n.length?"path('".concat(n,"')"):"none"}))},updateVisibleDoors:function(){var t=this,e=o[i.gmId],n=e.roomGraph.nodesArray[i.roomId],a=o.map((function(t){return[]}));a[i.gmId]=e.roomGraph.getAdjacentDoors(n).map((function(t){return t.doorId})),e.roomGraph.getAdjacentHullDoorIds(e,n).flatMap((function(t){var e=t.hullDoorIndex;return r.getAdjacentRoomCtxt(i.gmId,e)||[]})).forEach((function(t){var e=t.adjGmId,n=t.adjDoorId;return(a[e]=a[e]||[]).push(n)})),o.forEach((function(e,n){return t.doorsApi.setVisible(n,a[n])}))}}}),{overwrite:{gmId:!0,roomId:!0},deps:[o,r]});return c.default.useEffect((function(){if(o.length&&i.doorsApi.ready&&i.npcsApi.ready){i.update();var t=i.doorsApi.events.pipe((0,u.h)((function(t){return"closed-door"===t.key||"opened-door"===t.key}))).subscribe((function(){return i.update()})),e=i.npcsApi.events.subscribe((function(t){"set-player"===t.key&&(i.npcsApi.playerKey=t.npcKey||null,t.npcKey&&i.setRoomByNpc(t.npcKey)),"way-point"===t.key&&t.npcKey===i.npcsApi.playerKey&&i.handlePlayerWayEvent(t)}));return function(){t.unsubscribe(),e.unsubscribe()}}}),[o,i.doorsApi.ready,i.npcsApi.ready]),o.length?(0,H.BX)(y.Z,{className:lt,initZoom:1.5,initCenter:{x:300,y:300},dark:!0,onLoad:function(t){return i.panZoomApi=t},children:[o.map((function(t){return(0,H.tZ)("img",{className:"geomorph",src:(0,d.qX)(t.key),draggable:!1,width:t.pngRect.width,height:t.pngRect.height,style:{left:t.pngRect.x,top:t.pngRect.y,transform:t.transformStyle,transformOrigin:t.transformOrigin}})})),i.doorsApi.ready&&(0,H.tZ)(ut,{showIds:!0,gms:o,gmGraph:r,doorsApi:i.doorsApi,gmId:i.gmId,roomId:i.roomId,setRoom:function(t,e){var n=[t,e];i.gmId=n[0],i.roomId=n[1],i.update()}}),(0,H.tZ)(ot,{disabled:t.disabled,doorsApi:i.doorsApi,gmGraph:r,npcsKey:ct,panZoomApi:i.panZoomApi,onLoad:function(t){i.npcsApi=t,e()}}),o.map((function(t,e){return(0,H.tZ)("img",{className:"geomorph-dark",src:(0,d.qX)(t.key),draggable:!1,width:t.pngRect.width,height:t.pngRect.height,style:{clipPath:i.clipPath[e],WebkitClipPath:i.clipPath[e],left:t.pngRect.x,top:t.pngRect.y,transform:t.transformStyle,transformOrigin:t.transformOrigin}},e)})),(0,H.tZ)(v.Z,{gms:o,gmGraph:r,initOpen:i.initOpen,npcsKey:ct,onLoad:function(t){i.doorsApi=t,e()}})]}):null}var ct="npcs-demo-1",lt=(0,l.iv)(rt||(rt=(0,r.Z)(["\n  img {\n    position: absolute;\n    transform-origin: top left;\n    pointer-events: none;\n  }\n  img.geomorph {\n    filter: brightness(80%);\n  }\n  img.geomorph-dark {\n    filter: invert(100%) brightness(34%);\n    /* filter: invert(100%) brightness(55%) contrast(200%) brightness(60%); */\n  }\n\n  div.debug {\n    position: absolute;\n    div.debug-door-arrow {\n      cursor: pointer;\n      position: absolute;\n      background-image: url('/icon/solid_arrow-circle-right.svg');\n      border-radius: ","px;\n    }\n    div.debug-door-id-icon, div.debug-room-id-icon {\n      position: absolute;\n      background: black;\n      color: white;\n      font-size: 8px;\n      line-height: 1;\n      border: 1px solid black;\n    }\n    div.debug-room-id-icon {\n      color: #4f4;\n    }\n    div.debug-window {\n      position: absolute;\n      background: #0000ff40;\n      border: 1px solid white;\n      pointer-events: none;\n      transform-origin: top left;\n    }\n    svg.debug-room-nav, svg.debug-room-outline {\n      position: absolute;\n      pointer-events: none;\n      path.nav-poly {\n        pointer-events: none;\n        fill: rgba(255, 0, 0, 0.1);\n        stroke: blue;\n      }\n      path.room-outline {\n        pointer-events: none;\n        fill: rgba(0, 0, 255, 0.1);\n        stroke: red;\n      }\n    }\n  }\n\n"])),5);function ut(t){var e=t.gms[t.gmId],n=t.doorsApi.getVisible(t.gmId),r=e.lazy.roomNavPoly[t.roomId],a=r.rect,i=e.rooms[t.roomId].rect,s=e.rooms[t.roomId];return(0,H.BX)("div",{className:"debug-parent",onClick:function(n){var r=n.target;if(r.hasAttribute("data-debug-door-index")){var a=e.doors[Number(r.getAttribute("data-debug-door-index"))],i=a.roomIds.filter((function(e){return e!==t.roomId})),s=(0,o.Z)(i,1)[0];if(null!==s)return t.setRoom(t.gmId,s);var c=e.hullDoors.indexOf(a),l=t.gmGraph.getAdjacentRoomCtxt(t.gmId,c);l?t.setRoom(l.adjGmId,l.adjRoomId):console.info("hull door is isolated",t.gmId,c)}},children:[t.outlines&&t.gms.map((function(t,e){return(0,H.tZ)("div",{style:{position:"absolute",left:t.gridRect.x,top:t.gridRect.y,width:t.gridRect.width,height:t.gridRect.height,border:"2px red solid"}},e)})),(0,H.BX)("div",{className:"debug",style:{transform:e.transformStyle},children:[t.localNav&&(0,H.tZ)("svg",{className:"debug-room-nav",width:a.width,height:a.height,style:{left:a.x,top:a.y},children:(0,H.BX)("g",{style:{transform:"translate(".concat(-a.x,"px, ").concat(-a.y,"px)")},children:[(0,H.tZ)("path",{className:"nav-poly",d:r.svgPath}),n.map((function(t){var n=(0,o.Z)(e.doors[t].seg,2),r=n[0],a=n[1];return(0,H.tZ)("line",{stroke:"red",x1:r.x,y1:r.y,x2:a.x,y2:a.y},t)}))]})}),t.roomOutlines&&(0,H.tZ)("svg",{className:"debug-room-outline",width:i.width,height:i.height,style:{left:i.x,top:i.y},children:(0,H.tZ)("g",{style:{transform:"translate(".concat(-i.x,"px, ").concat(-i.y,"px)")},children:(0,H.tZ)("path",{className:"room-outline",d:s.svgPath})})}),n.map((function(n){var o=e.doors[n],r=o.poly,a=o.normal,i=o.roomIds[0]===t.roomId?1:-1,s=f.dl.from(a).scale(-i).angle,c=r.center.addScaledVector(a,18*i),l=r.center.addScaledVector(a,18*-i);return(0,H.BX)(H.HY,{children:[(0,H.tZ)("div",{"data-debug-door-index":n,"data-tags":"debug door-arrow",className:"debug-door-arrow",style:{left:c.x-5,top:c.y-5,width:10,height:10,transform:"rotate(".concat(s,"rad)")}},n),t.showIds&&(0,H.tZ)("div",{className:"debug-door-id-icon",style:{left:l.x,top:l.y-4},children:n},"icon")]})})),t.showIds&&(0,H.tZ)("div",{className:"debug-room-id-icon",style:{left:a.x+a.width-35,top:a.y+25},children:t.roomId}),t.windows&&e.windows.map((function(t,e){var n=t.baseRect,o=t.angle;return(0,H.tZ)("div",{className:"debug-window",style:{left:n.x,top:n.y,width:n.width,height:n.height,transform:"rotate(".concat(o,"rad)")}},"window-".concat(e))}))]},e.itemKey)]})}},69862:function(){},40964:function(){},28949:function(){}}]);